<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ è«‹æ±‚ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v7</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 120px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            border: none;
            background: transparent;
            font-size: 14px;
        }

        .tab:hover {
            background: #e0e0e0;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .content {
            padding: 30px;
            max-height: calc(100vh - 250px);
            overflow-y: auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
        }

        .checkbox-item label {
            margin: 0;
            font-weight: 500;
            cursor: pointer;
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f9f9f9;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #e6e6ff;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .user-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .user-card {
            border: 2px solid #ddd;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .user-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .user-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .user-card p {
            margin: 5px 0;
            color: #666;
        }

        .calendar {
            margin-top: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: #ddd;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-day {
            background: white;
            padding: 15px;
            min-height: 100px;
            position: relative;
        }

        .calendar-day.header {
            background: #667eea;
            color: white;
            font-weight: 600;
            text-align: center;
            padding: 10px;
            min-height: auto;
        }

        .calendar-day.disabled {
            background: #f5f5f5;
            color: #ccc;
        }

        .day-number {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .day-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 5px;
        }

        .status-ok {
            background: #d4edda;
            color: #155724;
        }

        .status-away {
            background: #fff3cd;
            color: #856404;
        }

        .status-hospital {
            background: #f8d7da;
            color: #721c24;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: flex-start;
            justify-content: center;
            overflow-y: auto;
            padding: 20px 0;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 480px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            font-size: 1.2em;
            font-weight: 700;
            margin-bottom: 16px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            cursor: pointer;
            font-size: 1.2em;
            color: #888;
            background: none;
            border: none;
            padding: 0 4px;
        }

        .modal-section {
            margin-bottom: 14px;
        }

        .modal-label {
            font-size: 0.85em;
            color: #555;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .modal-label input[type=checkbox] {
            width: 16px;
            height: 16px;
        }

        .modal-hint {
            font-size: 0.75em;
            color: #888;
            margin-bottom: 4px;
        }

        .modal select, .modal input[type=text], .modal input[type=date] {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .modal-row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 4px;
        }

        .modal-checkbox-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
        }

        .modal-collapse-btn {
            color: #667eea;
            cursor: pointer;
            font-size: 0.85em;
            text-decoration: underline;
            background: none;
            border: none;
            padding: 4px 0;
        }

        .modal-divider {
            border: none;
            border-top: 1px solid #eee;
            margin: 12px 0;
        }

        .modal-update-bar {
            background: #f0f4ff;
            border-radius: 6px;
            padding: 8px 12px;
            margin-bottom: 12px;
            font-size: 0.82em;
            color: #555;
        }

        .status-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .status-option {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .status-option:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }

        .status-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .progress {
            margin: 20px 0;
            text-align: center;
            color: #667eea;
            font-weight: 600;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }

            .calendar-day {
                min-height: 80px;
                padding: 10px;
            }

            .status-options {
                grid-template-columns: 1fr;
            }

            .tab {
                font-size: 12px;
                padding: 10px 5px;
            }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .section-header {
            font-size: 1.5em;
            font-weight: 600;
            color: #667eea;
            margin: 30px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .subsection-header {
            font-size: 1.2em;
            font-weight: 600;
            color: #495057;
            margin: 25px 0 15px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid #dee2e6;
        }

        .info-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .info-card h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .info-card p {
            margin: 8px 0;
            color: #495057;
        }

        /* å»ºç‰©ç®¡ç† */
        .building-sidebar-item {
            padding: 12px 16px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            background: white;
            transition: all 0.2s;
        }
        .building-sidebar-item:hover { background: #f0f0ff; border-color: #667eea; }
        .building-sidebar-item.active { background: #667eea; color: white; border-color: #667eea; }
        .building-sidebar-item.active small { color: #ddd; }

        .building-inner-tabs { display: flex; border-bottom: 2px solid #dee2e6; margin-bottom: 20px; gap: 4px; }
        .building-inner-tab {
            padding: 8px 18px;
            cursor: pointer;
            border-radius: 6px 6px 0 0;
            background: #f5f5f5;
            border: 1px solid #dee2e6;
            border-bottom: none;
            font-size: 0.9em;
        }
        .building-inner-tab.active { background: white; border-color: #667eea; color: #667eea; font-weight: bold; }

        .building-detail-panel { display: none; }
        .building-detail-panel.active { display: block; }

        .history-grid { display: grid; grid-template-columns: 120px repeat(12, 1fr); gap: 4px; margin-bottom: 16px; }
        .history-grid-year { grid-column: 1; font-weight: bold; padding: 6px; background: #f5f5f5; border-radius: 4px; align-self: start; }
        .history-link { padding: 4px 6px; background: #e8f0fe; color: #667eea; border-radius: 4px; text-align: center; font-size: 0.8em; cursor: pointer; text-decoration: underline; }
        .history-link:hover { background: #667eea; color: white; }
        .history-row-label { font-size: 0.75em; color: #888; margin-bottom: 2px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ  ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ è«‹æ±‚ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v7</h1>
            <p>éšœå®³è€…å…±åŒç”Ÿæ´»æ´åŠ©ã‚µãƒ¼ãƒ“ã‚¹</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('facility')">ğŸ¢ äº‹æ¥­æ‰€æƒ…å ±</button>
            <button class="tab" onclick="showTab('buildings')">ğŸ˜ï¸ å»ºç‰©ç®¡ç†</button>
            <button class="tab" onclick="showTab('users')">ğŸ‘¤ åˆ©ç”¨è€…ç®¡ç†</button>
            <button class="tab" onclick="showTab('records')">ğŸ“… å®Ÿç¸¾è¨˜éŒ²</button>
            <button class="tab" onclick="showTab('export')">ğŸ“¤ è«‹æ±‚ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›</button>
        </div>

        <div class="content">
            <!-- äº‹æ¥­æ‰€æƒ…å ±ã‚¿ãƒ– -->
            <div id="facility" class="tab-content active">
                <h2 class="section-header">äº‹æ¥­æ‰€åŸºæœ¬æƒ…å ±</h2>

                <form id="facilityForm">
                    <div class="grid-2">
                        <div class="form-group">
                            <label>äº‹æ¥­æ‰€ç•ªå· *</label>
                            <input type="text" id="facilityNumber" value="1321402032" required>
                        </div>
                        <div class="form-group">
                            <label>äº‹æ¥­æ‰€å *</label>
                            <input type="text" id="facilityName" value="Tokyo. settle" required>
                        </div>
                    </div>

                    <div class="grid-2">
                        <div class="form-group">
                            <label>æ³•äººå</label>
                            <input type="text" id="corporationName" value="åˆåŒä¼šç¤¾ã‚¨ãƒ´ã‚§ãƒ¬ã‚«ãƒ³ãƒ‘ãƒ‹ãƒ¼">
                        </div>
                        <div class="form-group">
                            <label>åœ°åŸŸåŒºåˆ†</label>
                            <select id="areaCode">
                                <option value="01">ä¸€ç´šåœ°</option>
                                <option value="02">äºŒç´šåœ°</option>
                                <option value="03">ä¸‰ç´šåœ°</option>
                                <option value="04">å››ç´šåœ°</option>
                                <option value="05">äº”ç´šåœ°</option>
                                <option value="06">å…­ç´šåœ°</option>
                                <option value="07">ä¸ƒç´šåœ°</option>
                                <option value="20">ãã®ä»–</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>å…¥å“¡é…ç½®ä½“åˆ¶</label>
                        <select id="residentialCareSystem">
                            <option value="">â€»ä»¤å’Œ6å¹´4æœˆä»¥é™ã¯ã€è¨­å®šä¸è¦</option>
                            <option value="å…±åŒç”Ÿæ´»æ´åŠ©Iï¼ˆ4ï¼š1ï¼‰">å…±åŒç”Ÿæ´»æ´åŠ©Iï¼ˆ4ï¼š1ï¼‰</option>
                            <option value="å…±åŒç”Ÿæ´»æ´åŠ©I(6:1)">å…±åŒç”Ÿæ´»æ´åŠ©I(6:1)</option>
                            <option value="å…±åŒç”Ÿæ´»æ´åŠ©I(6:1)ãƒ»å…¥å“¡é…ç½®ä½“åˆ¶ 12ï¼š1">å…±åŒç”Ÿæ´»æ´åŠ©I(6:1)ãƒ»å…¥å“¡é…ç½®ä½“åˆ¶ 12ï¼š1</option>
                            <option value="å…±åŒç”Ÿæ´»æ´åŠ©I(6:1)ãƒ»å…¥å“¡é…ç½®ä½“åˆ¶ 30ï¼š1">å…±åŒç”Ÿæ´»æ´åŠ©I(6:1)ãƒ»å…¥å“¡é…ç½®ä½“åˆ¶ 30ï¼š1</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>å…¥å“¡é…ç½®ä½“åˆ¶</label>
                        <input type="text" id="staffRatio" placeholder="ä¾‹: 12:1" value="12ï¼š1">
                    </div>

                    <h3 class="subsection-header">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—</h3>
                    <div class="form-group">
                        <label>å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰</label>
                        <select id="nightSupportType1">
                            <option value="">è¨­å®šãªã—</option>
                            <option value="2äººä»¥ä¸‹">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 2äººä»¥ä¸‹</option>
                            <option value="3äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 3äºº</option>
                            <option value="4äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 4äºº</option>
                            <option value="5äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 5äºº</option>
                            <option value="6äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 6äºº</option>
                            <option value="7äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 7äºº</option>
                            <option value="8äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 8äºº</option>
                            <option value="9äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 9äºº</option>
                            <option value="10äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 10äºº</option>
                            <option value="11äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 11äºº</option>
                            <option value="12äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 12äºº</option>
                            <option value="13äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 13äºº</option>
                            <option value="14äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 14äºº</option>
                            <option value="15äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 15äºº</option>
                            <option value="16äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 16äºº</option>
                            <option value="17äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 17äºº</option>
                            <option value="18äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 18äºº</option>
                            <option value="19äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 19äºº</option>
                            <option value="20äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 20äºº</option>
                            <option value="21äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 21äºº</option>
                            <option value="22äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 22äºº</option>
                            <option value="23äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 23äºº</option>
                            <option value="24äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 24äºº</option>
                            <option value="25äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 25äºº</option>
                            <option value="26äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 26äºº</option>
                            <option value="27äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 27äºº</option>
                            <option value="28äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 28äºº</option>
                            <option value="29äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 29äºº</option>
                            <option value="30äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 30äºº</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰</label>
                        <select id="nightSupportType2">
                            <option value="">è¨­å®šãªã—</option>
                            <option value="4äººä»¥ä¸‹">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 4äººä»¥ä¸‹</option>
                            <option value="5äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 5äºº</option>
                            <option value="6äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 6äºº</option>
                            <option value="7äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 7äºº</option>
                            <option value="8äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 8äºº</option>
                            <option value="9äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 9äºº</option>
                            <option value="10äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 10äºº</option>
                            <option value="11äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 11äºº</option>
                            <option value="12äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 12äºº</option>
                            <option value="13äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 13äºº</option>
                            <option value="14äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 14äºº</option>
                            <option value="15äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 15äºº</option>
                            <option value="16äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 16äºº</option>
                            <option value="17äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 17äºº</option>
                            <option value="18äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 18äºº</option>
                            <option value="19äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 19äºº</option>
                            <option value="20äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 20äºº</option>
                            <option value="21äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 21äºº</option>
                            <option value="22äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 22äºº</option>
                            <option value="23äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 23äºº</option>
                            <option value="24äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 24äºº</option>
                            <option value="25äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 25äºº</option>
                            <option value="26äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 26äºº</option>
                            <option value="27äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 27äºº</option>
                            <option value="28äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 28äºº</option>
                            <option value="29äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 29äºº</option>
                            <option value="30äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 30äºº</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¢ï¼‰</label>
                        <select id="nightSupportType3">
                            <option value="">è¨­å®šãªã—</option>
                            <option value="å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¢ï¼‰">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¢ï¼‰</option>
                        </select>
                    </div>

                    <h3 class="subsection-header">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—</h3>
                    <div class="form-group">
                        <label>ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—</label>
                        <select id="treatmentImprovement">
                            <option value="">è¨­å®šãªã—</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆâ… ï¼‰">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆâ… ï¼‰</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆâ…¡ï¼‰">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆâ…¡ï¼‰</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆâ…¢ï¼‰">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆâ…¢ï¼‰</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆâ…£ï¼‰">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆâ…£ï¼‰</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(1)">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(1)</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(2)">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(2)</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(3)">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(3)</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(4)">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(4)</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(5)">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(5)</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(6)">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(6)</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(7)">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(7)</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(8)">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(8)</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(9)">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(9)</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(10)">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(10)</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(11)">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(11)</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(12)">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(12)</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(13)">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(13)</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(14)">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(14)</option>
                        </select>
                    </div>

                    <h3 class="subsection-header">æ—¥ä¸­æ”¯æ´åŠ ç®—</h3>
                    <div class="form-group">
                        <label>æ—¥ä¸­æ”¯æ´åŠ ç®—</label>
                        <select id="daySupport">
                            <option value="">è¨­å®šãªã—</option>
                            <option value="æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰ 1äºº">æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰ 1äºº</option>
                            <option value="æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰ 2äººä»¥ä¸Š">æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰ 2äººä»¥ä¸Š</option>
                            <option value="æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰ 1äºº åŒºåˆ†4ã€5ã€6">æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰ 1äºº åŒºåˆ†4ã€5ã€6</option>
                            <option value="æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰ 1äºº åŒºåˆ†3ä»¥ä¸‹">æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰ 1äºº åŒºåˆ†3ä»¥ä¸‹</option>
                            <option value="æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰ 2äººä»¥ä¸Š åŒºåˆ†4ã€5ã€6">æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰ 2äººä»¥ä¸Š åŒºåˆ†4ã€5ã€6</option>
                            <option value="æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰ 2äººä»¥ä¸Š åŒºåˆ†3ä»¥ä¸‹">æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰ 2äººä»¥ä¸Š åŒºåˆ†3ä»¥ä¸‹</option>
                        </select>
                    </div>

                    <h3 class="subsection-header">ç¦ç¥‰å°‚é–€è·å“¡é…ç½®ç­‰åŠ ç®—</h3>
                    <div class="form-group">
                        <select id="specialistAllowance">
                            <option value="">è¨­å®šãªã—</option>
                            <option value="ç¦ç¥‰å°‚é–€è·å“¡é…ç½®ç­‰åŠ ç®—ï¼ˆâ… ï¼‰">ç¦ç¥‰å°‚é–€è·å“¡é…ç½®ç­‰åŠ ç®—ï¼ˆâ… ï¼‰</option>
                            <option value="ç¦ç¥‰å°‚é–€è·å“¡é…ç½®ç­‰åŠ ç®—ï¼ˆâ…¡ï¼‰">ç¦ç¥‰å°‚é–€è·å“¡é…ç½®ç­‰åŠ ç®—ï¼ˆâ…¡ï¼‰</option>
                            <option value="ç¦ç¥‰å°‚é–€è·å“¡é…ç½®ç­‰åŠ ç®—ï¼ˆâ…¢ï¼‰">ç¦ç¥‰å°‚é–€è·å“¡é…ç½®ç­‰åŠ ç®—ï¼ˆâ…¢ï¼‰</option>
                        </select>
                    </div>

                    <h3 class="subsection-header">è¦–è¦šãƒ»è´è¦šè¨€èªéšœå®³è€…æ”¯æ´ä½“åˆ¶åŠ ç®—</h3>
                    <div class="form-group">
                        <select id="sensorySupport">
                            <option value="">è¨­å®šãªã—</option>
                            <option value="è¦–è¦šãƒ»è´è¦šè¨€èªéšœå®³è€…æ”¯æ´ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰">è¦–è¦šãƒ»è´è¦šè¨€èªéšœå®³è€…æ”¯æ´ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰</option>
                            <option value="è¦–è¦šãƒ»è´è¦šè¨€èªéšœå®³è€…æ”¯æ´ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰">è¦–è¦šãƒ»è´è¦šè¨€èªéšœå®³è€…æ”¯æ´ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰</option>
                        </select>
                    </div>

                    <h3 class="subsection-header">çœ‹è­·è·å“¡é…ç½®åŠ ç®—</h3>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="nurseAllowance" value="çœ‹è­·è·å“¡é…ç½®åŠ ç®—">
                                <label for="nurseAllowance">çœ‹è­·è·å“¡é…ç½®åŠ ç®—</label>
                            </div>
                        </div>
                    </div>

                    <h3 class="subsection-header">åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—</h3>
                    <div class="form-group">
                        <select id="medicalCooperation">
                            <option value="">è¨­å®šãªã—</option>
                            <option value="åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…¥ï¼‰">åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…¥ï¼‰</option>
                            <option value="åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…¦ï¼‰">åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…¦ï¼‰</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>å®Ÿç¸¾è¨˜éŒ²ç­‰ã®æ•´å‚™ã«å¿…è¦</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="medicalCooperationRecord" value="å®Ÿç¸¾è¨˜éŒ²ç­‰ã®æ•´å‚™ã«å¿…è¦">
                                <label for="medicalCooperationRecord">å®Ÿç¸¾è¨˜éŒ²ç­‰ã®æ•´å‚™ã«å¿…è¦</label>
                            </div>
                        </div>
                    </div>

                    <h3 class="subsection-header">çœ‹è­·è·å“¡æ•°</h3>
                    <div class="form-group">
                        <input type="number" id="nurseCount" placeholder="çœ‹è­·è·å“¡æ•°">
                    </div>

                    <h3 class="subsection-header">é€šå‹¤è€…ç”Ÿæ´»æ”¯æ´åŠ ç®—</h3>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="commuterSupport" value="é€šå‹¤è€…ç”Ÿæ´»æ”¯æ´åŠ ç®—">
                                <label for="commuterSupport">é€šå‹¤è€…ç”Ÿæ´»æ”¯æ´åŠ ç®—</label>
                            </div>
                        </div>
                    </div>

                    <h3 class="subsection-header">å±…ä½æ”¯æ´ä½“åˆ¶</h3>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="housingSupport" value="å±…ä½æ”¯æ´ä½“åˆ¶">
                                <label for="housingSupport">å±…ä½æ”¯æ´ä½“åˆ¶</label>
                            </div>
                        </div>
                    </div>

                    <h3 class="subsection-header">ç§»è¡Œæ”¯æ´ä½ä½“åˆ¶</h3>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="transitionSupport" value="ç§»è¡Œæ”¯æ´ä½ä½“åˆ¶">
                                <label for="transitionSupport">ç§»è¡Œæ”¯æ´ä½ä½“åˆ¶</label>
                            </div>
                        </div>
                    </div>

                    <h3 class="subsection-header">ãƒ”ã‚¢ã‚µãƒãƒ¼ãƒˆå®Ÿæ–½åŠ ç®—</h3>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="peerSupport" value="ãƒ”ã‚¢ã‚µãƒãƒ¼ãƒˆå®Ÿæ–½åŠ ç®—">
                                <label for="peerSupport">ãƒ”ã‚¢ã‚µãƒãƒ¼ãƒˆå®Ÿæ–½åŠ ç®—</label>
                            </div>
                        </div>
                    </div>

                    <h3 class="subsection-header">éšœå®³è€…æ”¯æ´æ–½è¨­ç­‰æ„ŸæŸ“å¯¾ç­–å‘ä¸ŠåŠ ç®—</h3>
                    <div class="form-group">
                        <label>éšœå®³è€…æ”¯æ´æ–½è¨­ç­‰æ„ŸæŸ“å¯¾ç­–å‘ä¸ŠåŠ ç®—</label>
                        <select id="infectionControl">
                            <option value="">è¨­å®šãªã—</option>
                            <option value="éšœå®³è€…æ”¯æ´æ–½è¨­ç­‰æ„ŸæŸ“å¯¾ç­–å‘ä¸ŠåŠ ç®—ï¼ˆâ… ï¼‰">éšœå®³è€…æ”¯æ´æ–½è¨­ç­‰æ„ŸæŸ“å¯¾ç­–å‘ä¸ŠåŠ ç®—ï¼ˆâ… ï¼‰</option>
                            <option value="éšœå®³è€…æ”¯æ´æ–½è¨­ç­‰æ„ŸæŸ“å¯¾ç­–å‘ä¸ŠåŠ ç®—ï¼ˆâ…¡ï¼‰">éšœå®³è€…æ”¯æ´æ–½è¨­ç­‰æ„ŸæŸ“å¯¾ç­–å‘ä¸ŠåŠ ç®—ï¼ˆâ…¡ï¼‰</option>
                            <option value="éšœå®³è€…æ”¯æ´æ–½è¨­ç­‰æ„ŸæŸ“å¯¾ç­–å‘ä¸ŠåŠ ç®—ï¼ˆâ… ï¼‰ï¼ˆâ…¡ï¼‰">éšœå®³è€…æ”¯æ´æ–½è¨­ç­‰æ„ŸæŸ“å¯¾ç­–å‘ä¸ŠåŠ ç®—ï¼ˆâ… ï¼‰ï¼ˆâ…¡ï¼‰</option>
                        </select>
                    </div>

                    <h3 class="subsection-header">ä¸­æ ¸çš„é…ç½®ç­‰åŠ ç®—ä½“åˆ¶</h3>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="coreStaffing" value="ä¸­æ ¸çš„é…ç½®ç­‰åŠ ç®—ä½“åˆ¶">
                                <label for="coreStaffing">ä¸­æ ¸çš„é…ç½®ç­‰åŠ ç®—ä½“åˆ¶</label>
                            </div>
                        </div>
                    </div>

                    <h3 class="subsection-header">é«˜æ¬¡è„³æ©Ÿèƒ½éƒ¨è€…æ”¯æ´ä½“åˆ¶</h3>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="brainInjurySupport" value="é«˜æ¬¡è„³æ©Ÿèƒ½éƒ¨è€…æ”¯æ´ä½“åˆ¶">
                                <label for="brainInjurySupport">é«˜æ¬¡è„³æ©Ÿèƒ½éƒ¨è€…æ”¯æ´ä½“åˆ¶</label>
                            </div>
                        </div>
                    </div>

                    <h3 class="subsection-header">æ¸›ç®—</h3>
                    <div class="form-group">
                        <label>å¤§è¦æ¨¡ä½å±…ç­‰æ¸›ç®—</label>
                        <select id="largeScaleReduction">
                            <option value="">è¨­å®šãªã—</option>
                            <option value="å¤§è¦æ¨¡ä½å±…ç­‰æ¸›ç®—ï¼ˆå…¥å±…å®šå“¡8äººä»¥ä¸Šï¼‰">å…¥å±…å®šå“¡ãŒï¼˜äººä»¥ä¸Š</option>
                            <option value="å¤§è¦æ¨¡ä½å±…ç­‰æ¸›ç®—ï¼ˆå…¥å±…å®šå“¡21äººä»¥ä¸Šï¼‰">å…¥å±…å®šå“¡ãŒ21äººä»¥ä¸Š</option>
                            <option value="å¤§è¦æ¨¡ä½å±…ç­‰æ¸›ç®—ï¼ˆä¸€ä½“çš„ãªå…±åŒç”Ÿæ´»ä½å±…21äººä»¥ä¸Šï¼‰">ä¸€ä½“çš„ãªå…±åŒç”Ÿæ´»ä½å±…ã®å…¥å±…å®šå“¡æ•°21ä»¥ä¸Š</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ã‚µãƒ¼ãƒ“ã‚¹ç®¡ç†è²¬ä»»è€…ã®å“¡æ•°ãŒåŸºæº–ã«æº€ãŸãªã„</label>
                        <select id="serviceManagerReduction">
                            <option value="">è¨­å®šãªã—</option>
                            <option value="ã‚µãƒ¼ãƒ“ã‚¹ç®¡ç†è²¬ä»»è€…ä¸è¶³ï¼ˆ4æœˆç›®ã¾ã§ï¼‰">æ¸›ç®—ãŒé©ç”¨ã•ã‚Œã‚‹æœˆã‹ã‚‰ï¼”æœˆç›®ã¾ã§</option>
                            <option value="ã‚µãƒ¼ãƒ“ã‚¹ç®¡ç†è²¬ä»»è€…ä¸è¶³ï¼ˆ5æœˆä»¥ä¸Šé€£ç¶šï¼‰">ï¼•æœˆä»¥ä¸Šé€£ç¶šã—ã¦æ¸›ç®—ã®å ´åˆ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ä¸–è©±äººåˆã¯ç”Ÿæ´»æ”¯æ´å“¡ã®å“¡æ•°ãŒåŸºæº–ã«æº€ãŸãªã„</label>
                        <select id="staffReduction">
                            <option value="">è¨­å®šãªã—</option>
                            <option value="ä¸–è©±äººãƒ»ç”Ÿæ´»æ”¯æ´å“¡ä¸è¶³ï¼ˆ2æœˆç›®ã¾ã§ï¼‰">æ¸›ç®—ãŒé©ç”¨ã•ã‚Œã‚‹æœˆã‹ã‚‰ï¼’æœˆç›®ã¾ã§</option>
                            <option value="ä¸–è©±äººãƒ»ç”Ÿæ´»æ”¯æ´å“¡ä¸è¶³ï¼ˆ3æœˆä»¥ä¸Šé€£ç¶šï¼‰">ï¼“æœˆä»¥ä¸Šé€£ç¶šã—ã¦æ¸›ç®—ã®å ´åˆ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>èº«ä½“æ‹˜æŸå»ƒæ­¢æœªå®Ÿæ–½æ¸›ç®—</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="restraintReduction" value="èº«ä½“æ‹˜æŸå»ƒæ­¢æœªå®Ÿæ–½">
                                <label for="restraintReduction">èº«ä½“æ‹˜æŸå»ƒæ­¢æœªå®Ÿæ–½æ¸›ç®—</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>è™å¾…é˜²æ­¢æªç½®æœªå®Ÿæ–½æ¸›ç®—</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="abusePreventionReduction" value="è™å¾…é˜²æ­¢æªç½®æœªå®Ÿæ–½">
                                <label for="abusePreventionReduction">è™å¾…é˜²æ­¢æªç½®æœªå®Ÿæ–½æ¸›ç®—</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>æ¥­å‹™ç¶™ç¶šè¨ˆç”»æœªç­–å®šæ¸›ç®—</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="bcpReduction" value="æ¥­å‹™ç¶™ç¶šè¨ˆç”»æœªç­–å®š">
                                <label for="bcpReduction">æ¥­å‹™ç¶™ç¶šè¨ˆç”»æœªç­–å®šæ¸›ç®—</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>æƒ…å ±å…¬è¡¨æœªå ±å‘Šæ¸›ç®—</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="infoDisclosureReduction" value="æƒ…å ±å…¬è¡¨æœªå ±å‘Š">
                                <label for="infoDisclosureReduction">æƒ…å ±å…¬è¡¨æœªå ±å‘Šæ¸›ç®—</label>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 30px;">
                        <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜</button>
                    </div>
                </form>

                <div id="facilityInfo" style="margin-top: 40px;"></div>
            </div>

            <!-- å»ºç‰©ç®¡ç†ã‚¿ãƒ– -->
            <div id="buildings" class="tab-content">
                <h2 class="section-header">å»ºç‰©ï¼ˆãƒ¦ãƒ‹ãƒƒãƒˆï¼‰ç®¡ç†</h2>
                <div style="display:flex; gap:16px; flex-wrap:wrap; margin-bottom:20px;">
                    <div id="buildingSidebar" style="width:220px; min-width:180px;"></div>
                    <div id="buildingDetail" style="flex:1; min-width:300px;"></div>
                </div>
                <button type="button" class="btn btn-info" onclick="addBuilding()">ï¼‹ å»ºç‰©ã‚’è¿½åŠ </button>
            </div>

            <!-- åˆ©ç”¨è€…ç®¡ç†ã‚¿ãƒ– -->
            <div id="users" class="tab-content">
                <!-- åˆ©ç”¨è€…ä¸€è¦§ç”»é¢ -->
                <div id="userListView">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; flex-wrap:wrap; gap:8px;">
                        <h2 class="section-header" style="margin:0;">åˆ©ç”¨è€…ä¸€è¦§</h2>
                        <button type="button" class="btn btn-primary" onclick="showUserNew()" style="background:#e91e8c; border-color:#e91e8c;">ï¼‹ æ–°è¦ç™»éŒ²</button>
                    </div>
                    <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px; align-items:center;">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span style="font-size:0.9em;">äº‹æ¥­æ‰€</span>
                            <select id="filterFacility" style="padding:6px 10px; border:1px solid #ddd; border-radius:6px;" onchange="renderUserList()">
                                <option value="">é¸æŠã—ã¦ã...</option>
                                <option value="tokyo">Tokyo. settle</option>
                            </select>
                        </div>
                        <input type="text" id="filterName" placeholder="åˆ©ç”¨è€…å" style="padding:6px 10px; border:1px solid #ddd; border-radius:6px;" oninput="renderUserList()">
                        <button class="btn btn-primary" onclick="renderUserList()" style="background:#e91e8c; border-color:#e91e8c; padding:6px 16px;">æ¤œç´¢</button>
                        <div style="display:flex; align-items:center; gap:8px; margin-left:8px;">
                            <span style="font-size:0.9em;">å»ºç‰©</span>
                            <select id="filterBuilding" style="padding:6px 10px; border:1px solid #ddd; border-radius:6px;" onchange="renderUserList()">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            </select>
                        </div>
                    </div>
                    <div id="userPager" style="margin-bottom:8px;"></div>
                    <div id="userListCount" style="margin-bottom:8px; font-size:0.9em; color:#555;"></div>
                    <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
                        <thead>
                            <tr style="border-bottom:2px solid #ddd;">
                                <th style="width:40px;"></th>
                                <th style="text-align:left; padding:8px; color:#667eea; cursor:pointer;">äº‹æ¥­æ‰€</th>
                                <th style="text-align:left; padding:8px; color:#667eea; cursor:pointer;">å»ºç‰©</th>
                                <th style="text-align:left; padding:8px;">åˆ©ç”¨è€…å</th>
                                <th style="width:120px;"></th>
                            </tr>
                        </thead>
                        <tbody id="userListBody"></tbody>
                    </table>
                </div>

                <!-- åˆ©ç”¨è€…è©³ç´°ãƒ»ç·¨é›†ç”»é¢ -->
                <div id="userDetailView" style="display:none;">
                    <div style="font-size:0.85em; color:#888; margin-bottom:8px;">
                        <span style="cursor:pointer; color:#667eea;" onclick="showUserList()">ãƒ›ãƒ¼ãƒ </span> /
                        <span style="cursor:pointer; color:#667eea;" onclick="showUserList()">åˆ©ç”¨è€…ä¸€è¦§</span> /
                        <span id="userDetailBreadcrumb"></span>
                    </div>
                    <h2 id="userDetailName" style="margin-bottom:16px; font-size:1.4em;"></h2>
                    <div class="building-inner-tabs" id="userDetailTabs">
                        <div class="building-inner-tab active" onclick="showUserTab('basic1')">åŸºæœ¬æƒ…å ±â‘ </div>
                        <div class="building-inner-tab" onclick="showUserTab('basic2')">åŸºæœ¬æƒ…å ±â‘¡</div>
                        <div class="building-inner-tab" onclick="showUserTab('medical')">æ—¢å¾€æ­´ãƒ»æœè–¬</div>
                        <div class="building-inner-tab" onclick="showUserTab('certificate')">å—çµ¦è€…è¨¼</div>
                        <div class="building-inner-tab" onclick="showUserTab('calc')">ç®—å®šæƒ…å ±</div>
                        <div class="building-inner-tab" onclick="showUserTab('contract')">å¥‘ç´„æƒ…å ±</div>
                        <div class="building-inner-tab" onclick="showUserTab('history')">å±¥æ­´æƒ…å ±</div>
                    </div>

                    <!-- åŸºæœ¬æƒ…å ±â‘  -->
                    <div id="userTab-basic1" class="building-detail-panel active">
                        <div class="info-card">
                            <div class="upload-area" id="uploadArea" style="margin-bottom:16px;">
                                <input type="file" id="certificateFile" accept="image/*,application/pdf" style="display:none;" onchange="handleFileUpload(event)">
                                <p style="font-size:1em; margin-bottom:6px;">ğŸ“· å—çµ¦è€…è¨¼ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆOCRï¼‰</p>
                                <p style="color:#666; font-size:0.85em;">ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
                            </div>
                            <div id="ocrProgress" class="progress" style="display:none;"></div>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>äº‹æ¥­æ‰€</label>
                                    <input type="text" id="userFacilityName" value="Tokyo. settle" readonly style="background:#f5f5f5;">
                                </div>
                                <div class="form-group">
                                    <label>å»ºç‰©ï¼ˆãƒ¦ãƒ‹ãƒƒãƒˆï¼‰</label>
                                    <select id="userUnit">
                                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>éƒ¨å±‹ç•ªå·</label>
                                    <input type="text" id="userRoom">
                                </div>
                                <div class="form-group">
                                    <label>ç§»å‹•æ—¥</label>
                                    <input type="date" id="userMoveDate">
                                </div>
                                <div class="form-group">
                                    <label>åˆ©ç”¨è€…å *</label>
                                    <input type="text" id="userName">
                                </div>
                                <div class="form-group">
                                    <label>åˆ©ç”¨è€…åã‚«ãƒŠ</label>
                                    <input type="text" id="userNameKana">
                                </div>
                                <div class="form-group">
                                    <label>æ€§åˆ¥</label>
                                    <select id="userGender">
                                        <option value="">é¸æŠ</option>
                                        <option value="ç”·æ€§">ç”·æ€§</option>
                                        <option value="å¥³æ€§">å¥³æ€§</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>ç”Ÿå¹´æœˆæ—¥</label>
                                    <input type="date" id="userBirthdate">
                                </div>
                                <div class="form-group">
                                    <label>éƒµä¾¿ç•ªå·</label>
                                    <input type="text" id="userZip">
                                </div>
                                <div class="form-group">
                                    <label>éƒ½é“åºœçœŒ</label>
                                    <input type="text" id="userPrefecture">
                                </div>
                                <div class="form-group">
                                    <label>å¸‚åŒºç”ºæ‘</label>
                                    <input type="text" id="userCity">
                                </div>
                                <div class="form-group">
                                    <label>ç”ºåãƒ»ç•ªåœ°</label>
                                    <input type="text" id="userAddress">
                                </div>
                                <div class="form-group">
                                    <label>å»ºç‰©å</label>
                                    <input type="text" id="userBuildingName">
                                </div>
                                <div class="form-group">
                                    <label>é›»è©±ç•ªå·</label>
                                    <input type="text" id="userTel">
                                </div>
                                <div class="form-group">
                                    <label>æºå¸¯é›»è©±ç•ªå·</label>
                                    <input type="text" id="userMobile">
                                </div>
                                <div class="form-group">
                                    <label>æ—¥ä¸­æ´»å‹•äº‹æ¥­æ‰€ç•ªå·</label>
                                    <input type="text" id="userDaytimeOrgNo">
                                </div>
                                <div class="form-group">
                                    <label>æ—¥ä¸­æ´»å‹•äº‹æ¥­æ‰€å</label>
                                    <input type="text" id="userDaytimeOrgName">
                                </div>
                                <div class="form-group">
                                    <label>ä½å®…æ‰¶åŠ©</label>
                                    <input type="text" id="userHousingAssist">
                                </div>
                                <div class="form-group">
                                    <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                                    <select id="userStatus">
                                        <option value="åˆ©ç”¨ä¸­">åˆ©ç”¨ä¸­</option>
                                        <option value="ä½“é¨“">ä½“é¨“</option>
                                        <option value="é€€å±…">é€€å±…</option>
                                    </select>
                                </div>
                            </div>
                            <div style="margin-top:12px; display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
                                <button type="button" class="btn btn-primary" onclick="saveCurrentUser('basic1')">ğŸ’¾ ä¿å­˜</button>
                                <a href="#" onclick="return false;" style="color:#667eea; font-size:0.9em;">å®Ÿç¸¾ãƒã‚¹ã‚¿</a>
                                <a href="#" onclick="return false;" style="color:#667eea; font-size:0.9em;">å€‹åˆ¥æ”¯æ´è¨ˆç”»</a>
                            </div>
                        </div>
                    </div>

                    <!-- åŸºæœ¬æƒ…å ±â‘¡ -->
                    <div id="userTab-basic2" class="building-detail-panel">
                        <div class="info-card">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                <strong>&lt;ç·Šæ€¥é€£çµ¡å…ˆ&gt;</strong>
                                <button type="button" class="btn btn-primary" onclick="addEmergencyContact()" style="background:#e91e8c; border-color:#e91e8c; font-size:0.85em; padding:4px 12px;">æ–°è¦ç™»éŒ²</button>
                            </div>
                            <div id="emergencyContactList"></div>
                            <hr style="margin:20px 0;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                <strong>&lt;ã‹ã‹ã‚Šã¤ã‘åŒ»ç™‚æ©Ÿé–¢&gt;</strong>
                                <button type="button" class="btn btn-primary" onclick="addMedicalFacility()" style="background:#e91e8c; border-color:#e91e8c; font-size:0.85em; padding:4px 12px;">æ–°è¦ç™»éŒ²</button>
                            </div>
                            <div id="medicalFacilityList"></div>
                            <hr style="margin:20px 0;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                <strong>&lt;æ€§æ ¼ãƒ»è¶£å‘³ãªã©&gt;</strong>
                                <button type="button" class="btn btn-primary" onclick="editPersonality()" style="background:#e91e8c; border-color:#e91e8c; font-size:0.85em; padding:4px 12px;">ç·¨é›†</button>
                            </div>
                            <div id="personalityInfo" style="background:#f9f9f9; border-radius:6px; padding:12px; font-size:0.9em; white-space:pre-wrap;"></div>
                            <hr style="margin:20px 0;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                <strong>&lt;å…¥å±…å‰ã®çŠ¶æ³ãƒ»æˆè‚²æ­´&gt;</strong>
                                <button type="button" class="btn btn-primary" onclick="addMoveInHistory()" style="background:#e91e8c; border-color:#e91e8c; font-size:0.85em; padding:4px 12px;">æ–°è¦ç™»éŒ²</button>
                            </div>
                            <div id="moveInHistoryList"></div>
                        </div>
                    </div>

                    <!-- æ—¢å¾€æ­´ãƒ»æœè–¬ -->
                    <div id="userTab-medical" class="building-detail-panel">
                        <div class="info-card">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                <strong>&lt;ç–¾ç—…&gt;</strong>
                                <button type="button" class="btn btn-primary" onclick="addDisease()" style="background:#e91e8c; border-color:#e91e8c; font-size:0.85em; padding:4px 12px;">æ–°è¦ç™»éŒ²</button>
                            </div>
                            <table style="width:100%; border-collapse:collapse; font-size:0.9em; margin-bottom:16px;">
                                <thead>
                                    <tr style="border-bottom:1px solid #ddd;">
                                        <th style="text-align:left; padding:8px; color:#667eea;">ç—…å</th>
                                        <th style="text-align:left; padding:8px; color:#667eea;">ç™ºç—‡å¹´æœˆæ—¥</th>
                                        <th style="text-align:left; padding:8px; color:#667eea;">åŒ»ç™‚æ©Ÿé–¢å</th>
                                        <th style="text-align:left; padding:8px; color:#667eea;">å‚™è€ƒ</th>
                                        <th style="width:80px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="diseaseList"></tbody>
                            </table>
                            <hr style="margin:20px 0;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                <strong>&lt;æœè–¬&gt;</strong>
                                <button type="button" class="btn btn-primary" onclick="addMedicine()" style="background:#e91e8c; border-color:#e91e8c; font-size:0.85em; padding:4px 12px;">æ–°è¦ç™»éŒ²</button>
                            </div>
                            <div id="medicineList"></div>
                            <hr style="margin:20px 0;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                <strong>&lt;ç•™æ„ç‚¹ï¼ç‰¹è¨˜äº‹é …&gt;</strong>
                                <button type="button" class="btn btn-primary" onclick="editMedicalNotes()" style="background:#e91e8c; border-color:#e91e8c; font-size:0.85em; padding:4px 12px;">ç·¨é›†</button>
                            </div>
                            <div id="medicalNotes" style="background:#f9f9f9; border-radius:6px; padding:12px; font-size:0.9em; white-space:pre-wrap;"></div>
                        </div>
                    </div>

                    <!-- å—çµ¦è€…è¨¼ -->
                    <div id="userTab-certificate" class="building-detail-panel">
                        <div class="info-card">
                            <p style="color:#555; font-size:0.9em; margin-bottom:16px; background:#fff9e6; padding:10px; border-radius:6px; border-left:4px solid #f0a;">
                                åŒºåˆ†å¤‰æ›´ãŒã‚ã£ãŸã€ã‚ã‚‹ã„ã¯æœ‰åŠ¹æœŸé™æ›´æ–°ãŒã‚ã£ãŸå ´åˆã«è¿½åŠ ã§æ–°è¦ç™»éŒ²ã—ã¦æƒ…å ±ã‚’è¿½åŠ ã—ã¦ä¸‹ã•ã„ã€‚
                            </p>
                            <div style="display:flex; justify-content:flex-end; margin-bottom:12px;">
                                <button type="button" class="btn btn-primary" onclick="showCertificateForm()" style="background:#e91e8c; border-color:#e91e8c;">æ–°è¦ç™»éŒ²</button>
                            </div>
                            <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
                                <thead>
                                    <tr style="border-bottom:2px solid #ddd;">
                                        <th style="text-align:left; padding:8px; font-weight:600;">èªå®šæœ‰åŠ¹æœŸé–“</th>
                                        <th style="text-align:left; padding:8px; font-weight:600;">äº¤ä»˜å¹´æœˆæ—¥</th>
                                        <th style="text-align:left; padding:8px; font-weight:600;">å—çµ¦è€…è¨¼ç•ªå·</th>
                                        <th style="text-align:left; padding:8px; font-weight:600;">éšœå®³æ”¯æ´åŒºåˆ†</th>
                                        <th style="width:160px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="certificateHistoryList"></tbody>
                            </table>
                            <!-- å—çµ¦è€…è¨¼ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
                            <div id="certificateForm" style="display:none; margin-top:24px; border-top:2px solid #ddd; padding-top:20px;">
                                <h4 style="margin-bottom:16px; color:#e91e8c;">å—çµ¦è€…è¨¼ç·¨é›†</h4>
                                <div style="display:flex; flex-direction:column; gap:14px; max-width:700px;">
                                    <div>
                                        <label style="color:#e91e8c; font-weight:600;">â˜…å—çµ¦è€…è¨¼ç•ªå·</label>
                                        <input type="text" id="certNo" style="width:100%; margin-top:6px; padding:10px; border:1px solid #ddd; border-radius:6px;">
                                    </div>
                                    <div class="grid-2">
                                        <div>
                                            <label style="color:#e91e8c; font-weight:600;">â˜…æ”¯çµ¦å¸‚ç”ºæ‘ç•ªå·</label>
                                            <input type="text" id="certCityCode" style="width:100%; margin-top:6px; padding:10px; border:1px solid #ddd; border-radius:6px;">
                                        </div>
                                        <div>
                                            <label style="color:#e91e8c; font-weight:600;">â˜…æ”¯çµ¦å¸‚ç”ºæ‘å</label>
                                            <input type="text" id="certCityName" style="width:100%; margin-top:6px; padding:10px; border:1px solid #ddd; border-radius:6px;">
                                        </div>
                                    </div>
                                    <div>
                                        <label>éšœå®³ç¨®åˆ¥</label>
                                        <select id="certDisabilityType" style="width:100%; margin-top:6px; padding:10px; border:1px solid #ddd; border-radius:6px;">
                                            <option value="">é¸æŠ</option>
                                            <option value="01:èº«ä½“éšœå®³è€…">01:èº«ä½“éšœå®³è€…</option>
                                            <option value="02:çŸ¥çš„éšœå®³è€…">02:çŸ¥çš„éšœå®³è€…</option>
                                            <option value="03:ç²¾ç¥éšœå®³è€…">03:ç²¾ç¥éšœå®³è€…</option>
                                            <option value="04:éšœå®³å…">04:éšœå®³å…</option>
                                            <option value="05:é›£ç—…ç­‰å¯¾è±¡è€…">05:é›£ç—…ç­‰å¯¾è±¡è€…</option>
                                        </select>
                                        <p style="font-size:0.8em; color:#888; margin-top:4px;">åˆä½µã—ã¦ã„ã‚‹å ´åˆã€ã‚ˆã‚Šé‡åº¦ã¨ã•ã‚Œã¦ã„ã‚‹éšœå®³ç¨®åˆ¥ã‚’é¸æŠã—ã¦ä¸‹ã•ã„ã€‚</p>
                                    </div>
                                    <div>
                                        <label style="color:#e91e8c; font-weight:600;">â˜…éšœå®³æ”¯æ´åŒºåˆ†</label>
                                        <select id="certSupportLevel" style="width:100%; margin-top:6px; padding:10px; border:1px solid #ddd; border-radius:6px;">
                                            <option value="">ãªã—</option>
                                            <option value="åŒºåˆ†1">åŒºåˆ†1</option>
                                            <option value="åŒºåˆ†2">åŒºåˆ†2</option>
                                            <option value="åŒºåˆ†3">åŒºåˆ†3</option>
                                            <option value="åŒºåˆ†4">åŒºåˆ†4</option>
                                            <option value="åŒºåˆ†5">åŒºåˆ†5</option>
                                            <option value="åŒºåˆ†6">åŒºåˆ†6</option>
                                            <option value="ãªã—">ãªã—</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="color:#e91e8c; font-weight:600;">â˜…äº¤ä»˜å¹´æœˆæ—¥</label>
                                        <input type="date" id="certIssueDate" style="width:100%; margin-top:6px; padding:10px; border:1px solid #ddd; border-radius:6px;">
                                    </div>
                                    <div>
                                        <label style="color:#e91e8c; font-weight:600;">â˜…èªå®šæœ‰åŠ¹æœŸé–“</label>
                                        <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
                                            <input type="date" id="certValidFrom" style="padding:10px; border:1px solid #ddd; border-radius:6px;">
                                            <span>ã€œ</span>
                                            <input type="date" id="certValidTo" style="padding:10px; border:1px solid #ddd; border-radius:6px;">
                                        </div>
                                    </div>
                                    <div>
                                        <label style="color:#e91e8c; font-weight:600;">â˜…è² æ‹…ä¸Šé™æœˆé¡</label>
                                        <input type="number" id="certBurdenLimit" value="0" style="width:100%; margin-top:6px; padding:10px; border:1px solid #ddd; border-radius:6px;">
                                    </div>
                                    <div>
                                        <label style="color:#e91e8c; font-weight:600;">â˜…ä¸Šé™æœˆé¡é©ç”¨æœŸé–“</label>
                                        <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
                                            <input type="date" id="certLimitFrom" style="padding:10px; border:1px solid #ddd; border-radius:6px;">
                                            <span>ã€œ</span>
                                            <input type="date" id="certLimitTo" style="padding:10px; border:1px solid #ddd; border-radius:6px;">
                                        </div>
                                    </div>
                                    <div>
                                        <label>
                                            <input type="checkbox" id="certUpperMgmt"> ä¸Šé™é¡ç®¡ç†å¯¾è±¡è€… <span style="font-size:0.8em; color:#888;">â€»è©²å½“ã®åˆ©ç”¨è€…ã®å ´åˆã¯ã€ãƒã‚§ãƒƒã‚¯ã‚’ä»˜ã‘ã‚‹ã€‚</span>
                                        </label>
                                        <div style="display:flex; gap:16px; margin-top:8px;" id="certUpperMgmtArea">
                                            <div style="flex:1;">
                                                <label style="font-size:0.9em;">ä¸Šé™é¡ç®¡ç†äº‹æ¥­æ‰€ç•ªå·</label>
                                                <input type="text" id="certUpperMgmtOrgNo" style="width:100%; margin-top:4px; padding:8px; border:1px solid #ddd; border-radius:6px;">
                                            </div>
                                            <div style="flex:1;">
                                                <label style="font-size:0.9em;">ä¸Šé™é¡ç®¡ç†äº‹æ¥­æ‰€å</label>
                                                <input type="text" id="certUpperMgmtOrgName" style="width:100%; margin-top:4px; padding:8px; border:1px solid #ddd; border-radius:6px;">
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label>
                                            <input type="checkbox" id="certSpecialDisabled"> ç‰¹å®šéšœå®³è€…ç‰¹åˆ¥çµ¦ä»˜è²»å¯¾è±¡è€… <span style="font-size:0.8em; color:#888;">â€»è©²å½“ã®åˆ©ç”¨è€…ã®å ´åˆã¯ã€ãƒã‚§ãƒƒã‚¯ã‚’ä»˜ã‘ã‚‹ã€‚</span>
                                        </label>
                                        <div id="certSpecialDisabledArea" style="margin-top:8px; display:none;">
                                            <label style="color:#e91e8c; font-weight:600;">â˜…ç‰¹å®šéšœå®³è€…ç‰¹åˆ¥çµ¦ä»˜è²»</label>
                                            <input type="number" id="certSpecialAmount" style="width:100%; margin-top:4px; padding:8px; border:1px solid #ddd; border-radius:6px;" value="0">
                                            <label style="color:#e91e8c; font-weight:600; margin-top:8px; display:block;">â˜…ç‰¹å®šéšœå®³è€…é©ç”¨æœŸé–“</label>
                                            <div style="display:flex; gap:8px; align-items:center; margin-top:4px;">
                                                <input type="date" id="certSpecialFrom" style="padding:8px; border:1px solid #ddd; border-radius:6px;">
                                                <span>ã€œ</span>
                                                <input type="date" id="certSpecialTo" style="padding:8px; border:1px solid #ddd; border-radius:6px;">
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label>
                                            <input type="checkbox" id="certMunicipalityAssist"> è‡ªæ²»ä½“åŠ©æˆ <span style="font-size:0.8em; color:#888;">â€»æœªè¨˜è¼‰OKã€‚ç‰¹åˆ¥ãªåŒ»ç™‚åŠ©æˆå¯¾è±¡è€…ã®å ´åˆã®ã¿è¨˜å…¥ã—ã¾ã™ã€‚</span>
                                        </label>
                                        <div id="certMunicipalityArea" style="margin-top:8px; display:none;">
                                            <div class="grid-2">
                                                <div>
                                                    <label style="font-size:0.9em;">åŠ©æˆè‡ªæ²»ä½“ç•ªå·</label>
                                                    <input type="text" id="certMuniOrgNo" style="width:100%; margin-top:4px; padding:8px; border:1px solid #ddd; border-radius:6px;">
                                                </div>
                                                <div>
                                                    <label style="font-size:0.9em;">è‡ªæ²»ä½“åŠ©æˆç‡</label>
                                                    <input type="text" id="certMuniRate" style="width:100%; margin-top:4px; padding:8px; border:1px solid #ddd; border-radius:6px;">
                                                </div>
                                                <div>
                                                    <label style="font-size:0.9em;">è‡ªæ²»ä½“åŠ©æˆé¡</label>
                                                    <input type="number" id="certMuniAmount" style="width:100%; margin-top:4px; padding:8px; border:1px solid #ddd; border-radius:6px;">
                                                </div>
                                                <div>
                                                    <label style="font-size:0.9em;">å¸‚ç”ºæ‘ä¸Šé™é¡</label>
                                                    <input type="number" id="certMuniMax" style="width:100%; margin-top:4px; padding:8px; border:1px solid #ddd; border-radius:6px;">
                                                </div>
                                                <div>
                                                    <label style="font-size:0.9em;">æ”¯çµ¦é‡</label>
                                                    <input type="text" id="certMuniGrant" style="width:100%; margin-top:4px; padding:8px; border:1px solid #ddd; border-radius:6px;">
                                                </div>
                                            </div>
                                            <div style="margin-top:8px;">
                                                <label style="font-size:0.9em;">æ”¯çµ¦æ±ºå®šæœŸé–“</label>
                                                <div style="display:flex; gap:8px; align-items:center; margin-top:4px;">
                                                    <input type="date" id="certGrantFrom" style="padding:8px; border:1px solid #ddd; border-radius:6px;">
                                                    <span>ã€œ</span>
                                                    <input type="date" id="certGrantTo" style="padding:8px; border:1px solid #ddd; border-radius:6px;">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display:flex; gap:12px;">
                                        <button type="button" class="btn btn-primary" onclick="saveCertificate()" style="background:#e91e8c; border-color:#e91e8c;">ä¿å­˜ã™ã‚‹</button>
                                        <button type="button" class="btn btn-secondary" onclick="cancelCertificateForm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ç®—å®šæƒ…å ± -->
                    <div id="userTab-calc" class="building-detail-panel">
                        <div class="info-card">
                            <p style="font-size:0.9em; color:#555; margin-bottom:16px;">33:å…±åŒç”Ÿæ´»æ´åŠ©ï¼ˆä»‹è­·ã‚µãƒ¼ãƒ“ã‚¹åŒ…æ‹¬å‹ï¼‰ã®è¨­å®š</p>
                            <div class="form-group">
                                <label>é‡åº¦éšœå®³è€…æ”¯æ´åŠ ç®—</label>
                                <select id="calcSevereDisability" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; margin-top:4px;">
                                    <option value="">è¨­å®šãªã—</option>
                                    <option value="é‡åº¦éšœå®³è€…æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰">é‡åº¦éšœå®³è€…æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰</option>
                                    <option value="é‡åº¦éšœå®³è€…æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰">é‡åº¦éšœå®³è€…æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰</option>
                                    <option value="é‡åº¦éšœå®³è€…æ”¯æ´åŠ ç®—ï¼ˆè¡Œå‹•é–¢é€£é …ç›®ï¼‘ï¼˜ç‚¹ä»¥ä¸Šï¼‰">é‡åº¦éšœå®³è€…æ”¯æ´åŠ ç®—ï¼ˆè¡Œå‹•é–¢é€£é …ç›®ï¼‘ï¼˜ç‚¹ä»¥ä¸Šï¼‰</option>
                                </select>
                            </div>
                            <div style="margin:12px 0; display:flex; flex-direction:column; gap:8px;">
                                <label><input type="checkbox" id="calcRegionalTransition"> åœ°åŸŸç”Ÿæ´»ç§»è¡Œå€‹åˆ¥æ”¯æ´ç‰¹åˆ¥åŠ ç®—</label>
                                <label><input type="checkbox" id="calcMentalTransition"> ç²¾ç¥éšœå®³è€…åœ°åŸŸç§»è¡Œç‰¹åˆ¥åŠ ç®—</label>
                                <label><input type="checkbox" id="calcBehaviorTransition"> å¼·åº¦è¡Œå‹•éšœå®³è€…åœ°åŸŸç§»è¡Œç‰¹åˆ¥åŠ ç®—</label>
                                <label><input type="checkbox" id="calcBehaviorExperience"> å¼·åº¦è¡Œå‹•éšœå®³è€…ä½“é¨“åˆ©ç”¨åŠ ç®—</label>
                                <p style="font-size:0.8em; color:#888; margin-left:20px;">é‡åº¦éšœå®³è€…æ”¯æ´åŠ ç®—ãŒç®—å®šã•ã‚Œã‚‹å ´åˆã¯ç®—å®šã•ã‚Œã¾ã›ã‚“ã€‚</p>
                                <label><input type="checkbox" id="calcMedicalCare"> åŒ»ç™‚çš„ã‚±ã‚¢å¯¾å¿œæ”¯æ´åŠ ç®—</label>
                                <p style="font-size:0.8em; color:#888; margin-left:20px;">é‡åº¦éšœå®³è€…æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰åˆã¯åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ãŒç®—å®šã•ã‚Œã‚‹å ´åˆã¯ç®—å®šã•ã‚Œã¾ã›ã‚“ã€‚</p>
                                <label><input type="checkbox" id="calcIndividualCare"> å€‹äººå˜ä½ã§å±…å®…ä»‹è­·ç­‰ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆ</label>
                            </div>
                            <div class="form-group" style="margin-top:12px;">
                                <label>å…±åŒç”Ÿæ´»æ´åŠ©è¨ˆç”»ãŒä½œæˆã•ã‚Œã¦ã„ãªã„</label>
                                <select id="calcNoPlanReduction" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; margin-top:4px;">
                                    <option value="">è¨­å®šãªã—</option>
                                    <option value="å…±åŒç”Ÿæ´»æ´åŠ©è¨ˆç”»æœªä½œæˆï¼ˆ2æœˆç›®ã¾ã§ï¼‰">æ¸›ç®—ãŒé©ç”¨ã•ã‚Œã‚‹æœˆã‹ã‚‰ï¼’æœˆç›®ã¾ã§</option>
                                    <option value="å…±åŒç”Ÿæ´»æ´åŠ©è¨ˆç”»æœªä½œæˆï¼ˆ3æœˆä»¥ä¸Šï¼‰">ï¼“æœˆä»¥ä¸Šé€£ç¶šã—ã¦æ¸›ç®—ã®å ´åˆ</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-top:12px;">
                                <label>å¤§è¦æ¨¡ä½å±…ç­‰æ¸›ç®—</label>
                                <select id="calcLargeScaleReduction" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; margin-top:4px;">
                                    <option value="">è¨­å®šãªã—</option>
                                    <option value="å¤§è¦æ¨¡ä½å±…ç­‰æ¸›ç®—ï¼ˆå…¥å±…å®šå“¡8äººä»¥ä¸Šï¼‰">å…¥å±…å®šå“¡ãŒï¼˜äººä»¥ä¸Š</option>
                                    <option value="å¤§è¦æ¨¡ä½å±…ç­‰æ¸›ç®—ï¼ˆå…¥å±…å®šå“¡21äººä»¥ä¸Šï¼‰">å…¥å±…å®šå“¡ãŒ21äººä»¥ä¸Š</option>
                                    <option value="å¤§è¦æ¨¡ä½å±…ç­‰æ¸›ç®—ï¼ˆä¸€ä½“çš„ãªå…±åŒç”Ÿæ´»ä½å±…21äººä»¥ä¸Šï¼‰">ä¸€ä½“çš„ãªå…±åŒç”Ÿæ´»ä½å±…ã®å…¥å±…å®šå“¡æ•°21ä»¥ä¸Š</option>
                                </select>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="saveCurrentUser('calc')" style="margin-top:16px; background:#e91e8c; border-color:#e91e8c;">ä¿å­˜ã™ã‚‹</button>
                        </div>
                    </div>

                    <!-- å¥‘ç´„æƒ…å ± -->
                    <div id="userTab-contract" class="building-detail-panel">
                        <div class="info-card">
                            <p style="font-size:0.85em; color:#555; margin-bottom:16px; background:#fff9e6; padding:10px; border-radius:6px;">
                                ï¼ˆå ´åˆã«ã‚ˆã£ã¦ã¯ï¼‰ä½“é¨“å…¥å±…å¥‘ç´„æ™‚ã‚ã‚‹ã„ã¯æœ¬å…¥å±…å¥‘ç´„æ™‚ã«ã¯ã€Œæ–°è¦ã€ã®å¥‘ç´„å†…å®¹å ±å‘Šæ›¸ã‚’è¡Œæ”¿ã«æå‡ºã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã€ã€Œçµ‚äº†ã€ã®å¥‘ç´„å†…å®¹å ±å‘Šæ›¸ã¯é€€å±…ã‚ã‚‹ã„ã¯äº¡ããªã‚‰ã‚ŒãŸå ´åˆã«æå‡ºã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
                            </p>
                            <div style="margin-bottom:12px;">
                                <strong id="contractFacilityLabel">Tokyo. settle</strong>
                                <button type="button" class="btn btn-primary" onclick="addContract()" style="float:right; background:#e91e8c; border-color:#e91e8c; font-size:0.85em;">æ–°è¦ç™»éŒ²</button>
                            </div>
                            <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
                                <thead>
                                    <tr style="border-bottom:1px solid #ddd;">
                                        <th style="text-align:left; padding:8px;">ã‚µãƒ¼ãƒ“ã‚¹é–‹å§‹æ—¥</th>
                                        <th style="text-align:left; padding:8px;">ä½“é¨“é–‹å§‹æ—¥</th>
                                        <th style="text-align:left; padding:8px;">å¥‘ç´„é–‹å§‹æ—¥</th>
                                        <th style="text-align:left; padding:8px;">æ›´æ–°æ—¥æ™‚</th>
                                        <th style="width:200px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="contractList"></tbody>
                            </table>
                            <div id="contractDetail" style="margin-top:20px; border-top:1px solid #eee; padding-top:16px; display:none; font-size:0.9em;"></div>
                        </div>
                    </div>

                    <!-- å±¥æ­´æƒ…å ± -->
                    <div id="userTab-history" class="building-detail-panel">
                        <div class="info-card">
                            <div id="userHistoryContent"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å®Ÿç¸¾è¨˜éŒ²ã‚¿ãƒ– -->
            <div id="records" class="tab-content">
                <div class="form-group">
                    <label style="font-weight: 600; margin-bottom: 10px; display: block;">åˆ©ç”¨è€…ã‚’é¸æŠ</label>
                    <select id="recordUser" onchange="loadRecords()" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                        <option value="">åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                </div>

                <div class="calendar-header">
                    <button class="btn btn-secondary" onclick="changeMonth(-1)">â† å‰æœˆ</button>
                    <h2 id="currentMonth"></h2>
                    <button class="btn btn-secondary" onclick="changeMonth(1)">æ¬¡æœˆ â†’</button>
                </div>

                <div class="calendar-actions">
                    <button class="btn btn-success" onclick="fillMonth('â—‹ï¼ˆæœ¬å…¥å±…ï¼‰')">âœ… å…¨ã¦æœ¬å…¥å±…ï¼ˆâ—‹ï¼‰ã§åŸ‹ã‚ã‚‹</button>
                    <button class="btn btn-warning" onclick="fillMonth('å¤–æ³Š')">ğŸ–ï¸ å…¨ã¦å¤–æ³Šã§åŸ‹ã‚ã‚‹</button>
                    <button class="btn btn-info" onclick="fillMonth('å…¥é™¢')">ğŸ¥ å…¨ã¦å…¥é™¢ã§åŸ‹ã‚ã‚‹</button>
                    <button class="btn btn-secondary" onclick="clearMonth()">ğŸ—‘ï¸ ä»Šæœˆã‚’ã‚¯ãƒªã‚¢</button>
                </div>

                <div id="calendar" class="calendar"></div>

                <div style="margin-top:20px; padding:16px; background:#fff; border-top:2px solid #eee; text-align:center;">
                    <p style="font-size:0.85em; color:#888; margin-bottom:10px;">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®å„æ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¨˜éŒ²ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                    <button class="btn btn-primary" onclick="confirmSaveAllRecords()" style="background:#e91e8c; border-color:#e91e8c; padding:12px 40px; font-size:1em;">ğŸ’¾ ä¿å­˜ã™ã‚‹</button>
                </div>
            </div>

            <!-- è«‹æ±‚ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›ã‚¿ãƒ– -->
            <div id="export" class="tab-content">
                <h2 class="section-header">è«‹æ±‚ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›</h2>

                <!-- å¯¾è±¡å¹´æœˆãƒ»åˆ©ç”¨è€…é¸æŠ -->
                <div style="display:flex; gap:16px; align-items:flex-end; flex-wrap:wrap; margin-bottom:20px;">
                    <div>
                        <label style="font-size:0.85em; color:#555; display:block; margin-bottom:4px;">å¯¾è±¡å¹´æœˆ</label>
                        <input type="month" id="exportMonth" style="padding:8px 12px; border:1px solid #ddd; border-radius:6px;">
                    </div>
                    <div>
                        <label style="font-size:0.85em; color:#555; display:block; margin-bottom:4px;">å°åˆ·æ—¥</label>
                        <input type="date" id="exportPrintDate" style="padding:8px 12px; border:1px solid #ddd; border-radius:6px;">
                    </div>
                    <div>
                        <label style="font-size:0.85em; color:#555; display:block; margin-bottom:4px;">å—é ˜æ—¥ï¼ˆä»£ç†å—é ˜é€šçŸ¥ç¥¨ç”¨ï¼‰</label>
                        <input type="date" id="exportReceiveDate" style="padding:8px 12px; border:1px solid #ddd; border-radius:6px;">
                    </div>
                </div>

                <!-- åˆ©ç”¨è€…é¸æŠ -->
                <div style="background:#f9f9f9; border:1px solid #ddd; border-radius:8px; padding:16px; margin-bottom:20px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <strong style="font-size:0.9em;">å‡ºåŠ›å¯¾è±¡åˆ©ç”¨è€…</strong>
                        <div style="display:flex; gap:8px;">
                            <button class="btn btn-secondary" onclick="selectAllExportUsers(true)" style="padding:4px 10px; font-size:0.8em;">å…¨é¸æŠ</button>
                            <button class="btn btn-secondary" onclick="selectAllExportUsers(false)" style="padding:4px 10px; font-size:0.8em;">å…¨è§£é™¤</button>
                        </div>
                    </div>
                    <div id="exportUserList" style="display:flex; flex-wrap:wrap; gap:8px; max-height:150px; overflow-y:auto;"></div>
                </div>

                <!-- å›½ä¿é€£é€ä¿¡ç”¨CSVãƒ•ã‚¡ã‚¤ãƒ« -->
                <div style="border:1px solid #ddd; border-radius:8px; overflow:hidden; margin-bottom:20px;">
                    <div style="background:#f0f4ff; padding:12px 16px; border-bottom:1px solid #ddd;">
                        <strong>å›½ä¿é€£é€ä¿¡ç”¨CSVãƒ•ã‚¡ã‚¤ãƒ«</strong>
                        <p style="font-size:0.8em; color:#666; margin:4px 0 0;">å›½ä¿é€£è«‹æ±‚æ™‚ã«ã€å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦å–è¾¼é€ä¿¡V2ï¼ˆé›»å­è«‹æ±‚å—ä»˜ã‚·ã‚¹ãƒ†ãƒ ï¼‰ã«æ·»ä»˜ã—ã¦é€ä¿¡ã—ã¾ã™ã€‚</p>
                    </div>
                    <div style="padding:16px; display:flex; flex-direction:column; gap:14px;">
                        <div>
                            <p style="font-size:0.85em; margin-bottom:6px;">ä»‹è­·çµ¦ä»˜è²»ãƒ»è¨“ç·´ç­‰çµ¦ä»˜è²»ç­‰è«‹æ±‚æ›¸ãƒ»æ˜ç´°æ›¸ã€€ã€SEã€‘</p>
                            <button class="btn btn-primary" onclick="exportCSV('SE')" style="background:#e91e8c; border-color:#e91e8c;">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                        </div>
                        <div>
                            <p style="font-size:0.85em; margin-bottom:6px;">åˆ©ç”¨è€…è² æ‹…ä¸Šé™é¡ç®¡ç†çµæœç¥¨ã€€ã€RKã€‘ã€€<span style="color:#888; font-size:0.85em;">ï¼ˆâ€»è‡ªäº‹æ¥­æ‰€ãŒã€ŒåŸç±ç®¡ç†äº‹æ¥­è€…ã®å ´åˆã®ã¿ä½¿ç”¨ï¼‰</span></p>
                            <button class="btn btn-primary" onclick="exportCSV('RK')" style="background:#e91e8c; border-color:#e91e8c;">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                        </div>
                        <div>
                            <p style="font-size:0.85em; margin-bottom:6px;">ã‚µãƒ¼ãƒ“ã‚¹æä¾›å®Ÿç¸¾è¨˜éŒ²ç¥¨ã€€ã€SVã€‘</p>
                            <button class="btn btn-primary" onclick="exportCSV('SV')" style="background:#e91e8c; border-color:#e91e8c;">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                        </div>
                        <p style="font-size:0.78em; color:#888;">åŸºæœ¬çš„ã«ã¯ã€SEã€‘ã¨ã€SVã€‘ãƒ•ã‚¡ã‚¤ãƒ«ã®2ç¨®é¡ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦é€ä¿¡ã—ã¾ã™ã€‚ã¾ãŸã€é€ä¿¡ã‚¨ãƒ©ãƒ¼ã®åŸå› ã«ãªã‚‹ãŸã‚ã€CSVãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¾Œã€é–‹å°ã›ãšã«ãã®æœªæ·»ä»˜ã—ã¦ãã ã•ã„ï¼ˆCSVãƒ•ã‚¡ã‚¤ãƒ«ã¯é€ä¿¡ç”¨ãªã®ã§é–²è¦§ä¸è¦ã§ã™ï¼‰ã€‚</p>
                    </div>
                </div>

                <!-- å¸³ç¥¨å°åˆ·ç”¨PDFãƒ•ã‚¡ã‚¤ãƒ« -->
                <div style="border:1px solid #ddd; border-radius:8px; overflow:hidden; margin-bottom:20px;">
                    <div style="background:#f0f4ff; padding:12px 16px; border-bottom:1px solid #ddd;">
                        <strong>å¸³ç¥¨å°åˆ·ç”¨PDFãƒ•ã‚¡ã‚¤ãƒ«</strong>
                        <p style="font-size:0.8em; color:#666; margin:4px 0 0;">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸPDFãƒ•ã‚¡ã‚¤ãƒ«ã¯å¿…ãšä¿å­˜ã—ã€ä¿ç®¡ã—ã¦ãã ã•ã„ã€‚</p>
                    </div>
                    <div style="padding:16px; display:flex; flex-direction:column; gap:14px;">
                        <div>
                            <p style="font-size:0.85em; margin-bottom:6px;">ä»‹è­·çµ¦ä»˜è²»ãƒ»è¨“ç·´ç­‰çµ¦ä»˜è²»ç­‰è«‹æ±‚æ›¸ãƒ»æ˜ç´°æ›¸ã€€ã€SEã€‘ã€€<span style="color:#888; font-size:0.85em;">...è«‹æ±‚æ›¸ãƒ»æ˜ç´°æ›¸ã®ç¢ºèªç”¨</span></p>
                            <button class="btn btn-primary" onclick="exportPDF('SE')" style="background:#e91e8c; border-color:#e91e8c;">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                        </div>
                        <div>
                            <p style="font-size:0.85em; margin-bottom:6px;">åˆ©ç”¨è€…è² æ‹…ä¸Šé™é¡ç®¡ç†çµæœç¥¨ã€€ã€RKã€‘ã€€<span style="color:#888; font-size:0.85em;">ï¼ˆâ€»è‡ªäº‹æ¥­æ‰€ãŒã€ŒåŸç±ï¼ˆç®¡ç†ï¼‰ã€äº‹æ¥­è€…ã®å ´åˆã®ã¿ä½¿ç”¨ï¼‰</span></p>
                            <button class="btn btn-primary" onclick="exportPDF('RK')" style="background:#e91e8c; border-color:#e91e8c;">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                        </div>
                        <div>
                            <p style="font-size:0.85em; margin-bottom:6px;">åˆ©ç”¨è€…è² æ‹…é¡ä¸€è¦§è¡¨ã€€<span style="color:#888; font-size:0.85em;">ï¼ˆâ€»è‡ªäº‹æ¥­æ‰€ãŒã€ŒåŸç±ï¼ˆé–¢ä¿‚ï¼‰ã€äº‹æ¥­è€…ã®å ´åˆã®ã¿ä½¿ç”¨ï¼‰</span></p>
                            <button class="btn btn-primary" onclick="exportPDF('è² æ‹…é¡ä¸€è¦§')" style="background:#e91e8c; border-color:#e91e8c;">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                        </div>
                        <div>
                            <p style="font-size:0.85em; margin-bottom:6px;">ã‚µãƒ¼ãƒ“ã‚¹æä¾›å®Ÿç¸¾è¨˜éŒ²ç¥¨ã€€ã€SVã€‘ã€€<span style="color:#888; font-size:0.85em;">...æ—¥ãƒ™ãƒ¼ã‚¹ã§ä¿ç®¡ãŒå¿…è¦ï¼ˆåˆ©ç”¨è€…ç½²åæ¬„ã‚ã‚Šï¼‰</span></p>
                            <button class="btn btn-primary" onclick="exportPDF('SV')" style="background:#e91e8c; border-color:#e91e8c;">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                        </div>
                        <hr style="border:none; border-top:1px solid #eee;">
                        <div>
                            <p style="font-size:0.85em; margin-bottom:6px; font-weight:600;">åˆ©ç”¨è€…è«‹æ±‚æ›¸</p>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <button class="btn btn-primary" onclick="exportPDF('è«‹æ±‚æ›¸PDF')" style="background:#e91e8c; border-color:#e91e8c; padding:6px 14px;">PDF</button>
                                <button class="btn btn-success" onclick="exportExcel('è«‹æ±‚æ›¸')" style="background:#217346; border-color:#217346; padding:6px 14px;">EXCEL</button>
                                <span style="font-size:0.85em; color:#555;">å°åˆ·æ—¥</span>
                                <input type="date" id="exportPrintDate2" style="padding:5px 8px; border:1px solid #ddd; border-radius:5px; font-size:0.85em;">
                            </div>
                        </div>
                        <div>
                            <p style="font-size:0.85em; margin-bottom:6px; font-weight:600;">åˆ©ç”¨è€…é ˜åæ›¸</p>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <button class="btn btn-primary" onclick="exportPDF('é ˜åæ›¸PDF')" style="background:#e91e8c; border-color:#e91e8c; padding:6px 14px;">PDF</button>
                                <button class="btn btn-success" onclick="exportExcel('é ˜åæ›¸')" style="background:#217346; border-color:#217346; padding:6px 14px;">EXCEL</button>
                                <span style="font-size:0.85em; color:#555;">å°åˆ·æ—¥</span>
                                <input type="date" id="exportPrintDate3" style="padding:5px 8px; border:1px solid #ddd; border-radius:5px; font-size:0.85em;">
                            </div>
                        </div>
                        <div>
                            <p style="font-size:0.85em; margin-bottom:6px; font-weight:600;">ä»£ç†å—é ˜é€šçŸ¥ç¥¨</p>
                            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                                <button class="btn btn-primary" onclick="exportPDF('ä»£ç†å—é ˜PDF')" style="background:#e91e8c; border-color:#e91e8c; padding:6px 14px;">PDF</button>
                                <button class="btn btn-success" onclick="exportExcel('ä»£ç†å—é ˜')" style="background:#217346; border-color:#217346; padding:6px 14px;">EXCEL</button>
                                <span style="font-size:0.85em; color:#555;">å°åˆ·æ—¥</span>
                                <input type="date" id="exportPrintDate4" style="padding:5px 8px; border:1px solid #ddd; border-radius:5px; font-size:0.85em;">
                                <span style="font-size:0.85em; color:#555;">å—é ˜æ—¥</span>
                                <input type="date" id="exportReceiveDate2" style="padding:5px 8px; border:1px solid #ddd; border-radius:5px; font-size:0.85em;">
                                <span style="font-size:0.78em; color:#888;">ï¼ˆâ€»å—é ˜æ—¥ï¼šå›½ä¿é€£è«‹æ±‚ã§å…¥é‡‘ã•ã‚ŒãŸæ—¥ï¼‰</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="exportStatus" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šå®Ÿç¸¾è¨˜éŒ²è©³ç´° -->
    <div id="dateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                å®Ÿç¸¾è¨˜éŒ²è©³ç´°
                <button class="modal-close" onclick="closeModal()">âœ•</button>
            </div>

            <!-- ç™»éŒ²æ—¥ -->
            <div class="modal-section">
                <div class="modal-label">ç™»éŒ²æ—¥</div>
                <div class="modal-row">
                    <input type="date" id="modalDateFrom" style="flex:1;">
                    <span>ã€œ</span>
                    <input type="date" id="modalDateTo" style="flex:1;">
                </div>
            </div>

            <!-- ç™»éŒ²æ›œæ—¥ -->
            <div class="modal-section">
                <div class="modal-label">ç™»éŒ²æ›œæ—¥</div>
                <div class="modal-row" style="flex-wrap:wrap; gap:10px;">
                    <label class="modal-checkbox-row"><input type="checkbox" class="modalDow" value="1"> æœˆ</label>
                    <label class="modal-checkbox-row"><input type="checkbox" class="modalDow" value="2"> ç«</label>
                    <label class="modal-checkbox-row"><input type="checkbox" class="modalDow" value="3"> æ°´</label>
                    <label class="modal-checkbox-row"><input type="checkbox" class="modalDow" value="4"> æœ¨</label>
                    <label class="modal-checkbox-row"><input type="checkbox" class="modalDow" value="5"> é‡‘</label>
                    <label class="modal-checkbox-row"><input type="checkbox" class="modalDow" value="6"> åœŸ</label>
                    <label class="modal-checkbox-row"><input type="checkbox" class="modalDow" value="0"> æ—¥</label>
                </div>
            </div>

            <div class="modal-update-bar">
                <label class="modal-checkbox-row">
                    <input type="checkbox" id="modalOverwrite" checked>
                    æ›´æ–°ã€€ç™»éŒ²æœŸé–“ã§æ—¢ã«ç™»éŒ²æ¸ˆã¿ã®å ´åˆã€ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™ã¨ä¸Šæ›¸ãã—ã¾ã›ã‚“
                </label>
            </div>

            <!-- ã‚µãƒ¼ãƒ“ã‚¹æä¾›ã®çŠ¶æ³ -->
            <div class="modal-section">
                <label class="modal-label"><input type="checkbox" id="modalEnableStatus" checked> ã‚µãƒ¼ãƒ“ã‚¹æä¾›ã®çŠ¶æ³</label>
                <select id="modalStatus">
                    <option value="">ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>
                    <option value="â—‹ï¼ˆæœ¬å…¥å±…ï¼‰">â—‹(æœ¬å…¥å±…)</option>
                    <option value="å…¥é™¢å§‹">å…¥é™¢å§‹</option>
                    <option value="å…¥é™¢">å…¥é™¢</option>
                    <option value="å…¥é™¢çµ‚">å…¥é™¢çµ‚</option>
                    <option value="å¤–æ³Šå§‹">å¤–æ³Šå§‹</option>
                    <option value="å¤–æ³Š">å¤–æ³Š</option>
                    <option value="å¤–æ³Šçµ‚">å¤–æ³Šçµ‚</option>
                    <option value="å…¥é™¢â†’å¤–æ³Š">å…¥é™¢â†’å¤–æ³Š</option>
                    <option value="å¤–æ³Šâ†’å…¥é™¢">å¤–æ³Šâ†’å…¥é™¢</option>
                    <option value="å…¥é™¢â†’å…±åŒç”Ÿæ´»ä½å±…ã«æˆ»ã‚‹â†’å¤–æ³Š">å…¥é™¢â†’å…±åŒç”Ÿæ´»ä½å±…ã«æˆ»ã‚‹â†’å¤–æ³Š</option>
                    <option value="å¤–æ³Šâ†’å…±åŒç”Ÿæ´»ä½å±…ã«æˆ»ã‚‹â†’å…¥é™¢">å¤–æ³Šâ†’å…±åŒç”Ÿæ´»ä½å±…ã«æˆ»ã‚‹â†’å…¥é™¢</option>
                    <option value="ä½“é¨“">ä½“é¨“</option>
                </select>
            </div>

            <!-- å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®— -->
            <div class="modal-section">
                <label class="modal-label"><input type="checkbox" id="modalEnableNight" checked> å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—</label>
                <div class="modal-hint" id="modalNightHint"></div>
                <select id="modalNightSupport">
                    <option value="">ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>
                </select>
            </div>

            <!-- ãã®ä»–ã®é …ç›®ã‚’è¡¨ç¤º -->
            <div style="margin: 12px 0;">
                <a href="#" class="modal-collapse-btn" onclick="toggleModalExtra(); return false;">ãã®ä»–ã®é …ç›®ã‚’è¡¨ç¤º</a>
            </div>

            <div id="modalExtraItems" style="display:none;">
                <!-- å…¥é™¢æ™‚/å¸°å®…æ™‚æ”¯æ´ç‰¹åˆ¥åŠ ç®— -->
                <div class="modal-section">
                    <label class="modal-checkbox-row"><input type="checkbox" id="modalInpatientSupport"> å…¥é™¢æ™‚æ”¯æ´ç‰¹åˆ¥åŠ ç®—</label>
                    <label class="modal-checkbox-row"><input type="checkbox" id="modalReturnSupport"> å¸°å®…æ™‚æ”¯æ´åŠ ç®—</label>
                </div>

                <!-- æ—¥ä¸­æ”¯æ´åŠ ç®— -->
                <div class="modal-section">
                    <label class="modal-label"><input type="checkbox" id="modalEnableDaytime" checked> æ—¥ä¸­æ”¯æ´åŠ ç®—</label>
                    <div class="modal-hint" id="modalDaytimeHint"></div>
                    <select id="modalDaytimeSupport">
                        <option value="">ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>
                        <option value="æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰1äºº">æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰ã€€1äºº</option>
                        <option value="æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰2äººä»¥ä¸Š">æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰ã€€2äººä»¥ä¸Š</option>
                        <option value="æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰1äºº åŒºåˆ†4ãƒ»5ãƒ»6">æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰ã€€1äººã€€åŒºåˆ†ï¼”ã€ï¼•ã€ï¼–</option>
                        <option value="æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰1äºº åŒºåˆ†3ä»¥ä¸‹">æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰ã€€1äººã€€åŒºåˆ†ï¼“ä»¥ä¸‹</option>
                        <option value="æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰2äººä»¥ä¸Š åŒºåˆ†4ãƒ»5ãƒ»6">æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰ã€€2äººä»¥ä¸Šã€€åŒºåˆ†ï¼”ã€ï¼•ã€ï¼–</option>
                        <option value="æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰2äººä»¥ä¸Š åŒºåˆ†3ä»¥ä¸‹">æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰ã€€2äººä»¥ä¸Šã€€åŒºåˆ†ï¼“ä»¥ä¸‹</option>
                    </select>
                </div>

                <!-- åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®— -->
                <div class="modal-section">
                    <label class="modal-label"><input type="checkbox" id="modalEnableMedical" checked> åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—</label>
                    <select id="modalMedicalCoop">
                        <option value="">ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>
                        <option value="åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰">åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰</option>
                        <option value="åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰">åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰</option>
                        <option value="åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…¢ï¼‰">åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…¢ï¼‰</option>
                        <option value="åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…£ï¼‰">åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…£ï¼‰</option>
                        <option value="åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…¤ï¼‰">åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…¤ï¼‰</option>
                        <option value="åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…¥ï¼‰">åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…¥ï¼‰</option>
                        <option value="åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…¦ï¼‰">åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…¦ï¼‰</option>
                    </select>
                </div>

                <!-- è‡ªç«‹ç”Ÿæ´»æ”¯æ´åŠ ç®— -->
                <div class="modal-section">
                    <label class="modal-label"><input type="checkbox" id="modalEnableSelfSupport" checked> è‡ªç«‹ç”Ÿæ´»æ”¯æ´åŠ ç®—</label>
                    <select id="modalSelfSupport">
                        <option value="">ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>
                        <option value="è‡ªç«‹ç”Ÿæ´»æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰">è‡ªç«‹ç”Ÿæ´»æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰</option>
                    </select>
                </div>

                <!-- å‚™è€ƒ -->
                <div class="modal-section">
                    <label class="modal-label"><input type="checkbox" id="modalEnableNote" checked> å‚™è€ƒ</label>
                    <input type="text" id="modalNote" placeholder="å‚™è€ƒ">
                </div>

                <hr class="modal-divider">

                <!-- é•·æœŸå…¥é™¢æ™‚/å¸°å®…æ™‚æ”¯æ´ç‰¹åˆ¥åŠ ç®— -->
                <div class="modal-section">
                    <label class="modal-checkbox-row"><input type="checkbox" id="modalLongInpatient"> é•·æœŸå…¥é™¢æ™‚æ”¯æ´ç‰¹åˆ¥åŠ ç®—</label>
                    <label class="modal-checkbox-row"><input type="checkbox" id="modalLongReturn"> é•·æœŸå¸°å®…æ™‚æ”¯æ´åŠ ç®—</label>
                    <label class="modal-checkbox-row"><input type="checkbox" id="modalHomeCare"> å±…å®…ä»‹è­·ç­‰ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆï¼ˆé•·æ™‚é–“ï¼‰</label>
                </div>

                <!-- é›†ä¸­çš„æ”¯æ´åŠ ç®— -->
                <div class="modal-section">
                    <label class="modal-label"><input type="checkbox" id="modalEnableIntensive" checked> é›†ä¸­çš„æ”¯æ´åŠ ç®—</label>
                    <select id="modalIntensive">
                        <option value="">ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>
                        <option value="é›†ä¸­çš„æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰">é›†ä¸­çš„æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰</option>
                        <option value="é›†ä¸­çš„æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰">é›†ä¸­çš„æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰</option>
                        <option value="é›†ä¸­çš„æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰ï¼ˆâ…¡ï¼‰">é›†ä¸­çš„æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰ï¼ˆâ…¡ï¼‰</option>
                    </select>
                </div>

                <hr class="modal-divider">

                <!-- ãã®ä»–ã®åŠ ç®—ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ç¾¤ -->
                <div class="modal-section">
                    <label class="modal-checkbox-row"><input type="checkbox" id="modalAfterLeave"> é€€å±…å¾Œã‚µãƒ¼ãƒ“ã‚¹æä¾›</label>
                    <label class="modal-checkbox-row"><input type="checkbox" id="modalPeerSupport"> ãƒ”ã‚¢ã‚µãƒãƒ¼ãƒˆå®Ÿæ–½åŠ ç®—</label>
                    <label class="modal-checkbox-row"><input type="checkbox" id="modalAfterPeer"> é€€å»å¾Œãƒ”ã‚¢ã‚µãƒãƒ¼ãƒˆå®Ÿæ–½åŠ ç®—</label>
                    <label class="modal-checkbox-row"><input type="checkbox" id="modalInfection"> æ–°èˆˆæ„ŸæŸ“ç—‡ç­‰æ–½è¨­ç™‚é¤ŠåŠ ç®—</label>
                    <label class="modal-checkbox-row"><input type="checkbox" id="modalStaffArrangement"> äººå“¡é…ç½®ä½“åˆ¶åŠ ç®—</label>
                </div>
            </div>

            <!-- ãƒœã‚¿ãƒ³ -->
            <div style="margin-top:20px; display:flex; gap:10px; position:sticky; bottom:0; background:white; padding-top:12px; border-top:1px solid #eee;">
                <button class="btn btn-primary" onclick="saveRecord()" style="background:#e91e8c; border-color:#e91e8c; flex:1;">ä¿å­˜ã™ã‚‹</button>
                <button class="btn btn-secondary" onclick="closeModal()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        // ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
        let users = JSON.parse(localStorage.getItem('gh_users') || '[]');
        let records = JSON.parse(localStorage.getItem('gh_records') || '{}');
        let facility = JSON.parse(localStorage.getItem('gh_facility') || '{}');
        let buildings = JSON.parse(localStorage.getItem('gh_buildings') || '[]');
        
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        let selectedUserId = null;
        let selectedDate = null;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadFacilityInfo();
            renderBuildingList();
            renderUserList();
            updateUserSelector();
            updateCalendar();
            updateUnitOptions();
            displayFacilityInfo();
            
            const today = new Date();
            document.getElementById('exportMonth').value = 
                `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
        });

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'export') {
                renderExportUserList();
                // ä»Šæœˆã‚’åˆæœŸå€¤ã«
                const today = new Date();
                const m = today.getFullYear() + '-' + String(today.getMonth()+1).padStart(2,'0');
                if (!document.getElementById('exportMonth').value) {
                    document.getElementById('exportMonth').value = m;
                }
                const todayStr = today.toISOString().slice(0,10);
                ['exportPrintDate','exportPrintDate2','exportPrintDate3','exportPrintDate4'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el && !el.value) el.value = todayStr;
                });
            }
        }

        // ========== äº‹æ¥­æ‰€æƒ…å ±ç®¡ç† ==========
        
        function loadFacilityInfo() {
            if (facility.facilityNumber) {
                document.getElementById('facilityNumber').value = facility.facilityNumber || '';
                document.getElementById('facilityName').value = facility.facilityName || '';
                document.getElementById('corporationName').value = facility.corporationName || '';
                document.getElementById('areaCode').value = facility.areaCode || '01';
                document.getElementById('residentialCareSystem').value = facility.residentialCareSystem || '';
                document.getElementById('staffRatio').value = facility.staffRatio || '12ï¼š1';
                document.getElementById('nurseCount').value = facility.nurseCount || '';
                document.getElementById('nightSupportType1').value = facility.nightSupportType1 || '';
                document.getElementById('nightSupportType2').value = facility.nightSupportType2 || '';
                document.getElementById('nightSupportType3').value = facility.nightSupportType3 || '';
                document.getElementById('treatmentImprovement').value = facility.treatmentImprovement || '';
                document.getElementById('daySupport').value = facility.daySupport || '';
                document.getElementById('infectionControl').value = facility.infectionControl || '';

                // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®å¾©å…ƒï¼ˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³åŒ–ã—ãŸåŠ ç®—ãƒ»æ¸›ç®—ï¼‰
                const selects = [
                    'specialistAllowance', 'sensorySupport', 'medicalCooperation',
                    'largeScaleReduction', 'serviceManagerReduction', 'staffReduction'
                ];
                selects.forEach(id => {
                    const el = document.getElementById(id);
                    if (el && facility[id]) el.value = facility[id];
                });

                // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¾©å…ƒ
                const checkboxes = [
                    'nurseAllowance', 'medicalCooperationRecord', 'commuterSupport',
                    'housingSupport', 'transitionSupport', 'peerSupport',
                    'coreStaffing', 'brainInjurySupport',
                    'restraintReduction', 'abusePreventionReduction',
                    'bcpReduction', 'infoDisclosureReduction'
                ];

                checkboxes.forEach(id => {
                    const checkbox = document.getElementById(id);
                    if (checkbox && facility[id]) {
                        checkbox.checked = true;
                    }
                });
            }
        }

        document.getElementById('facilityForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            facility = {
                facilityNumber: document.getElementById('facilityNumber').value,
                facilityName: document.getElementById('facilityName').value,
                corporationName: document.getElementById('corporationName').value,
                areaCode: document.getElementById('areaCode').value,
                residentialCareSystem: document.getElementById('residentialCareSystem').value,
                staffRatio: document.getElementById('staffRatio').value,
                nurseCount: document.getElementById('nurseCount').value,
                nightSupportType1: document.getElementById('nightSupportType1').value,
                nightSupportType2: document.getElementById('nightSupportType2').value,
                nightSupportType3: document.getElementById('nightSupportType3').value,
                treatmentImprovement: document.getElementById('treatmentImprovement').value,
                daySupport: document.getElementById('daySupport').value,
                infectionControl: document.getElementById('infectionControl').value
            };

            // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®ä¿å­˜ï¼ˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³åŒ–ã—ãŸåŠ ç®—ãƒ»æ¸›ç®—ï¼‰
            const selects = [
                'specialistAllowance', 'sensorySupport', 'medicalCooperation',
                'largeScaleReduction', 'serviceManagerReduction', 'staffReduction'
            ];
            selects.forEach(id => {
                const el = document.getElementById(id);
                facility[id] = el ? el.value : '';
            });

            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ä¿å­˜
            const checkboxes = [
                'nurseAllowance', 'medicalCooperationRecord', 'commuterSupport',
                'housingSupport', 'transitionSupport', 'peerSupport',
                'coreStaffing', 'brainInjurySupport',
                'restraintReduction', 'abusePreventionReduction',
                'bcpReduction', 'infoDisclosureReduction'
            ];

            checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                facility[id] = checkbox ? checkbox.checked : false;
            });

            localStorage.setItem('gh_facility', JSON.stringify(facility));
            
            displayFacilityInfo();
            alert('âœ… äº‹æ¥­æ‰€æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
        });

        function displayFacilityInfo() {
            const container = document.getElementById('facilityInfo');
            if (!facility.facilityNumber) return;

            const activeAdditions = [];
            const activeReductions = [];

            // é¸æŠå¼ã®åŠ ç®—
            if (facility.nightSupportType1) activeAdditions.push('å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰: ' + facility.nightSupportType1);
            if (facility.nightSupportType2) activeAdditions.push('å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰: ' + facility.nightSupportType2);
            if (facility.nightSupportType3) activeAdditions.push(facility.nightSupportType3);
            if (facility.treatmentImprovement) activeAdditions.push(facility.treatmentImprovement);
            if (facility.daySupport) activeAdditions.push(facility.daySupport);
            if (facility.infectionControl) activeAdditions.push(facility.infectionControl);
            // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³åŒ–ã—ãŸåŠ ç®—
            if (facility.specialistAllowance) activeAdditions.push(facility.specialistAllowance);
            if (facility.sensorySupport) activeAdditions.push(facility.sensorySupport);
            if (facility.medicalCooperation) activeAdditions.push(facility.medicalCooperation);

            const additions = {
                nurseAllowance: 'çœ‹è­·è·å“¡é…ç½®åŠ ç®—',
                medicalCooperationRecord: 'åŒ»ç™‚é€£æºï¼ˆå®Ÿç¸¾è¨˜éŒ²ç­‰ã®æ•´å‚™ã«å¿…è¦ï¼‰',
                commuterSupport: 'é€šå‹¤è€…ç”Ÿæ´»æ”¯æ´åŠ ç®—',
                housingSupport: 'å±…ä½æ”¯æ´ä½“åˆ¶',
                transitionSupport: 'ç§»è¡Œæ”¯æ´ä½ä½“åˆ¶',
                peerSupport: 'ãƒ”ã‚¢ã‚µãƒãƒ¼ãƒˆå®Ÿæ–½åŠ ç®—',
                coreStaffing: 'ä¸­æ ¸çš„äººæé…ç½®ä½“åˆ¶',
                brainInjurySupport: 'é«˜æ¬¡è„³æ©Ÿèƒ½éšœå®³è€…æ”¯æ´ä½“åˆ¶'
            };

            const reductions = {
                restraintReduction: 'èº«ä½“æ‹˜æŸå»ƒæ­¢æœªå®Ÿæ–½æ¸›ç®—',
                abusePreventionReduction: 'è™å¾…é˜²æ­¢æªç½®æœªå®Ÿæ–½æ¸›ç®—',
                bcpReduction: 'æ¥­å‹™ç¶™ç¶šè¨ˆç”»æœªç­–å®šæ¸›ç®—',
                infoDisclosureReduction: 'æƒ…å ±å…¬è¡¨æœªå ±å‘Šæ¸›ç®—'
            };

            // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³åŒ–ã—ãŸæ¸›ç®—
            if (facility.largeScaleReduction) activeReductions.push(facility.largeScaleReduction);
            if (facility.serviceManagerReduction) activeReductions.push(facility.serviceManagerReduction);
            if (facility.staffReduction) activeReductions.push(facility.staffReduction);

            Object.keys(additions).forEach(key => {
                if (facility[key]) activeAdditions.push(additions[key]);
            });

            Object.keys(reductions).forEach(key => {
                if (facility[key]) activeReductions.push(reductions[key]);
            });

            container.innerHTML = `
                <h2 class="section-header">ç™»éŒ²æƒ…å ±</h2>
                <div class="info-card">
                    <h3>äº‹æ¥­æ‰€åŸºæœ¬æƒ…å ±</h3>
                    <p><strong>äº‹æ¥­æ‰€ç•ªå·:</strong> ${facility.facilityNumber}</p>
                    <p><strong>äº‹æ¥­æ‰€å:</strong> ${facility.facilityName}</p>
                    <p><strong>æ³•äººå:</strong> ${facility.corporationName}</p>
                    <p><strong>åœ°åŸŸåŒºåˆ†:</strong> ${getAreaName(facility.areaCode)}</p>
                    ${facility.residentialCareSystem ? `<p><strong>å…¥å“¡é…ç½®ä½“åˆ¶:</strong> ${facility.residentialCareSystem}</p>` : ''}
                    ${facility.staffRatio ? `<p><strong>è·å“¡é…ç½®:</strong> ${facility.staffRatio}</p>` : ''}
                    ${facility.nurseCount ? `<p><strong>çœ‹è­·è·å“¡æ•°:</strong> ${facility.nurseCount}äºº</p>` : ''}
                </div>
                ${activeAdditions.length > 0 ? `
                <div class="info-card">
                    <h3>æœ‰åŠ¹ãªåŠ ç®—</h3>
                    ${activeAdditions.map(a => `<p>âœ… ${a}</p>`).join('')}
                </div>
                ` : ''}
                ${activeReductions.length > 0 ? `
                <div class="info-card" style="border-color: #f8d7da;">
                    <h3 style="color: #721c24;">é©ç”¨ä¸­ã®æ¸›ç®—</h3>
                    ${activeReductions.map(r => `<p>âš ï¸ ${r}</p>`).join('')}
                </div>
                ` : ''}
            `;
        }

        function getAreaName(code) {
            const areas = {
                '01': 'ä¸€ç´šåœ°', '02': 'äºŒç´šåœ°', '03': 'ä¸‰ç´šåœ°',
                '04': 'å››ç´šåœ°', '05': 'äº”ç´šåœ°', '06': 'å…­ç´šåœ°',
                '07': 'ä¸ƒç´šåœ°', '20': 'ãã®ä»–'
            };
            return areas[code] || code;
        }

        // ========== å»ºç‰©ç®¡ç† ==========

        let selectedBuildingId = null;
        let selectedBuildingInnerTab = 'basic'; // basic | calc | users | history

        function addBuilding() {
            const now = new Date();
            const building = {
                id: Date.now().toString(),
                name: 'æ–°ã—ã„å»ºç‰©',
                nameKana: '',
                manager: '',
                zip: '',
                prefecture: '',
                city: '',
                address: '',
                buildingName: '',
                tel: '',
                fax: '',
                email: '',
                totalRooms: 0,
                nightSupportType: '', // å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ã®é¸æŠå€¤
                largeScaleReduction: '',
                history: {
                    basic: {},
                    calc: {},
                    users: {}
                }
            };
            buildings.push(building);
            localStorage.setItem('gh_buildings', JSON.stringify(buildings));
            selectedBuildingId = building.id;
            renderBuildingList();
        }

        function removeBuilding(id) {
            if (confirm('ã“ã®å»ºç‰©ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                buildings = buildings.filter(b => b.id !== id);
                if (selectedBuildingId === id) selectedBuildingId = buildings.length > 0 ? buildings[0].id : null;
                localStorage.setItem('gh_buildings', JSON.stringify(buildings));
                renderBuildingList();
                updateUnitOptions();
            }
        }

        function renderBuildingList() {
            if (buildings.length === 0) {
                buildings = [
                    { id: 'nakano', name: 'Nakano. settle', nameKana: 'ãƒŠã‚«ãƒã‚»ãƒˆãƒ«', manager: 'éˆ´æœ¨', zip: '165-0026', prefecture: 'æ±äº¬éƒ½', city: 'ä¸­é‡åŒº', address: 'æ–°äº•5-30-4', buildingName: 'ã‚¹ã‚¯ã‚¨ã‚¢æ–°äº•è–¬å¸«å‰', tel: '', fax: '', email: '', totalRooms: 5, nightSupportType: '', largeScaleReduction: '', history: {basic:{},calc:{},users:{}} },
                    { id: 'nerima', name: 'Nerima. settle', nameKana: 'ãƒãƒªãƒã‚»ãƒˆãƒ«', manager: '', zip: '', prefecture: '', city: '', address: '', buildingName: '', tel: '', fax: '', email: '', totalRooms: 5, nightSupportType: '', largeScaleReduction: '', history: {basic:{},calc:{},users:{}} },
                    { id: 'nerima-west', name: 'Nerima. settle west', nameKana: 'ãƒãƒªãƒã‚»ãƒˆãƒ«ã‚¦ã‚¨ã‚¹ãƒˆ', manager: '', zip: '', prefecture: '', city: '', address: '', buildingName: '', tel: '', fax: '', email: '', totalRooms: 8, nightSupportType: '', largeScaleReduction: 'å¤§è¦æ¨¡ä½å±…ç­‰æ¸›ç®—ï¼ˆå…¥å±…å®šå“¡8äººä»¥ä¸Šï¼‰', history: {basic:{},calc:{},users:{}} }
                ];
                localStorage.setItem('gh_buildings', JSON.stringify(buildings));
            }

            // åˆæœŸé¸æŠ
            if (!selectedBuildingId && buildings.length > 0) selectedBuildingId = buildings[0].id;

            // ã‚µã‚¤ãƒ‰ãƒãƒ¼
            const sidebar = document.getElementById('buildingSidebar');
            sidebar.innerHTML = buildings.map(b => `
                <div class="building-sidebar-item ${b.id === selectedBuildingId ? 'active' : ''}" onclick="selectBuilding('${b.id}')">
                    <strong>${b.name}</strong><br>
                    <small>å®šå“¡ ${b.totalRooms}äºº</small>
                </div>
            `).join('');

            renderBuildingDetail();
            updateUnitOptions();
        }

        function selectBuilding(id) {
            selectedBuildingId = id;
            selectedBuildingInnerTab = 'basic';
            renderBuildingList();
        }

        function selectBuildingInnerTab(tab) {
            selectedBuildingInnerTab = tab;
            renderBuildingDetail();
        }

        function renderBuildingDetail() {
            const container = document.getElementById('buildingDetail');
            const b = buildings.find(b => b.id === selectedBuildingId);
            if (!b) { container.innerHTML = '<p style="color:#888;">å»ºç‰©ã‚’é¸æŠã—ã¦ãã ã•ã„</p>'; return; }

            // å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ã®é¸æŠè‚¢ç”Ÿæˆ
            const nightOpts = generateNightSupportOptions(b.nightSupportType);
            // å¤§è¦æ¨¡ä½å±…ç­‰æ¸›ç®—ã®é¸æŠè‚¢
            const largeOpts = [
                ['', 'è¨­å®šãªã—'],
                ['å¤§è¦æ¨¡ä½å±…ç­‰æ¸›ç®—ï¼ˆå…¥å±…å®šå“¡8äººä»¥ä¸Šï¼‰', 'å…¥å±…å®šå“¡ãŒï¼˜äººä»¥ä¸Š'],
                ['å¤§è¦æ¨¡ä½å±…ç­‰æ¸›ç®—ï¼ˆå…¥å±…å®šå“¡21äººä»¥ä¸Šï¼‰', 'å…¥å±…å®šå“¡ãŒ21äººä»¥ä¸Š'],
                ['å¤§è¦æ¨¡ä½å±…ç­‰æ¸›ç®—ï¼ˆä¸€ä½“çš„ãªå…±åŒç”Ÿæ´»ä½å±…21äººä»¥ä¸Šï¼‰', 'ä¸€ä½“çš„ãªå…±åŒç”Ÿæ´»ä½å±…ã®å…¥å±…å®šå“¡æ•°21ä»¥ä¸Š']
            ].map(([v, l]) => `<option value="${v}" ${b.largeScaleReduction === v ? 'selected' : ''}>${l}</option>`).join('');

            // åˆ©ç”¨è€…ã‚¿ãƒ–
            const buildingUsers = users.filter(u => u.unit === b.id);

            // å±¥æ­´ã‚¿ãƒ–
            const historyHtml = renderHistoryTab(b);

            container.innerHTML = `
                <div style="margin-bottom:12px;">
                    <strong style="font-size:1.1em;">${facility.facilityName || 'Tokyo. settle'} ${b.name}</strong>
                    <button type="button" class="btn btn-secondary" style="float:right;font-size:0.8em;padding:4px 10px;" onclick="removeBuilding('${b.id}')">ğŸ—‘ï¸ å‰Šé™¤</button>
                </div>
                <div class="building-inner-tabs">
                    <div class="building-inner-tab ${selectedBuildingInnerTab==='basic'?'active':''}" onclick="selectBuildingInnerTab('basic')">åŸºæœ¬æƒ…å ±</div>
                    <div class="building-inner-tab ${selectedBuildingInnerTab==='calc'?'active':''}" onclick="selectBuildingInnerTab('calc')">ç®—å®šæƒ…å ±</div>
                    <div class="building-inner-tab ${selectedBuildingInnerTab==='users'?'active':''}" onclick="selectBuildingInnerTab('users')">åˆ©ç”¨è€…</div>
                    <div class="building-inner-tab ${selectedBuildingInnerTab==='history'?'active':''}" onclick="selectBuildingInnerTab('history')">å±¥æ­´æƒ…å ±</div>
                </div>

                <!-- åŸºæœ¬æƒ…å ± -->
                <div class="building-detail-panel ${selectedBuildingInnerTab==='basic'?'active':''}">
                    <div class="info-card">
                        <div class="grid-2">
                            <div class="form-group">
                                <label>å»ºç‰©å</label>
                                <input type="text" value="${b.name}" onchange="updateBuilding('${b.id}','name',this.value)">
                            </div>
                            <div class="form-group">
                                <label>å»ºç‰©åã‚«ãƒŠ</label>
                                <input type="text" value="${b.nameKana||''}" onchange="updateBuilding('${b.id}','nameKana',this.value)">
                            </div>
                            <div class="form-group">
                                <label>ç®¡ç†è€…</label>
                                <input type="text" value="${b.manager||''}" onchange="updateBuilding('${b.id}','manager',this.value)">
                            </div>
                            <div class="form-group">
                                <label>éƒµä¾¿ç•ªå·</label>
                                <input type="text" value="${b.zip||''}" placeholder="000-0000" onchange="updateBuilding('${b.id}','zip',this.value)">
                            </div>
                            <div class="form-group">
                                <label>éƒ½é“åºœçœŒ</label>
                                <input type="text" value="${b.prefecture||''}" onchange="updateBuilding('${b.id}','prefecture',this.value)">
                            </div>
                            <div class="form-group">
                                <label>å¸‚åŒºç”ºæ‘</label>
                                <input type="text" value="${b.city||''}" onchange="updateBuilding('${b.id}','city',this.value)">
                            </div>
                            <div class="form-group">
                                <label>ç”ºåãƒ»ç•ªåœ°</label>
                                <input type="text" value="${b.address||''}" onchange="updateBuilding('${b.id}','address',this.value)">
                            </div>
                            <div class="form-group">
                                <label>ä½æ‰€å»ºç‰©å</label>
                                <input type="text" value="${b.buildingName||''}" onchange="updateBuilding('${b.id}','buildingName',this.value)">
                            </div>
                            <div class="form-group">
                                <label>é›»è©±ç•ªå·</label>
                                <input type="text" value="${b.tel||''}" onchange="updateBuilding('${b.id}','tel',this.value)">
                            </div>
                            <div class="form-group">
                                <label>FAX</label>
                                <input type="text" value="${b.fax||''}" onchange="updateBuilding('${b.id}','fax',this.value)">
                            </div>
                            <div class="form-group">
                                <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                                <input type="text" value="${b.email||''}" onchange="updateBuilding('${b.id}','email',this.value)">
                            </div>
                            <div class="form-group">
                                <label>ç·å±…å®¤æ•°</label>
                                <input type="number" value="${b.totalRooms||0}" onchange="updateBuilding('${b.id}','totalRooms',parseInt(this.value))">
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="saveBuildingHistory('${b.id}','basic')">ğŸ’¾ ä¿å­˜</button>
                        <a href="#" onclick="saveBuildingHistory('${b.id}','basic'); return false;" style="margin-left:12px; font-size:0.85em; color:#667eea;">å®Ÿç¸¾ãƒã‚¹ã‚¿</a>
                    </div>
                </div>

                <!-- ç®—å®šæƒ…å ± -->
                <div class="building-detail-panel ${selectedBuildingInnerTab==='calc'?'active':''}">
                    <div class="info-card">
                        <div class="form-group">
                            <label>å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—</label>
                            <select onchange="updateBuilding('${b.id}','nightSupportType',this.value)">
                                ${nightOpts}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>å¤§è¦æ¨¡ä½å±…ç­‰æ¸›ç®—</label>
                            <select onchange="updateBuilding('${b.id}','largeScaleReduction',this.value)">
                                ${largeOpts}
                            </select>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="saveBuildingHistory('${b.id}','calc')">ğŸ’¾ ä¿å­˜</button>
                    </div>
                </div>

                <!-- åˆ©ç”¨è€… -->
                <div class="building-detail-panel ${selectedBuildingInnerTab==='users'?'active':''}">
                    <div class="info-card">
                        <p style="color:#888; margin-bottom:12px;">äº‹æ¥­æ‰€ ${facility.facilityName||'Tokyo. settle'} ã®åˆ©ç”¨è€…ä¸€è¦§</p>
                        <p style="margin-bottom:12px;">${buildingUsers.length} ä»¶ã®åˆ©ç”¨è€…ã‚’è¡¨ç¤º</p>
                        ${buildingUsers.length === 0
                            ? '<p style="color:#aaa;">ã“ã®å»ºç‰©ã«åˆ©ç”¨è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>'
                            : buildingUsers.map(u => `
                                <div style="padding:10px 0; border-bottom:1px solid #eee; color:#667eea; cursor:pointer;" onclick="showTab('users')">
                                    ${u.name}
                                </div>`).join('')
                        }
                    </div>
                </div>

                <!-- å±¥æ­´æƒ…å ± -->
                <div class="building-detail-panel ${selectedBuildingInnerTab==='history'?'active':''}">
                    <div class="info-card">
                        ${historyHtml}
                    </div>
                </div>
            `;
        }

        function generateNightSupportOptions(selected) {
            const opts = [['', 'è¨­å®šãªã—']];
            // â… : 1äººã€œ30äºº
            for (let i = 1; i <= 30; i++) {
                opts.push([`å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰${i}äºº`, `å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ã€€${i}äºº`]);
            }
            // â…¡: 4äººä»¥ä¸‹ã€œ30äºº
            opts.push([`å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰4äººä»¥ä¸‹`, `å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ã€€4äººä»¥ä¸‹`]);
            for (let i = 5; i <= 30; i++) {
                opts.push([`å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰${i}äºº`, `å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ã€€${i}äºº`]);
            }
            // â…¢
            opts.push(['å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¢ï¼‰', 'å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¢ï¼‰']);

            return opts.map(([v, l]) => `<option value="${v}" ${selected===v?'selected':''}>${l}</option>`).join('');
        }

        function renderHistoryTab(b) {
            if (!b.history) b.history = {basic:{}, calc:{}, users:{}};

            // å…¨ã¦ã®ã‚­ãƒ¼ï¼ˆYYYY-MMï¼‰ã‚’é›†ã‚ã‚‹
            const allKeys = new Set([
                ...Object.keys(b.history.basic||{}),
                ...Object.keys(b.history.calc||{}),
                ...Object.keys(b.history.users||{})
            ]);

            if (allKeys.size === 0) return '<p style="color:#aaa;">å¤‰æ›´å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>';

            // å¹´ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const byYear = {};
            allKeys.forEach(k => {
                const [y] = k.split('-');
                if (!byYear[y]) byYear[y] = [];
                byYear[y].push(k);
            });

            const years = Object.keys(byYear).sort((a,b)=>b-a);

            const rows = ['basic','calc','users'];
            const rowLabels = {basic:'åŸºæœ¬æƒ…å ±', calc:'ç®—å®šæƒ…å ±', users:'åˆ©ç”¨è€…'};

            let html = '';
            years.forEach(year => {
                const months = byYear[year].map(k=>k.split('-')[1]).filter((v,i,a)=>a.indexOf(v)===i).sort((a,b)=>a-b);

                // æœ€æ–°å¹´ã¯åˆ†ã‘ã¦è¡¨ç¤º
                const isLatest = year === years[0];
                if (isLatest) {
                    html += `<div style="margin-bottom:16px;">`;
                    rows.forEach(row => {
                        const latestMonths = months.filter(m => b.history[row] && b.history[row][`${year}-${m}`]);
                        if (latestMonths.length > 0) {
                            html += `<div style="display:flex; gap:8px; margin-bottom:6px; align-items:center;">
                                <span style="width:80px; font-size:0.85em; color:#888;">${rowLabels[row]}</span>
                                ${latestMonths.map(m=>`<span class="history-link" onclick="viewHistory('${b.id}','${row}','${year}-${m}')">${year}å¹´${parseInt(m)}æœˆ</span>`).join('')}
                            </div>`;
                        }
                    });
                    html += `</div>`;
                }

                html += `<div style="margin-bottom:16px;">`;
                rows.forEach(row => {
                    const histMonths = months.filter(m => b.history[row] && b.history[row][`${year}-${m}`]);
                    if (!isLatest && histMonths.length > 0) {
                        html += `<div style="display:flex; gap:6px; margin-bottom:6px; align-items:center; flex-wrap:wrap;">
                            <span style="width:80px; font-size:0.85em; color:#888;">${rowLabels[row]}</span>
                            ${histMonths.map(m=>`<span class="history-link" onclick="viewHistory('${b.id}','${row}','${year}-${m}')">${year}å¹´${parseInt(m)}æœˆ</span>`).join('')}
                        </div>`;
                    }
                });
                html += `</div>`;
            });

            return html;
        }

        function saveBuildingHistory(id, type) {
            const b = buildings.find(b => b.id === id);
            if (!b) return;
            if (!b.history) b.history = {basic:{}, calc:{}, users:{}};

            const now = new Date();
            const key = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;

            if (type === 'basic') {
                b.history.basic[key] = {
                    name: b.name, nameKana: b.nameKana, manager: b.manager,
                    zip: b.zip, prefecture: b.prefecture, city: b.city,
                    address: b.address, buildingName: b.buildingName,
                    tel: b.tel, fax: b.fax, email: b.email, totalRooms: b.totalRooms,
                    savedAt: now.toISOString()
                };
            } else if (type === 'calc') {
                b.history.calc[key] = {
                    nightSupportType: b.nightSupportType,
                    largeScaleReduction: b.largeScaleReduction,
                    savedAt: now.toISOString()
                };
            } else if (type === 'users') {
                b.history.users[key] = {
                    users: users.filter(u => u.unit === id).map(u => u.name),
                    savedAt: now.toISOString()
                };
            }

            localStorage.setItem('gh_buildings', JSON.stringify(buildings));
            alert(`âœ… ${['basic','calc','users'].includes(type) ? {basic:'åŸºæœ¬æƒ…å ±',calc:'ç®—å®šæƒ…å ±',users:'åˆ©ç”¨è€…'}[type] : type}ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼`);
            renderBuildingDetail();
        }

        function viewHistory(buildingId, type, key) {
            const b = buildings.find(b => b.id === buildingId);
            if (!b || !b.history || !b.history[type] || !b.history[type][key]) return;
            const data = b.history[type][key];
            const labels = {basic:'åŸºæœ¬æƒ…å ±', calc:'ç®—å®šæƒ…å ±', users:'åˆ©ç”¨è€…'};
            const [y, m] = key.split('-');
            let msg = `ã€${b.name} - ${labels[type]} ${y}å¹´${parseInt(m)}æœˆã€‘\n`;
            msg += `ä¿å­˜æ—¥æ™‚: ${data.savedAt ? new Date(data.savedAt).toLocaleString('ja-JP') : 'ä¸æ˜'}\n\n`;
            if (type === 'users') {
                msg += `åˆ©ç”¨è€…: ${data.users && data.users.length > 0 ? data.users.join(', ') : 'ãªã—'}`;
            } else {
                Object.entries(data).forEach(([k,v]) => {
                    if (k !== 'savedAt') msg += `${k}: ${v}\n`;
                });
            }
            alert(msg);
        }

        function updateBuilding(id, field, value) {
            const building = buildings.find(b => b.id === id);
            if (building) {
                building[field] = value;
                localStorage.setItem('gh_buildings', JSON.stringify(buildings));
                if (field === 'name') {
                    renderBuildingList(); // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚‚æ›´æ–°
                } else {
                    renderBuildingDetail();
                }
                updateUnitOptions();
            }
        }

        function updateUnitOptions() {
            const select = document.getElementById('userUnit');
            select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
                buildings.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
        }

        // ========== OCRæ©Ÿèƒ½ ==========

        function initUploadArea() {
            const uploadArea = document.getElementById('uploadArea');
            if (!uploadArea || uploadArea._initialized) return;
            uploadArea._initialized = true;
            uploadArea.addEventListener('click', () => {
                document.getElementById('certificateFile').click();
            });
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && (file.type.startsWith('image/') || file.type === 'application/pdf')) {
                    processFile(file);
                } else {
                    alert('âŒ PDFã¾ãŸã¯ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                }
            });
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        async function processFile(file) {
            const progress = document.getElementById('ocrProgress');
            progress.style.display = 'block';
            progress.textContent = 'ğŸ” ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...';

            try {
                if (file.type === 'application/pdf') {
                    await processPDFSimple(file);
                } else {
                    await processImage(file);
                }
            } catch (err) {
                console.error('ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã‚¨ãƒ©ãƒ¼:', err);
                progress.textContent = 'âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
                setTimeout(() => {
                    progress.style.display = 'none';
                }, 3000);
            }
        }

        async function processPDFSimple(file) {
            const progress = document.getElementById('ocrProgress');
            progress.textContent = 'ğŸ“„ PDFã‚’ç”»åƒã«å¤‰æ›ä¸­...';
            
            alert('ğŸ“ PDFã®OCRã¯ç¾åœ¨é–‹ç™ºä¸­ã§ã™ã€‚ç”»åƒå½¢å¼ï¼ˆPNG/JPEGï¼‰ã§ã®èª­ã¿è¾¼ã¿ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚\n\nã¾ãŸã¯ã€PDFã‚’é–‹ã„ã¦ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®ã‚Šã€ãã®ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
            progress.style.display = 'none';
        }

        async function processImage(file) {
            const progress = document.getElementById('ocrProgress');
            progress.textContent = 'ğŸ” ç”»åƒã‚’è§£æä¸­...';

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    progress.textContent = 'ğŸ” OCRå‡¦ç†ä¸­... 0%';
                    
                    const result = await Tesseract.recognize(
                        e.target.result,
                        'jpn',
                        {
                            logger: m => {
                                if (m.status === 'recognizing text') {
                                    const percent = Math.round(m.progress * 100);
                                    progress.textContent = `ğŸ” OCRå‡¦ç†ä¸­... ${percent}%`;
                                }
                            }
                        }
                    );

                    progress.textContent = 'âœ… èª­ã¿å–ã‚Šå®Œäº†ï¼';
                    console.log('OCRçµæœ:', result.data.text);
                    extractCertificateData(result.data.text);
                    
                    setTimeout(() => {
                        progress.style.display = 'none';
                    }, 3000);

                } catch (err) {
                    console.error('OCRã‚¨ãƒ©ãƒ¼:', err);
                    progress.textContent = 'âŒ OCRã«å¤±æ•—ã—ã¾ã—ãŸ';
                    alert('OCRã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\n\nã‚¨ãƒ©ãƒ¼: ' + err.message);
                    setTimeout(() => {
                        progress.style.display = 'none';
                    }, 3000);
                }
            };

            reader.readAsDataURL(file);
        }

        function extractCertificateData(text) {
            console.log('æŠ½å‡ºå…ƒãƒ†ã‚­ã‚¹ãƒˆ:', text);
            
            const certMatch = text.match(/\d{10}/);
            if (certMatch) {
                document.getElementById('certificateNumber').value = certMatch[0];
            }

            const namePatterns = [
                /æ°[\sã€€]*å[ï¼š:\sã€€]*([^\n\rã€€]{2,10})/,
                /å—çµ¦è€…æ°å[ï¼š:\sã€€]*([^\n\rã€€]{2,10})/,
            ];
            
            for (const pattern of namePatterns) {
                const match = text.match(pattern);
                if (match) {
                    const name = match[1].trim().replace(/[0-9]/g, '');
                    if (name.length >= 2) {
                        document.getElementById('userName').value = name;
                        break;
                    }
                }
            }

            const cityMatch = text.match(/\d{6}/);
            if (cityMatch && cityMatch[0] !== certMatch?.[0]) {
                document.getElementById('cityCode').value = cityMatch[0];
            }

            const supportMatch = text.match(/åŒºåˆ†[ã€€\s]*([ï¼‘-ï¼–1-6])/);
            if (supportMatch) {
                const num = supportMatch[1].replace(/[ï¼‘-ï¼–]/g, (s) => 
                    String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
                document.getElementById('supportLevel').value = (20 + parseInt(num)).toString();
            }

            alert('ğŸ“ èª­ã¿å–ã‚Šçµæœã‚’åæ˜ ã—ã¾ã—ãŸã€‚å†…å®¹ã‚’ç¢ºèªã—ã¦å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚');
        }

        // ========== åˆ©ç”¨è€…ç®¡ç† ==========

        let currentUserId = null;
        let userListPage = 1;
        const USER_PAGE_SIZE = 15;

        function showUserList() {
            document.getElementById('userListView').style.display = '';
            document.getElementById('userDetailView').style.display = 'none';
            renderUserList();
        }

        function showUserNew() {
            currentUserId = null;
            const newUser = {
                id: Date.now().toString(),
                name: 'æ–°ã—ã„åˆ©ç”¨è€…',
                nameKana: '',
                unit: '',
                room: '',
                moveDate: '',
                gender: '',
                birthdate: '',
                zip: '', prefecture: '', city: '', address: '', buildingName: '',
                tel: '', mobile: '',
                daytimeOrgNo: '', daytimeOrgName: '',
                housingAssist: '',
                status: 'åˆ©ç”¨ä¸­',
                emergencyContacts: [],
                medicalFacilities: [],
                personality: '',
                moveInHistory: [],
                diseases: [],
                medicines: [],
                medicalNotes: '',
                certificates: [],
                calcSevereDisability: '',
                calcRegionalTransition: false,
                calcMentalTransition: false,
                calcBehaviorTransition: false,
                calcBehaviorExperience: false,
                calcMedicalCare: false,
                calcIndividualCare: false,
                calcNoPlanReduction: '',
                calcLargeScaleReduction: '',
                contracts: [],
                userHistory: { basic: {}, calc: {} }
            };
            users.push(newUser);
            localStorage.setItem('gh_users', JSON.stringify(users));
            currentUserId = newUser.id;
            showUserDetail(newUser.id);
        }

        function showUserDetail(userId) {
            currentUserId = userId;
            const user = users.find(u => u.id === userId);
            if (!user) return;
            document.getElementById('userListView').style.display = 'none';
            document.getElementById('userDetailView').style.display = '';
            document.getElementById('userDetailName').textContent = user.name;
            document.getElementById('userDetailBreadcrumb').textContent = `åˆ©ç”¨è€…ç…§ä¼š ${user.name}`;
            loadUserForm(user);
            showUserTab('basic1');
            updateUnitOptions();
        }

        function showUserTab(tab) {
            document.querySelectorAll('#userDetailTabs .building-inner-tab').forEach((el, i) => {
                const tabs = ['basic1','basic2','medical','certificate','calc','contract','history'];
                el.classList.toggle('active', tabs[i] === tab);
            });
            document.querySelectorAll('[id^="userTab-"]').forEach(el => el.classList.remove('active'));
            const panel = document.getElementById('userTab-' + tab);
            if (panel) panel.classList.add('active');
            if (tab === 'certificate') renderCertificateHistory();
            if (tab === 'basic2') renderBasic2();
            if (tab === 'medical') renderMedical();
            if (tab === 'contract') renderContractList();
            if (tab === 'history') renderUserHistory();
        }

        function loadUserForm(user) {
            // åŸºæœ¬æƒ…å ±â‘ 
            document.getElementById('userUnit').value = user.unit || '';
            document.getElementById('userRoom').value = user.room || '';
            document.getElementById('userMoveDate').value = user.moveDate || '';
            document.getElementById('userName').value = user.name || '';
            document.getElementById('userNameKana').value = user.nameKana || '';
            document.getElementById('userGender').value = user.gender || '';
            document.getElementById('userBirthdate').value = user.birthdate || '';
            document.getElementById('userZip').value = user.zip || '';
            document.getElementById('userPrefecture').value = user.prefecture || '';
            document.getElementById('userCity').value = user.city || '';
            document.getElementById('userAddress').value = user.address || '';
            document.getElementById('userBuildingName').value = user.buildingName || '';
            document.getElementById('userTel').value = user.tel || '';
            document.getElementById('userMobile').value = user.mobile || '';
            document.getElementById('userDaytimeOrgNo').value = user.daytimeOrgNo || '';
            document.getElementById('userDaytimeOrgName').value = user.daytimeOrgName || '';
            document.getElementById('userHousingAssist').value = user.housingAssist || '';
            document.getElementById('userStatus').value = user.status || 'åˆ©ç”¨ä¸­';
            // ç®—å®šæƒ…å ±
            document.getElementById('calcSevereDisability').value = user.calcSevereDisability || '';
            document.getElementById('calcRegionalTransition').checked = !!user.calcRegionalTransition;
            document.getElementById('calcMentalTransition').checked = !!user.calcMentalTransition;
            document.getElementById('calcBehaviorTransition').checked = !!user.calcBehaviorTransition;
            document.getElementById('calcBehaviorExperience').checked = !!user.calcBehaviorExperience;
            document.getElementById('calcMedicalCare').checked = !!user.calcMedicalCare;
            document.getElementById('calcIndividualCare').checked = !!user.calcIndividualCare;
            document.getElementById('calcNoPlanReduction').value = user.calcNoPlanReduction || '';
            document.getElementById('calcLargeScaleReduction').value = user.calcLargeScaleReduction || '';
            // å¥‘ç´„
            document.getElementById('contractFacilityLabel').textContent = facility.facilityName || 'Tokyo. settle';
        }

        function saveCurrentUser(type) {
            const user = users.find(u => u.id === currentUserId);
            if (!user) return;
            const now = new Date();
            const histKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;

            if (type === 'basic1') {
                const prevSnap = JSON.parse(JSON.stringify(user));
                user.unit = document.getElementById('userUnit').value;
                user.room = document.getElementById('userRoom').value;
                user.moveDate = document.getElementById('userMoveDate').value;
                user.name = document.getElementById('userName').value;
                user.nameKana = document.getElementById('userNameKana').value;
                user.gender = document.getElementById('userGender').value;
                user.birthdate = document.getElementById('userBirthdate').value;
                user.zip = document.getElementById('userZip').value;
                user.prefecture = document.getElementById('userPrefecture').value;
                user.city = document.getElementById('userCity').value;
                user.address = document.getElementById('userAddress').value;
                user.buildingName = document.getElementById('userBuildingName').value;
                user.tel = document.getElementById('userTel').value;
                user.mobile = document.getElementById('userMobile').value;
                user.daytimeOrgNo = document.getElementById('userDaytimeOrgNo').value;
                user.daytimeOrgName = document.getElementById('userDaytimeOrgName').value;
                user.housingAssist = document.getElementById('userHousingAssist').value;
                user.status = document.getElementById('userStatus').value;
                if (!user.userHistory) user.userHistory = {basic:{}, calc:{}};
                user.userHistory.basic[histKey] = { ...prevSnap, savedAt: now.toISOString() };
                document.getElementById('userDetailName').textContent = user.name;
            } else if (type === 'calc') {
                const prevSnap = { calcSevereDisability: user.calcSevereDisability, calcRegionalTransition: user.calcRegionalTransition, calcMentalTransition: user.calcMentalTransition, calcBehaviorTransition: user.calcBehaviorTransition, calcBehaviorExperience: user.calcBehaviorExperience, calcMedicalCare: user.calcMedicalCare, calcIndividualCare: user.calcIndividualCare, calcNoPlanReduction: user.calcNoPlanReduction, calcLargeScaleReduction: user.calcLargeScaleReduction };
                user.calcSevereDisability = document.getElementById('calcSevereDisability').value;
                user.calcRegionalTransition = document.getElementById('calcRegionalTransition').checked;
                user.calcMentalTransition = document.getElementById('calcMentalTransition').checked;
                user.calcBehaviorTransition = document.getElementById('calcBehaviorTransition').checked;
                user.calcBehaviorExperience = document.getElementById('calcBehaviorExperience').checked;
                user.calcMedicalCare = document.getElementById('calcMedicalCare').checked;
                user.calcIndividualCare = document.getElementById('calcIndividualCare').checked;
                user.calcNoPlanReduction = document.getElementById('calcNoPlanReduction').value;
                user.calcLargeScaleReduction = document.getElementById('calcLargeScaleReduction').value;
                if (!user.userHistory) user.userHistory = {basic:{}, calc:{}};
                user.userHistory.calc[histKey] = { ...prevSnap, savedAt: now.toISOString() };
            }

            localStorage.setItem('gh_users', JSON.stringify(users));
            updateUserSelector();
            alert('âœ… ä¿å­˜ã—ã¾ã—ãŸï¼');
        }

        function renderUserList() {
            const filterName = (document.getElementById('filterName')?.value || '').trim();
            const filterBuilding = document.getElementById('filterBuilding')?.value || '';

            // update building filter options
            const bSel = document.getElementById('filterBuilding');
            if (bSel) {
                const curr = bSel.value;
                bSel.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
                    buildings.map(b => `<option value="${b.id}" ${b.id===curr?'selected':''}>${b.name}</option>`).join('');
            }

            let filtered = users.filter(u => {
                if (filterName && !u.name.includes(filterName)) return false;
                if (filterBuilding && u.unit !== filterBuilding) return false;
                return true;
            });

            const total = filtered.length;
            const totalPages = Math.max(1, Math.ceil(total / USER_PAGE_SIZE));
            if (userListPage > totalPages) userListPage = 1;
            const start = (userListPage - 1) * USER_PAGE_SIZE;
            const pageUsers = filtered.slice(start, start + USER_PAGE_SIZE);

            document.getElementById('userListCount').textContent =
                `${total} ä»¶ä¸­ ${start+1} - ${Math.min(start+USER_PAGE_SIZE, total)} ä»¶ã® åˆ©ç”¨è€… ã‚’è¡¨ç¤º`;

            // Pager
            let pagerHtml = '';
            if (totalPages > 1) {
                pagerHtml = `<div style="display:flex; gap:4px; align-items:center;">`;
                for (let i = 1; i <= totalPages; i++) {
                    if (i === userListPage) {
                        pagerHtml += `<span style="padding:4px 10px; background:#e91e8c; color:white; border-radius:4px;">${i}</span>`;
                    } else {
                        pagerHtml += `<span style="padding:4px 10px; border:1px solid #ddd; border-radius:4px; cursor:pointer; color:#667eea;" onclick="userListPage=${i};renderUserList();">${i}</span>`;
                    }
                }
                if (userListPage < totalPages) {
                    pagerHtml += `<span style="padding:4px 10px; border:1px solid #ddd; border-radius:4px; cursor:pointer; color:#667eea;" onclick="userListPage=${userListPage+1};renderUserList();">æ¬¡ â€º</span>`;
                    pagerHtml += `<span style="padding:4px 10px; border:1px solid #ddd; border-radius:4px; cursor:pointer; color:#667eea;" onclick="userListPage=${totalPages};renderUserList();">æœ€å¾Œ Â»</span>`;
                }
                pagerHtml += `</div>`;
            }
            document.getElementById('userPager').innerHTML = pagerHtml;

            const tbody = document.getElementById('userListBody');
            if (pageUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; color:#aaa;">åˆ©ç”¨è€…ãŒã„ã¾ã›ã‚“</td></tr>';
                return;
            }
            tbody.innerHTML = pageUsers.map(u => {
                // å—çµ¦è€…è¨¼æœŸé™ãƒã‚§ãƒƒã‚¯
                const today = new Date();
                const todayStr = today.toISOString().slice(0,10);
                const soon = new Date(today); soon.setDate(soon.getDate() + 90);
                const soonStr = soon.toISOString().slice(0,10);
                let certWarning = '';
                if (u.certificates && u.certificates.length > 0) {
                    const latest = u.certificates.reduce((a,b) => (a.certValidTo||'') > (b.certValidTo||'') ? a : b);
                    if (latest.certValidTo) {
                        if (latest.certValidTo < todayStr) certWarning = '<span title="å—çµ¦è€…è¨¼æœŸé™åˆ‡ã‚Œ" style="font-size:1em;">ğŸ”´</span>';
                        else if (latest.certValidTo < soonStr) certWarning = '<span title="å—çµ¦è€…è¨¼æœŸé™è¿‘ã„" style="font-size:1em;">ğŸŸ¡</span>';
                    }
                }
                return '<tr style="border-bottom:1px solid #f0f0f0;">' +
                    '<td style="padding:10px 6px; text-align:center;">' +
                        certWarning +
                        '<span style="display:inline-block; background:#e0e8ff; color:#667eea; border-radius:4px; padding:2px 6px; font-size:0.8em;">ä»‹</span>' +
                    '</td>' +
                    '<td style="padding:10px 6px; color:#555;">' + (facility.facilityName || 'Tokyo. settle') + '</td>' +
                    '<td style="padding:10px 6px; color:#667eea; cursor:pointer;" onclick="showUserDetail(\'' + u.id + '\')">' + getUnitName(u.unit) + '</td>' +
                    '<td style="padding:10px 6px;">' + u.name + '</td>' +
                    '<td style="padding:10px 6px; text-align:right;">' +
                        '<button class="btn btn-primary" onclick="showUserDetail(\'' + u.id + '\')" style="background:#e91e8c; border-color:#e91e8c; padding:4px 10px; font-size:0.8em; margin-right:4px;">è©³ç´°</button>' +
                        '<button class="btn btn-secondary" onclick="deleteUser(\'' + u.id + '\')" style="padding:4px 10px; font-size:0.8em;">å‰Šé™¤</button>' +
                    '</td>' +
                    '</tr>';
            }).join('');
        }

        function deleteUser(id) {
            if (confirm('ã“ã®åˆ©ç”¨è€…ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                users = users.filter(u => u.id !== id);
                localStorage.setItem('gh_users', JSON.stringify(users));
                renderUserList();
                updateUserSelector();
            }
        }

        // ===== å—çµ¦è€…è¨¼ =====
        let editingCertIndex = null;

        function showCertificateForm(index) {
            editingCertIndex = index !== undefined ? index : null;
            const user = users.find(u => u.id === currentUserId);
            const form = document.getElementById('certificateForm');
            form.style.display = '';

            // reset
            ['certNo','certCityCode','certCityName','certDisabilityType','certSupportLevel','certIssueDate','certValidFrom','certValidTo','certBurdenLimit','certLimitFrom','certLimitTo','certUpperMgmtOrgNo','certUpperMgmtOrgName','certSpecialAmount','certSpecialFrom','certSpecialTo','certMuniOrgNo','certMuniRate','certMuniAmount','certMuniMax','certMuniGrant','certGrantFrom','certGrantTo'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            ['certUpperMgmt','certSpecialDisabled','certMunicipalityAssist'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.checked = false;
            });
            document.getElementById('certSpecialDisabledArea').style.display = 'none';
            document.getElementById('certMunicipalityArea').style.display = 'none';

            if (editingCertIndex !== null && user && user.certificates && user.certificates[editingCertIndex]) {
                const cert = user.certificates[editingCertIndex];
                document.getElementById('certNo').value = cert.certNo || '';
                document.getElementById('certCityCode').value = cert.certCityCode || '';
                document.getElementById('certCityName').value = cert.certCityName || '';
                document.getElementById('certDisabilityType').value = cert.certDisabilityType || '';
                document.getElementById('certSupportLevel').value = cert.certSupportLevel || '';
                document.getElementById('certIssueDate').value = cert.certIssueDate || '';
                document.getElementById('certValidFrom').value = cert.certValidFrom || '';
                document.getElementById('certValidTo').value = cert.certValidTo || '';
                document.getElementById('certBurdenLimit').value = cert.certBurdenLimit || '0';
                document.getElementById('certLimitFrom').value = cert.certLimitFrom || '';
                document.getElementById('certLimitTo').value = cert.certLimitTo || '';
                document.getElementById('certUpperMgmt').checked = !!cert.certUpperMgmt;
                document.getElementById('certUpperMgmtOrgNo').value = cert.certUpperMgmtOrgNo || '';
                document.getElementById('certUpperMgmtOrgName').value = cert.certUpperMgmtOrgName || '';
                document.getElementById('certSpecialDisabled').checked = !!cert.certSpecialDisabled;
                if (cert.certSpecialDisabled) {
                    document.getElementById('certSpecialDisabledArea').style.display = '';
                    document.getElementById('certSpecialAmount').value = cert.certSpecialAmount || '0';
                    document.getElementById('certSpecialFrom').value = cert.certSpecialFrom || '';
                    document.getElementById('certSpecialTo').value = cert.certSpecialTo || '';
                }
                document.getElementById('certMunicipalityAssist').checked = !!cert.certMunicipalityAssist;
                if (cert.certMunicipalityAssist) {
                    document.getElementById('certMunicipalityArea').style.display = '';
                    document.getElementById('certMuniOrgNo').value = cert.certMuniOrgNo || '';
                    document.getElementById('certMuniRate').value = cert.certMuniRate || '';
                    document.getElementById('certMuniAmount').value = cert.certMuniAmount || '';
                    document.getElementById('certMuniMax').value = cert.certMuniMax || '';
                    document.getElementById('certMuniGrant').value = cert.certMuniGrant || '';
                    document.getElementById('certGrantFrom').value = cert.certGrantFrom || '';
                    document.getElementById('certGrantTo').value = cert.certGrantTo || '';
                }
            }
            // toggle listeners
            document.getElementById('certSpecialDisabled').onchange = function() {
                document.getElementById('certSpecialDisabledArea').style.display = this.checked ? '' : 'none';
            };
            document.getElementById('certMunicipalityAssist').onchange = function() {
                document.getElementById('certMunicipalityArea').style.display = this.checked ? '' : 'none';
            };
        }

        function cancelCertificateForm() {
            document.getElementById('certificateForm').style.display = 'none';
            editingCertIndex = null;
        }

        function saveCertificate() {
            const user = users.find(u => u.id === currentUserId);
            if (!user) return;
            if (!user.certificates) user.certificates = [];

            const cert = {
                certNo: document.getElementById('certNo').value,
                certCityCode: document.getElementById('certCityCode').value,
                certCityName: document.getElementById('certCityName').value,
                certDisabilityType: document.getElementById('certDisabilityType').value,
                certSupportLevel: document.getElementById('certSupportLevel').value,
                certIssueDate: document.getElementById('certIssueDate').value,
                certValidFrom: document.getElementById('certValidFrom').value,
                certValidTo: document.getElementById('certValidTo').value,
                certBurdenLimit: document.getElementById('certBurdenLimit').value,
                certLimitFrom: document.getElementById('certLimitFrom').value,
                certLimitTo: document.getElementById('certLimitTo').value,
                certUpperMgmt: document.getElementById('certUpperMgmt').checked,
                certUpperMgmtOrgNo: document.getElementById('certUpperMgmtOrgNo').value,
                certUpperMgmtOrgName: document.getElementById('certUpperMgmtOrgName').value,
                certSpecialDisabled: document.getElementById('certSpecialDisabled').checked,
                certSpecialAmount: document.getElementById('certSpecialAmount').value,
                certSpecialFrom: document.getElementById('certSpecialFrom').value,
                certSpecialTo: document.getElementById('certSpecialTo').value,
                certMunicipalityAssist: document.getElementById('certMunicipalityAssist').checked,
                certMuniOrgNo: document.getElementById('certMuniOrgNo').value,
                certMuniRate: document.getElementById('certMuniRate').value,
                certMuniAmount: document.getElementById('certMuniAmount').value,
                certMuniMax: document.getElementById('certMuniMax').value,
                certMuniGrant: document.getElementById('certMuniGrant').value,
                certGrantFrom: document.getElementById('certGrantFrom').value,
                certGrantTo: document.getElementById('certGrantTo').value,
                savedAt: new Date().toISOString()
            };

            if (editingCertIndex !== null) {
                user.certificates[editingCertIndex] = cert;
            } else {
                user.certificates.push(cert);
            }

            localStorage.setItem('gh_users', JSON.stringify(users));
            cancelCertificateForm();
            renderCertificateHistory();
            alert('âœ… å—çµ¦è€…è¨¼ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
        }

        function deleteCertificate(index) {
            if (!confirm('ã“ã®å—çµ¦è€…è¨¼å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            const user = users.find(u => u.id === currentUserId);
            if (!user || !user.certificates) return;
            user.certificates.splice(index, 1);
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderCertificateHistory();
        }

        function renderCertificateHistory() {
            const user = users.find(u => u.id === currentUserId);
            const tbody = document.getElementById('certificateHistoryList');
            if (!tbody) return;
            const certs = user && user.certificates ? user.certificates : [];
            if (certs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="padding:20px; color:#aaa; text-align:center;">å—çµ¦è€…è¨¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</td></tr>';
                return;
            }
            // Sort by validFrom descending
            const sorted = certs.map((c,i) => ({...c, _i: i})).sort((a,b) => (b.certValidFrom||'').localeCompare(a.certValidFrom||''));
            const today = new Date().toISOString().slice(0,10);
            const soon = new Date(); soon.setDate(soon.getDate() + 90);
            const soonStr = soon.toISOString().slice(0,10);
            tbody.innerHTML = sorted.map(cert => {
                let rowStyle = 'border-bottom:1px solid #f0f0f0;';
                let expiryBadge = '';
                if (cert.certValidTo) {
                    if (cert.certValidTo < today) {
                        rowStyle += ' background:#fff0f0;';
                        expiryBadge = '<span style="color:red; font-size:0.8em; margin-left:4px;">æœŸé™åˆ‡ã‚Œ</span>';
                    } else if (cert.certValidTo < soonStr) {
                        rowStyle += ' background:#fffbe6;';
                        expiryBadge = '<span style="color:#e65; font-size:0.8em; margin-left:4px;">æœŸé™è¿‘ã„</span>';
                    }
                }
                return `
                <tr style="${rowStyle}">
                    <td style="padding:10px 8px;">${cert.certValidFrom||''}ã€œ${cert.certValidTo||''}${expiryBadge}</td>
                    <td style="padding:10px 8px;">${cert.certIssueDate||''}</td>
                    <td style="padding:10px 8px;">${cert.certNo||''}</td>
                    <td style="padding:10px 8px;">${cert.certSupportLevel||''}</td>
                    <td style="padding:10px 8px; text-align:right;">
                        <button class="btn btn-primary" onclick="showCertificateForm(${cert._i})" style="background:#e91e8c; border-color:#e91e8c; padding:3px 8px; font-size:0.8em; margin-right:3px;">è©³ç´°</button>
                        <button class="btn btn-secondary" onclick="deleteCertificate(${cert._i})" style="padding:3px 8px; font-size:0.8em; margin-right:3px;">å‰Šé™¤</button>
                        <button class="btn btn-secondary" onclick="copyCertificate(${cert._i})" style="padding:3px 8px; font-size:0.8em;">ï½ºï¾‹ï¾Ÿï½°</button>
                    </td>
                </tr>`;
            }).join('');
        }

        function copyCertificate(index) {
            const user = users.find(u => u.id === currentUserId);
            if (!user || !user.certificates || !user.certificates[index]) return;
            const copy = JSON.parse(JSON.stringify(user.certificates[index]));
            copy.certValidFrom = '';
            copy.certValidTo = '';
            copy.certIssueDate = '';
            copy.savedAt = '';
            user.certificates.push(copy);
            localStorage.setItem('gh_users', JSON.stringify(users));
            showCertificateForm(user.certificates.length - 1);
            renderCertificateHistory();
        }

        // ===== åŸºæœ¬æƒ…å ±â‘¡ =====
        function renderBasic2() {
            const user = users.find(u => u.id === currentUserId);
            if (!user) return;
            // ç·Šæ€¥é€£çµ¡å…ˆ
            const ecList = document.getElementById('emergencyContactList');
            if (ecList) {
                const ecs = user.emergencyContacts || [];
                ecList.innerHTML = ecs.length === 0 ? '<p style="color:#aaa; font-size:0.9em;">ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>' :
                    ecs.map((ec, i) => `
                        <div style="padding:12px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:start;">
                            <div style="font-size:0.9em;">
                                <p>æ°å: ${ec.name||''}&nbsp;&nbsp;&nbsp;ç¶šæŸ„: ${ec.relationship||''}</p>
                                <p>é›»è©±: ${ec.tel||''}</p>
                                ${ec.address?`<p>ä½æ‰€: ${ec.address}</p>`:''}
                                ${ec.note?`<p>å‚™è€ƒ: ${ec.note}</p>`:''}
                            </div>
                            <div style="display:flex; gap:6px;">
                                <button class="btn btn-primary" onclick="editEmergencyContact(${i})" style="background:#e91e8c; border-color:#e91e8c; padding:3px 8px; font-size:0.8em;">ç·¨é›†</button>
                                <button class="btn btn-secondary" onclick="deleteEmergencyContact(${i})" style="padding:3px 8px; font-size:0.8em;">å‰Šé™¤</button>
                            </div>
                        </div>`).join('');
            }
            // ã‹ã‹ã‚Šã¤ã‘åŒ»ç™‚æ©Ÿé–¢
            const mfList = document.getElementById('medicalFacilityList');
            if (mfList) {
                const mfs = user.medicalFacilities || [];
                mfList.innerHTML = mfs.length === 0 ? '<p style="color:#aaa; font-size:0.9em;">ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>' :
                    mfs.map((mf, i) => `
                        <div style="padding:12px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:start;">
                            <div style="font-size:0.9em;">
                                <p>åŒ»ç™‚æ©Ÿé–¢å: ${mf.name||''}&nbsp;&nbsp;&nbsp;ä¸»æ²»åŒ»: ${mf.doctor||''}</p>
                                <p>é›»è©±ç•ªå·: ${mf.tel||''}</p>
                                ${mf.address?`<p>ä½æ‰€: ${mf.address}</p>`:''}
                            </div>
                            <div style="display:flex; gap:6px;">
                                <button class="btn btn-primary" onclick="editMedicalFacility(${i})" style="background:#e91e8c; border-color:#e91e8c; padding:3px 8px; font-size:0.8em;">ç·¨é›†</button>
                                <button class="btn btn-secondary" onclick="deleteMedicalFacility(${i})" style="padding:3px 8px; font-size:0.8em;">å‰Šé™¤</button>
                            </div>
                        </div>`).join('');
            }
            // æ€§æ ¼ãƒ»è¶£å‘³
            const pi = document.getElementById('personalityInfo');
            if (pi) pi.textContent = user.personality || '';
        }

        function addEmergencyContact() {
            const name = prompt('æ°å:');
            if (name === null) return;
            const rel = prompt('ç¶šæŸ„:') || '';
            const tel = prompt('é›»è©±:') || '';
            const user = users.find(u => u.id === currentUserId);
            if (!user.emergencyContacts) user.emergencyContacts = [];
            user.emergencyContacts.push({ name, relationship: rel, tel });
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderBasic2();
        }
        function editEmergencyContact(i) {
            const user = users.find(u => u.id === currentUserId);
            const ec = user.emergencyContacts[i];
            ec.name = prompt('æ°å:', ec.name) || ec.name;
            ec.relationship = prompt('ç¶šæŸ„:', ec.relationship) || ec.relationship;
            ec.tel = prompt('é›»è©±:', ec.tel) || ec.tel;
            ec.address = prompt('ä½æ‰€:', ec.address||'') || ec.address || '';
            ec.note = prompt('å‚™è€ƒ:', ec.note||'') || ec.note || '';
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderBasic2();
        }
        function deleteEmergencyContact(i) {
            if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            const user = users.find(u => u.id === currentUserId);
            user.emergencyContacts.splice(i, 1);
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderBasic2();
        }
        function addMedicalFacility() {
            const name = prompt('åŒ»ç™‚æ©Ÿé–¢å:');
            if (name === null) return;
            const doctor = prompt('ä¸»æ²»åŒ»:') || '';
            const tel = prompt('é›»è©±ç•ªå·:') || '';
            const address = prompt('ä½æ‰€:') || '';
            const user = users.find(u => u.id === currentUserId);
            if (!user.medicalFacilities) user.medicalFacilities = [];
            user.medicalFacilities.push({ name, doctor, tel, address });
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderBasic2();
        }
        function editMedicalFacility(i) {
            const user = users.find(u => u.id === currentUserId);
            const mf = user.medicalFacilities[i];
            mf.name = prompt('åŒ»ç™‚æ©Ÿé–¢å:', mf.name) || mf.name;
            mf.doctor = prompt('ä¸»æ²»åŒ»:', mf.doctor) || mf.doctor;
            mf.tel = prompt('é›»è©±ç•ªå·:', mf.tel) || mf.tel;
            mf.address = prompt('ä½æ‰€:', mf.address||'') || mf.address || '';
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderBasic2();
        }
        function deleteMedicalFacility(i) {
            if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            const user = users.find(u => u.id === currentUserId);
            user.medicalFacilities.splice(i, 1);
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderBasic2();
        }
        function editPersonality() {
            const user = users.find(u => u.id === currentUserId);
            const val = prompt('æ€§æ ¼ãƒ»è¶£å‘³ãªã©:', user.personality||'');
            if (val === null) return;
            user.personality = val;
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderBasic2();
        }
        function addMoveInHistory() {
            const val = prompt('å…¥å±…å‰ã®çŠ¶æ³ãƒ»æˆè‚²æ­´:');
            if (val === null) return;
            const user = users.find(u => u.id === currentUserId);
            if (!user.moveInHistory) user.moveInHistory = [];
            user.moveInHistory.push({ content: val, date: new Date().toISOString() });
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderBasic2();
        }

        // ===== æ—¢å¾€æ­´ãƒ»æœè–¬ =====
        function renderMedical() {
            const user = users.find(u => u.id === currentUserId);
            if (!user) return;
            const dl = document.getElementById('diseaseList');
            if (dl) {
                const diseases = user.diseases || [];
                dl.innerHTML = diseases.length === 0
                    ? '<tr><td colspan="5" style="padding:10px; color:#aaa; font-size:0.9em;">ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>'
                    : diseases.map((d, i) => `
                        <tr style="border-bottom:1px solid #f0f0f0;">
                            <td style="padding:8px;">${d.name||''}</td>
                            <td style="padding:8px;">${d.onsetDate||''}</td>
                            <td style="padding:8px;">${d.hospital||''}</td>
                            <td style="padding:8px;">${d.note||''}</td>
                            <td style="padding:8px; text-align:right; display:flex; gap:4px;">
                                <button class="btn btn-primary" onclick="editDisease(${i})" style="background:#e91e8c; border-color:#e91e8c; padding:3px 8px; font-size:0.8em;">ç·¨é›†</button>
                                <button class="btn btn-secondary" onclick="deleteDisease(${i})" style="padding:3px 8px; font-size:0.8em;">å‰Šé™¤</button>
                            </td>
                        </tr>`).join('');
            }
            const mn = document.getElementById('medicalNotes');
            if (mn) mn.textContent = user.medicalNotes || '';
        }
        function addDisease() {
            const name = prompt('ç—…å:');
            if (name === null) return;
            const onsetDate = prompt('ç™ºç—‡å¹´æœˆæ—¥ (ä¾‹: 2020/01/01):') || '';
            const hospital = prompt('åŒ»ç™‚æ©Ÿé–¢å:') || '';
            const note = prompt('å‚™è€ƒ:') || '';
            const user = users.find(u => u.id === currentUserId);
            if (!user.diseases) user.diseases = [];
            user.diseases.push({ name, onsetDate, hospital, note });
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderMedical();
        }
        function editDisease(i) {
            const user = users.find(u => u.id === currentUserId);
            const d = user.diseases[i];
            d.name = prompt('ç—…å:', d.name) || d.name;
            d.onsetDate = prompt('ç™ºç—‡å¹´æœˆæ—¥:', d.onsetDate||'') || d.onsetDate || '';
            d.hospital = prompt('åŒ»ç™‚æ©Ÿé–¢å:', d.hospital||'') || d.hospital || '';
            d.note = prompt('å‚™è€ƒ:', d.note||'') || d.note || '';
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderMedical();
        }
        function deleteDisease(i) {
            if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            const user = users.find(u => u.id === currentUserId);
            user.diseases.splice(i, 1);
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderMedical();
        }
        function addMedicine() {
            const name = prompt('è–¬å“å:');
            if (name === null) return;
            const dose = prompt('ç”¨é‡:') || '';
            const user = users.find(u => u.id === currentUserId);
            if (!user.medicines) user.medicines = [];
            user.medicines.push({ name, dose });
            localStorage.setItem('gh_users', JSON.stringify(users));
            const ml = document.getElementById('medicineList');
            if (ml) ml.innerHTML = (user.medicines||[]).map((m,i)=>`<div style="padding:8px; border-bottom:1px solid #eee;">${m.name} ${m.dose}</div>`).join('');
        }
        function editMedicalNotes() {
            const user = users.find(u => u.id === currentUserId);
            const val = prompt('ç•™æ„ç‚¹ï¼ç‰¹è¨˜äº‹é …:', user.medicalNotes||'');
            if (val === null) return;
            user.medicalNotes = val;
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderMedical();
        }

        // ===== å¥‘ç´„æƒ…å ± =====
        function addContract() {
            const svcStart = prompt('ã‚µãƒ¼ãƒ“ã‚¹é–‹å§‹æ—¥ (ä¾‹: 2023/11/01):');
            if (svcStart === null) return;
            const contractStart = prompt('å¥‘ç´„é–‹å§‹æ—¥:') || svcStart;
            const user = users.find(u => u.id === currentUserId);
            if (!user.contracts) user.contracts = [];
            user.contracts.push({
                svcStart, trialStart:'', trialEnd:'',
                contractStart, contractEnd:'', svcEnd:'',
                selfSupportLeave:'', selfSupportAfter:'',
                transitionMoveIn:'',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            });
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderContractList();
        }

        function renderContractList() {
            const user = users.find(u => u.id === currentUserId);
            const tbody = document.getElementById('contractList');
            if (!tbody) return;
            const contracts = user && user.contracts ? user.contracts : [];
            if (contracts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="padding:20px; color:#aaa; text-align:center;">å¥‘ç´„æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }
            tbody.innerHTML = contracts.map((c, i) => `
                <tr style="border-bottom:1px solid #f0f0f0;">
                    <td style="padding:10px 8px;">${c.svcStart||''}</td>
                    <td style="padding:10px 8px;">${c.trialStart||''}</td>
                    <td style="padding:10px 8px;">${c.contractStart||''}</td>
                    <td style="padding:10px 8px; font-size:0.85em;">${c.updatedAt ? new Date(c.updatedAt).toLocaleString('ja-JP') : ''}</td>
                    <td style="padding:10px 8px; text-align:right;">
                        <button class="btn btn-primary" onclick="showContractDetail(${i})" style="background:#e91e8c; border-color:#e91e8c; padding:3px 8px; font-size:0.8em; margin-right:3px;">è©³ç´°</button>
                        <button class="btn btn-secondary" onclick="deleteContract(${i})" style="padding:3px 8px; font-size:0.8em; margin-right:3px;">å‰Šé™¤</button>
                        <select style="padding:3px; font-size:0.8em; border:1px solid #ddd; border-radius:4px;" onchange="this.value=''">
                            <option value="">æ–°è¦ âˆ¨</option>
                            <option value="new">æ–°è¦</option>
                            <option value="end">çµ‚äº†</option>
                        </select>
                        <button class="btn btn-secondary" onclick="alert('å ±å‘Šæ›¸æ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™')" style="background:#e91e8c; border-color:#e91e8c; color:white; padding:3px 8px; font-size:0.8em;">å ±å‘Šæ›¸</button>
                    </td>
                </tr>
            `).join('');
        }

        function showContractDetail(i) {
            const user = users.find(u => u.id === currentUserId);
            const c = user.contracts[i];
            const div = document.getElementById('contractDetail');
            div.style.display = '';
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:start;">
                    <div style="font-size:0.9em; line-height:2;">
                        <p>ã‚µãƒ¼ãƒ“ã‚¹é–‹å§‹æ—¥ï¼ˆä½“é¨“åŠã³æœ¬å…¥å±…é–‹å§‹æ—¥ï¼‰ï¼š${c.svcStart||''}</p>
                        <p>ä½“é¨“é–‹å§‹æ—¥ï¼š${c.trialStart||''}</p>
                        <p>ä½“é¨“çµ‚äº†æ—¥ï¼š${c.trialEnd||''}</p>
                        <p>å¥‘ç´„é–‹å§‹æ—¥ï¼š${c.contractStart||''}</p>
                        <p>å¥‘ç´„çµ‚äº†æ—¥ï¼š${c.contractEnd||''}</p>
                        <p>ã‚µãƒ¼ãƒ“ã‚¹çµ‚äº†æ—¥ï¼š${c.svcEnd||''}</p>
                        <p>ï¼ˆè‡ªç«‹ç”Ÿæ´»æ”¯æ´ï¼‰é€€å»æ—¥ï¼š${c.selfSupportLeave||''}</p>
                        <p>ï¼ˆè‡ªç«‹ç”Ÿæ´»æ”¯æ´ï¼‰é€€å»å¾Œç®—å®šæ—¥ï¼š${c.selfSupportAfter||''}</p>
                        <p>ç§»è¡Œæ”¯æ´ä½å±…ã®å…¥å±…æ—¥ï¼š${c.transitionMoveIn||''}</p>
                        <p>æ›´æ–°æ—¥æ™‚ï¼š${c.updatedAt ? new Date(c.updatedAt).toLocaleString('ja-JP') : ''}</p>
                    </div>
                    <button class="btn btn-primary" onclick="editContract(${i})" style="background:#e91e8c; border-color:#e91e8c; padding:4px 10px; font-size:0.85em;">ç·¨é›†</button>
                </div>
            `;
        }

        function editContract(i) {
            const user = users.find(u => u.id === currentUserId);
            const c = user.contracts[i];
            c.svcStart = prompt('ã‚µãƒ¼ãƒ“ã‚¹é–‹å§‹æ—¥:', c.svcStart||'') || c.svcStart || '';
            c.trialStart = prompt('ä½“é¨“é–‹å§‹æ—¥:', c.trialStart||'') || c.trialStart || '';
            c.contractStart = prompt('å¥‘ç´„é–‹å§‹æ—¥:', c.contractStart||'') || c.contractStart || '';
            c.contractEnd = prompt('å¥‘ç´„çµ‚äº†æ—¥:', c.contractEnd||'') || c.contractEnd || '';
            c.svcEnd = prompt('ã‚µãƒ¼ãƒ“ã‚¹çµ‚äº†æ—¥:', c.svcEnd||'') || c.svcEnd || '';
            c.updatedAt = new Date().toISOString();
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderContractList();
            showContractDetail(i);
        }

        function deleteContract(i) {
            if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            const user = users.find(u => u.id === currentUserId);
            user.contracts.splice(i, 1);
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderContractList();
            document.getElementById('contractDetail').style.display = 'none';
        }

        // ===== åˆ©ç”¨è€…å±¥æ­´æƒ…å ± =====
        function renderUserHistory() {
            const user = users.find(u => u.id === currentUserId);
            const div = document.getElementById('userHistoryContent');
            if (!div || !user) return;
            const hist = user.userHistory || {basic:{}, calc:{}};
            const allKeys = new Set([...Object.keys(hist.basic||{}), ...Object.keys(hist.calc||{})]);
            if (allKeys.size === 0) {
                div.innerHTML = '<p style="color:#aaa;">å¤‰æ›´å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            // å¹´ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const byYear = {};
            allKeys.forEach(k => {
                const [y] = k.split('-');
                if (!byYear[y]) byYear[y] = new Set();
                byYear[y].add(k);
            });
            const years = Object.keys(byYear).sort((a,b)=>b-a);
            const rows = ['basic','calc'];
            const rowLabels = {basic:'åŸºæœ¬æƒ…å ±', calc:'ç®—å®šæƒ…å ±'};

            let html = '';
            // æœ€æ–°å¹´ï¼ˆç¾åœ¨å¹´ï¼‰ã¯å…ˆé ­ã«åˆ†ã‘ã¦è¡¨ç¤º
            const latestYear = years[0];
            rows.forEach(row => {
                const months = [...byYear[latestYear]].filter(k => hist[row] && hist[row][k]).sort();
                if (months.length > 0) {
                    html += `<div style="display:flex; gap:10px; align-items:center; margin-bottom:8px; flex-wrap:wrap;">
                        <span style="width:70px; font-size:0.85em; color:#555; flex-shrink:0;">${rowLabels[row]}</span>
                        ${months.map(k => {
                            const [y, m] = k.split('-');
                            return `<span class="history-link" onclick="viewUserHistory('${row}','${k}')">${y}å¹´${parseInt(m)}æœˆ</span>`;
                        }).join('')}
                    </div>`;
                }
            });

            // æ®‹ã‚Šå¹´
            years.slice(1).forEach(year => {
                html += '<hr style="margin:12px 0; border:none; border-top:1px solid #eee;">';
                rows.forEach(row => {
                    const months = [...byYear[year]].filter(k => hist[row] && hist[row][k]).sort();
                    if (months.length > 0) {
                        html += `<div style="display:flex; gap:10px; align-items:center; margin-bottom:8px; flex-wrap:wrap;">
                            <span style="width:70px; font-size:0.85em; color:#555; flex-shrink:0;">${rowLabels[row]}</span>
                            ${months.map(k => {
                                const [y, m] = k.split('-');
                                return `<span class="history-link" onclick="viewUserHistory('${row}','${k}')">${y}å¹´${parseInt(m)}æœˆ</span>`;
                            }).join('')}
                        </div>`;
                    }
                });
            });

            div.innerHTML = html;
        }

        function viewUserHistory(type, key) {
            const user = users.find(u => u.id === currentUserId);
            if (!user || !user.userHistory || !user.userHistory[type] || !user.userHistory[type][key]) return;
            const data = user.userHistory[type][key];
            const [y, m] = key.split('-');
            let msg = `ã€${user.name} - ${type==='basic'?'åŸºæœ¬æƒ…å ±':'ç®—å®šæƒ…å ±'} ${y}å¹´${parseInt(m)}æœˆã€‘\n`;
            msg += `ä¿å­˜æ—¥æ™‚: ${data.savedAt ? new Date(data.savedAt).toLocaleString('ja-JP') : 'ä¸æ˜'}\n\n`;
            const labels = {name:'æ°å', unit:'ãƒ¦ãƒ‹ãƒƒãƒˆ', room:'éƒ¨å±‹', status:'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', gender:'æ€§åˆ¥', birthdate:'ç”Ÿå¹´æœˆæ—¥', mobile:'æºå¸¯'};
            Object.entries(labels).forEach(([k,l]) => {
                if (data[k]) msg += `${l}: ${data[k]}\n`;
            });
            alert(msg);
        }

        function resetUserForm() {}

        function getUnitName(unitId) {
            const building = buildings.find(b => b.id === unitId);
            return building ? building.name : (unitId || 'æœªè¨­å®š');
        }

        function getSupportLevelName(level) {
            const levels = { '21':'åŒºåˆ†1','22':'åŒºåˆ†2','23':'åŒºåˆ†3','24':'åŒºåˆ†4','25':'åŒºåˆ†5','26':'åŒºåˆ†6' };
            return levels[level] || 'ãªã—';
        }

        function updateUserSelector() {
            const select = document.getElementById('recordUser');
            select.innerHTML = '<option value="">åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</option>' +
                users.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
        }

        // ========== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»å®Ÿç¸¾è¨˜éŒ² ==========

        function updateCalendar() {
            const calendar = document.getElementById('calendar');
            const monthLabel = document.getElementById('currentMonth');
            
            const date = new Date(currentYear, currentMonth, 1);
            monthLabel.textContent = `${currentYear}å¹´ ${currentMonth + 1}æœˆ`;

            const firstDay = date.getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            let html = '<div class="calendar-grid">';
            
            ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'].forEach(day => {
                html += `<div class="calendar-day header">${day}</div>`;
            });

            for (let i = 0; i < firstDay; i++) {
                html += '<div class="calendar-day disabled"></div>';
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const record = getRecord(selectedUserId, dateStr);
                
                const statusClass = record ? getStatusClass(record.status) : '';
                const statusText = record ? (record.status || '') : '';
                // å¤œé–“æ”¯æ´åŠ ç®—ã®ç•¥ç§°è¡¨ç¤º
                let nightText = '';
                if (record && record.nightSupport) {
                    const m = record.nightSupport.match(/å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆ(.+?)ï¼‰(.+)?/);
                    nightText = m ? `å¤œ(${m[1]})` : '';
                }

                html += '<div class="calendar-day" onclick="openDateModal(\'' + dateStr + '\')">' +
                    '<div class="day-number">' + day + '</div>' +
                    (statusText ? '<div class="day-status ' + statusClass + '">' + statusText + '</div>' : '') +
                    (nightText ? '<div style="font-size:0.65em; color:#667eea; margin-top:2px;">' + nightText + '</div>' : '') +
                    '</div>';
            }

            html += '</div>';
            calendar.innerHTML = html;
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            updateCalendar();
        }

        function loadRecords() {
            selectedUserId = document.getElementById('recordUser').value;
            updateCalendar();
        }

        function fillMonth(status) {
            if (!selectedUserId) {
                alert('åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (!confirm(`${currentYear}å¹´${currentMonth + 1}æœˆã®å…¨ã¦ã®æ—¥ã‚’ã€Œ${status}ã€ã§åŸ‹ã‚ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }

            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            if (!records[selectedUserId]) {
                records[selectedUserId] = {};
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                records[selectedUserId][dateStr] = { status, date: dateStr };
            }

            localStorage.setItem('gh_records', JSON.stringify(records));
            updateCalendar();
            alert(`âœ… ${currentYear}å¹´${currentMonth + 1}æœˆã‚’ã€Œ${status}ã€ã§åŸ‹ã‚ã¾ã—ãŸ`);
        }

        function clearMonth() {
            if (!selectedUserId) {
                alert('åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (!confirm(`${currentYear}å¹´${currentMonth + 1}æœˆã®è¨˜éŒ²ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }

            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            if (records[selectedUserId]) {
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    delete records[selectedUserId][dateStr];
                }
            }

            localStorage.setItem('gh_records', JSON.stringify(records));
            updateCalendar();
            alert(`âœ… ${currentYear}å¹´${currentMonth + 1}æœˆã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
        }

        function getStatusClass(status) {
            if (status === 'â—‹' || status === 'â—‹ï¼ˆæœ¬å…¥å±…ï¼‰') return 'status-ok';
            if (status.includes('å¤–æ³Š')) return 'status-away';
            if (status.includes('å…¥é™¢')) return 'status-hospital';
            return '';
        }

        function getRecord(userId, date) {
            if (!userId || !records[userId]) return null;
            return records[userId][date];
        }

        function openDateModal(dateStr) {
            if (!selectedUserId) {
                alert('åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            selectedDate = dateStr;

            // ç™»éŒ²æ—¥ã‚’é¸æŠã—ãŸæ—¥ä»˜ã«åˆæœŸè¨­å®š
            document.getElementById('modalDateFrom').value = dateStr;
            document.getElementById('modalDateTo').value = dateStr;

            // æ›œæ—¥ãƒã‚§ãƒƒã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.modalDow').forEach(cb => cb.checked = false);

            // ä¸Šæ›¸ããƒã‚§ãƒƒã‚¯
            document.getElementById('modalOverwrite').checked = true;

            // å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼šå»ºç‰©è¨­å®šã‹ã‚‰é¸æŠè‚¢ã‚’ç”Ÿæˆ
            const user = users.find(u => u.id === selectedUserId);
            const building = user ? buildings.find(b => b.id === user.unit) : null;
            const nightSelect = document.getElementById('modalNightSupport');
            const nightHint = document.getElementById('modalNightHint');
            nightSelect.innerHTML = '<option value="">ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>';
            if (building && building.nightSupportType) {
                // å»ºç‰©è¨­å®šå€¤ã‚’å…ˆé ­ã«è¡¨ç¤º
                const opt = document.createElement('option');
                opt.value = building.nightSupportType;
                opt.textContent = building.nightSupportType;
                nightSelect.appendChild(opt);
                nightHint.textContent = 'å»ºç‰©è¨­å®šï¼š' + building.nightSupportType;
            } else {
                nightHint.textContent = 'å»ºç‰©è¨­å®šãªã—';
            }
            // äº‹æ¥­æ‰€ã®å¤œé–“æ”¯æ´è¨­å®šã‚‚è¿½åŠ 
            if (facility.nightSupportType1) {
                const opt = document.createElement('option');
                opt.value = facility.nightSupportType1;
                opt.textContent = facility.nightSupportType1;
                nightSelect.appendChild(opt);
            }
            if (facility.nightSupportType3) {
                const opt = document.createElement('option');
                opt.value = facility.nightSupportType3;
                opt.textContent = facility.nightSupportType3;
                nightSelect.appendChild(opt);
            }

            // æ—¥ä¸­æ”¯æ´åŠ ç®—ãƒ’ãƒ³ãƒˆ
            const daytimeHint = document.getElementById('modalDaytimeHint');
            if (facility.daySupport) {
                daytimeHint.textContent = 'äº‹æ¥­æ‰€è¨­å®šï¼š' + facility.daySupport;
            } else {
                daytimeHint.textContent = '';
            }

            // æ—¢å­˜è¨˜éŒ²ãŒã‚ã‚Œã°èª­ã¿è¾¼ã‚€
            const record = getRecord(selectedUserId, dateStr);
            if (record) {
                document.getElementById('modalStatus').value = record.status || '';
                document.getElementById('modalNightSupport').value = record.nightSupport || '';
                document.getElementById('modalDaytimeSupport').value = record.daytimeSupport || '';
                document.getElementById('modalMedicalCoop').value = record.medicalCoop || '';
                document.getElementById('modalSelfSupport').value = record.selfSupport || '';
                document.getElementById('modalNote').value = record.note || '';
                document.getElementById('modalInpatientSupport').checked = !!record.inpatientSupport;
                document.getElementById('modalReturnSupport').checked = !!record.returnSupport;
                document.getElementById('modalLongInpatient').checked = !!record.longInpatient;
                document.getElementById('modalLongReturn').checked = !!record.longReturn;
                document.getElementById('modalHomeCare').checked = !!record.homeCare;
                document.getElementById('modalIntensive').value = record.intensive || '';
                document.getElementById('modalAfterLeave').checked = !!record.afterLeave;
                document.getElementById('modalPeerSupport').checked = !!record.peerSupport;
                document.getElementById('modalAfterPeer').checked = !!record.afterPeer;
                document.getElementById('modalInfection').checked = !!record.infection;
                document.getElementById('modalStaffArrangement').checked = !!record.staffArrangement;
            } else {
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚¯ãƒªã‚¢
                ['modalStatus','modalNightSupport','modalDaytimeSupport','modalMedicalCoop','modalSelfSupport','modalNote','modalIntensive'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });
                ['modalInpatientSupport','modalReturnSupport','modalLongInpatient','modalLongReturn','modalHomeCare','modalAfterLeave','modalPeerSupport','modalAfterPeer','modalInfection','modalStaffArrangement'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.checked = false;
                });
            }

            // ãã®ä»–é …ç›®ã¯éš ã™
            document.getElementById('modalExtraItems').style.display = 'none';
            const collapseBtn = document.querySelector('.modal-collapse-btn');
            if (collapseBtn) collapseBtn.textContent = 'ãã®ä»–ã®é …ç›®ã‚’è¡¨ç¤º';

            document.getElementById('dateModal').classList.add('active');
        }

        function toggleModalExtra() {
            const el = document.getElementById('modalExtraItems');
            const btn = document.querySelector('.modal-collapse-btn');
            if (el.style.display === 'none' || el.style.display === '') {
                el.style.display = 'block';
                if (btn) btn.textContent = 'ãã®ä»–ã®é …ç›®ã‚’éš ã™';
            } else {
                el.style.display = 'none';
                if (btn) btn.textContent = 'ãã®ä»–ã®é …ç›®ã‚’è¡¨ç¤º';
            }
        }

        function closeModal() {
            document.getElementById('dateModal').classList.remove('active');
        }

        function saveRecord() {
            if (!selectedUserId) return;

            const dateFrom = document.getElementById('modalDateFrom').value;
            const dateTo = document.getElementById('modalDateTo').value;
            const overwrite = document.getElementById('modalOverwrite').checked;

            if (!dateFrom || !dateTo) {
                alert('ç™»éŒ²æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // ç™»éŒ²æ›œæ—¥ã®å–å¾—ï¼ˆãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„å ´åˆã¯å…¨æ›œæ—¥ï¼‰
            const checkedDows = [...document.querySelectorAll('.modalDow:checked')].map(cb => parseInt(cb.value));

            const recordData = {
                status: document.getElementById('modalEnableStatus').checked ? document.getElementById('modalStatus').value : '',
                nightSupport: document.getElementById('modalEnableNight').checked ? document.getElementById('modalNightSupport').value : '',
                daytimeSupport: document.getElementById('modalEnableDaytime').checked ? document.getElementById('modalDaytimeSupport').value : '',
                medicalCoop: document.getElementById('modalEnableMedical').checked ? document.getElementById('modalMedicalCoop').value : '',
                selfSupport: document.getElementById('modalEnableSelfSupport').checked ? document.getElementById('modalSelfSupport').value : '',
                note: document.getElementById('modalEnableNote').checked ? document.getElementById('modalNote').value : '',
                inpatientSupport: document.getElementById('modalInpatientSupport').checked,
                returnSupport: document.getElementById('modalReturnSupport').checked,
                longInpatient: document.getElementById('modalLongInpatient').checked,
                longReturn: document.getElementById('modalLongReturn').checked,
                homeCare: document.getElementById('modalHomeCare').checked,
                intensive: document.getElementById('modalEnableIntensive').checked ? document.getElementById('modalIntensive').value : '',
                afterLeave: document.getElementById('modalAfterLeave').checked,
                peerSupport: document.getElementById('modalPeerSupport').checked,
                afterPeer: document.getElementById('modalAfterPeer').checked,
                infection: document.getElementById('modalInfection').checked,
                staffArrangement: document.getElementById('modalStaffArrangement').checked
            };

            if (!records[selectedUserId]) records[selectedUserId] = {};

            // ç™»éŒ²æœŸé–“ã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦ä¿å­˜
            let d = new Date(dateFrom);
            const end = new Date(dateTo);
            let count = 0;
            while (d <= end) {
                const dow = d.getDay();
                const skip = checkedDows.length > 0 && !checkedDows.includes(dow);
                if (!skip) {
                    const dateStr = d.toISOString().slice(0, 10);
                    if (overwrite || !records[selectedUserId][dateStr]) {
                        records[selectedUserId][dateStr] = { ...recordData, date: dateStr };
                        count++;
                    }
                }
                d.setDate(d.getDate() + 1);
            }

            localStorage.setItem('gh_records', JSON.stringify(records));
            updateCalendar();
            closeModal();
            alert(`âœ… ${count}ä»¶ã®è¨˜éŒ²ã‚’ç™»éŒ²ã—ã¾ã—ãŸ`);
        }

        // ========== CSVå‡ºåŠ› ==========

        // ===== å®Ÿç¸¾è¨˜éŒ²ã®ä¿å­˜ç¢ºèª =====
        function confirmSaveAllRecords() {
            if (!selectedUserId) {
                alert('åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            const user = users.find(u => u.id === selectedUserId);
            const userName = user ? user.name : '';
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const prefix = currentYear + '-' + String(currentMonth + 1).padStart(2, '0');
            const count = records[selectedUserId]
                ? Object.keys(records[selectedUserId]).filter(d => d.startsWith(prefix)).length
                : 0;
            if (confirm(userName + ' ã® ' + currentYear + 'å¹´' + (currentMonth+1) + 'æœˆ ã®å®Ÿç¸¾ï¼ˆ' + count + 'ä»¶ï¼‰ã‚’ä¿å­˜æ¸ˆã¿ã§ã™ã€‚\n\nè¨˜éŒ²ã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚')) {
                alert('âœ… ' + userName + ' ã® ' + currentYear + 'å¹´' + (currentMonth+1) + 'æœˆã®å®Ÿç¸¾è¨˜éŒ²ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚');
            }
        }

        // ===== è«‹æ±‚ãƒ‡ãƒ¼ã‚¿å‡ºåŠ› =====
        function renderExportUserList() {
            const div = document.getElementById('exportUserList');
            if (!div) return;
            if (users.length === 0) {
                div.innerHTML = '<p style="color:#aaa; font-size:0.85em;">åˆ©ç”¨è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
                return;
            }
            div.innerHTML = users.map(u =>
                '<label style="display:flex; align-items:center; gap:6px; padding:5px 10px; background:white; border:1px solid #ddd; border-radius:20px; cursor:pointer; font-size:0.85em; white-space:nowrap;">' +
                '<input type="checkbox" class="exportUserCheck" value="' + u.id + '" checked>' +
                u.name +
                '</label>'
            ).join('');
        }

        function selectAllExportUsers(val) {
            document.querySelectorAll('.exportUserCheck').forEach(cb => cb.checked = val);
        }

        function getSelectedExportUsers() {
            const checked = [...document.querySelectorAll('.exportUserCheck:checked')].map(cb => cb.value);
            return users.filter(u => checked.includes(u.id));
        }

        function exportCSV(type) {
            const month = document.getElementById('exportMonth').value;
            if (!month) { alert('å¯¾è±¡å¹´æœˆã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
            const [year, mon] = month.split('-');
            const targetUsers = getSelectedExportUsers();
            if (targetUsers.length === 0) { alert('å‡ºåŠ›å¯¾è±¡ã®åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
            if (type === 'SE') generateSE(year, mon, targetUsers);
            else if (type === 'SV') generateSV(year, mon, targetUsers);
            else if (type === 'RK') {
                alert('RKï¼ˆåˆ©ç”¨è€…è² æ‹…ä¸Šé™é¡ç®¡ç†çµæœç¥¨ï¼‰ã¯ä¸Šé™é¡ç®¡ç†å¯¾è±¡è€…ãŒã„ã‚‹å ´åˆã«ä½¿ç”¨ã—ã¾ã™ã€‚\nç¾åœ¨ã“ã®CSVã®è‡ªå‹•ç”Ÿæˆã¯æº–å‚™ä¸­ã§ã™ã€‚');
            }
        }

        function exportPDF(type) {
            const month = document.getElementById('exportMonth').value;
            if (!month) { alert('å¯¾è±¡å¹´æœˆã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
            document.getElementById('exportStatus').innerHTML =
                '<div class="alert alert-info">â„¹ï¸ ' + type + ' ã®PDFå‡ºåŠ›æ©Ÿèƒ½ã¯ç¾åœ¨æº–å‚™ä¸­ã§ã™ã€‚</div>';
        }

        function exportExcel(type) {
            const month = document.getElementById('exportMonth').value;
            if (!month) { alert('å¯¾è±¡å¹´æœˆã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
            document.getElementById('exportStatus').innerHTML =
                '<div class="alert alert-info">â„¹ï¸ ' + type + ' ã®Excelå‡ºåŠ›æ©Ÿèƒ½ã¯ç¾åœ¨æº–å‚™ä¸­ã§ã™ã€‚</div>';
        }

        function generateSE(year, month, targetUsers) {
            let csv = '"1","1","0","11","J11","0","' + (facility.facilityNumber||'') + '","0","1","' + year + month + '","0"\n';
            let lineNum = 2;
            targetUsers.forEach(user => {
                const recordCount = countRecordsForMonth(user.id, year, month);
                if (recordCount > 0) {
                    const certNo = (user.certificates && user.certificates.length > 0)
                        ? (user.certificates.slice().sort((a,b)=>(b.certValidFrom||'').localeCompare(a.certValidFrom||''))[0].certNo || '')
                        : '';
                    const cityCode = (user.certificates && user.certificates.length > 0)
                        ? (user.certificates.slice().sort((a,b)=>(b.certValidFrom||'').localeCompare(a.certValidFrom||''))[0].certCityCode || '')
                        : '';
                    csv += '"2","' + lineNum + '","J111","01","' + year + month + '","' + cityCode + '","' + (facility.facilityNumber||'') + '","135001","1","10776","125001","125001","0","0","0","1","10000","10000","2","10776","135001","135001","0","0","0"\n';
                    lineNum++;
                }
            });
            csv += '"3","' + lineNum + '"\n';
            downloadCSV(csv, 'SE' + year + month + '.csv');
        }

        function generateSV(year, month, targetUsers) {
            let csv = '"1","1","0","32","J61","0","' + (facility.facilityNumber||'') + '","0","1","' + year + month + '","0"\n';
            let lineNum = 2;
            targetUsers.forEach(user => {
                const monthRecords = getMonthRecords(user.id, year, month);
                if (Object.keys(monthRecords).length > 0) {
                    const certNo = (user.certificates && user.certificates.length > 0)
                        ? (user.certificates.slice().sort((a,b)=>(b.certValidFrom||'').localeCompare(a.certValidFrom||''))[0].certNo || '')
                        : '';
                    const cityCode = (user.certificates && user.certificates.length > 0)
                        ? (user.certificates.slice().sort((a,b)=>(b.certValidFrom||'').localeCompare(a.certValidFrom||''))[0].certCityCode || '')
                        : '';
                    csv += '"2","' + lineNum + '","J611","01","' + year + month + '","' + cityCode + '","' + (facility.facilityNumber||'') + '","' + certNo + '","1801"\n';
                    lineNum++;
                    const daysInMonth = new Date(parseInt(year), parseInt(month), 0).getDate();
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateStr = year + '-' + month.padStart(2,'0') + '-' + String(day).padStart(2,'0');
                        const record = monthRecords[dateStr];
                        const status = record ? (record.status === 'â—‹ï¼ˆæœ¬å…¥å±…ï¼‰' || record.status === 'â—‹' ? '3' : '') : '';
                        csv += '"2","' + lineNum + '","J611","02","' + year + month + '","' + cityCode + '","' + (facility.facilityNumber||'') + '","' + certNo + '","1801","","' + day + '","","","","","","","","","","","","","","","","","","","","","","","","","","","' + status + '"\n';
                        lineNum++;
                    }
                }
            });
            csv += '"3","' + lineNum + '"\n';
            downloadCSV(csv, 'SV' + year + month + '.csv');
        }

        function countRecordsForMonth(userId, year, month) {
            if (!records[userId]) return 0;
            const prefix = year + '-' + month.padStart(2, '0');
            return Object.keys(records[userId]).filter(date => date.startsWith(prefix)).length;
        }

        function getMonthRecords(userId, year, month) {
            if (!records[userId]) return {};
            const prefix = year + '-' + month.padStart(2, '0');
            const monthRecords = {};
            Object.entries(records[userId]).forEach(([date, record]) => {
                if (date.startsWith(prefix)) monthRecords[date] = record;
            });
            return monthRecords;
        }

        function downloadCSV(content, filename) {
            const bom = '\uFEFF';
            const blob = new Blob([bom + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            document.getElementById('exportStatus').innerHTML =
                '<div class="alert alert-success">âœ… ' + filename + ' ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ</div>';
        }
    </script>
</body>
</html>
