<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ è«‹æ±‚ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v4.11</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 120px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            border: none;
            background: transparent;
            font-size: 14px;
        }

        .tab:hover {
            background: #e0e0e0;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .content {
            padding: 30px;
            max-height: calc(100vh - 250px);
            overflow-y: auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
        }

        .checkbox-item label {
            margin: 0;
            font-weight: 500;
            cursor: pointer;
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f9f9f9;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #e6e6ff;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .user-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .user-card {
            border: 2px solid #ddd;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .user-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .user-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .user-card p {
            margin: 5px 0;
            color: #666;
        }

        .calendar {
            margin-top: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: #ddd;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-day {
            background: white;
            padding: 15px;
            min-height: 100px;
            position: relative;
        }

        .calendar-day.header {
            background: #667eea;
            color: white;
            font-weight: 600;
            text-align: center;
            padding: 10px;
            min-height: auto;
        }

        .calendar-day.disabled {
            background: #f5f5f5;
            color: #ccc;
        }

        .day-number {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .day-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 5px;
        }

        .status-ok {
            background: #d4edda;
            color: #155724;
        }

        .status-away {
            background: #fff3cd;
            color: #856404;
        }

        .status-hospital {
            background: #f8d7da;
            color: #721c24;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: flex-start;
            justify-content: center;
            overflow-y: auto;
            padding: 20px 0;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 480px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            font-size: 1.2em;
            font-weight: 700;
            margin-bottom: 16px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            cursor: pointer;
            font-size: 1.2em;
            color: #888;
            background: none;
            border: none;
            padding: 0 4px;
        }

        .modal-section {
            margin-bottom: 14px;
        }

        .modal-label {
            font-size: 0.85em;
            color: #555;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .modal-label input[type=checkbox] {
            width: 16px;
            height: 16px;
        }

        .modal-hint {
            font-size: 0.75em;
            color: #888;
            margin-bottom: 4px;
        }

        .modal select, .modal input[type=text], .modal input[type=date] {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .modal-row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 4px;
        }

        .modal-checkbox-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
        }

        .modal-collapse-btn {
            color: #667eea;
            cursor: pointer;
            font-size: 0.85em;
            text-decoration: underline;
            background: none;
            border: none;
            padding: 4px 0;
        }

        .modal-divider {
            border: none;
            border-top: 1px solid #eee;
            margin: 12px 0;
        }

        .modal-update-bar {
            background: #f0f4ff;
            border-radius: 6px;
            padding: 8px 12px;
            margin-bottom: 12px;
            font-size: 0.82em;
            color: #555;
        }

        .status-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .status-option {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .status-option:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }

        .status-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .progress {
            margin: 20px 0;
            text-align: center;
            color: #667eea;
            font-weight: 600;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }

            .calendar-day {
                min-height: 80px;
                padding: 10px;
            }

            .status-options {
                grid-template-columns: 1fr;
            }

            .tab {
                font-size: 12px;
                padding: 10px 5px;
            }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .section-header {
            font-size: 1.5em;
            font-weight: 600;
            color: #667eea;
            margin: 30px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .subsection-header {
            font-size: 1.2em;
            font-weight: 600;
            color: #495057;
            margin: 25px 0 15px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid #dee2e6;
        }

        .info-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .info-card h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .info-card p {
            margin: 8px 0;
            color: #495057;
        }

        /* å»ºç‰©ç®¡ç† */
        .building-sidebar-item {
            padding: 12px 16px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            background: white;
            transition: all 0.2s;
        }
        .building-sidebar-item:hover { background: #f0f0ff; border-color: #667eea; }
        .building-sidebar-item.active { background: #667eea; color: white; border-color: #667eea; }
        .building-sidebar-item.active small { color: #ddd; }

        .building-inner-tabs { display: flex; border-bottom: 2px solid #dee2e6; margin-bottom: 20px; gap: 4px; }
        .building-inner-tab {
            padding: 8px 18px;
            cursor: pointer;
            border-radius: 6px 6px 0 0;
            background: #f5f5f5;
            border: 1px solid #dee2e6;
            border-bottom: none;
            font-size: 0.9em;
        }
        .building-inner-tab.active { background: white; border-color: #667eea; color: #667eea; font-weight: bold; }

        .building-detail-panel { display: none; }
        .building-detail-panel.active { display: block; }

        .history-grid { display: grid; grid-template-columns: 120px repeat(12, 1fr); gap: 4px; margin-bottom: 16px; }
        .history-grid-year { grid-column: 1; font-weight: bold; padding: 6px; background: #f5f5f5; border-radius: 4px; align-self: start; }
        .history-link { padding: 4px 6px; background: #e8f0fe; color: #667eea; border-radius: 4px; text-align: center; font-size: 0.8em; cursor: pointer; text-decoration: underline; }
        .history-link:hover { background: #667eea; color: white; }
        .history-row-label { font-size: 0.75em; color: #888; margin-bottom: 2px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ  ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ è«‹æ±‚ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v4.11</h1>
            <p>éšœå®³è€…å…±åŒç”Ÿæ´»æ´åŠ©ã‚µãƒ¼ãƒ“ã‚¹</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('facility')">ğŸ¢ äº‹æ¥­æ‰€æƒ…å ±</button>
            <button class="tab" onclick="showTab('buildings')">ğŸ˜ï¸ å»ºç‰©ç®¡ç†</button>
            <button class="tab" onclick="showTab('users')">ğŸ‘¤ åˆ©ç”¨è€…ç®¡ç†</button>
            <button class="tab" onclick="showTab('records')">ğŸ“… å®Ÿç¸¾è¨˜éŒ²</button>
            <button class="tab" onclick="showTab('export')">ğŸ“¤ è«‹æ±‚ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›</button>
        </div>

        <div class="content">
            <!-- äº‹æ¥­æ‰€æƒ…å ±ã‚¿ãƒ– -->
            <div id="facility" class="tab-content active">
                <h2 class="section-header">äº‹æ¥­æ‰€åŸºæœ¬æƒ…å ±</h2>

                <form id="facilityForm">
                    <div class="grid-2">
                        <div class="form-group">
                            <label>äº‹æ¥­æ‰€ç•ªå· *</label>
                            <input type="text" id="facilityNumber" value="1321402032" required>
                        </div>
                        <div class="form-group">
                            <label>äº‹æ¥­æ‰€å *</label>
                            <input type="text" id="facilityName" value="Tokyo. settle" required>
                        </div>
                    </div>

                    <div class="grid-2">
                        <div class="form-group">
                            <label>æ³•äººå</label>
                            <input type="text" id="corporationName" value="åˆåŒä¼šç¤¾ã‚¨ãƒ´ã‚§ãƒ¬ã‚«ãƒ³ãƒ‘ãƒ‹ãƒ¼">
                        </div>
                        <div class="form-group">
                            <label>åœ°åŸŸåŒºåˆ†</label>
                            <select id="areaCode">
                                <option value="01">ä¸€ç´šåœ°</option>
                                <option value="02">äºŒç´šåœ°</option>
                                <option value="03">ä¸‰ç´šåœ°</option>
                                <option value="04">å››ç´šåœ°</option>
                                <option value="05">äº”ç´šåœ°</option>
                                <option value="06">å…­ç´šåœ°</option>
                                <option value="07">ä¸ƒç´šåœ°</option>
                                <option value="20">ãã®ä»–</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>éƒµä¾¿ç•ªå·</label>
                        <input type="text" id="facilityZip" placeholder="ä¾‹: 156-0052">
                    </div>
                    <div class="form-group">
                        <label>æ‰€åœ¨åœ°ï¼ˆä½æ‰€ï¼‰</label>
                        <input type="text" id="facilityAddress" placeholder="ä¾‹: æ±äº¬éƒ½ä¸–ç”°è°·åŒºâ—‹â—‹1-2-3">
                    </div>
                    <div class="form-group">
                        <label>é›»è©±ç•ªå·</label>
                        <input type="text" id="facilityTel" placeholder="ä¾‹: 03-1234-5678">
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>ä»£è¡¨è€…è·å</label>
                            <input type="text" id="directorTitle" placeholder="ä¾‹: ä»£è¡¨ç¤¾å“¡">
                        </div>
                        <div class="form-group">
                            <label>ä»£è¡¨è€…æ°å</label>
                            <input type="text" id="directorName" placeholder="ä¾‹: å±±ç”° å¤ªéƒ">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>å…¥å“¡é…ç½®ä½“åˆ¶</label>
                        <select id="residentialCareSystem">
                            <option value="">â€»ä»¤å’Œ6å¹´4æœˆä»¥é™ã¯ã€è¨­å®šä¸è¦</option>
                            <option value="å…±åŒç”Ÿæ´»æ´åŠ©Iï¼ˆ4ï¼š1ï¼‰">å…±åŒç”Ÿæ´»æ´åŠ©Iï¼ˆ4ï¼š1ï¼‰</option>
                            <option value="å…±åŒç”Ÿæ´»æ´åŠ©I(6:1)">å…±åŒç”Ÿæ´»æ´åŠ©I(6:1)</option>
                            <option value="å…±åŒç”Ÿæ´»æ´åŠ©I(6:1)ãƒ»å…¥å“¡é…ç½®ä½“åˆ¶ 12ï¼š1">å…±åŒç”Ÿæ´»æ´åŠ©I(6:1)ãƒ»å…¥å“¡é…ç½®ä½“åˆ¶ 12ï¼š1</option>
                            <option value="å…±åŒç”Ÿæ´»æ´åŠ©I(6:1)ãƒ»å…¥å“¡é…ç½®ä½“åˆ¶ 30ï¼š1">å…±åŒç”Ÿæ´»æ´åŠ©I(6:1)ãƒ»å…¥å“¡é…ç½®ä½“åˆ¶ 30ï¼š1</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>å…¥å“¡é…ç½®ä½“åˆ¶</label>
                        <input type="text" id="staffRatio" placeholder="ä¾‹: 12:1" value="12ï¼š1">
                    </div>

                    <h3 class="subsection-header">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—</h3>
                    <div class="form-group">
                        <label>å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰</label>
                        <select id="nightSupportType1">
                            <option value="">è¨­å®šãªã—</option>
                            <option value="2äººä»¥ä¸‹">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 2äººä»¥ä¸‹</option>
                            <option value="3äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 3äºº</option>
                            <option value="4äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 4äºº</option>
                            <option value="5äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 5äºº</option>
                            <option value="6äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 6äºº</option>
                            <option value="7äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 7äºº</option>
                            <option value="8äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 8äºº</option>
                            <option value="9äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 9äºº</option>
                            <option value="10äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 10äºº</option>
                            <option value="11äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 11äºº</option>
                            <option value="12äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 12äºº</option>
                            <option value="13äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 13äºº</option>
                            <option value="14äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 14äºº</option>
                            <option value="15äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 15äºº</option>
                            <option value="16äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 16äºº</option>
                            <option value="17äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 17äºº</option>
                            <option value="18äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 18äºº</option>
                            <option value="19äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 19äºº</option>
                            <option value="20äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 20äºº</option>
                            <option value="21äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 21äºº</option>
                            <option value="22äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 22äºº</option>
                            <option value="23äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 23äºº</option>
                            <option value="24äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 24äºº</option>
                            <option value="25äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 25äºº</option>
                            <option value="26äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 26äºº</option>
                            <option value="27äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 27äºº</option>
                            <option value="28äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 28äºº</option>
                            <option value="29äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 29äºº</option>
                            <option value="30äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ 30äºº</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰</label>
                        <select id="nightSupportType2">
                            <option value="">è¨­å®šãªã—</option>
                            <option value="4äººä»¥ä¸‹">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 4äººä»¥ä¸‹</option>
                            <option value="5äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 5äºº</option>
                            <option value="6äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 6äºº</option>
                            <option value="7äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 7äºº</option>
                            <option value="8äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 8äºº</option>
                            <option value="9äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 9äºº</option>
                            <option value="10äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 10äºº</option>
                            <option value="11äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 11äºº</option>
                            <option value="12äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 12äºº</option>
                            <option value="13äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 13äºº</option>
                            <option value="14äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 14äºº</option>
                            <option value="15äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 15äºº</option>
                            <option value="16äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 16äºº</option>
                            <option value="17äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 17äºº</option>
                            <option value="18äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 18äºº</option>
                            <option value="19äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 19äºº</option>
                            <option value="20äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 20äºº</option>
                            <option value="21äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 21äºº</option>
                            <option value="22äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 22äºº</option>
                            <option value="23äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 23äºº</option>
                            <option value="24äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 24äºº</option>
                            <option value="25äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 25äºº</option>
                            <option value="26äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 26äºº</option>
                            <option value="27äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 27äºº</option>
                            <option value="28äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 28äºº</option>
                            <option value="29äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 29äºº</option>
                            <option value="30äºº">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ 30äºº</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¢ï¼‰</label>
                        <select id="nightSupportType3">
                            <option value="">è¨­å®šãªã—</option>
                            <option value="å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¢ï¼‰">å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¢ï¼‰</option>
                        </select>
                    </div>

                    <h3 class="subsection-header">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—</h3>
                    <div class="form-group">
                        <label>ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—</label>
                        <select id="treatmentImprovement">
                            <option value="">è¨­å®šãªã—</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆâ… ï¼‰">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆâ… ï¼‰</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆâ…¡ï¼‰">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆâ…¡ï¼‰</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆâ…¢ï¼‰">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆâ…¢ï¼‰</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆâ…£ï¼‰">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆâ…£ï¼‰</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(1)">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(1)</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(2)">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(2)</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(3)">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(3)</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(4)">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(4)</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(5)">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(5)</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(6)">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(6)</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(7)">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(7)</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(8)">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(8)</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(9)">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(9)</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(10)">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(10)</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(11)">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(11)</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(12)">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(12)</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(13)">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(13)</option>
                            <option value="ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(14)">ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(14)</option>
                        </select>
                    </div>

                    <h3 class="subsection-header">æ—¥ä¸­æ”¯æ´åŠ ç®—</h3>
                    <div class="form-group">
                        <label>æ—¥ä¸­æ”¯æ´åŠ ç®—</label>
                        <select id="daySupport">
                            <option value="">è¨­å®šãªã—</option>
                            <option value="æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰ 1äºº">æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰ 1äºº</option>
                            <option value="æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰ 2äººä»¥ä¸Š">æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰ 2äººä»¥ä¸Š</option>
                            <option value="æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰ 1äºº åŒºåˆ†4ã€5ã€6">æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰ 1äºº åŒºåˆ†4ã€5ã€6</option>
                            <option value="æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰ 1äºº åŒºåˆ†3ä»¥ä¸‹">æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰ 1äºº åŒºåˆ†3ä»¥ä¸‹</option>
                            <option value="æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰ 2äººä»¥ä¸Š åŒºåˆ†4ã€5ã€6">æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰ 2äººä»¥ä¸Š åŒºåˆ†4ã€5ã€6</option>
                            <option value="æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰ 2äººä»¥ä¸Š åŒºåˆ†3ä»¥ä¸‹">æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰ 2äººä»¥ä¸Š åŒºåˆ†3ä»¥ä¸‹</option>
                        </select>
                    </div>

                    <h3 class="subsection-header">ç¦ç¥‰å°‚é–€è·å“¡é…ç½®ç­‰åŠ ç®—</h3>
                    <div class="form-group">
                        <select id="specialistAllowance">
                            <option value="">è¨­å®šãªã—</option>
                            <option value="ç¦ç¥‰å°‚é–€è·å“¡é…ç½®ç­‰åŠ ç®—ï¼ˆâ… ï¼‰">ç¦ç¥‰å°‚é–€è·å“¡é…ç½®ç­‰åŠ ç®—ï¼ˆâ… ï¼‰</option>
                            <option value="ç¦ç¥‰å°‚é–€è·å“¡é…ç½®ç­‰åŠ ç®—ï¼ˆâ…¡ï¼‰">ç¦ç¥‰å°‚é–€è·å“¡é…ç½®ç­‰åŠ ç®—ï¼ˆâ…¡ï¼‰</option>
                            <option value="ç¦ç¥‰å°‚é–€è·å“¡é…ç½®ç­‰åŠ ç®—ï¼ˆâ…¢ï¼‰">ç¦ç¥‰å°‚é–€è·å“¡é…ç½®ç­‰åŠ ç®—ï¼ˆâ…¢ï¼‰</option>
                        </select>
                    </div>

                    <h3 class="subsection-header">è¦–è¦šãƒ»è´è¦šè¨€èªéšœå®³è€…æ”¯æ´ä½“åˆ¶åŠ ç®—</h3>
                    <div class="form-group">
                        <select id="sensorySupport">
                            <option value="">è¨­å®šãªã—</option>
                            <option value="è¦–è¦šãƒ»è´è¦šè¨€èªéšœå®³è€…æ”¯æ´ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰">è¦–è¦šãƒ»è´è¦šè¨€èªéšœå®³è€…æ”¯æ´ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰</option>
                            <option value="è¦–è¦šãƒ»è´è¦šè¨€èªéšœå®³è€…æ”¯æ´ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰">è¦–è¦šãƒ»è´è¦šè¨€èªéšœå®³è€…æ”¯æ´ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰</option>
                        </select>
                    </div>

                    <h3 class="subsection-header">çœ‹è­·è·å“¡é…ç½®åŠ ç®—</h3>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="nurseAllowance" value="çœ‹è­·è·å“¡é…ç½®åŠ ç®—">
                                <label for="nurseAllowance">çœ‹è­·è·å“¡é…ç½®åŠ ç®—</label>
                            </div>
                        </div>
                    </div>

                    <h3 class="subsection-header">åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—</h3>
                    <div class="form-group">
                        <select id="medicalCooperation">
                            <option value="">è¨­å®šãªã—</option>
                            <option value="åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…¥ï¼‰">åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…¥ï¼‰</option>
                            <option value="åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…¦ï¼‰">åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…¦ï¼‰</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>å®Ÿç¸¾è¨˜éŒ²ç­‰ã®æ•´å‚™ã«å¿…è¦</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="medicalCooperationRecord" value="å®Ÿç¸¾è¨˜éŒ²ç­‰ã®æ•´å‚™ã«å¿…è¦">
                                <label for="medicalCooperationRecord">å®Ÿç¸¾è¨˜éŒ²ç­‰ã®æ•´å‚™ã«å¿…è¦</label>
                            </div>
                        </div>
                    </div>

                    <h3 class="subsection-header">çœ‹è­·è·å“¡æ•°</h3>
                    <div class="form-group">
                        <input type="number" id="nurseCount" placeholder="çœ‹è­·è·å“¡æ•°">
                    </div>

                    <h3 class="subsection-header">é€šå‹¤è€…ç”Ÿæ´»æ”¯æ´åŠ ç®—</h3>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="commuterSupport" value="é€šå‹¤è€…ç”Ÿæ´»æ”¯æ´åŠ ç®—">
                                <label for="commuterSupport">é€šå‹¤è€…ç”Ÿæ´»æ”¯æ´åŠ ç®—</label>
                            </div>
                        </div>
                    </div>

                    <h3 class="subsection-header">å±…ä½æ”¯æ´ä½“åˆ¶</h3>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="housingSupport" value="å±…ä½æ”¯æ´ä½“åˆ¶">
                                <label for="housingSupport">å±…ä½æ”¯æ´ä½“åˆ¶</label>
                            </div>
                        </div>
                    </div>

                    <h3 class="subsection-header">ç§»è¡Œæ”¯æ´ä½ä½“åˆ¶</h3>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="transitionSupport" value="ç§»è¡Œæ”¯æ´ä½ä½“åˆ¶">
                                <label for="transitionSupport">ç§»è¡Œæ”¯æ´ä½ä½“åˆ¶</label>
                            </div>
                        </div>
                    </div>

                    <h3 class="subsection-header">ãƒ”ã‚¢ã‚µãƒãƒ¼ãƒˆå®Ÿæ–½åŠ ç®—</h3>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="peerSupport" value="ãƒ”ã‚¢ã‚µãƒãƒ¼ãƒˆå®Ÿæ–½åŠ ç®—">
                                <label for="peerSupport">ãƒ”ã‚¢ã‚µãƒãƒ¼ãƒˆå®Ÿæ–½åŠ ç®—</label>
                            </div>
                        </div>
                    </div>

                    <h3 class="subsection-header">éšœå®³è€…æ”¯æ´æ–½è¨­ç­‰æ„ŸæŸ“å¯¾ç­–å‘ä¸ŠåŠ ç®—</h3>
                    <div class="form-group">
                        <label>éšœå®³è€…æ”¯æ´æ–½è¨­ç­‰æ„ŸæŸ“å¯¾ç­–å‘ä¸ŠåŠ ç®—</label>
                        <select id="infectionControl">
                            <option value="">è¨­å®šãªã—</option>
                            <option value="éšœå®³è€…æ”¯æ´æ–½è¨­ç­‰æ„ŸæŸ“å¯¾ç­–å‘ä¸ŠåŠ ç®—ï¼ˆâ… ï¼‰">éšœå®³è€…æ”¯æ´æ–½è¨­ç­‰æ„ŸæŸ“å¯¾ç­–å‘ä¸ŠåŠ ç®—ï¼ˆâ… ï¼‰</option>
                            <option value="éšœå®³è€…æ”¯æ´æ–½è¨­ç­‰æ„ŸæŸ“å¯¾ç­–å‘ä¸ŠåŠ ç®—ï¼ˆâ…¡ï¼‰">éšœå®³è€…æ”¯æ´æ–½è¨­ç­‰æ„ŸæŸ“å¯¾ç­–å‘ä¸ŠåŠ ç®—ï¼ˆâ…¡ï¼‰</option>
                            <option value="éšœå®³è€…æ”¯æ´æ–½è¨­ç­‰æ„ŸæŸ“å¯¾ç­–å‘ä¸ŠåŠ ç®—ï¼ˆâ… ï¼‰ï¼ˆâ…¡ï¼‰">éšœå®³è€…æ”¯æ´æ–½è¨­ç­‰æ„ŸæŸ“å¯¾ç­–å‘ä¸ŠåŠ ç®—ï¼ˆâ… ï¼‰ï¼ˆâ…¡ï¼‰</option>
                        </select>
                    </div>

                    <h3 class="subsection-header">ä¸­æ ¸çš„é…ç½®ç­‰åŠ ç®—ä½“åˆ¶</h3>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="coreStaffing" value="ä¸­æ ¸çš„é…ç½®ç­‰åŠ ç®—ä½“åˆ¶">
                                <label for="coreStaffing">ä¸­æ ¸çš„é…ç½®ç­‰åŠ ç®—ä½“åˆ¶</label>
                            </div>
                        </div>
                    </div>

                    <h3 class="subsection-header">é«˜æ¬¡è„³æ©Ÿèƒ½éƒ¨è€…æ”¯æ´ä½“åˆ¶</h3>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="brainInjurySupport" value="é«˜æ¬¡è„³æ©Ÿèƒ½éƒ¨è€…æ”¯æ´ä½“åˆ¶">
                                <label for="brainInjurySupport">é«˜æ¬¡è„³æ©Ÿèƒ½éƒ¨è€…æ”¯æ´ä½“åˆ¶</label>
                            </div>
                        </div>
                    </div>

                    <h3 class="subsection-header">æ¸›ç®—</h3>
                    <div class="form-group">
                        <label>å¤§è¦æ¨¡ä½å±…ç­‰æ¸›ç®—</label>
                        <select id="largeScaleReduction">
                            <option value="">è¨­å®šãªã—</option>
                            <option value="å¤§è¦æ¨¡ä½å±…ç­‰æ¸›ç®—ï¼ˆå…¥å±…å®šå“¡8äººä»¥ä¸Šï¼‰">å…¥å±…å®šå“¡ãŒï¼˜äººä»¥ä¸Š</option>
                            <option value="å¤§è¦æ¨¡ä½å±…ç­‰æ¸›ç®—ï¼ˆå…¥å±…å®šå“¡21äººä»¥ä¸Šï¼‰">å…¥å±…å®šå“¡ãŒ21äººä»¥ä¸Š</option>
                            <option value="å¤§è¦æ¨¡ä½å±…ç­‰æ¸›ç®—ï¼ˆä¸€ä½“çš„ãªå…±åŒç”Ÿæ´»ä½å±…21äººä»¥ä¸Šï¼‰">ä¸€ä½“çš„ãªå…±åŒç”Ÿæ´»ä½å±…ã®å…¥å±…å®šå“¡æ•°21ä»¥ä¸Š</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ã‚µãƒ¼ãƒ“ã‚¹ç®¡ç†è²¬ä»»è€…ã®å“¡æ•°ãŒåŸºæº–ã«æº€ãŸãªã„</label>
                        <select id="serviceManagerReduction">
                            <option value="">è¨­å®šãªã—</option>
                            <option value="ã‚µãƒ¼ãƒ“ã‚¹ç®¡ç†è²¬ä»»è€…ä¸è¶³ï¼ˆ4æœˆç›®ã¾ã§ï¼‰">æ¸›ç®—ãŒé©ç”¨ã•ã‚Œã‚‹æœˆã‹ã‚‰ï¼”æœˆç›®ã¾ã§</option>
                            <option value="ã‚µãƒ¼ãƒ“ã‚¹ç®¡ç†è²¬ä»»è€…ä¸è¶³ï¼ˆ5æœˆä»¥ä¸Šé€£ç¶šï¼‰">ï¼•æœˆä»¥ä¸Šé€£ç¶šã—ã¦æ¸›ç®—ã®å ´åˆ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ä¸–è©±äººåˆã¯ç”Ÿæ´»æ”¯æ´å“¡ã®å“¡æ•°ãŒåŸºæº–ã«æº€ãŸãªã„</label>
                        <select id="staffReduction">
                            <option value="">è¨­å®šãªã—</option>
                            <option value="ä¸–è©±äººãƒ»ç”Ÿæ´»æ”¯æ´å“¡ä¸è¶³ï¼ˆ2æœˆç›®ã¾ã§ï¼‰">æ¸›ç®—ãŒé©ç”¨ã•ã‚Œã‚‹æœˆã‹ã‚‰ï¼’æœˆç›®ã¾ã§</option>
                            <option value="ä¸–è©±äººãƒ»ç”Ÿæ´»æ”¯æ´å“¡ä¸è¶³ï¼ˆ3æœˆä»¥ä¸Šé€£ç¶šï¼‰">ï¼“æœˆä»¥ä¸Šé€£ç¶šã—ã¦æ¸›ç®—ã®å ´åˆ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>èº«ä½“æ‹˜æŸå»ƒæ­¢æœªå®Ÿæ–½æ¸›ç®—</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="restraintReduction" value="èº«ä½“æ‹˜æŸå»ƒæ­¢æœªå®Ÿæ–½">
                                <label for="restraintReduction">èº«ä½“æ‹˜æŸå»ƒæ­¢æœªå®Ÿæ–½æ¸›ç®—</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>è™å¾…é˜²æ­¢æªç½®æœªå®Ÿæ–½æ¸›ç®—</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="abusePreventionReduction" value="è™å¾…é˜²æ­¢æªç½®æœªå®Ÿæ–½">
                                <label for="abusePreventionReduction">è™å¾…é˜²æ­¢æªç½®æœªå®Ÿæ–½æ¸›ç®—</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>æ¥­å‹™ç¶™ç¶šè¨ˆç”»æœªç­–å®šæ¸›ç®—</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="bcpReduction" value="æ¥­å‹™ç¶™ç¶šè¨ˆç”»æœªç­–å®š">
                                <label for="bcpReduction">æ¥­å‹™ç¶™ç¶šè¨ˆç”»æœªç­–å®šæ¸›ç®—</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>æƒ…å ±å…¬è¡¨æœªå ±å‘Šæ¸›ç®—</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="infoDisclosureReduction" value="æƒ…å ±å…¬è¡¨æœªå ±å‘Š">
                                <label for="infoDisclosureReduction">æƒ…å ±å…¬è¡¨æœªå ±å‘Šæ¸›ç®—</label>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 30px;">
                        <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜</button>
                    </div>
                </form>

                <div id="facilityInfo" style="margin-top: 40px;"></div>
            </div>

            <!-- å»ºç‰©ç®¡ç†ã‚¿ãƒ– -->
            <div id="buildings" class="tab-content">
                <h2 class="section-header">å»ºç‰©ï¼ˆãƒ¦ãƒ‹ãƒƒãƒˆï¼‰ç®¡ç†</h2>
                <div style="display:flex; gap:16px; flex-wrap:wrap; margin-bottom:20px;">
                    <div id="buildingSidebar" style="width:220px; min-width:180px;"></div>
                    <div id="buildingDetail" style="flex:1; min-width:300px;"></div>
                </div>
                <button type="button" class="btn btn-info" onclick="addBuilding()">ï¼‹ å»ºç‰©ã‚’è¿½åŠ </button>
            </div>

            <!-- åˆ©ç”¨è€…ç®¡ç†ã‚¿ãƒ– -->
            <div id="users" class="tab-content">
                <!-- åˆ©ç”¨è€…ä¸€è¦§ç”»é¢ -->
                <div id="userListView">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; flex-wrap:wrap; gap:8px;">
                        <h2 class="section-header" style="margin:0;">åˆ©ç”¨è€…ä¸€è¦§</h2>
                        <button type="button" class="btn btn-primary" onclick="showUserNew()" style="background:#e91e8c; border-color:#e91e8c;">ï¼‹ æ–°è¦ç™»éŒ²</button>
                    </div>
                    <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px; align-items:center;">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span style="font-size:0.9em;">äº‹æ¥­æ‰€</span>
                            <select id="filterFacility" style="padding:6px 10px; border:1px solid #ddd; border-radius:6px;" onchange="renderUserList()">
                                <option value="">é¸æŠã—ã¦ã...</option>
                                <option value="tokyo">Tokyo. settle</option>
                            </select>
                        </div>
                        <input type="text" id="filterName" placeholder="åˆ©ç”¨è€…å" style="padding:6px 10px; border:1px solid #ddd; border-radius:6px;" oninput="renderUserList()">
                        <button class="btn btn-primary" onclick="renderUserList()" style="background:#e91e8c; border-color:#e91e8c; padding:6px 16px;">æ¤œç´¢</button>
                        <div style="display:flex; align-items:center; gap:8px; margin-left:8px;">
                            <span style="font-size:0.9em;">å»ºç‰©</span>
                            <select id="filterBuilding" style="padding:6px 10px; border:1px solid #ddd; border-radius:6px;" onchange="renderUserList()">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            </select>
                        </div>
                    </div>
                    <div id="userPager" style="margin-bottom:8px;"></div>
                    <div id="userListCount" style="margin-bottom:8px; font-size:0.9em; color:#555;"></div>
                    <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
                        <thead>
                            <tr style="border-bottom:2px solid #ddd;">
                                <th style="width:40px;"></th>
                                <th style="text-align:left; padding:8px; color:#667eea; cursor:pointer;">äº‹æ¥­æ‰€</th>
                                <th style="text-align:left; padding:8px; color:#667eea; cursor:pointer;">å»ºç‰©</th>
                                <th style="text-align:left; padding:8px;">åˆ©ç”¨è€…å</th>
                                <th style="width:120px;"></th>
                            </tr>
                        </thead>
                        <tbody id="userListBody"></tbody>
                    </table>
                </div>

                <!-- åˆ©ç”¨è€…è©³ç´°ãƒ»ç·¨é›†ç”»é¢ -->
                <div id="userDetailView" style="display:none;">
                    <div style="font-size:0.85em; color:#888; margin-bottom:8px;">
                        <span style="cursor:pointer; color:#667eea;" onclick="showUserList()">ãƒ›ãƒ¼ãƒ </span> /
                        <span style="cursor:pointer; color:#667eea;" onclick="showUserList()">åˆ©ç”¨è€…ä¸€è¦§</span> /
                        <span id="userDetailBreadcrumb"></span>
                    </div>
                    <h2 id="userDetailName" style="margin-bottom:16px; font-size:1.4em;"></h2>
                    <div class="building-inner-tabs" id="userDetailTabs">
                        <div class="building-inner-tab active" onclick="showUserTab('basic1')">åŸºæœ¬æƒ…å ±â‘ </div>
                        <div class="building-inner-tab" onclick="showUserTab('basic2')">åŸºæœ¬æƒ…å ±â‘¡</div>
                        <div class="building-inner-tab" onclick="showUserTab('medical')">æ—¢å¾€æ­´ãƒ»æœè–¬</div>
                        <div class="building-inner-tab" onclick="showUserTab('certificate')">å—çµ¦è€…è¨¼</div>
                        <div class="building-inner-tab" onclick="showUserTab('calc')">ç®—å®šæƒ…å ±</div>
                        <div class="building-inner-tab" onclick="showUserTab('contract')">å¥‘ç´„æƒ…å ±</div>
                        <div class="building-inner-tab" onclick="showUserTab('history')">å±¥æ­´æƒ…å ±</div>
                    </div>

                    <!-- åŸºæœ¬æƒ…å ±â‘  -->
                    <div id="userTab-basic1" class="building-detail-panel active">
                        <div class="info-card">
                            <div class="upload-area" id="uploadArea" style="margin-bottom:16px;">
                                <input type="file" id="certificateFile" accept="image/*,application/pdf" style="display:none;" onchange="handleFileUpload(event)">
                                <p style="font-size:1em; margin-bottom:6px;">ğŸ“· å—çµ¦è€…è¨¼ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆOCRï¼‰</p>
                                <p style="color:#666; font-size:0.85em;">ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
                            </div>
                            <div id="ocrProgress" class="progress" style="display:none;"></div>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>äº‹æ¥­æ‰€</label>
                                    <input type="text" id="userFacilityName" value="Tokyo. settle" readonly style="background:#f5f5f5;">
                                </div>
                                <div class="form-group">
                                    <label>å»ºç‰©ï¼ˆãƒ¦ãƒ‹ãƒƒãƒˆï¼‰</label>
                                    <select id="userUnit">
                                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>éƒ¨å±‹ç•ªå·</label>
                                    <input type="text" id="userRoom">
                                </div>
                                <div class="form-group">
                                    <label>ç§»å‹•æ—¥</label>
                                    <input type="date" id="userMoveDate">
                                </div>
                                <div class="form-group">
                                    <label>åˆ©ç”¨è€…å *</label>
                                    <input type="text" id="userName">
                                </div>
                                <div class="form-group">
                                    <label>åˆ©ç”¨è€…åã‚«ãƒŠ</label>
                                    <input type="text" id="userNameKana">
                                </div>
                                <div class="form-group">
                                    <label>æ€§åˆ¥</label>
                                    <select id="userGender">
                                        <option value="">é¸æŠ</option>
                                        <option value="ç”·æ€§">ç”·æ€§</option>
                                        <option value="å¥³æ€§">å¥³æ€§</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>ç”Ÿå¹´æœˆæ—¥</label>
                                    <input type="date" id="userBirthdate">
                                </div>
                                <div class="form-group">
                                    <label>éƒµä¾¿ç•ªå·</label>
                                    <input type="text" id="userZip">
                                </div>
                                <div class="form-group">
                                    <label>éƒ½é“åºœçœŒ</label>
                                    <input type="text" id="userPrefecture">
                                </div>
                                <div class="form-group">
                                    <label>å¸‚åŒºç”ºæ‘</label>
                                    <input type="text" id="userCity">
                                </div>
                                <div class="form-group">
                                    <label>ç”ºåãƒ»ç•ªåœ°</label>
                                    <input type="text" id="userAddress">
                                </div>
                                <div class="form-group">
                                    <label>å»ºç‰©å</label>
                                    <input type="text" id="userBuildingName">
                                </div>
                                <div class="form-group">
                                    <label>é›»è©±ç•ªå·</label>
                                    <input type="text" id="userTel">
                                </div>
                                <div class="form-group">
                                    <label>æºå¸¯é›»è©±ç•ªå·</label>
                                    <input type="text" id="userMobile">
                                </div>
                                <div class="form-group">
                                    <label>æ—¥ä¸­æ´»å‹•äº‹æ¥­æ‰€ç•ªå·</label>
                                    <input type="text" id="userDaytimeOrgNo">
                                </div>
                                <div class="form-group">
                                    <label>æ—¥ä¸­æ´»å‹•äº‹æ¥­æ‰€å</label>
                                    <input type="text" id="userDaytimeOrgName">
                                </div>
                                <div class="form-group">
                                    <label>ä½å®…æ‰¶åŠ©</label>
                                    <input type="text" id="userHousingAssist">
                                </div>
                                <div class="form-group">
                                    <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                                    <select id="userStatus">
                                        <option value="åˆ©ç”¨ä¸­">åˆ©ç”¨ä¸­</option>
                                        <option value="ä½“é¨“">ä½“é¨“</option>
                                        <option value="é€€å±…">é€€å±…</option>
                                    </select>
                                </div>
                            </div>
                            <div style="margin-top:12px; display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
                                <button type="button" class="btn btn-primary" onclick="saveCurrentUser('basic1')">ğŸ’¾ ä¿å­˜</button>
                                <a href="#" onclick="return false;" style="color:#667eea; font-size:0.9em;">å®Ÿç¸¾ãƒã‚¹ã‚¿</a>
                                <a href="#" onclick="return false;" style="color:#667eea; font-size:0.9em;">å€‹åˆ¥æ”¯æ´è¨ˆç”»</a>
                            </div>
                        </div>
                    </div>

                    <!-- åŸºæœ¬æƒ…å ±â‘¡ -->
                    <div id="userTab-basic2" class="building-detail-panel">
                        <div class="info-card">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                <strong>&lt;ç·Šæ€¥é€£çµ¡å…ˆ&gt;</strong>
                                <button type="button" class="btn btn-primary" onclick="addEmergencyContact()" style="background:#e91e8c; border-color:#e91e8c; font-size:0.85em; padding:4px 12px;">æ–°è¦ç™»éŒ²</button>
                            </div>
                            <div id="emergencyContactList"></div>
                            <hr style="margin:20px 0;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                <strong>&lt;ã‹ã‹ã‚Šã¤ã‘åŒ»ç™‚æ©Ÿé–¢&gt;</strong>
                                <button type="button" class="btn btn-primary" onclick="addMedicalFacility()" style="background:#e91e8c; border-color:#e91e8c; font-size:0.85em; padding:4px 12px;">æ–°è¦ç™»éŒ²</button>
                            </div>
                            <div id="medicalFacilityList"></div>
                            <hr style="margin:20px 0;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                <strong>&lt;æ€§æ ¼ãƒ»è¶£å‘³ãªã©&gt;</strong>
                                <button type="button" class="btn btn-primary" onclick="editPersonality()" style="background:#e91e8c; border-color:#e91e8c; font-size:0.85em; padding:4px 12px;">ç·¨é›†</button>
                            </div>
                            <div id="personalityInfo" style="background:#f9f9f9; border-radius:6px; padding:12px; font-size:0.9em; white-space:pre-wrap;"></div>
                            <hr style="margin:20px 0;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                <strong>&lt;å…¥å±…å‰ã®çŠ¶æ³ãƒ»æˆè‚²æ­´&gt;</strong>
                                <button type="button" class="btn btn-primary" onclick="addMoveInHistory()" style="background:#e91e8c; border-color:#e91e8c; font-size:0.85em; padding:4px 12px;">æ–°è¦ç™»éŒ²</button>
                            </div>
                            <div id="moveInHistoryList"></div>
                        </div>
                    </div>

                    <!-- æ—¢å¾€æ­´ãƒ»æœè–¬ -->
                    <div id="userTab-medical" class="building-detail-panel">
                        <div class="info-card">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                <strong>&lt;ç–¾ç—…&gt;</strong>
                                <button type="button" class="btn btn-primary" onclick="addDisease()" style="background:#e91e8c; border-color:#e91e8c; font-size:0.85em; padding:4px 12px;">æ–°è¦ç™»éŒ²</button>
                            </div>
                            <table style="width:100%; border-collapse:collapse; font-size:0.9em; margin-bottom:16px;">
                                <thead>
                                    <tr style="border-bottom:1px solid #ddd;">
                                        <th style="text-align:left; padding:8px; color:#667eea;">ç—…å</th>
                                        <th style="text-align:left; padding:8px; color:#667eea;">ç™ºç—‡å¹´æœˆæ—¥</th>
                                        <th style="text-align:left; padding:8px; color:#667eea;">åŒ»ç™‚æ©Ÿé–¢å</th>
                                        <th style="text-align:left; padding:8px; color:#667eea;">å‚™è€ƒ</th>
                                        <th style="width:80px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="diseaseList"></tbody>
                            </table>
                            <hr style="margin:20px 0;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                <strong>&lt;æœè–¬&gt;</strong>
                                <button type="button" class="btn btn-primary" onclick="addMedicine()" style="background:#e91e8c; border-color:#e91e8c; font-size:0.85em; padding:4px 12px;">æ–°è¦ç™»éŒ²</button>
                            </div>
                            <div id="medicineList"></div>
                            <hr style="margin:20px 0;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                <strong>&lt;ç•™æ„ç‚¹ï¼ç‰¹è¨˜äº‹é …&gt;</strong>
                                <button type="button" class="btn btn-primary" onclick="editMedicalNotes()" style="background:#e91e8c; border-color:#e91e8c; font-size:0.85em; padding:4px 12px;">ç·¨é›†</button>
                            </div>
                            <div id="medicalNotes" style="background:#f9f9f9; border-radius:6px; padding:12px; font-size:0.9em; white-space:pre-wrap;"></div>
                        </div>
                    </div>

                    <!-- å—çµ¦è€…è¨¼ -->
                    <div id="userTab-certificate" class="building-detail-panel">
                        <div class="info-card">
                            <p style="color:#555; font-size:0.9em; margin-bottom:16px; background:#fff9e6; padding:10px; border-radius:6px; border-left:4px solid #f0a;">
                                åŒºåˆ†å¤‰æ›´ãŒã‚ã£ãŸã€ã‚ã‚‹ã„ã¯æœ‰åŠ¹æœŸé™æ›´æ–°ãŒã‚ã£ãŸå ´åˆã«è¿½åŠ ã§æ–°è¦ç™»éŒ²ã—ã¦æƒ…å ±ã‚’è¿½åŠ ã—ã¦ä¸‹ã•ã„ã€‚
                            </p>
                            <div style="display:flex; justify-content:flex-end; margin-bottom:12px;">
                                <button type="button" class="btn btn-primary" onclick="showCertificateForm()" style="background:#e91e8c; border-color:#e91e8c;">æ–°è¦ç™»éŒ²</button>
                            </div>
                            <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
                                <thead>
                                    <tr style="border-bottom:2px solid #ddd;">
                                        <th style="text-align:left; padding:8px; font-weight:600;">èªå®šæœ‰åŠ¹æœŸé–“</th>
                                        <th style="text-align:left; padding:8px; font-weight:600;">äº¤ä»˜å¹´æœˆæ—¥</th>
                                        <th style="text-align:left; padding:8px; font-weight:600;">å—çµ¦è€…è¨¼ç•ªå·</th>
                                        <th style="text-align:left; padding:8px; font-weight:600;">éšœå®³æ”¯æ´åŒºåˆ†</th>
                                        <th style="width:160px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="certificateHistoryList"></tbody>
                            </table>
                            <!-- å—çµ¦è€…è¨¼ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
                            <div id="certificateForm" style="display:none; margin-top:24px; border-top:2px solid #ddd; padding-top:20px;">
                                <h4 style="margin-bottom:16px; color:#e91e8c;">å—çµ¦è€…è¨¼ç·¨é›†</h4>
                                <div style="display:flex; flex-direction:column; gap:14px; max-width:700px;">
                                    <div>
                                        <label style="color:#e91e8c; font-weight:600;">â˜…å—çµ¦è€…è¨¼ç•ªå·</label>
                                        <input type="text" id="certNo" style="width:100%; margin-top:6px; padding:10px; border:1px solid #ddd; border-radius:6px;">
                                    </div>
                                    <div class="grid-2">
                                        <div>
                                            <label style="color:#e91e8c; font-weight:600;">â˜…æ”¯çµ¦å¸‚ç”ºæ‘ç•ªå·</label>
                                            <input type="text" id="certCityCode" style="width:100%; margin-top:6px; padding:10px; border:1px solid #ddd; border-radius:6px;">
                                        </div>
                                        <div>
                                            <label style="color:#e91e8c; font-weight:600;">â˜…æ”¯çµ¦å¸‚ç”ºæ‘å</label>
                                            <input type="text" id="certCityName" style="width:100%; margin-top:6px; padding:10px; border:1px solid #ddd; border-radius:6px;">
                                        </div>
                                    </div>
                                    <div>
                                        <label>éšœå®³ç¨®åˆ¥</label>
                                        <select id="certDisabilityType" style="width:100%; margin-top:6px; padding:10px; border:1px solid #ddd; border-radius:6px;">
                                            <option value="">é¸æŠ</option>
                                            <option value="01:èº«ä½“éšœå®³è€…">01:èº«ä½“éšœå®³è€…</option>
                                            <option value="02:çŸ¥çš„éšœå®³è€…">02:çŸ¥çš„éšœå®³è€…</option>
                                            <option value="03:ç²¾ç¥éšœå®³è€…">03:ç²¾ç¥éšœå®³è€…</option>
                                            <option value="04:éšœå®³å…">04:éšœå®³å…</option>
                                            <option value="05:é›£ç—…ç­‰å¯¾è±¡è€…">05:é›£ç—…ç­‰å¯¾è±¡è€…</option>
                                        </select>
                                        <p style="font-size:0.8em; color:#888; margin-top:4px;">åˆä½µã—ã¦ã„ã‚‹å ´åˆã€ã‚ˆã‚Šé‡åº¦ã¨ã•ã‚Œã¦ã„ã‚‹éšœå®³ç¨®åˆ¥ã‚’é¸æŠã—ã¦ä¸‹ã•ã„ã€‚</p>
                                    </div>
                                    <div>
                                        <label style="color:#e91e8c; font-weight:600;">â˜…éšœå®³æ”¯æ´åŒºåˆ†</label>
                                        <select id="certSupportLevel" style="width:100%; margin-top:6px; padding:10px; border:1px solid #ddd; border-radius:6px;">
                                            <option value="">ãªã—</option>
                                            <option value="åŒºåˆ†1">åŒºåˆ†1</option>
                                            <option value="åŒºåˆ†2">åŒºåˆ†2</option>
                                            <option value="åŒºåˆ†3">åŒºåˆ†3</option>
                                            <option value="åŒºåˆ†4">åŒºåˆ†4</option>
                                            <option value="åŒºåˆ†5">åŒºåˆ†5</option>
                                            <option value="åŒºåˆ†6">åŒºåˆ†6</option>
                                            <option value="ãªã—">ãªã—</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="color:#e91e8c; font-weight:600;">â˜…äº¤ä»˜å¹´æœˆæ—¥</label>
                                        <input type="date" id="certIssueDate" style="width:100%; margin-top:6px; padding:10px; border:1px solid #ddd; border-radius:6px;">
                                    </div>
                                    <div>
                                        <label style="color:#e91e8c; font-weight:600;">â˜…èªå®šæœ‰åŠ¹æœŸé–“</label>
                                        <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
                                            <input type="date" id="certValidFrom" style="padding:10px; border:1px solid #ddd; border-radius:6px;">
                                            <span>ã€œ</span>
                                            <input type="date" id="certValidTo" style="padding:10px; border:1px solid #ddd; border-radius:6px;">
                                        </div>
                                    </div>
                                    <div>
                                        <label style="color:#e91e8c; font-weight:600;">â˜…è² æ‹…ä¸Šé™æœˆé¡</label>
                                        <input type="number" id="certBurdenLimit" value="0" style="width:100%; margin-top:6px; padding:10px; border:1px solid #ddd; border-radius:6px;">
                                    </div>
                                    <div>
                                        <label style="color:#e91e8c; font-weight:600;">â˜…ä¸Šé™æœˆé¡é©ç”¨æœŸé–“</label>
                                        <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
                                            <input type="date" id="certLimitFrom" style="padding:10px; border:1px solid #ddd; border-radius:6px;">
                                            <span>ã€œ</span>
                                            <input type="date" id="certLimitTo" style="padding:10px; border:1px solid #ddd; border-radius:6px;">
                                        </div>
                                    </div>
                                    <div>
                                        <label>
                                            <input type="checkbox" id="certUpperMgmt"> ä¸Šé™é¡ç®¡ç†å¯¾è±¡è€… <span style="font-size:0.8em; color:#888;">â€»è©²å½“ã®åˆ©ç”¨è€…ã®å ´åˆã¯ã€ãƒã‚§ãƒƒã‚¯ã‚’ä»˜ã‘ã‚‹ã€‚</span>
                                        </label>
                                        <div style="display:flex; gap:16px; margin-top:8px;" id="certUpperMgmtArea">
                                            <div style="flex:1;">
                                                <label style="font-size:0.9em;">ä¸Šé™é¡ç®¡ç†äº‹æ¥­æ‰€ç•ªå·</label>
                                                <input type="text" id="certUpperMgmtOrgNo" style="width:100%; margin-top:4px; padding:8px; border:1px solid #ddd; border-radius:6px;">
                                            </div>
                                            <div style="flex:1;">
                                                <label style="font-size:0.9em;">ä¸Šé™é¡ç®¡ç†äº‹æ¥­æ‰€å</label>
                                                <input type="text" id="certUpperMgmtOrgName" style="width:100%; margin-top:4px; padding:8px; border:1px solid #ddd; border-radius:6px;">
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label>
                                            <input type="checkbox" id="certSpecialDisabled"> ç‰¹å®šéšœå®³è€…ç‰¹åˆ¥çµ¦ä»˜è²»å¯¾è±¡è€… <span style="font-size:0.8em; color:#888;">â€»è©²å½“ã®åˆ©ç”¨è€…ã®å ´åˆã¯ã€ãƒã‚§ãƒƒã‚¯ã‚’ä»˜ã‘ã‚‹ã€‚</span>
                                        </label>
                                        <div id="certSpecialDisabledArea" style="margin-top:8px; display:none;">
                                            <label style="color:#e91e8c; font-weight:600;">â˜…ç‰¹å®šéšœå®³è€…ç‰¹åˆ¥çµ¦ä»˜è²»</label>
                                            <input type="number" id="certSpecialAmount" style="width:100%; margin-top:4px; padding:8px; border:1px solid #ddd; border-radius:6px;" value="0">
                                            <label style="color:#e91e8c; font-weight:600; margin-top:8px; display:block;">â˜…ç‰¹å®šéšœå®³è€…é©ç”¨æœŸé–“</label>
                                            <div style="display:flex; gap:8px; align-items:center; margin-top:4px;">
                                                <input type="date" id="certSpecialFrom" style="padding:8px; border:1px solid #ddd; border-radius:6px;">
                                                <span>ã€œ</span>
                                                <input type="date" id="certSpecialTo" style="padding:8px; border:1px solid #ddd; border-radius:6px;">
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label>
                                            <input type="checkbox" id="certMunicipalityAssist"> è‡ªæ²»ä½“åŠ©æˆ <span style="font-size:0.8em; color:#888;">â€»æœªè¨˜è¼‰OKã€‚ç‰¹åˆ¥ãªåŒ»ç™‚åŠ©æˆå¯¾è±¡è€…ã®å ´åˆã®ã¿è¨˜å…¥ã—ã¾ã™ã€‚</span>
                                        </label>
                                        <div id="certMunicipalityArea" style="margin-top:8px; display:none;">
                                            <div class="grid-2">
                                                <div>
                                                    <label style="font-size:0.9em;">åŠ©æˆè‡ªæ²»ä½“ç•ªå·</label>
                                                    <input type="text" id="certMuniOrgNo" style="width:100%; margin-top:4px; padding:8px; border:1px solid #ddd; border-radius:6px;">
                                                </div>
                                                <div>
                                                    <label style="font-size:0.9em;">è‡ªæ²»ä½“åŠ©æˆç‡</label>
                                                    <input type="text" id="certMuniRate" style="width:100%; margin-top:4px; padding:8px; border:1px solid #ddd; border-radius:6px;">
                                                </div>
                                                <div>
                                                    <label style="font-size:0.9em;">è‡ªæ²»ä½“åŠ©æˆé¡</label>
                                                    <input type="number" id="certMuniAmount" style="width:100%; margin-top:4px; padding:8px; border:1px solid #ddd; border-radius:6px;">
                                                </div>
                                                <div>
                                                    <label style="font-size:0.9em;">å¸‚ç”ºæ‘ä¸Šé™é¡</label>
                                                    <input type="number" id="certMuniMax" style="width:100%; margin-top:4px; padding:8px; border:1px solid #ddd; border-radius:6px;">
                                                </div>
                                                <div>
                                                    <label style="font-size:0.9em;">æ”¯çµ¦é‡</label>
                                                    <input type="text" id="certMuniGrant" style="width:100%; margin-top:4px; padding:8px; border:1px solid #ddd; border-radius:6px;">
                                                </div>
                                            </div>
                                            <div style="margin-top:8px;">
                                                <label style="font-size:0.9em;">æ”¯çµ¦æ±ºå®šæœŸé–“</label>
                                                <div style="display:flex; gap:8px; align-items:center; margin-top:4px;">
                                                    <input type="date" id="certGrantFrom" style="padding:8px; border:1px solid #ddd; border-radius:6px;">
                                                    <span>ã€œ</span>
                                                    <input type="date" id="certGrantTo" style="padding:8px; border:1px solid #ddd; border-radius:6px;">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display:flex; gap:12px;">
                                        <button type="button" class="btn btn-primary" onclick="saveCertificate()" style="background:#e91e8c; border-color:#e91e8c;">ä¿å­˜ã™ã‚‹</button>
                                        <button type="button" class="btn btn-secondary" onclick="cancelCertificateForm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ç®—å®šæƒ…å ± -->
                    <div id="userTab-calc" class="building-detail-panel">
                        <div class="info-card">
                            <p style="font-size:0.9em; color:#555; margin-bottom:16px;">33:å…±åŒç”Ÿæ´»æ´åŠ©ï¼ˆä»‹è­·ã‚µãƒ¼ãƒ“ã‚¹åŒ…æ‹¬å‹ï¼‰ã®è¨­å®š</p>
                            <div class="form-group">
                                <label>é‡åº¦éšœå®³è€…æ”¯æ´åŠ ç®—</label>
                                <select id="calcSevereDisability" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; margin-top:4px;">
                                    <option value="">è¨­å®šãªã—</option>
                                    <option value="é‡åº¦éšœå®³è€…æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰">é‡åº¦éšœå®³è€…æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰</option>
                                    <option value="é‡åº¦éšœå®³è€…æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰">é‡åº¦éšœå®³è€…æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰</option>
                                    <option value="é‡åº¦éšœå®³è€…æ”¯æ´åŠ ç®—ï¼ˆè¡Œå‹•é–¢é€£é …ç›®ï¼‘ï¼˜ç‚¹ä»¥ä¸Šï¼‰">é‡åº¦éšœå®³è€…æ”¯æ´åŠ ç®—ï¼ˆè¡Œå‹•é–¢é€£é …ç›®ï¼‘ï¼˜ç‚¹ä»¥ä¸Šï¼‰</option>
                                </select>
                            </div>
                            <div style="margin:12px 0; display:flex; flex-direction:column; gap:8px;">
                                <label><input type="checkbox" id="calcRegionalTransition"> åœ°åŸŸç”Ÿæ´»ç§»è¡Œå€‹åˆ¥æ”¯æ´ç‰¹åˆ¥åŠ ç®—</label>
                                <label><input type="checkbox" id="calcMentalTransition"> ç²¾ç¥éšœå®³è€…åœ°åŸŸç§»è¡Œç‰¹åˆ¥åŠ ç®—</label>
                                <label><input type="checkbox" id="calcBehaviorTransition"> å¼·åº¦è¡Œå‹•éšœå®³è€…åœ°åŸŸç§»è¡Œç‰¹åˆ¥åŠ ç®—</label>
                                <label><input type="checkbox" id="calcBehaviorExperience"> å¼·åº¦è¡Œå‹•éšœå®³è€…ä½“é¨“åˆ©ç”¨åŠ ç®—</label>
                                <p style="font-size:0.8em; color:#888; margin-left:20px;">é‡åº¦éšœå®³è€…æ”¯æ´åŠ ç®—ãŒç®—å®šã•ã‚Œã‚‹å ´åˆã¯ç®—å®šã•ã‚Œã¾ã›ã‚“ã€‚</p>
                                <label><input type="checkbox" id="calcMedicalCare"> åŒ»ç™‚çš„ã‚±ã‚¢å¯¾å¿œæ”¯æ´åŠ ç®—</label>
                                <p style="font-size:0.8em; color:#888; margin-left:20px;">é‡åº¦éšœå®³è€…æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰åˆã¯åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ãŒç®—å®šã•ã‚Œã‚‹å ´åˆã¯ç®—å®šã•ã‚Œã¾ã›ã‚“ã€‚</p>
                                <label><input type="checkbox" id="calcIndividualCare"> å€‹äººå˜ä½ã§å±…å®…ä»‹è­·ç­‰ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆ</label>
                            </div>
                            <div class="form-group" style="margin-top:12px;">
                                <label>å…±åŒç”Ÿæ´»æ´åŠ©è¨ˆç”»ãŒä½œæˆã•ã‚Œã¦ã„ãªã„</label>
                                <select id="calcNoPlanReduction" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; margin-top:4px;">
                                    <option value="">è¨­å®šãªã—</option>
                                    <option value="å…±åŒç”Ÿæ´»æ´åŠ©è¨ˆç”»æœªä½œæˆï¼ˆ2æœˆç›®ã¾ã§ï¼‰">æ¸›ç®—ãŒé©ç”¨ã•ã‚Œã‚‹æœˆã‹ã‚‰ï¼’æœˆç›®ã¾ã§</option>
                                    <option value="å…±åŒç”Ÿæ´»æ´åŠ©è¨ˆç”»æœªä½œæˆï¼ˆ3æœˆä»¥ä¸Šï¼‰">ï¼“æœˆä»¥ä¸Šé€£ç¶šã—ã¦æ¸›ç®—ã®å ´åˆ</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-top:12px;">
                                <label>å¤§è¦æ¨¡ä½å±…ç­‰æ¸›ç®—</label>
                                <select id="calcLargeScaleReduction" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; margin-top:4px;">
                                    <option value="">è¨­å®šãªã—</option>
                                    <option value="å¤§è¦æ¨¡ä½å±…ç­‰æ¸›ç®—ï¼ˆå…¥å±…å®šå“¡8äººä»¥ä¸Šï¼‰">å…¥å±…å®šå“¡ãŒï¼˜äººä»¥ä¸Š</option>
                                    <option value="å¤§è¦æ¨¡ä½å±…ç­‰æ¸›ç®—ï¼ˆå…¥å±…å®šå“¡21äººä»¥ä¸Šï¼‰">å…¥å±…å®šå“¡ãŒ21äººä»¥ä¸Š</option>
                                    <option value="å¤§è¦æ¨¡ä½å±…ç­‰æ¸›ç®—ï¼ˆä¸€ä½“çš„ãªå…±åŒç”Ÿæ´»ä½å±…21äººä»¥ä¸Šï¼‰">ä¸€ä½“çš„ãªå…±åŒç”Ÿæ´»ä½å±…ã®å…¥å±…å®šå“¡æ•°21ä»¥ä¸Š</option>
                                </select>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="saveCurrentUser('calc')" style="margin-top:16px; background:#e91e8c; border-color:#e91e8c;">ä¿å­˜ã™ã‚‹</button>
                        </div>
                    </div>

                    <!-- å¥‘ç´„æƒ…å ± -->
                    <div id="userTab-contract" class="building-detail-panel">
                        <div class="info-card">
                            <p style="font-size:0.85em; color:#555; margin-bottom:16px; background:#fff9e6; padding:10px; border-radius:6px;">
                                ï¼ˆå ´åˆã«ã‚ˆã£ã¦ã¯ï¼‰ä½“é¨“å…¥å±…å¥‘ç´„æ™‚ã‚ã‚‹ã„ã¯æœ¬å…¥å±…å¥‘ç´„æ™‚ã«ã¯ã€Œæ–°è¦ã€ã®å¥‘ç´„å†…å®¹å ±å‘Šæ›¸ã‚’è¡Œæ”¿ã«æå‡ºã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã€ã€Œçµ‚äº†ã€ã®å¥‘ç´„å†…å®¹å ±å‘Šæ›¸ã¯é€€å±…ã‚ã‚‹ã„ã¯äº¡ããªã‚‰ã‚ŒãŸå ´åˆã«æå‡ºã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
                            </p>
                            <div style="margin-bottom:12px;">
                                <strong id="contractFacilityLabel">Tokyo. settle</strong>
                                <button type="button" class="btn btn-primary" onclick="addContract()" style="float:right; background:#e91e8c; border-color:#e91e8c; font-size:0.85em;">æ–°è¦ç™»éŒ²</button>
                            </div>
                            <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
                                <thead>
                                    <tr style="border-bottom:1px solid #ddd;">
                                        <th style="text-align:left; padding:8px;">ã‚µãƒ¼ãƒ“ã‚¹é–‹å§‹æ—¥</th>
                                        <th style="text-align:left; padding:8px;">ä½“é¨“é–‹å§‹æ—¥</th>
                                        <th style="text-align:left; padding:8px;">å¥‘ç´„é–‹å§‹æ—¥</th>
                                        <th style="text-align:left; padding:8px;">æ›´æ–°æ—¥æ™‚</th>
                                        <th style="width:200px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="contractList"></tbody>
                            </table>
                            <div id="contractDetail" style="margin-top:20px; border-top:1px solid #eee; padding-top:16px; display:none; font-size:0.9em;"></div>
                        </div>
                    </div>

                    <!-- å±¥æ­´æƒ…å ± -->
                    <div id="userTab-history" class="building-detail-panel">
                        <div class="info-card">
                            <div id="userHistoryContent"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å®Ÿç¸¾è¨˜éŒ²ã‚¿ãƒ– -->
            <div id="records" class="tab-content">
                <div class="form-group">
                    <label style="font-weight: 600; margin-bottom: 10px; display: block;">åˆ©ç”¨è€…ã‚’é¸æŠ</label>
                    <select id="recordUser" onchange="loadRecords()" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                        <option value="">åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                </div>

                <div class="calendar-header">
                    <button class="btn btn-secondary" onclick="changeMonth(-1)">â† å‰æœˆ</button>
                    <h2 id="currentMonth"></h2>
                    <button class="btn btn-secondary" onclick="changeMonth(1)">æ¬¡æœˆ â†’</button>
                </div>

                <div class="calendar-actions">
                    <button class="btn btn-success" onclick="fillMonth('â—‹ï¼ˆæœ¬å…¥å±…ï¼‰')">âœ… å…¨ã¦æœ¬å…¥å±…ï¼ˆâ—‹ï¼‰ã§åŸ‹ã‚ã‚‹</button>
                    <button class="btn btn-warning" onclick="fillMonth('å¤–æ³Š')">ğŸ–ï¸ å…¨ã¦å¤–æ³Šã§åŸ‹ã‚ã‚‹</button>
                    <button class="btn btn-info" onclick="fillMonth('å…¥é™¢')">ğŸ¥ å…¨ã¦å…¥é™¢ã§åŸ‹ã‚ã‚‹</button>
                    <button class="btn btn-secondary" onclick="clearMonth()">ğŸ—‘ï¸ ä»Šæœˆã‚’ã‚¯ãƒªã‚¢</button>
                </div>

                <div id="calendar" class="calendar"></div>

                <div style="margin-top:20px; padding:16px; background:#fff; border-top:2px solid #eee; text-align:center;">
                    <p style="font-size:0.85em; color:#888; margin-bottom:10px;">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®å„æ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¨˜éŒ²ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                    <button class="btn btn-primary" onclick="confirmSaveAllRecords()" style="background:#e91e8c; border-color:#e91e8c; padding:12px 40px; font-size:1em;">ğŸ’¾ ä¿å­˜ã™ã‚‹</button>
                </div>
            </div>

            <!-- è«‹æ±‚ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›ã‚¿ãƒ– -->
            <div id="export" class="tab-content">
                <h2 class="section-header">è«‹æ±‚ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›</h2>

                <!-- ãƒ‘ãƒ³ããš -->
                <div style="font-size:0.85em; color:#888; margin-bottom:12px;">
                    <span style="color:#667eea;">ãƒ›ãƒ¼ãƒ </span> / è«‹æ±‚
                </div>

                <!-- äº‹æ¥­æ‰€ãƒ»ã‚µãƒ¼ãƒ“ã‚¹æä¾›å¹´æœˆ -->
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:12px;">
                    <div>
                        <label style="font-size:0.85em; color:#555; display:block; margin-bottom:4px;">äº‹æ¥­æ‰€</label>
                        <div id="exportFacilityName" style="padding:10px 14px; border:1px solid #ddd; border-radius:6px; background:#f9f9f9; font-size:0.95em;"></div>
                    </div>
                    <div>
                        <label style="font-size:0.85em; color:#555; display:block; margin-bottom:4px;">ã‚µãƒ¼ãƒ“ã‚¹æä¾›å¹´æœˆ</label>
                        <select id="exportMonthSelect" onchange="onExportMonthChange()" style="width:100%; padding:10px 14px; border:1px solid #ddd; border-radius:6px; background:white;">
                        </select>
                    </div>
                </div>

                <!-- ç¢ºå®šãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding:10px 0; border-top:1px solid #eee; border-bottom:1px solid #eee;">
                    <div style="display:flex; gap:10px; align-items:center;">
                        <button id="btnConfirm" onclick="toggleConfirm()" style="padding:8px 20px; border-radius:6px; border:none; cursor:pointer; font-size:0.9em; font-weight:600; background:#e91e8c; color:white;">ç¢ºå®š</button>
                        <span id="confirmStatusLabel" style="font-size:0.85em; color:#888;"></span>
                    </div>
                    <a href="#" onclick="showConfirmHistory(); return false;" style="font-size:0.85em; color:#667eea;">ç¢ºå®šå±¥æ­´ç”»é¢ã¸</a>
                </div>

                <div id="confirmHistoryPanel" style="display:none; background:#f9f9f9; border:1px solid #ddd; border-radius:8px; padding:16px; margin-bottom:20px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <strong style="font-size:0.9em;">ç¢ºå®šå±¥æ­´</strong>
                        <button onclick="document.getElementById('confirmHistoryPanel').style.display='none'" style="background:none; border:none; cursor:pointer; color:#888; font-size:1.1em;">âœ•</button>
                    </div>
                    <div id="confirmHistoryList" style="font-size:0.85em;"></div>
                </div>

                <!-- åˆ©ç”¨è€…è©³ç´°ã‚’è¡¨ç¤ºãƒªãƒ³ã‚¯ -->
                <div style="margin-bottom:20px;">
                    <a href="#" onclick="showTab2('users'); return false;" style="font-size:0.85em; color:#667eea;">åˆ©ç”¨è€…è©³ç´°ã‚’è¡¨ç¤º</a>
                </div>

                <!-- å¯¾è±¡å¹´æœˆï¼ˆhiddenã€æ—§äº’æ›ç”¨ï¼‰ -->
                <input type="hidden" id="exportMonth">

                <!-- åˆ©ç”¨è€…é¸æŠ -->
                <div style="background:#f9f9f9; border:1px solid #ddd; border-radius:8px; padding:16px; margin-bottom:20px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <strong style="font-size:0.9em;">å‡ºåŠ›å¯¾è±¡åˆ©ç”¨è€…</strong>
                        <div style="display:flex; gap:8px;">
                            <button class="btn btn-secondary" onclick="selectAllExportUsers(true)" style="padding:4px 10px; font-size:0.8em;">å…¨é¸æŠ</button>
                            <button class="btn btn-secondary" onclick="selectAllExportUsers(false)" style="padding:4px 10px; font-size:0.8em;">å…¨è§£é™¤</button>
                        </div>
                    </div>
                    <div id="exportUserList" style="display:flex; flex-wrap:wrap; gap:8px; max-height:150px; overflow-y:auto;"></div>
                </div>

                <!-- å›½ä¿é€£é€ä¿¡ç”¨CSVãƒ•ã‚¡ã‚¤ãƒ« -->
                <div style="border:1px solid #ddd; border-radius:8px; overflow:hidden; margin-bottom:20px;">
                    <div style="background:#f0f4ff; padding:12px 16px; border-bottom:1px solid #ddd;">
                        <strong>å›½ä¿é€£é€ä¿¡ç”¨CSVãƒ•ã‚¡ã‚¤ãƒ«</strong>
                        <p style="font-size:0.8em; color:#666; margin:4px 0 0;">å›½ä¿é€£è«‹æ±‚æ™‚ã«ã€å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦å–è¾¼é€ä¿¡V2ï¼ˆé›»å­è«‹æ±‚å—ä»˜ã‚·ã‚¹ãƒ†ãƒ ï¼‰ã«æ·»ä»˜ã—ã¦é€ä¿¡ã—ã¾ã™ã€‚</p>
                    </div>
                    <div style="padding:16px; display:flex; flex-direction:column; gap:14px;">
                        <div>
                            <p style="font-size:0.85em; margin-bottom:6px;">ä»‹è­·çµ¦ä»˜è²»ãƒ»è¨“ç·´ç­‰çµ¦ä»˜è²»ç­‰è«‹æ±‚æ›¸ãƒ»æ˜ç´°æ›¸ã€€ã€SEã€‘</p>
                            <button class="btn btn-primary" onclick="exportCSV('SE')" style="background:#e91e8c; border-color:#e91e8c;">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                        </div>
                        <div>
                            <p style="font-size:0.85em; margin-bottom:6px;">åˆ©ç”¨è€…è² æ‹…ä¸Šé™é¡ç®¡ç†çµæœç¥¨ã€€ã€RKã€‘ã€€<span style="color:#888; font-size:0.85em;">ï¼ˆâ€»è‡ªäº‹æ¥­æ‰€ãŒã€ŒåŸç±ç®¡ç†äº‹æ¥­è€…ã®å ´åˆã®ã¿ä½¿ç”¨ï¼‰</span></p>
                            <button class="btn btn-primary" onclick="exportCSV('RK')" style="background:#e91e8c; border-color:#e91e8c;">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                        </div>
                        <div>
                            <p style="font-size:0.85em; margin-bottom:6px;">ã‚µãƒ¼ãƒ“ã‚¹æä¾›å®Ÿç¸¾è¨˜éŒ²ç¥¨ã€€ã€SVã€‘</p>
                            <button class="btn btn-primary" onclick="exportCSV('SV')" style="background:#e91e8c; border-color:#e91e8c;">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                        </div>
                        <p style="font-size:0.78em; color:#888;">åŸºæœ¬çš„ã«ã¯ã€SEã€‘ã¨ã€SVã€‘ãƒ•ã‚¡ã‚¤ãƒ«ã®2ç¨®é¡ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦é€ä¿¡ã—ã¾ã™ã€‚ã¾ãŸã€é€ä¿¡ã‚¨ãƒ©ãƒ¼ã®åŸå› ã«ãªã‚‹ãŸã‚ã€CSVãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¾Œã€é–‹å°ã›ãšã«ãã®æœªæ·»ä»˜ã—ã¦ãã ã•ã„ï¼ˆCSVãƒ•ã‚¡ã‚¤ãƒ«ã¯é€ä¿¡ç”¨ãªã®ã§é–²è¦§ä¸è¦ã§ã™ï¼‰ã€‚</p>
                    </div>
                </div>

                <!-- å¸³ç¥¨å°åˆ·ç”¨PDFãƒ•ã‚¡ã‚¤ãƒ« -->
                <div style="border:1px solid #ddd; border-radius:8px; overflow:hidden; margin-bottom:20px;">
                    <div style="background:#f0f4ff; padding:12px 16px; border-bottom:1px solid #ddd;">
                        <strong>å¸³ç¥¨å°åˆ·ç”¨PDFãƒ•ã‚¡ã‚¤ãƒ«</strong>
                        <p style="font-size:0.8em; color:#666; margin:4px 0 0;">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸPDFãƒ•ã‚¡ã‚¤ãƒ«ã¯å¿…ãšä¿å­˜ã—ã€ä¿ç®¡ã—ã¦ãã ã•ã„ã€‚</p>
                    </div>
                    <div style="padding:16px; display:flex; flex-direction:column; gap:14px;">
                        <div>
                            <p style="font-size:0.85em; margin-bottom:6px;">ä»‹è­·çµ¦ä»˜è²»ãƒ»è¨“ç·´ç­‰çµ¦ä»˜è²»ç­‰è«‹æ±‚æ›¸ãƒ»æ˜ç´°æ›¸ã€€ã€SEã€‘ã€€<span style="color:#888; font-size:0.85em;">...è«‹æ±‚æ›¸ãƒ»æ˜ç´°æ›¸ã®ç¢ºèªç”¨</span></p>
                            <button class="btn btn-primary" onclick="exportPDF('SE')" style="background:#e91e8c; border-color:#e91e8c;">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                        </div>
                        <div>
                            <p style="font-size:0.85em; margin-bottom:6px;">åˆ©ç”¨è€…è² æ‹…ä¸Šé™é¡ç®¡ç†çµæœç¥¨ã€€ã€RKã€‘ã€€<span style="color:#888; font-size:0.85em;">ï¼ˆâ€»è‡ªäº‹æ¥­æ‰€ãŒã€ŒåŸç±ï¼ˆç®¡ç†ï¼‰ã€äº‹æ¥­è€…ã®å ´åˆã®ã¿ä½¿ç”¨ï¼‰</span></p>
                            <button class="btn btn-primary" onclick="exportPDF('RK')" style="background:#e91e8c; border-color:#e91e8c;">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                        </div>
                        <div>
                            <p style="font-size:0.85em; margin-bottom:6px;">åˆ©ç”¨è€…è² æ‹…é¡ä¸€è¦§è¡¨ã€€<span style="color:#888; font-size:0.85em;">ï¼ˆâ€»è‡ªäº‹æ¥­æ‰€ãŒã€ŒåŸç±ï¼ˆé–¢ä¿‚ï¼‰ã€äº‹æ¥­è€…ã®å ´åˆã®ã¿ä½¿ç”¨ï¼‰</span></p>
                            <button class="btn btn-primary" onclick="exportPDF('è² æ‹…é¡ä¸€è¦§')" style="background:#e91e8c; border-color:#e91e8c;">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                        </div>
                        <div>
                            <p style="font-size:0.85em; margin-bottom:6px;">ã‚µãƒ¼ãƒ“ã‚¹æä¾›å®Ÿç¸¾è¨˜éŒ²ç¥¨ã€€ã€SVã€‘ã€€<span style="color:#888; font-size:0.85em;">...æ—¥ãƒ™ãƒ¼ã‚¹ã§ä¿ç®¡ãŒå¿…è¦ï¼ˆåˆ©ç”¨è€…ç½²åæ¬„ã‚ã‚Šï¼‰</span></p>
                            <button class="btn btn-primary" onclick="exportPDF('SV')" style="background:#e91e8c; border-color:#e91e8c;">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                        </div>
                        <hr style="border:none; border-top:1px solid #eee;">
                        <div>
                            <p style="font-size:0.85em; margin-bottom:6px; font-weight:600;">åˆ©ç”¨è€…è«‹æ±‚æ›¸</p>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <button class="btn btn-primary" onclick="exportPDF('è«‹æ±‚æ›¸PDF')" style="background:#e91e8c; border-color:#e91e8c; padding:6px 14px;">PDF</button>
                                <button class="btn btn-success" onclick="exportExcel('è«‹æ±‚æ›¸')" style="background:#217346; border-color:#217346; padding:6px 14px;">EXCEL</button>
                                <span style="font-size:0.85em; color:#555;">å°åˆ·æ—¥</span>
                                <input type="date" id="exportPrintDate2" style="padding:5px 8px; border:1px solid #ddd; border-radius:5px; font-size:0.85em;">
                            </div>
                        </div>
                        <div>
                            <p style="font-size:0.85em; margin-bottom:6px; font-weight:600;">åˆ©ç”¨è€…é ˜åæ›¸</p>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <button class="btn btn-primary" onclick="exportPDF('é ˜åæ›¸PDF')" style="background:#e91e8c; border-color:#e91e8c; padding:6px 14px;">PDF</button>
                                <button class="btn btn-success" onclick="exportExcel('é ˜åæ›¸')" style="background:#217346; border-color:#217346; padding:6px 14px;">EXCEL</button>
                                <span style="font-size:0.85em; color:#555;">å°åˆ·æ—¥</span>
                                <input type="date" id="exportPrintDate3" style="padding:5px 8px; border:1px solid #ddd; border-radius:5px; font-size:0.85em;">
                            </div>
                        </div>
                        <div>
                            <p style="font-size:0.85em; margin-bottom:6px; font-weight:600;">ä»£ç†å—é ˜é€šçŸ¥ç¥¨</p>
                            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                                <button class="btn btn-primary" onclick="exportPDF('ä»£ç†å—é ˜PDF')" style="background:#e91e8c; border-color:#e91e8c; padding:6px 14px;">PDF</button>
                                <button class="btn btn-success" onclick="exportExcel('ä»£ç†å—é ˜')" style="background:#217346; border-color:#217346; padding:6px 14px;">EXCEL</button>
                                <span style="font-size:0.85em; color:#555;">å°åˆ·æ—¥</span>
                                <input type="date" id="exportPrintDate4" style="padding:5px 8px; border:1px solid #ddd; border-radius:5px; font-size:0.85em;">
                                <span style="font-size:0.85em; color:#555;">å—é ˜æ—¥</span>
                                <input type="date" id="exportReceiveDate2" style="padding:5px 8px; border:1px solid #ddd; border-radius:5px; font-size:0.85em;">
                                <span style="font-size:0.78em; color:#888;">ï¼ˆâ€»å—é ˜æ—¥ï¼šå›½ä¿é€£è«‹æ±‚ã§å…¥é‡‘ã•ã‚ŒãŸæ—¥ï¼‰</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="exportStatus" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šå®Ÿç¸¾è¨˜éŒ²è©³ç´° -->
    <div id="dateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                å®Ÿç¸¾è¨˜éŒ²è©³ç´°
                <button class="modal-close" onclick="closeModal()">âœ•</button>
            </div>

            <!-- ç™»éŒ²æ—¥ -->
            <div class="modal-section">
                <div class="modal-label">ç™»éŒ²æ—¥</div>
                <div class="modal-row">
                    <input type="date" id="modalDateFrom" style="flex:1;">
                    <span>ã€œ</span>
                    <input type="date" id="modalDateTo" style="flex:1;">
                </div>
            </div>

            <!-- ç™»éŒ²æ›œæ—¥ -->
            <div class="modal-section">
                <div class="modal-label">ç™»éŒ²æ›œæ—¥</div>
                <div class="modal-row" style="flex-wrap:wrap; gap:10px;">
                    <label class="modal-checkbox-row"><input type="checkbox" class="modalDow" value="1"> æœˆ</label>
                    <label class="modal-checkbox-row"><input type="checkbox" class="modalDow" value="2"> ç«</label>
                    <label class="modal-checkbox-row"><input type="checkbox" class="modalDow" value="3"> æ°´</label>
                    <label class="modal-checkbox-row"><input type="checkbox" class="modalDow" value="4"> æœ¨</label>
                    <label class="modal-checkbox-row"><input type="checkbox" class="modalDow" value="5"> é‡‘</label>
                    <label class="modal-checkbox-row"><input type="checkbox" class="modalDow" value="6"> åœŸ</label>
                    <label class="modal-checkbox-row"><input type="checkbox" class="modalDow" value="0"> æ—¥</label>
                </div>
            </div>

            <div class="modal-update-bar">
                <label class="modal-checkbox-row">
                    <input type="checkbox" id="modalOverwrite" checked>
                    æ›´æ–°ã€€ç™»éŒ²æœŸé–“ã§æ—¢ã«ç™»éŒ²æ¸ˆã¿ã®å ´åˆã€ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™ã¨ä¸Šæ›¸ãã—ã¾ã›ã‚“
                </label>
            </div>

            <!-- ã‚µãƒ¼ãƒ“ã‚¹æä¾›ã®çŠ¶æ³ -->
            <div class="modal-section">
                <label class="modal-label"><input type="checkbox" id="modalEnableStatus" checked> ã‚µãƒ¼ãƒ“ã‚¹æä¾›ã®çŠ¶æ³</label>
                <select id="modalStatus">
                    <option value="">ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>
                    <option value="â—‹ï¼ˆæœ¬å…¥å±…ï¼‰">â—‹(æœ¬å…¥å±…)</option>
                    <option value="å…¥é™¢å§‹">å…¥é™¢å§‹</option>
                    <option value="å…¥é™¢">å…¥é™¢</option>
                    <option value="å…¥é™¢çµ‚">å…¥é™¢çµ‚</option>
                    <option value="å¤–æ³Šå§‹">å¤–æ³Šå§‹</option>
                    <option value="å¤–æ³Š">å¤–æ³Š</option>
                    <option value="å¤–æ³Šçµ‚">å¤–æ³Šçµ‚</option>
                    <option value="å…¥é™¢â†’å¤–æ³Š">å…¥é™¢â†’å¤–æ³Š</option>
                    <option value="å¤–æ³Šâ†’å…¥é™¢">å¤–æ³Šâ†’å…¥é™¢</option>
                    <option value="å…¥é™¢â†’å…±åŒç”Ÿæ´»ä½å±…ã«æˆ»ã‚‹â†’å¤–æ³Š">å…¥é™¢â†’å…±åŒç”Ÿæ´»ä½å±…ã«æˆ»ã‚‹â†’å¤–æ³Š</option>
                    <option value="å¤–æ³Šâ†’å…±åŒç”Ÿæ´»ä½å±…ã«æˆ»ã‚‹â†’å…¥é™¢">å¤–æ³Šâ†’å…±åŒç”Ÿæ´»ä½å±…ã«æˆ»ã‚‹â†’å…¥é™¢</option>
                    <option value="ä½“é¨“">ä½“é¨“</option>
                </select>
            </div>

            <!-- å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®— -->
            <div class="modal-section">
                <label class="modal-label"><input type="checkbox" id="modalEnableNight" checked> å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—</label>
                <div class="modal-hint" id="modalNightHint"></div>
                <select id="modalNightSupport">
                    <option value="">ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>
                </select>
            </div>

            <!-- ãã®ä»–ã®é …ç›®ã‚’è¡¨ç¤º -->
            <div style="margin: 12px 0;">
                <a href="#" class="modal-collapse-btn" onclick="toggleModalExtra(); return false;">ãã®ä»–ã®é …ç›®ã‚’è¡¨ç¤º</a>
            </div>

            <div id="modalExtraItems" style="display:none;">
                <!-- å…¥é™¢æ™‚/å¸°å®…æ™‚æ”¯æ´ç‰¹åˆ¥åŠ ç®— -->
                <div class="modal-section">
                    <label class="modal-checkbox-row"><input type="checkbox" id="modalInpatientSupport"> å…¥é™¢æ™‚æ”¯æ´ç‰¹åˆ¥åŠ ç®—</label>
                    <label class="modal-checkbox-row"><input type="checkbox" id="modalReturnSupport"> å¸°å®…æ™‚æ”¯æ´åŠ ç®—</label>
                </div>

                <!-- æ—¥ä¸­æ”¯æ´åŠ ç®— -->
                <div class="modal-section">
                    <label class="modal-label"><input type="checkbox" id="modalEnableDaytime" checked> æ—¥ä¸­æ”¯æ´åŠ ç®—</label>
                    <div class="modal-hint" id="modalDaytimeHint"></div>
                    <select id="modalDaytimeSupport">
                        <option value="">ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>
                        <option value="æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰1äºº">æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰ã€€1äºº</option>
                        <option value="æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰2äººä»¥ä¸Š">æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰ã€€2äººä»¥ä¸Š</option>
                        <option value="æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰1äºº åŒºåˆ†4ãƒ»5ãƒ»6">æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰ã€€1äººã€€åŒºåˆ†ï¼”ã€ï¼•ã€ï¼–</option>
                        <option value="æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰1äºº åŒºåˆ†3ä»¥ä¸‹">æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰ã€€1äººã€€åŒºåˆ†ï¼“ä»¥ä¸‹</option>
                        <option value="æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰2äººä»¥ä¸Š åŒºåˆ†4ãƒ»5ãƒ»6">æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰ã€€2äººä»¥ä¸Šã€€åŒºåˆ†ï¼”ã€ï¼•ã€ï¼–</option>
                        <option value="æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰2äººä»¥ä¸Š åŒºåˆ†3ä»¥ä¸‹">æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰ã€€2äººä»¥ä¸Šã€€åŒºåˆ†ï¼“ä»¥ä¸‹</option>
                    </select>
                </div>

                <!-- åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®— -->
                <div class="modal-section">
                    <label class="modal-label"><input type="checkbox" id="modalEnableMedical" checked> åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—</label>
                    <select id="modalMedicalCoop">
                        <option value="">ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>
                        <option value="åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰">åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰</option>
                        <option value="åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰">åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰</option>
                        <option value="åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…¢ï¼‰">åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…¢ï¼‰</option>
                        <option value="åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…£ï¼‰">åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…£ï¼‰</option>
                        <option value="åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…¤ï¼‰">åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…¤ï¼‰</option>
                        <option value="åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…¥ï¼‰">åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…¥ï¼‰</option>
                        <option value="åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…¦ï¼‰">åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ï¼ˆâ…¦ï¼‰</option>
                    </select>
                </div>

                <!-- è‡ªç«‹ç”Ÿæ´»æ”¯æ´åŠ ç®— -->
                <div class="modal-section">
                    <label class="modal-label"><input type="checkbox" id="modalEnableSelfSupport" checked> è‡ªç«‹ç”Ÿæ´»æ”¯æ´åŠ ç®—</label>
                    <select id="modalSelfSupport">
                        <option value="">ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>
                        <option value="è‡ªç«‹ç”Ÿæ´»æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰">è‡ªç«‹ç”Ÿæ´»æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰</option>
                    </select>
                </div>

                <!-- å‚™è€ƒ -->
                <div class="modal-section">
                    <label class="modal-label"><input type="checkbox" id="modalEnableNote" checked> å‚™è€ƒ</label>
                    <input type="text" id="modalNote" placeholder="å‚™è€ƒ">
                </div>

                <hr class="modal-divider">

                <!-- é•·æœŸå…¥é™¢æ™‚/å¸°å®…æ™‚æ”¯æ´ç‰¹åˆ¥åŠ ç®— -->
                <div class="modal-section">
                    <label class="modal-checkbox-row"><input type="checkbox" id="modalLongInpatient"> é•·æœŸå…¥é™¢æ™‚æ”¯æ´ç‰¹åˆ¥åŠ ç®—</label>
                    <label class="modal-checkbox-row"><input type="checkbox" id="modalLongReturn"> é•·æœŸå¸°å®…æ™‚æ”¯æ´åŠ ç®—</label>
                    <label class="modal-checkbox-row"><input type="checkbox" id="modalHomeCare"> å±…å®…ä»‹è­·ç­‰ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆï¼ˆé•·æ™‚é–“ï¼‰</label>
                </div>

                <!-- é›†ä¸­çš„æ”¯æ´åŠ ç®— -->
                <div class="modal-section">
                    <label class="modal-label"><input type="checkbox" id="modalEnableIntensive" checked> é›†ä¸­çš„æ”¯æ´åŠ ç®—</label>
                    <select id="modalIntensive">
                        <option value="">ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>
                        <option value="é›†ä¸­çš„æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰">é›†ä¸­çš„æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰</option>
                        <option value="é›†ä¸­çš„æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰">é›†ä¸­çš„æ”¯æ´åŠ ç®—ï¼ˆâ…¡ï¼‰</option>
                        <option value="é›†ä¸­çš„æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰ï¼ˆâ…¡ï¼‰">é›†ä¸­çš„æ”¯æ´åŠ ç®—ï¼ˆâ… ï¼‰ï¼ˆâ…¡ï¼‰</option>
                    </select>
                </div>

                <hr class="modal-divider">

                <!-- ãã®ä»–ã®åŠ ç®—ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ç¾¤ -->
                <div class="modal-section">
                    <label class="modal-checkbox-row"><input type="checkbox" id="modalAfterLeave"> é€€å±…å¾Œã‚µãƒ¼ãƒ“ã‚¹æä¾›</label>
                    <label class="modal-checkbox-row"><input type="checkbox" id="modalPeerSupport"> ãƒ”ã‚¢ã‚µãƒãƒ¼ãƒˆå®Ÿæ–½åŠ ç®—</label>
                    <label class="modal-checkbox-row"><input type="checkbox" id="modalAfterPeer"> é€€å»å¾Œãƒ”ã‚¢ã‚µãƒãƒ¼ãƒˆå®Ÿæ–½åŠ ç®—</label>
                    <label class="modal-checkbox-row"><input type="checkbox" id="modalInfection"> æ–°èˆˆæ„ŸæŸ“ç—‡ç­‰æ–½è¨­ç™‚é¤ŠåŠ ç®—</label>
                    <label class="modal-checkbox-row"><input type="checkbox" id="modalStaffArrangement"> äººå“¡é…ç½®ä½“åˆ¶åŠ ç®—</label>
                </div>
            </div>

            <!-- ãƒœã‚¿ãƒ³ -->
            <div style="margin-top:20px; display:flex; gap:10px; position:sticky; bottom:0; background:white; padding-top:12px; border-top:1px solid #eee;">
                <button class="btn btn-primary" onclick="saveRecord()" style="background:#e91e8c; border-color:#e91e8c; flex:1;">ä¿å­˜ã™ã‚‹</button>
                <button class="btn btn-secondary" onclick="closeModal()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        // ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
        let users = JSON.parse(localStorage.getItem('gh_users') || '[]');
        let records = JSON.parse(localStorage.getItem('gh_records') || '{}');
        let facility = JSON.parse(localStorage.getItem('gh_facility') || '{}');
        let buildings = JSON.parse(localStorage.getItem('gh_buildings') || '[]');
        
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        let selectedUserId = null;
        let selectedDate = null;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadFacilityInfo();
            renderBuildingList();
            renderUserList();
            updateUserSelector();
            updateCalendar();
            updateUnitOptions();
            displayFacilityInfo();
            
            const today = new Date();
            document.getElementById('exportMonth').value = 
                `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
        });

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'export') {
                initExportTab();
            }
        }

        // ========== äº‹æ¥­æ‰€æƒ…å ±ç®¡ç† ==========
        
        function loadFacilityInfo() {
            if (facility.facilityNumber) {
                document.getElementById('facilityNumber').value = facility.facilityNumber || '';
                document.getElementById('facilityName').value = facility.facilityName || '';
                document.getElementById('corporationName').value = facility.corporationName || '';
                document.getElementById('facilityZip').value = facility.facilityZip || '';
                document.getElementById('facilityAddress').value = facility.facilityAddress || '';
                document.getElementById('facilityTel').value = facility.facilityTel || '';
                document.getElementById('directorTitle').value = facility.directorTitle || '';
                document.getElementById('directorName').value = facility.directorName || '';
                document.getElementById('areaCode').value = facility.areaCode || '01';
                document.getElementById('residentialCareSystem').value = facility.residentialCareSystem || '';
                document.getElementById('staffRatio').value = facility.staffRatio || '12ï¼š1';
                document.getElementById('nurseCount').value = facility.nurseCount || '';
                document.getElementById('nightSupportType1').value = facility.nightSupportType1 || '';
                document.getElementById('nightSupportType2').value = facility.nightSupportType2 || '';
                document.getElementById('nightSupportType3').value = facility.nightSupportType3 || '';
                document.getElementById('treatmentImprovement').value = facility.treatmentImprovement || '';
                document.getElementById('daySupport').value = facility.daySupport || '';
                document.getElementById('infectionControl').value = facility.infectionControl || '';

                // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®å¾©å…ƒï¼ˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³åŒ–ã—ãŸåŠ ç®—ãƒ»æ¸›ç®—ï¼‰
                const selects = [
                    'specialistAllowance', 'sensorySupport', 'medicalCooperation',
                    'largeScaleReduction', 'serviceManagerReduction', 'staffReduction'
                ];
                selects.forEach(id => {
                    const el = document.getElementById(id);
                    if (el && facility[id]) el.value = facility[id];
                });

                // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¾©å…ƒ
                const checkboxes = [
                    'nurseAllowance', 'medicalCooperationRecord', 'commuterSupport',
                    'housingSupport', 'transitionSupport', 'peerSupport',
                    'coreStaffing', 'brainInjurySupport',
                    'restraintReduction', 'abusePreventionReduction',
                    'bcpReduction', 'infoDisclosureReduction'
                ];

                checkboxes.forEach(id => {
                    const checkbox = document.getElementById(id);
                    if (checkbox && facility[id]) {
                        checkbox.checked = true;
                    }
                });
            }
        }

        document.getElementById('facilityForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            facility = {
                facilityNumber: document.getElementById('facilityNumber').value,
                facilityName: document.getElementById('facilityName').value,
                corporationName: document.getElementById('corporationName').value,
                facilityZip: document.getElementById('facilityZip').value,
                facilityAddress: document.getElementById('facilityAddress').value,
                facilityTel: document.getElementById('facilityTel').value,
                directorTitle: document.getElementById('directorTitle').value,
                directorName: document.getElementById('directorName').value,
                areaCode: document.getElementById('areaCode').value,
                residentialCareSystem: document.getElementById('residentialCareSystem').value,
                staffRatio: document.getElementById('staffRatio').value,
                nurseCount: document.getElementById('nurseCount').value,
                nightSupportType1: document.getElementById('nightSupportType1').value,
                nightSupportType2: document.getElementById('nightSupportType2').value,
                nightSupportType3: document.getElementById('nightSupportType3').value,
                treatmentImprovement: document.getElementById('treatmentImprovement').value,
                daySupport: document.getElementById('daySupport').value,
                infectionControl: document.getElementById('infectionControl').value
            };

            // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®ä¿å­˜ï¼ˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³åŒ–ã—ãŸåŠ ç®—ãƒ»æ¸›ç®—ï¼‰
            const selects = [
                'specialistAllowance', 'sensorySupport', 'medicalCooperation',
                'largeScaleReduction', 'serviceManagerReduction', 'staffReduction'
            ];
            selects.forEach(id => {
                const el = document.getElementById(id);
                facility[id] = el ? el.value : '';
            });

            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ä¿å­˜
            const checkboxes = [
                'nurseAllowance', 'medicalCooperationRecord', 'commuterSupport',
                'housingSupport', 'transitionSupport', 'peerSupport',
                'coreStaffing', 'brainInjurySupport',
                'restraintReduction', 'abusePreventionReduction',
                'bcpReduction', 'infoDisclosureReduction'
            ];

            checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                facility[id] = checkbox ? checkbox.checked : false;
            });

            localStorage.setItem('gh_facility', JSON.stringify(facility));
            
            displayFacilityInfo();
            alert('âœ… äº‹æ¥­æ‰€æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
        });

        function displayFacilityInfo() {
            const container = document.getElementById('facilityInfo');
            if (!facility.facilityNumber) return;

            const activeAdditions = [];
            const activeReductions = [];

            // é¸æŠå¼ã®åŠ ç®—
            if (facility.nightSupportType1) activeAdditions.push('å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰: ' + facility.nightSupportType1);
            if (facility.nightSupportType2) activeAdditions.push('å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰: ' + facility.nightSupportType2);
            if (facility.nightSupportType3) activeAdditions.push(facility.nightSupportType3);
            if (facility.treatmentImprovement) activeAdditions.push(facility.treatmentImprovement);
            if (facility.daySupport) activeAdditions.push(facility.daySupport);
            if (facility.infectionControl) activeAdditions.push(facility.infectionControl);
            // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³åŒ–ã—ãŸåŠ ç®—
            if (facility.specialistAllowance) activeAdditions.push(facility.specialistAllowance);
            if (facility.sensorySupport) activeAdditions.push(facility.sensorySupport);
            if (facility.medicalCooperation) activeAdditions.push(facility.medicalCooperation);

            const additions = {
                nurseAllowance: 'çœ‹è­·è·å“¡é…ç½®åŠ ç®—',
                medicalCooperationRecord: 'åŒ»ç™‚é€£æºï¼ˆå®Ÿç¸¾è¨˜éŒ²ç­‰ã®æ•´å‚™ã«å¿…è¦ï¼‰',
                commuterSupport: 'é€šå‹¤è€…ç”Ÿæ´»æ”¯æ´åŠ ç®—',
                housingSupport: 'å±…ä½æ”¯æ´ä½“åˆ¶',
                transitionSupport: 'ç§»è¡Œæ”¯æ´ä½ä½“åˆ¶',
                peerSupport: 'ãƒ”ã‚¢ã‚µãƒãƒ¼ãƒˆå®Ÿæ–½åŠ ç®—',
                coreStaffing: 'ä¸­æ ¸çš„äººæé…ç½®ä½“åˆ¶',
                brainInjurySupport: 'é«˜æ¬¡è„³æ©Ÿèƒ½éšœå®³è€…æ”¯æ´ä½“åˆ¶'
            };

            const reductions = {
                restraintReduction: 'èº«ä½“æ‹˜æŸå»ƒæ­¢æœªå®Ÿæ–½æ¸›ç®—',
                abusePreventionReduction: 'è™å¾…é˜²æ­¢æªç½®æœªå®Ÿæ–½æ¸›ç®—',
                bcpReduction: 'æ¥­å‹™ç¶™ç¶šè¨ˆç”»æœªç­–å®šæ¸›ç®—',
                infoDisclosureReduction: 'æƒ…å ±å…¬è¡¨æœªå ±å‘Šæ¸›ç®—'
            };

            // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³åŒ–ã—ãŸæ¸›ç®—
            if (facility.largeScaleReduction) activeReductions.push(facility.largeScaleReduction);
            if (facility.serviceManagerReduction) activeReductions.push(facility.serviceManagerReduction);
            if (facility.staffReduction) activeReductions.push(facility.staffReduction);

            Object.keys(additions).forEach(key => {
                if (facility[key]) activeAdditions.push(additions[key]);
            });

            Object.keys(reductions).forEach(key => {
                if (facility[key]) activeReductions.push(reductions[key]);
            });

            container.innerHTML = `
                <h2 class="section-header">ç™»éŒ²æƒ…å ±</h2>
                <div class="info-card">
                    <h3>äº‹æ¥­æ‰€åŸºæœ¬æƒ…å ±</h3>
                    <p><strong>äº‹æ¥­æ‰€ç•ªå·:</strong> ${facility.facilityNumber}</p>
                    <p><strong>äº‹æ¥­æ‰€å:</strong> ${facility.facilityName}</p>
                    <p><strong>æ³•äººå:</strong> ${facility.corporationName}</p>
                    <p><strong>åœ°åŸŸåŒºåˆ†:</strong> ${getAreaName(facility.areaCode)}</p>
                    ${facility.residentialCareSystem ? `<p><strong>å…¥å“¡é…ç½®ä½“åˆ¶:</strong> ${facility.residentialCareSystem}</p>` : ''}
                    ${facility.staffRatio ? `<p><strong>è·å“¡é…ç½®:</strong> ${facility.staffRatio}</p>` : ''}
                    ${facility.nurseCount ? `<p><strong>çœ‹è­·è·å“¡æ•°:</strong> ${facility.nurseCount}äºº</p>` : ''}
                </div>
                ${activeAdditions.length > 0 ? `
                <div class="info-card">
                    <h3>æœ‰åŠ¹ãªåŠ ç®—</h3>
                    ${activeAdditions.map(a => `<p>âœ… ${a}</p>`).join('')}
                </div>
                ` : ''}
                ${activeReductions.length > 0 ? `
                <div class="info-card" style="border-color: #f8d7da;">
                    <h3 style="color: #721c24;">é©ç”¨ä¸­ã®æ¸›ç®—</h3>
                    ${activeReductions.map(r => `<p>âš ï¸ ${r}</p>`).join('')}
                </div>
                ` : ''}
            `;
        }

        function getAreaName(code) {
            const areas = {
                '01': 'ä¸€ç´šåœ°', '02': 'äºŒç´šåœ°', '03': 'ä¸‰ç´šåœ°',
                '04': 'å››ç´šåœ°', '05': 'äº”ç´šåœ°', '06': 'å…­ç´šåœ°',
                '07': 'ä¸ƒç´šåœ°', '20': 'ãã®ä»–'
            };
            return areas[code] || code;
        }

        // ========== å»ºç‰©ç®¡ç† ==========

        let selectedBuildingId = null;
        let selectedBuildingInnerTab = 'basic'; // basic | calc | users | history

        function addBuilding() {
            const now = new Date();
            const building = {
                id: Date.now().toString(),
                name: 'æ–°ã—ã„å»ºç‰©',
                nameKana: '',
                manager: '',
                zip: '',
                prefecture: '',
                city: '',
                address: '',
                buildingName: '',
                tel: '',
                fax: '',
                email: '',
                totalRooms: 0,
                nightSupportType: '', // å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ã®é¸æŠå€¤
                largeScaleReduction: '',
                history: {
                    basic: {},
                    calc: {},
                    users: {}
                }
            };
            buildings.push(building);
            localStorage.setItem('gh_buildings', JSON.stringify(buildings));
            selectedBuildingId = building.id;
            renderBuildingList();
        }

        function removeBuilding(id) {
            if (confirm('ã“ã®å»ºç‰©ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                buildings = buildings.filter(b => b.id !== id);
                if (selectedBuildingId === id) selectedBuildingId = buildings.length > 0 ? buildings[0].id : null;
                localStorage.setItem('gh_buildings', JSON.stringify(buildings));
                renderBuildingList();
                updateUnitOptions();
            }
        }

        function renderBuildingList() {
            if (buildings.length === 0) {
                buildings = [
                    { id: 'nakano', name: 'Nakano. settle', nameKana: 'ãƒŠã‚«ãƒã‚»ãƒˆãƒ«', manager: 'éˆ´æœ¨', zip: '165-0026', prefecture: 'æ±äº¬éƒ½', city: 'ä¸­é‡åŒº', address: 'æ–°äº•5-30-4', buildingName: 'ã‚¹ã‚¯ã‚¨ã‚¢æ–°äº•è–¬å¸«å‰', tel: '', fax: '', email: '', totalRooms: 5, nightSupportType: '', largeScaleReduction: '', history: {basic:{},calc:{},users:{}} },
                    { id: 'nerima', name: 'Nerima. settle', nameKana: 'ãƒãƒªãƒã‚»ãƒˆãƒ«', manager: '', zip: '', prefecture: '', city: '', address: '', buildingName: '', tel: '', fax: '', email: '', totalRooms: 5, nightSupportType: '', largeScaleReduction: '', history: {basic:{},calc:{},users:{}} },
                    { id: 'nerima-west', name: 'Nerima. settle west', nameKana: 'ãƒãƒªãƒã‚»ãƒˆãƒ«ã‚¦ã‚¨ã‚¹ãƒˆ', manager: '', zip: '', prefecture: '', city: '', address: '', buildingName: '', tel: '', fax: '', email: '', totalRooms: 8, nightSupportType: '', largeScaleReduction: 'å¤§è¦æ¨¡ä½å±…ç­‰æ¸›ç®—ï¼ˆå…¥å±…å®šå“¡8äººä»¥ä¸Šï¼‰', history: {basic:{},calc:{},users:{}} }
                ];
                localStorage.setItem('gh_buildings', JSON.stringify(buildings));
            }

            // åˆæœŸé¸æŠ
            if (!selectedBuildingId && buildings.length > 0) selectedBuildingId = buildings[0].id;

            // ã‚µã‚¤ãƒ‰ãƒãƒ¼
            const sidebar = document.getElementById('buildingSidebar');
            sidebar.innerHTML = buildings.map(b => `
                <div class="building-sidebar-item ${b.id === selectedBuildingId ? 'active' : ''}" onclick="selectBuilding('${b.id}')">
                    <strong>${b.name}</strong><br>
                    <small>å®šå“¡ ${b.totalRooms}äºº</small>
                </div>
            `).join('');

            renderBuildingDetail();
            updateUnitOptions();
        }

        function selectBuilding(id) {
            selectedBuildingId = id;
            selectedBuildingInnerTab = 'basic';
            renderBuildingList();
        }

        function selectBuildingInnerTab(tab) {
            selectedBuildingInnerTab = tab;
            renderBuildingDetail();
        }

        function renderBuildingDetail() {
            const container = document.getElementById('buildingDetail');
            const b = buildings.find(b => b.id === selectedBuildingId);
            if (!b) { container.innerHTML = '<p style="color:#888;">å»ºç‰©ã‚’é¸æŠã—ã¦ãã ã•ã„</p>'; return; }

            // å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ã®é¸æŠè‚¢ç”Ÿæˆ
            const nightOpts = generateNightSupportOptions(b.nightSupportType);
            // å¤§è¦æ¨¡ä½å±…ç­‰æ¸›ç®—ã®é¸æŠè‚¢
            const largeOpts = [
                ['', 'è¨­å®šãªã—'],
                ['å¤§è¦æ¨¡ä½å±…ç­‰æ¸›ç®—ï¼ˆå…¥å±…å®šå“¡8äººä»¥ä¸Šï¼‰', 'å…¥å±…å®šå“¡ãŒï¼˜äººä»¥ä¸Š'],
                ['å¤§è¦æ¨¡ä½å±…ç­‰æ¸›ç®—ï¼ˆå…¥å±…å®šå“¡21äººä»¥ä¸Šï¼‰', 'å…¥å±…å®šå“¡ãŒ21äººä»¥ä¸Š'],
                ['å¤§è¦æ¨¡ä½å±…ç­‰æ¸›ç®—ï¼ˆä¸€ä½“çš„ãªå…±åŒç”Ÿæ´»ä½å±…21äººä»¥ä¸Šï¼‰', 'ä¸€ä½“çš„ãªå…±åŒç”Ÿæ´»ä½å±…ã®å…¥å±…å®šå“¡æ•°21ä»¥ä¸Š']
            ].map(([v, l]) => `<option value="${v}" ${b.largeScaleReduction === v ? 'selected' : ''}>${l}</option>`).join('');

            // åˆ©ç”¨è€…ã‚¿ãƒ–
            const buildingUsers = users.filter(u => u.unit === b.id);

            // å±¥æ­´ã‚¿ãƒ–
            const historyHtml = renderHistoryTab(b);

            container.innerHTML = `
                <div style="margin-bottom:12px;">
                    <strong style="font-size:1.1em;">${facility.facilityName || 'Tokyo. settle'} ${b.name}</strong>
                    <button type="button" class="btn btn-secondary" style="float:right;font-size:0.8em;padding:4px 10px;" onclick="removeBuilding('${b.id}')">ğŸ—‘ï¸ å‰Šé™¤</button>
                </div>
                <div class="building-inner-tabs">
                    <div class="building-inner-tab ${selectedBuildingInnerTab==='basic'?'active':''}" onclick="selectBuildingInnerTab('basic')">åŸºæœ¬æƒ…å ±</div>
                    <div class="building-inner-tab ${selectedBuildingInnerTab==='calc'?'active':''}" onclick="selectBuildingInnerTab('calc')">ç®—å®šæƒ…å ±</div>
                    <div class="building-inner-tab ${selectedBuildingInnerTab==='users'?'active':''}" onclick="selectBuildingInnerTab('users')">åˆ©ç”¨è€…</div>
                    <div class="building-inner-tab ${selectedBuildingInnerTab==='history'?'active':''}" onclick="selectBuildingInnerTab('history')">å±¥æ­´æƒ…å ±</div>
                </div>

                <!-- åŸºæœ¬æƒ…å ± -->
                <div class="building-detail-panel ${selectedBuildingInnerTab==='basic'?'active':''}">
                    <div class="info-card">
                        <div class="grid-2">
                            <div class="form-group">
                                <label>å»ºç‰©å</label>
                                <input type="text" value="${b.name}" onchange="updateBuilding('${b.id}','name',this.value)">
                            </div>
                            <div class="form-group">
                                <label>å»ºç‰©åã‚«ãƒŠ</label>
                                <input type="text" value="${b.nameKana||''}" onchange="updateBuilding('${b.id}','nameKana',this.value)">
                            </div>
                            <div class="form-group">
                                <label>ç®¡ç†è€…</label>
                                <input type="text" value="${b.manager||''}" onchange="updateBuilding('${b.id}','manager',this.value)">
                            </div>
                            <div class="form-group">
                                <label>éƒµä¾¿ç•ªå·</label>
                                <input type="text" value="${b.zip||''}" placeholder="000-0000" onchange="updateBuilding('${b.id}','zip',this.value)">
                            </div>
                            <div class="form-group">
                                <label>éƒ½é“åºœçœŒ</label>
                                <input type="text" value="${b.prefecture||''}" onchange="updateBuilding('${b.id}','prefecture',this.value)">
                            </div>
                            <div class="form-group">
                                <label>å¸‚åŒºç”ºæ‘</label>
                                <input type="text" value="${b.city||''}" onchange="updateBuilding('${b.id}','city',this.value)">
                            </div>
                            <div class="form-group">
                                <label>ç”ºåãƒ»ç•ªåœ°</label>
                                <input type="text" value="${b.address||''}" onchange="updateBuilding('${b.id}','address',this.value)">
                            </div>
                            <div class="form-group">
                                <label>ä½æ‰€å»ºç‰©å</label>
                                <input type="text" value="${b.buildingName||''}" onchange="updateBuilding('${b.id}','buildingName',this.value)">
                            </div>
                            <div class="form-group">
                                <label>é›»è©±ç•ªå·</label>
                                <input type="text" value="${b.tel||''}" onchange="updateBuilding('${b.id}','tel',this.value)">
                            </div>
                            <div class="form-group">
                                <label>FAX</label>
                                <input type="text" value="${b.fax||''}" onchange="updateBuilding('${b.id}','fax',this.value)">
                            </div>
                            <div class="form-group">
                                <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                                <input type="text" value="${b.email||''}" onchange="updateBuilding('${b.id}','email',this.value)">
                            </div>
                            <div class="form-group">
                                <label>ç·å±…å®¤æ•°</label>
                                <input type="number" value="${b.totalRooms||0}" onchange="updateBuilding('${b.id}','totalRooms',parseInt(this.value))">
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="saveBuildingHistory('${b.id}','basic')">ğŸ’¾ ä¿å­˜</button>
                        <a href="#" onclick="saveBuildingHistory('${b.id}','basic'); return false;" style="margin-left:12px; font-size:0.85em; color:#667eea;">å®Ÿç¸¾ãƒã‚¹ã‚¿</a>
                    </div>
                </div>

                <!-- ç®—å®šæƒ…å ± -->
                <div class="building-detail-panel ${selectedBuildingInnerTab==='calc'?'active':''}">
                    <div class="info-card">
                        <div class="form-group">
                            <label>å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—</label>
                            <select onchange="updateBuilding('${b.id}','nightSupportType',this.value)">
                                ${nightOpts}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>å¤§è¦æ¨¡ä½å±…ç­‰æ¸›ç®—</label>
                            <select onchange="updateBuilding('${b.id}','largeScaleReduction',this.value)">
                                ${largeOpts}
                            </select>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="saveBuildingHistory('${b.id}','calc')">ğŸ’¾ ä¿å­˜</button>
                    </div>
                </div>

                <!-- åˆ©ç”¨è€… -->
                <div class="building-detail-panel ${selectedBuildingInnerTab==='users'?'active':''}">
                    <div class="info-card">
                        <p style="color:#888; margin-bottom:12px;">äº‹æ¥­æ‰€ ${facility.facilityName||'Tokyo. settle'} ã®åˆ©ç”¨è€…ä¸€è¦§</p>
                        <p style="margin-bottom:12px;">${buildingUsers.length} ä»¶ã®åˆ©ç”¨è€…ã‚’è¡¨ç¤º</p>
                        ${buildingUsers.length === 0
                            ? '<p style="color:#aaa;">ã“ã®å»ºç‰©ã«åˆ©ç”¨è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>'
                            : buildingUsers.map(u => `
                                <div style="padding:10px 0; border-bottom:1px solid #eee; color:#667eea; cursor:pointer;" onclick="showTab('users')">
                                    ${u.name}
                                </div>`).join('')
                        }
                    </div>
                </div>

                <!-- å±¥æ­´æƒ…å ± -->
                <div class="building-detail-panel ${selectedBuildingInnerTab==='history'?'active':''}">
                    <div class="info-card">
                        ${historyHtml}
                    </div>
                </div>
            `;
        }

        function generateNightSupportOptions(selected) {
            const opts = [['', 'è¨­å®šãªã—']];
            // â… : 1äººã€œ30äºº
            for (let i = 1; i <= 30; i++) {
                opts.push([`å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰${i}äºº`, `å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰ã€€${i}äºº`]);
            }
            // â…¡: 4äººä»¥ä¸‹ã€œ30äºº
            opts.push([`å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰4äººä»¥ä¸‹`, `å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ã€€4äººä»¥ä¸‹`]);
            for (let i = 5; i <= 30; i++) {
                opts.push([`å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰${i}äºº`, `å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¡ï¼‰ã€€${i}äºº`]);
            }
            // â…¢
            opts.push(['å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¢ï¼‰', 'å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ…¢ï¼‰']);

            return opts.map(([v, l]) => `<option value="${v}" ${selected===v?'selected':''}>${l}</option>`).join('');
        }

        function renderHistoryTab(b) {
            if (!b.history) b.history = {basic:{}, calc:{}, users:{}};

            // å…¨ã¦ã®ã‚­ãƒ¼ï¼ˆYYYY-MMï¼‰ã‚’é›†ã‚ã‚‹
            const allKeys = new Set([
                ...Object.keys(b.history.basic||{}),
                ...Object.keys(b.history.calc||{}),
                ...Object.keys(b.history.users||{})
            ]);

            if (allKeys.size === 0) return '<p style="color:#aaa;">å¤‰æ›´å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>';

            // å¹´ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const byYear = {};
            allKeys.forEach(k => {
                const [y] = k.split('-');
                if (!byYear[y]) byYear[y] = [];
                byYear[y].push(k);
            });

            const years = Object.keys(byYear).sort((a,b)=>b-a);

            const rows = ['basic','calc','users'];
            const rowLabels = {basic:'åŸºæœ¬æƒ…å ±', calc:'ç®—å®šæƒ…å ±', users:'åˆ©ç”¨è€…'};

            let html = '';
            years.forEach(year => {
                const months = byYear[year].map(k=>k.split('-')[1]).filter((v,i,a)=>a.indexOf(v)===i).sort((a,b)=>a-b);

                // æœ€æ–°å¹´ã¯åˆ†ã‘ã¦è¡¨ç¤º
                const isLatest = year === years[0];
                if (isLatest) {
                    html += `<div style="margin-bottom:16px;">`;
                    rows.forEach(row => {
                        const latestMonths = months.filter(m => b.history[row] && b.history[row][`${year}-${m}`]);
                        if (latestMonths.length > 0) {
                            html += `<div style="display:flex; gap:8px; margin-bottom:6px; align-items:center;">
                                <span style="width:80px; font-size:0.85em; color:#888;">${rowLabels[row]}</span>
                                ${latestMonths.map(m=>`<span class="history-link" onclick="viewHistory('${b.id}','${row}','${year}-${m}')">${year}å¹´${parseInt(m)}æœˆ</span>`).join('')}
                            </div>`;
                        }
                    });
                    html += `</div>`;
                }

                html += `<div style="margin-bottom:16px;">`;
                rows.forEach(row => {
                    const histMonths = months.filter(m => b.history[row] && b.history[row][`${year}-${m}`]);
                    if (!isLatest && histMonths.length > 0) {
                        html += `<div style="display:flex; gap:6px; margin-bottom:6px; align-items:center; flex-wrap:wrap;">
                            <span style="width:80px; font-size:0.85em; color:#888;">${rowLabels[row]}</span>
                            ${histMonths.map(m=>`<span class="history-link" onclick="viewHistory('${b.id}','${row}','${year}-${m}')">${year}å¹´${parseInt(m)}æœˆ</span>`).join('')}
                        </div>`;
                    }
                });
                html += `</div>`;
            });

            return html;
        }

        function saveBuildingHistory(id, type) {
            const b = buildings.find(b => b.id === id);
            if (!b) return;
            if (!b.history) b.history = {basic:{}, calc:{}, users:{}};

            const now = new Date();
            const key = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;

            if (type === 'basic') {
                b.history.basic[key] = {
                    name: b.name, nameKana: b.nameKana, manager: b.manager,
                    zip: b.zip, prefecture: b.prefecture, city: b.city,
                    address: b.address, buildingName: b.buildingName,
                    tel: b.tel, fax: b.fax, email: b.email, totalRooms: b.totalRooms,
                    savedAt: now.toISOString()
                };
            } else if (type === 'calc') {
                b.history.calc[key] = {
                    nightSupportType: b.nightSupportType,
                    largeScaleReduction: b.largeScaleReduction,
                    savedAt: now.toISOString()
                };
            } else if (type === 'users') {
                b.history.users[key] = {
                    users: users.filter(u => u.unit === id).map(u => u.name),
                    savedAt: now.toISOString()
                };
            }

            localStorage.setItem('gh_buildings', JSON.stringify(buildings));
            alert(`âœ… ${['basic','calc','users'].includes(type) ? {basic:'åŸºæœ¬æƒ…å ±',calc:'ç®—å®šæƒ…å ±',users:'åˆ©ç”¨è€…'}[type] : type}ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼`);
            renderBuildingDetail();
        }

        function viewHistory(buildingId, type, key) {
            const b = buildings.find(b => b.id === buildingId);
            if (!b || !b.history || !b.history[type] || !b.history[type][key]) return;
            const data = b.history[type][key];
            const labels = {basic:'åŸºæœ¬æƒ…å ±', calc:'ç®—å®šæƒ…å ±', users:'åˆ©ç”¨è€…'};
            const [y, m] = key.split('-');
            let msg = `ã€${b.name} - ${labels[type]} ${y}å¹´${parseInt(m)}æœˆã€‘\n`;
            msg += `ä¿å­˜æ—¥æ™‚: ${data.savedAt ? new Date(data.savedAt).toLocaleString('ja-JP') : 'ä¸æ˜'}\n\n`;
            if (type === 'users') {
                msg += `åˆ©ç”¨è€…: ${data.users && data.users.length > 0 ? data.users.join(', ') : 'ãªã—'}`;
            } else {
                Object.entries(data).forEach(([k,v]) => {
                    if (k !== 'savedAt') msg += `${k}: ${v}\n`;
                });
            }
            alert(msg);
        }

        function updateBuilding(id, field, value) {
            const building = buildings.find(b => b.id === id);
            if (building) {
                building[field] = value;
                localStorage.setItem('gh_buildings', JSON.stringify(buildings));
                if (field === 'name') {
                    renderBuildingList(); // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚‚æ›´æ–°
                } else {
                    renderBuildingDetail();
                }
                updateUnitOptions();
            }
        }

        function updateUnitOptions() {
            const select = document.getElementById('userUnit');
            select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
                buildings.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
        }

        // ========== OCRæ©Ÿèƒ½ ==========

        function initUploadArea() {
            const uploadArea = document.getElementById('uploadArea');
            if (!uploadArea || uploadArea._initialized) return;
            uploadArea._initialized = true;
            uploadArea.addEventListener('click', () => {
                document.getElementById('certificateFile').click();
            });
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && (file.type.startsWith('image/') || file.type === 'application/pdf')) {
                    processFile(file);
                } else {
                    alert('âŒ PDFã¾ãŸã¯ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                }
            });
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        async function processFile(file) {
            const progress = document.getElementById('ocrProgress');
            progress.style.display = 'block';
            progress.textContent = 'ğŸ” ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...';

            try {
                if (file.type === 'application/pdf') {
                    await processPDFSimple(file);
                } else {
                    await processImage(file);
                }
            } catch (err) {
                console.error('ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã‚¨ãƒ©ãƒ¼:', err);
                progress.textContent = 'âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
                setTimeout(() => {
                    progress.style.display = 'none';
                }, 3000);
            }
        }

        async function processPDFSimple(file) {
            const progress = document.getElementById('ocrProgress');
            progress.textContent = 'ğŸ“„ PDFã‚’ç”»åƒã«å¤‰æ›ä¸­...';
            
            alert('ğŸ“ PDFã®OCRã¯ç¾åœ¨é–‹ç™ºä¸­ã§ã™ã€‚ç”»åƒå½¢å¼ï¼ˆPNG/JPEGï¼‰ã§ã®èª­ã¿è¾¼ã¿ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚\n\nã¾ãŸã¯ã€PDFã‚’é–‹ã„ã¦ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®ã‚Šã€ãã®ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
            progress.style.display = 'none';
        }

        async function processImage(file) {
            const progress = document.getElementById('ocrProgress');
            progress.textContent = 'ğŸ” ç”»åƒã‚’è§£æä¸­...';

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    progress.textContent = 'ğŸ” OCRå‡¦ç†ä¸­... 0%';
                    
                    const result = await Tesseract.recognize(
                        e.target.result,
                        'jpn',
                        {
                            logger: m => {
                                if (m.status === 'recognizing text') {
                                    const percent = Math.round(m.progress * 100);
                                    progress.textContent = `ğŸ” OCRå‡¦ç†ä¸­... ${percent}%`;
                                }
                            }
                        }
                    );

                    progress.textContent = 'âœ… èª­ã¿å–ã‚Šå®Œäº†ï¼';
                    console.log('OCRçµæœ:', result.data.text);
                    extractCertificateData(result.data.text);
                    
                    setTimeout(() => {
                        progress.style.display = 'none';
                    }, 3000);

                } catch (err) {
                    console.error('OCRã‚¨ãƒ©ãƒ¼:', err);
                    progress.textContent = 'âŒ OCRã«å¤±æ•—ã—ã¾ã—ãŸ';
                    alert('OCRã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\n\nã‚¨ãƒ©ãƒ¼: ' + err.message);
                    setTimeout(() => {
                        progress.style.display = 'none';
                    }, 3000);
                }
            };

            reader.readAsDataURL(file);
        }

        function extractCertificateData(text) {
            console.log('æŠ½å‡ºå…ƒãƒ†ã‚­ã‚¹ãƒˆ:', text);
            
            const certMatch = text.match(/\d{10}/);
            if (certMatch) {
                document.getElementById('certificateNumber').value = certMatch[0];
            }

            const namePatterns = [
                /æ°[\sã€€]*å[ï¼š:\sã€€]*([^\n\rã€€]{2,10})/,
                /å—çµ¦è€…æ°å[ï¼š:\sã€€]*([^\n\rã€€]{2,10})/,
            ];
            
            for (const pattern of namePatterns) {
                const match = text.match(pattern);
                if (match) {
                    const name = match[1].trim().replace(/[0-9]/g, '');
                    if (name.length >= 2) {
                        document.getElementById('userName').value = name;
                        break;
                    }
                }
            }

            const cityMatch = text.match(/\d{6}/);
            if (cityMatch && cityMatch[0] !== certMatch?.[0]) {
                document.getElementById('cityCode').value = cityMatch[0];
            }

            const supportMatch = text.match(/åŒºåˆ†[ã€€\s]*([ï¼‘-ï¼–1-6])/);
            if (supportMatch) {
                const num = supportMatch[1].replace(/[ï¼‘-ï¼–]/g, (s) => 
                    String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
                document.getElementById('supportLevel').value = (20 + parseInt(num)).toString();
            }

            alert('ğŸ“ èª­ã¿å–ã‚Šçµæœã‚’åæ˜ ã—ã¾ã—ãŸã€‚å†…å®¹ã‚’ç¢ºèªã—ã¦å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚');
        }

        // ========== åˆ©ç”¨è€…ç®¡ç† ==========

        let currentUserId = null;
        let userListPage = 1;
        const USER_PAGE_SIZE = 15;

        function showUserList() {
            document.getElementById('userListView').style.display = '';
            document.getElementById('userDetailView').style.display = 'none';
            renderUserList();
        }

        function showUserNew() {
            currentUserId = null;
            const newUser = {
                id: Date.now().toString(),
                name: 'æ–°ã—ã„åˆ©ç”¨è€…',
                nameKana: '',
                unit: '',
                room: '',
                moveDate: '',
                gender: '',
                birthdate: '',
                zip: '', prefecture: '', city: '', address: '', buildingName: '',
                tel: '', mobile: '',
                daytimeOrgNo: '', daytimeOrgName: '',
                housingAssist: '',
                status: 'åˆ©ç”¨ä¸­',
                emergencyContacts: [],
                medicalFacilities: [],
                personality: '',
                moveInHistory: [],
                diseases: [],
                medicines: [],
                medicalNotes: '',
                certificates: [],
                calcSevereDisability: '',
                calcRegionalTransition: false,
                calcMentalTransition: false,
                calcBehaviorTransition: false,
                calcBehaviorExperience: false,
                calcMedicalCare: false,
                calcIndividualCare: false,
                calcNoPlanReduction: '',
                calcLargeScaleReduction: '',
                contracts: [],
                userHistory: { basic: {}, calc: {} }
            };
            users.push(newUser);
            localStorage.setItem('gh_users', JSON.stringify(users));
            currentUserId = newUser.id;
            showUserDetail(newUser.id);
        }

        function showUserDetail(userId) {
            currentUserId = userId;
            const user = users.find(u => u.id === userId);
            if (!user) return;
            document.getElementById('userListView').style.display = 'none';
            document.getElementById('userDetailView').style.display = '';
            document.getElementById('userDetailName').textContent = user.name;
            document.getElementById('userDetailBreadcrumb').textContent = `åˆ©ç”¨è€…ç…§ä¼š ${user.name}`;
            loadUserForm(user);
            showUserTab('basic1');
            updateUnitOptions();
        }

        function showUserTab(tab) {
            document.querySelectorAll('#userDetailTabs .building-inner-tab').forEach((el, i) => {
                const tabs = ['basic1','basic2','medical','certificate','calc','contract','history'];
                el.classList.toggle('active', tabs[i] === tab);
            });
            document.querySelectorAll('[id^="userTab-"]').forEach(el => el.classList.remove('active'));
            const panel = document.getElementById('userTab-' + tab);
            if (panel) panel.classList.add('active');
            if (tab === 'certificate') renderCertificateHistory();
            if (tab === 'basic2') renderBasic2();
            if (tab === 'medical') renderMedical();
            if (tab === 'contract') renderContractList();
            if (tab === 'history') renderUserHistory();
        }

        function loadUserForm(user) {
            // åŸºæœ¬æƒ…å ±â‘ 
            document.getElementById('userUnit').value = user.unit || '';
            document.getElementById('userRoom').value = user.room || '';
            document.getElementById('userMoveDate').value = user.moveDate || '';
            document.getElementById('userName').value = user.name || '';
            document.getElementById('userNameKana').value = user.nameKana || '';
            document.getElementById('userGender').value = user.gender || '';
            document.getElementById('userBirthdate').value = user.birthdate || '';
            document.getElementById('userZip').value = user.zip || '';
            document.getElementById('userPrefecture').value = user.prefecture || '';
            document.getElementById('userCity').value = user.city || '';
            document.getElementById('userAddress').value = user.address || '';
            document.getElementById('userBuildingName').value = user.buildingName || '';
            document.getElementById('userTel').value = user.tel || '';
            document.getElementById('userMobile').value = user.mobile || '';
            document.getElementById('userDaytimeOrgNo').value = user.daytimeOrgNo || '';
            document.getElementById('userDaytimeOrgName').value = user.daytimeOrgName || '';
            document.getElementById('userHousingAssist').value = user.housingAssist || '';
            document.getElementById('userStatus').value = user.status || 'åˆ©ç”¨ä¸­';
            // ç®—å®šæƒ…å ±
            document.getElementById('calcSevereDisability').value = user.calcSevereDisability || '';
            document.getElementById('calcRegionalTransition').checked = !!user.calcRegionalTransition;
            document.getElementById('calcMentalTransition').checked = !!user.calcMentalTransition;
            document.getElementById('calcBehaviorTransition').checked = !!user.calcBehaviorTransition;
            document.getElementById('calcBehaviorExperience').checked = !!user.calcBehaviorExperience;
            document.getElementById('calcMedicalCare').checked = !!user.calcMedicalCare;
            document.getElementById('calcIndividualCare').checked = !!user.calcIndividualCare;
            document.getElementById('calcNoPlanReduction').value = user.calcNoPlanReduction || '';
            document.getElementById('calcLargeScaleReduction').value = user.calcLargeScaleReduction || '';
            // å¥‘ç´„
            document.getElementById('contractFacilityLabel').textContent = facility.facilityName || 'Tokyo. settle';
        }

        function saveCurrentUser(type) {
            const user = users.find(u => u.id === currentUserId);
            if (!user) return;
            const now = new Date();
            const histKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;

            if (type === 'basic1') {
                const prevSnap = JSON.parse(JSON.stringify(user));
                user.unit = document.getElementById('userUnit').value;
                user.room = document.getElementById('userRoom').value;
                user.moveDate = document.getElementById('userMoveDate').value;
                user.name = document.getElementById('userName').value;
                user.nameKana = document.getElementById('userNameKana').value;
                user.gender = document.getElementById('userGender').value;
                user.birthdate = document.getElementById('userBirthdate').value;
                user.zip = document.getElementById('userZip').value;
                user.prefecture = document.getElementById('userPrefecture').value;
                user.city = document.getElementById('userCity').value;
                user.address = document.getElementById('userAddress').value;
                user.buildingName = document.getElementById('userBuildingName').value;
                user.tel = document.getElementById('userTel').value;
                user.mobile = document.getElementById('userMobile').value;
                user.daytimeOrgNo = document.getElementById('userDaytimeOrgNo').value;
                user.daytimeOrgName = document.getElementById('userDaytimeOrgName').value;
                user.housingAssist = document.getElementById('userHousingAssist').value;
                user.status = document.getElementById('userStatus').value;
                if (!user.userHistory) user.userHistory = {basic:{}, calc:{}};
                user.userHistory.basic[histKey] = { ...prevSnap, savedAt: now.toISOString() };
                document.getElementById('userDetailName').textContent = user.name;
            } else if (type === 'calc') {
                const prevSnap = { calcSevereDisability: user.calcSevereDisability, calcRegionalTransition: user.calcRegionalTransition, calcMentalTransition: user.calcMentalTransition, calcBehaviorTransition: user.calcBehaviorTransition, calcBehaviorExperience: user.calcBehaviorExperience, calcMedicalCare: user.calcMedicalCare, calcIndividualCare: user.calcIndividualCare, calcNoPlanReduction: user.calcNoPlanReduction, calcLargeScaleReduction: user.calcLargeScaleReduction };
                user.calcSevereDisability = document.getElementById('calcSevereDisability').value;
                user.calcRegionalTransition = document.getElementById('calcRegionalTransition').checked;
                user.calcMentalTransition = document.getElementById('calcMentalTransition').checked;
                user.calcBehaviorTransition = document.getElementById('calcBehaviorTransition').checked;
                user.calcBehaviorExperience = document.getElementById('calcBehaviorExperience').checked;
                user.calcMedicalCare = document.getElementById('calcMedicalCare').checked;
                user.calcIndividualCare = document.getElementById('calcIndividualCare').checked;
                user.calcNoPlanReduction = document.getElementById('calcNoPlanReduction').value;
                user.calcLargeScaleReduction = document.getElementById('calcLargeScaleReduction').value;
                if (!user.userHistory) user.userHistory = {basic:{}, calc:{}};
                user.userHistory.calc[histKey] = { ...prevSnap, savedAt: now.toISOString() };
            }

            localStorage.setItem('gh_users', JSON.stringify(users));
            updateUserSelector();
            alert('âœ… ä¿å­˜ã—ã¾ã—ãŸï¼');
        }

        function renderUserList() {
            const filterName = (document.getElementById('filterName')?.value || '').trim();
            const filterBuilding = document.getElementById('filterBuilding')?.value || '';

            // update building filter options
            const bSel = document.getElementById('filterBuilding');
            if (bSel) {
                const curr = bSel.value;
                bSel.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
                    buildings.map(b => `<option value="${b.id}" ${b.id===curr?'selected':''}>${b.name}</option>`).join('');
            }

            let filtered = users.filter(u => {
                if (filterName && !u.name.includes(filterName)) return false;
                if (filterBuilding && u.unit !== filterBuilding) return false;
                return true;
            });

            const total = filtered.length;
            const totalPages = Math.max(1, Math.ceil(total / USER_PAGE_SIZE));
            if (userListPage > totalPages) userListPage = 1;
            const start = (userListPage - 1) * USER_PAGE_SIZE;
            const pageUsers = filtered.slice(start, start + USER_PAGE_SIZE);

            document.getElementById('userListCount').textContent =
                `${total} ä»¶ä¸­ ${start+1} - ${Math.min(start+USER_PAGE_SIZE, total)} ä»¶ã® åˆ©ç”¨è€… ã‚’è¡¨ç¤º`;

            // Pager
            let pagerHtml = '';
            if (totalPages > 1) {
                pagerHtml = `<div style="display:flex; gap:4px; align-items:center;">`;
                for (let i = 1; i <= totalPages; i++) {
                    if (i === userListPage) {
                        pagerHtml += `<span style="padding:4px 10px; background:#e91e8c; color:white; border-radius:4px;">${i}</span>`;
                    } else {
                        pagerHtml += `<span style="padding:4px 10px; border:1px solid #ddd; border-radius:4px; cursor:pointer; color:#667eea;" onclick="userListPage=${i};renderUserList();">${i}</span>`;
                    }
                }
                if (userListPage < totalPages) {
                    pagerHtml += `<span style="padding:4px 10px; border:1px solid #ddd; border-radius:4px; cursor:pointer; color:#667eea;" onclick="userListPage=${userListPage+1};renderUserList();">æ¬¡ â€º</span>`;
                    pagerHtml += `<span style="padding:4px 10px; border:1px solid #ddd; border-radius:4px; cursor:pointer; color:#667eea;" onclick="userListPage=${totalPages};renderUserList();">æœ€å¾Œ Â»</span>`;
                }
                pagerHtml += `</div>`;
            }
            document.getElementById('userPager').innerHTML = pagerHtml;

            const tbody = document.getElementById('userListBody');
            if (pageUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; color:#aaa;">åˆ©ç”¨è€…ãŒã„ã¾ã›ã‚“</td></tr>';
                return;
            }
            tbody.innerHTML = pageUsers.map(u => {
                // å—çµ¦è€…è¨¼æœŸé™ãƒã‚§ãƒƒã‚¯
                const today = new Date();
                const todayStr = today.toISOString().slice(0,10);
                const soon = new Date(today); soon.setDate(soon.getDate() + 90);
                const soonStr = soon.toISOString().slice(0,10);
                let certWarning = '';
                if (u.certificates && u.certificates.length > 0) {
                    const latest = u.certificates.reduce((a,b) => (a.certValidTo||'') > (b.certValidTo||'') ? a : b);
                    if (latest.certValidTo) {
                        if (latest.certValidTo < todayStr) certWarning = '<span title="å—çµ¦è€…è¨¼æœŸé™åˆ‡ã‚Œ" style="font-size:1em;">ğŸ”´</span>';
                        else if (latest.certValidTo < soonStr) certWarning = '<span title="å—çµ¦è€…è¨¼æœŸé™è¿‘ã„" style="font-size:1em;">ğŸŸ¡</span>';
                    }
                }
                return '<tr style="border-bottom:1px solid #f0f0f0;">' +
                    '<td style="padding:10px 6px; text-align:center;">' +
                        certWarning +
                        '<span style="display:inline-block; background:#e0e8ff; color:#667eea; border-radius:4px; padding:2px 6px; font-size:0.8em;">ä»‹</span>' +
                    '</td>' +
                    '<td style="padding:10px 6px; color:#555;">' + (facility.facilityName || 'Tokyo. settle') + '</td>' +
                    '<td style="padding:10px 6px; color:#667eea; cursor:pointer;" onclick="showUserDetail(\'' + u.id + '\')">' + getUnitName(u.unit) + '</td>' +
                    '<td style="padding:10px 6px;">' + u.name + '</td>' +
                    '<td style="padding:10px 6px; text-align:right;">' +
                        '<button class="btn btn-primary" onclick="showUserDetail(\'' + u.id + '\')" style="background:#e91e8c; border-color:#e91e8c; padding:4px 10px; font-size:0.8em; margin-right:4px;">è©³ç´°</button>' +
                        '<button class="btn btn-secondary" onclick="deleteUser(\'' + u.id + '\')" style="padding:4px 10px; font-size:0.8em;">å‰Šé™¤</button>' +
                    '</td>' +
                    '</tr>';
            }).join('');
        }

        function deleteUser(id) {
            if (confirm('ã“ã®åˆ©ç”¨è€…ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                users = users.filter(u => u.id !== id);
                localStorage.setItem('gh_users', JSON.stringify(users));
                renderUserList();
                updateUserSelector();
            }
        }

        // ===== å—çµ¦è€…è¨¼ =====
        let editingCertIndex = null;

        function showCertificateForm(index) {
            editingCertIndex = index !== undefined ? index : null;
            const user = users.find(u => u.id === currentUserId);
            const form = document.getElementById('certificateForm');
            form.style.display = '';

            // reset
            ['certNo','certCityCode','certCityName','certDisabilityType','certSupportLevel','certIssueDate','certValidFrom','certValidTo','certBurdenLimit','certLimitFrom','certLimitTo','certUpperMgmtOrgNo','certUpperMgmtOrgName','certSpecialAmount','certSpecialFrom','certSpecialTo','certMuniOrgNo','certMuniRate','certMuniAmount','certMuniMax','certMuniGrant','certGrantFrom','certGrantTo'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            ['certUpperMgmt','certSpecialDisabled','certMunicipalityAssist'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.checked = false;
            });
            document.getElementById('certSpecialDisabledArea').style.display = 'none';
            document.getElementById('certMunicipalityArea').style.display = 'none';

            if (editingCertIndex !== null && user && user.certificates && user.certificates[editingCertIndex]) {
                const cert = user.certificates[editingCertIndex];
                document.getElementById('certNo').value = cert.certNo || '';
                document.getElementById('certCityCode').value = cert.certCityCode || '';
                document.getElementById('certCityName').value = cert.certCityName || '';
                document.getElementById('certDisabilityType').value = cert.certDisabilityType || '';
                document.getElementById('certSupportLevel').value = cert.certSupportLevel || '';
                document.getElementById('certIssueDate').value = cert.certIssueDate || '';
                document.getElementById('certValidFrom').value = cert.certValidFrom || '';
                document.getElementById('certValidTo').value = cert.certValidTo || '';
                document.getElementById('certBurdenLimit').value = cert.certBurdenLimit || '0';
                document.getElementById('certLimitFrom').value = cert.certLimitFrom || '';
                document.getElementById('certLimitTo').value = cert.certLimitTo || '';
                document.getElementById('certUpperMgmt').checked = !!cert.certUpperMgmt;
                document.getElementById('certUpperMgmtOrgNo').value = cert.certUpperMgmtOrgNo || '';
                document.getElementById('certUpperMgmtOrgName').value = cert.certUpperMgmtOrgName || '';
                document.getElementById('certSpecialDisabled').checked = !!cert.certSpecialDisabled;
                if (cert.certSpecialDisabled) {
                    document.getElementById('certSpecialDisabledArea').style.display = '';
                    document.getElementById('certSpecialAmount').value = cert.certSpecialAmount || '0';
                    document.getElementById('certSpecialFrom').value = cert.certSpecialFrom || '';
                    document.getElementById('certSpecialTo').value = cert.certSpecialTo || '';
                }
                document.getElementById('certMunicipalityAssist').checked = !!cert.certMunicipalityAssist;
                if (cert.certMunicipalityAssist) {
                    document.getElementById('certMunicipalityArea').style.display = '';
                    document.getElementById('certMuniOrgNo').value = cert.certMuniOrgNo || '';
                    document.getElementById('certMuniRate').value = cert.certMuniRate || '';
                    document.getElementById('certMuniAmount').value = cert.certMuniAmount || '';
                    document.getElementById('certMuniMax').value = cert.certMuniMax || '';
                    document.getElementById('certMuniGrant').value = cert.certMuniGrant || '';
                    document.getElementById('certGrantFrom').value = cert.certGrantFrom || '';
                    document.getElementById('certGrantTo').value = cert.certGrantTo || '';
                }
            }
            // toggle listeners
            document.getElementById('certSpecialDisabled').onchange = function() {
                document.getElementById('certSpecialDisabledArea').style.display = this.checked ? '' : 'none';
            };
            document.getElementById('certMunicipalityAssist').onchange = function() {
                document.getElementById('certMunicipalityArea').style.display = this.checked ? '' : 'none';
            };
        }

        function cancelCertificateForm() {
            document.getElementById('certificateForm').style.display = 'none';
            editingCertIndex = null;
        }

        function saveCertificate() {
            const user = users.find(u => u.id === currentUserId);
            if (!user) return;
            if (!user.certificates) user.certificates = [];

            const cert = {
                certNo: document.getElementById('certNo').value,
                certCityCode: document.getElementById('certCityCode').value,
                certCityName: document.getElementById('certCityName').value,
                certDisabilityType: document.getElementById('certDisabilityType').value,
                certSupportLevel: document.getElementById('certSupportLevel').value,
                certIssueDate: document.getElementById('certIssueDate').value,
                certValidFrom: document.getElementById('certValidFrom').value,
                certValidTo: document.getElementById('certValidTo').value,
                certBurdenLimit: document.getElementById('certBurdenLimit').value,
                certLimitFrom: document.getElementById('certLimitFrom').value,
                certLimitTo: document.getElementById('certLimitTo').value,
                certUpperMgmt: document.getElementById('certUpperMgmt').checked,
                certUpperMgmtOrgNo: document.getElementById('certUpperMgmtOrgNo').value,
                certUpperMgmtOrgName: document.getElementById('certUpperMgmtOrgName').value,
                certSpecialDisabled: document.getElementById('certSpecialDisabled').checked,
                certSpecialAmount: document.getElementById('certSpecialAmount').value,
                certSpecialFrom: document.getElementById('certSpecialFrom').value,
                certSpecialTo: document.getElementById('certSpecialTo').value,
                certMunicipalityAssist: document.getElementById('certMunicipalityAssist').checked,
                certMuniOrgNo: document.getElementById('certMuniOrgNo').value,
                certMuniRate: document.getElementById('certMuniRate').value,
                certMuniAmount: document.getElementById('certMuniAmount').value,
                certMuniMax: document.getElementById('certMuniMax').value,
                certMuniGrant: document.getElementById('certMuniGrant').value,
                certGrantFrom: document.getElementById('certGrantFrom').value,
                certGrantTo: document.getElementById('certGrantTo').value,
                savedAt: new Date().toISOString()
            };

            if (editingCertIndex !== null) {
                user.certificates[editingCertIndex] = cert;
            } else {
                user.certificates.push(cert);
            }

            localStorage.setItem('gh_users', JSON.stringify(users));
            cancelCertificateForm();
            renderCertificateHistory();
            alert('âœ… å—çµ¦è€…è¨¼ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
        }

        function deleteCertificate(index) {
            if (!confirm('ã“ã®å—çµ¦è€…è¨¼å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            const user = users.find(u => u.id === currentUserId);
            if (!user || !user.certificates) return;
            user.certificates.splice(index, 1);
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderCertificateHistory();
        }

        function renderCertificateHistory() {
            const user = users.find(u => u.id === currentUserId);
            const tbody = document.getElementById('certificateHistoryList');
            if (!tbody) return;
            const certs = user && user.certificates ? user.certificates : [];
            if (certs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="padding:20px; color:#aaa; text-align:center;">å—çµ¦è€…è¨¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</td></tr>';
                return;
            }
            // Sort by validFrom descending
            const sorted = certs.map((c,i) => ({...c, _i: i})).sort((a,b) => (b.certValidFrom||'').localeCompare(a.certValidFrom||''));
            const today = new Date().toISOString().slice(0,10);
            const soon = new Date(); soon.setDate(soon.getDate() + 90);
            const soonStr = soon.toISOString().slice(0,10);
            tbody.innerHTML = sorted.map(cert => {
                let rowStyle = 'border-bottom:1px solid #f0f0f0;';
                let expiryBadge = '';
                if (cert.certValidTo) {
                    if (cert.certValidTo < today) {
                        rowStyle += ' background:#fff0f0;';
                        expiryBadge = '<span style="color:red; font-size:0.8em; margin-left:4px;">æœŸé™åˆ‡ã‚Œ</span>';
                    } else if (cert.certValidTo < soonStr) {
                        rowStyle += ' background:#fffbe6;';
                        expiryBadge = '<span style="color:#e65; font-size:0.8em; margin-left:4px;">æœŸé™è¿‘ã„</span>';
                    }
                }
                return `
                <tr style="${rowStyle}">
                    <td style="padding:10px 8px;">${cert.certValidFrom||''}ã€œ${cert.certValidTo||''}${expiryBadge}</td>
                    <td style="padding:10px 8px;">${cert.certIssueDate||''}</td>
                    <td style="padding:10px 8px;">${cert.certNo||''}</td>
                    <td style="padding:10px 8px;">${cert.certSupportLevel||''}</td>
                    <td style="padding:10px 8px; text-align:right;">
                        <button class="btn btn-primary" onclick="showCertificateForm(${cert._i})" style="background:#e91e8c; border-color:#e91e8c; padding:3px 8px; font-size:0.8em; margin-right:3px;">è©³ç´°</button>
                        <button class="btn btn-secondary" onclick="deleteCertificate(${cert._i})" style="padding:3px 8px; font-size:0.8em; margin-right:3px;">å‰Šé™¤</button>
                        <button class="btn btn-secondary" onclick="copyCertificate(${cert._i})" style="padding:3px 8px; font-size:0.8em;">ï½ºï¾‹ï¾Ÿï½°</button>
                    </td>
                </tr>`;
            }).join('');
        }

        function copyCertificate(index) {
            const user = users.find(u => u.id === currentUserId);
            if (!user || !user.certificates || !user.certificates[index]) return;
            const copy = JSON.parse(JSON.stringify(user.certificates[index]));
            copy.certValidFrom = '';
            copy.certValidTo = '';
            copy.certIssueDate = '';
            copy.savedAt = '';
            user.certificates.push(copy);
            localStorage.setItem('gh_users', JSON.stringify(users));
            showCertificateForm(user.certificates.length - 1);
            renderCertificateHistory();
        }

        // ===== åŸºæœ¬æƒ…å ±â‘¡ =====
        function renderBasic2() {
            const user = users.find(u => u.id === currentUserId);
            if (!user) return;
            // ç·Šæ€¥é€£çµ¡å…ˆ
            const ecList = document.getElementById('emergencyContactList');
            if (ecList) {
                const ecs = user.emergencyContacts || [];
                ecList.innerHTML = ecs.length === 0 ? '<p style="color:#aaa; font-size:0.9em;">ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>' :
                    ecs.map((ec, i) => `
                        <div style="padding:12px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:start;">
                            <div style="font-size:0.9em;">
                                <p>æ°å: ${ec.name||''}&nbsp;&nbsp;&nbsp;ç¶šæŸ„: ${ec.relationship||''}</p>
                                <p>é›»è©±: ${ec.tel||''}</p>
                                ${ec.address?`<p>ä½æ‰€: ${ec.address}</p>`:''}
                                ${ec.note?`<p>å‚™è€ƒ: ${ec.note}</p>`:''}
                            </div>
                            <div style="display:flex; gap:6px;">
                                <button class="btn btn-primary" onclick="editEmergencyContact(${i})" style="background:#e91e8c; border-color:#e91e8c; padding:3px 8px; font-size:0.8em;">ç·¨é›†</button>
                                <button class="btn btn-secondary" onclick="deleteEmergencyContact(${i})" style="padding:3px 8px; font-size:0.8em;">å‰Šé™¤</button>
                            </div>
                        </div>`).join('');
            }
            // ã‹ã‹ã‚Šã¤ã‘åŒ»ç™‚æ©Ÿé–¢
            const mfList = document.getElementById('medicalFacilityList');
            if (mfList) {
                const mfs = user.medicalFacilities || [];
                mfList.innerHTML = mfs.length === 0 ? '<p style="color:#aaa; font-size:0.9em;">ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>' :
                    mfs.map((mf, i) => `
                        <div style="padding:12px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:start;">
                            <div style="font-size:0.9em;">
                                <p>åŒ»ç™‚æ©Ÿé–¢å: ${mf.name||''}&nbsp;&nbsp;&nbsp;ä¸»æ²»åŒ»: ${mf.doctor||''}</p>
                                <p>é›»è©±ç•ªå·: ${mf.tel||''}</p>
                                ${mf.address?`<p>ä½æ‰€: ${mf.address}</p>`:''}
                            </div>
                            <div style="display:flex; gap:6px;">
                                <button class="btn btn-primary" onclick="editMedicalFacility(${i})" style="background:#e91e8c; border-color:#e91e8c; padding:3px 8px; font-size:0.8em;">ç·¨é›†</button>
                                <button class="btn btn-secondary" onclick="deleteMedicalFacility(${i})" style="padding:3px 8px; font-size:0.8em;">å‰Šé™¤</button>
                            </div>
                        </div>`).join('');
            }
            // æ€§æ ¼ãƒ»è¶£å‘³
            const pi = document.getElementById('personalityInfo');
            if (pi) pi.textContent = user.personality || '';
        }

        function addEmergencyContact() {
            const name = prompt('æ°å:');
            if (name === null) return;
            const rel = prompt('ç¶šæŸ„:') || '';
            const tel = prompt('é›»è©±:') || '';
            const user = users.find(u => u.id === currentUserId);
            if (!user.emergencyContacts) user.emergencyContacts = [];
            user.emergencyContacts.push({ name, relationship: rel, tel });
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderBasic2();
        }
        function editEmergencyContact(i) {
            const user = users.find(u => u.id === currentUserId);
            const ec = user.emergencyContacts[i];
            ec.name = prompt('æ°å:', ec.name) || ec.name;
            ec.relationship = prompt('ç¶šæŸ„:', ec.relationship) || ec.relationship;
            ec.tel = prompt('é›»è©±:', ec.tel) || ec.tel;
            ec.address = prompt('ä½æ‰€:', ec.address||'') || ec.address || '';
            ec.note = prompt('å‚™è€ƒ:', ec.note||'') || ec.note || '';
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderBasic2();
        }
        function deleteEmergencyContact(i) {
            if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            const user = users.find(u => u.id === currentUserId);
            user.emergencyContacts.splice(i, 1);
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderBasic2();
        }
        function addMedicalFacility() {
            const name = prompt('åŒ»ç™‚æ©Ÿé–¢å:');
            if (name === null) return;
            const doctor = prompt('ä¸»æ²»åŒ»:') || '';
            const tel = prompt('é›»è©±ç•ªå·:') || '';
            const address = prompt('ä½æ‰€:') || '';
            const user = users.find(u => u.id === currentUserId);
            if (!user.medicalFacilities) user.medicalFacilities = [];
            user.medicalFacilities.push({ name, doctor, tel, address });
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderBasic2();
        }
        function editMedicalFacility(i) {
            const user = users.find(u => u.id === currentUserId);
            const mf = user.medicalFacilities[i];
            mf.name = prompt('åŒ»ç™‚æ©Ÿé–¢å:', mf.name) || mf.name;
            mf.doctor = prompt('ä¸»æ²»åŒ»:', mf.doctor) || mf.doctor;
            mf.tel = prompt('é›»è©±ç•ªå·:', mf.tel) || mf.tel;
            mf.address = prompt('ä½æ‰€:', mf.address||'') || mf.address || '';
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderBasic2();
        }
        function deleteMedicalFacility(i) {
            if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            const user = users.find(u => u.id === currentUserId);
            user.medicalFacilities.splice(i, 1);
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderBasic2();
        }
        function editPersonality() {
            const user = users.find(u => u.id === currentUserId);
            const val = prompt('æ€§æ ¼ãƒ»è¶£å‘³ãªã©:', user.personality||'');
            if (val === null) return;
            user.personality = val;
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderBasic2();
        }
        function addMoveInHistory() {
            const val = prompt('å…¥å±…å‰ã®çŠ¶æ³ãƒ»æˆè‚²æ­´:');
            if (val === null) return;
            const user = users.find(u => u.id === currentUserId);
            if (!user.moveInHistory) user.moveInHistory = [];
            user.moveInHistory.push({ content: val, date: new Date().toISOString() });
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderBasic2();
        }

        // ===== æ—¢å¾€æ­´ãƒ»æœè–¬ =====
        function renderMedical() {
            const user = users.find(u => u.id === currentUserId);
            if (!user) return;
            const dl = document.getElementById('diseaseList');
            if (dl) {
                const diseases = user.diseases || [];
                dl.innerHTML = diseases.length === 0
                    ? '<tr><td colspan="5" style="padding:10px; color:#aaa; font-size:0.9em;">ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>'
                    : diseases.map((d, i) => `
                        <tr style="border-bottom:1px solid #f0f0f0;">
                            <td style="padding:8px;">${d.name||''}</td>
                            <td style="padding:8px;">${d.onsetDate||''}</td>
                            <td style="padding:8px;">${d.hospital||''}</td>
                            <td style="padding:8px;">${d.note||''}</td>
                            <td style="padding:8px; text-align:right; display:flex; gap:4px;">
                                <button class="btn btn-primary" onclick="editDisease(${i})" style="background:#e91e8c; border-color:#e91e8c; padding:3px 8px; font-size:0.8em;">ç·¨é›†</button>
                                <button class="btn btn-secondary" onclick="deleteDisease(${i})" style="padding:3px 8px; font-size:0.8em;">å‰Šé™¤</button>
                            </td>
                        </tr>`).join('');
            }
            const mn = document.getElementById('medicalNotes');
            if (mn) mn.textContent = user.medicalNotes || '';
        }
        function addDisease() {
            const name = prompt('ç—…å:');
            if (name === null) return;
            const onsetDate = prompt('ç™ºç—‡å¹´æœˆæ—¥ (ä¾‹: 2020/01/01):') || '';
            const hospital = prompt('åŒ»ç™‚æ©Ÿé–¢å:') || '';
            const note = prompt('å‚™è€ƒ:') || '';
            const user = users.find(u => u.id === currentUserId);
            if (!user.diseases) user.diseases = [];
            user.diseases.push({ name, onsetDate, hospital, note });
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderMedical();
        }
        function editDisease(i) {
            const user = users.find(u => u.id === currentUserId);
            const d = user.diseases[i];
            d.name = prompt('ç—…å:', d.name) || d.name;
            d.onsetDate = prompt('ç™ºç—‡å¹´æœˆæ—¥:', d.onsetDate||'') || d.onsetDate || '';
            d.hospital = prompt('åŒ»ç™‚æ©Ÿé–¢å:', d.hospital||'') || d.hospital || '';
            d.note = prompt('å‚™è€ƒ:', d.note||'') || d.note || '';
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderMedical();
        }
        function deleteDisease(i) {
            if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            const user = users.find(u => u.id === currentUserId);
            user.diseases.splice(i, 1);
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderMedical();
        }
        function addMedicine() {
            const name = prompt('è–¬å“å:');
            if (name === null) return;
            const dose = prompt('ç”¨é‡:') || '';
            const user = users.find(u => u.id === currentUserId);
            if (!user.medicines) user.medicines = [];
            user.medicines.push({ name, dose });
            localStorage.setItem('gh_users', JSON.stringify(users));
            const ml = document.getElementById('medicineList');
            if (ml) ml.innerHTML = (user.medicines||[]).map((m,i)=>`<div style="padding:8px; border-bottom:1px solid #eee;">${m.name} ${m.dose}</div>`).join('');
        }
        function editMedicalNotes() {
            const user = users.find(u => u.id === currentUserId);
            const val = prompt('ç•™æ„ç‚¹ï¼ç‰¹è¨˜äº‹é …:', user.medicalNotes||'');
            if (val === null) return;
            user.medicalNotes = val;
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderMedical();
        }

        // ===== å¥‘ç´„æƒ…å ± =====
        function addContract() {
            const svcStart = prompt('ã‚µãƒ¼ãƒ“ã‚¹é–‹å§‹æ—¥ (ä¾‹: 2023/11/01):');
            if (svcStart === null) return;
            const contractStart = prompt('å¥‘ç´„é–‹å§‹æ—¥:') || svcStart;
            const user = users.find(u => u.id === currentUserId);
            if (!user.contracts) user.contracts = [];
            user.contracts.push({
                svcStart, trialStart:'', trialEnd:'',
                contractStart, contractEnd:'', svcEnd:'',
                selfSupportLeave:'', selfSupportAfter:'',
                transitionMoveIn:'',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            });
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderContractList();
        }

        function renderContractList() {
            const user = users.find(u => u.id === currentUserId);
            const tbody = document.getElementById('contractList');
            if (!tbody) return;
            const contracts = user && user.contracts ? user.contracts : [];
            if (contracts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="padding:20px; color:#aaa; text-align:center;">å¥‘ç´„æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }
            tbody.innerHTML = contracts.map((c, i) => `
                <tr style="border-bottom:1px solid #f0f0f0;">
                    <td style="padding:10px 8px;">${c.svcStart||''}</td>
                    <td style="padding:10px 8px;">${c.trialStart||''}</td>
                    <td style="padding:10px 8px;">${c.contractStart||''}</td>
                    <td style="padding:10px 8px; font-size:0.85em;">${c.updatedAt ? new Date(c.updatedAt).toLocaleString('ja-JP') : ''}</td>
                    <td style="padding:10px 8px; text-align:right;">
                        <button class="btn btn-primary" onclick="showContractDetail(${i})" style="background:#e91e8c; border-color:#e91e8c; padding:3px 8px; font-size:0.8em; margin-right:3px;">è©³ç´°</button>
                        <button class="btn btn-secondary" onclick="deleteContract(${i})" style="padding:3px 8px; font-size:0.8em; margin-right:3px;">å‰Šé™¤</button>
                        <select style="padding:3px; font-size:0.8em; border:1px solid #ddd; border-radius:4px;" onchange="this.value=''">
                            <option value="">æ–°è¦ âˆ¨</option>
                            <option value="new">æ–°è¦</option>
                            <option value="end">çµ‚äº†</option>
                        </select>
                        <button class="btn btn-secondary" onclick="alert('å ±å‘Šæ›¸æ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™')" style="background:#e91e8c; border-color:#e91e8c; color:white; padding:3px 8px; font-size:0.8em;">å ±å‘Šæ›¸</button>
                    </td>
                </tr>
            `).join('');
        }

        function showContractDetail(i) {
            const user = users.find(u => u.id === currentUserId);
            const c = user.contracts[i];
            const div = document.getElementById('contractDetail');
            div.style.display = '';
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:start;">
                    <div style="font-size:0.9em; line-height:2;">
                        <p>ã‚µãƒ¼ãƒ“ã‚¹é–‹å§‹æ—¥ï¼ˆä½“é¨“åŠã³æœ¬å…¥å±…é–‹å§‹æ—¥ï¼‰ï¼š${c.svcStart||''}</p>
                        <p>ä½“é¨“é–‹å§‹æ—¥ï¼š${c.trialStart||''}</p>
                        <p>ä½“é¨“çµ‚äº†æ—¥ï¼š${c.trialEnd||''}</p>
                        <p>å¥‘ç´„é–‹å§‹æ—¥ï¼š${c.contractStart||''}</p>
                        <p>å¥‘ç´„çµ‚äº†æ—¥ï¼š${c.contractEnd||''}</p>
                        <p>ã‚µãƒ¼ãƒ“ã‚¹çµ‚äº†æ—¥ï¼š${c.svcEnd||''}</p>
                        <p>ï¼ˆè‡ªç«‹ç”Ÿæ´»æ”¯æ´ï¼‰é€€å»æ—¥ï¼š${c.selfSupportLeave||''}</p>
                        <p>ï¼ˆè‡ªç«‹ç”Ÿæ´»æ”¯æ´ï¼‰é€€å»å¾Œç®—å®šæ—¥ï¼š${c.selfSupportAfter||''}</p>
                        <p>ç§»è¡Œæ”¯æ´ä½å±…ã®å…¥å±…æ—¥ï¼š${c.transitionMoveIn||''}</p>
                        <p>æ›´æ–°æ—¥æ™‚ï¼š${c.updatedAt ? new Date(c.updatedAt).toLocaleString('ja-JP') : ''}</p>
                    </div>
                    <button class="btn btn-primary" onclick="editContract(${i})" style="background:#e91e8c; border-color:#e91e8c; padding:4px 10px; font-size:0.85em;">ç·¨é›†</button>
                </div>
            `;
        }

        function editContract(i) {
            const user = users.find(u => u.id === currentUserId);
            const c = user.contracts[i];
            c.svcStart = prompt('ã‚µãƒ¼ãƒ“ã‚¹é–‹å§‹æ—¥:', c.svcStart||'') || c.svcStart || '';
            c.trialStart = prompt('ä½“é¨“é–‹å§‹æ—¥:', c.trialStart||'') || c.trialStart || '';
            c.contractStart = prompt('å¥‘ç´„é–‹å§‹æ—¥:', c.contractStart||'') || c.contractStart || '';
            c.contractEnd = prompt('å¥‘ç´„çµ‚äº†æ—¥:', c.contractEnd||'') || c.contractEnd || '';
            c.svcEnd = prompt('ã‚µãƒ¼ãƒ“ã‚¹çµ‚äº†æ—¥:', c.svcEnd||'') || c.svcEnd || '';
            c.updatedAt = new Date().toISOString();
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderContractList();
            showContractDetail(i);
        }

        function deleteContract(i) {
            if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            const user = users.find(u => u.id === currentUserId);
            user.contracts.splice(i, 1);
            localStorage.setItem('gh_users', JSON.stringify(users));
            renderContractList();
            document.getElementById('contractDetail').style.display = 'none';
        }

        // ===== åˆ©ç”¨è€…å±¥æ­´æƒ…å ± =====
        function renderUserHistory() {
            const user = users.find(u => u.id === currentUserId);
            const div = document.getElementById('userHistoryContent');
            if (!div || !user) return;
            const hist = user.userHistory || {basic:{}, calc:{}};
            const allKeys = new Set([...Object.keys(hist.basic||{}), ...Object.keys(hist.calc||{})]);
            if (allKeys.size === 0) {
                div.innerHTML = '<p style="color:#aaa;">å¤‰æ›´å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            // å¹´ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const byYear = {};
            allKeys.forEach(k => {
                const [y] = k.split('-');
                if (!byYear[y]) byYear[y] = new Set();
                byYear[y].add(k);
            });
            const years = Object.keys(byYear).sort((a,b)=>b-a);
            const rows = ['basic','calc'];
            const rowLabels = {basic:'åŸºæœ¬æƒ…å ±', calc:'ç®—å®šæƒ…å ±'};

            let html = '';
            // æœ€æ–°å¹´ï¼ˆç¾åœ¨å¹´ï¼‰ã¯å…ˆé ­ã«åˆ†ã‘ã¦è¡¨ç¤º
            const latestYear = years[0];
            rows.forEach(row => {
                const months = [...byYear[latestYear]].filter(k => hist[row] && hist[row][k]).sort();
                if (months.length > 0) {
                    html += `<div style="display:flex; gap:10px; align-items:center; margin-bottom:8px; flex-wrap:wrap;">
                        <span style="width:70px; font-size:0.85em; color:#555; flex-shrink:0;">${rowLabels[row]}</span>
                        ${months.map(k => {
                            const [y, m] = k.split('-');
                            return `<span class="history-link" onclick="viewUserHistory('${row}','${k}')">${y}å¹´${parseInt(m)}æœˆ</span>`;
                        }).join('')}
                    </div>`;
                }
            });

            // æ®‹ã‚Šå¹´
            years.slice(1).forEach(year => {
                html += '<hr style="margin:12px 0; border:none; border-top:1px solid #eee;">';
                rows.forEach(row => {
                    const months = [...byYear[year]].filter(k => hist[row] && hist[row][k]).sort();
                    if (months.length > 0) {
                        html += `<div style="display:flex; gap:10px; align-items:center; margin-bottom:8px; flex-wrap:wrap;">
                            <span style="width:70px; font-size:0.85em; color:#555; flex-shrink:0;">${rowLabels[row]}</span>
                            ${months.map(k => {
                                const [y, m] = k.split('-');
                                return `<span class="history-link" onclick="viewUserHistory('${row}','${k}')">${y}å¹´${parseInt(m)}æœˆ</span>`;
                            }).join('')}
                        </div>`;
                    }
                });
            });

            div.innerHTML = html;
        }

        function viewUserHistory(type, key) {
            const user = users.find(u => u.id === currentUserId);
            if (!user || !user.userHistory || !user.userHistory[type] || !user.userHistory[type][key]) return;
            const data = user.userHistory[type][key];
            const [y, m] = key.split('-');
            let msg = `ã€${user.name} - ${type==='basic'?'åŸºæœ¬æƒ…å ±':'ç®—å®šæƒ…å ±'} ${y}å¹´${parseInt(m)}æœˆã€‘\n`;
            msg += `ä¿å­˜æ—¥æ™‚: ${data.savedAt ? new Date(data.savedAt).toLocaleString('ja-JP') : 'ä¸æ˜'}\n\n`;
            const labels = {name:'æ°å', unit:'ãƒ¦ãƒ‹ãƒƒãƒˆ', room:'éƒ¨å±‹', status:'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', gender:'æ€§åˆ¥', birthdate:'ç”Ÿå¹´æœˆæ—¥', mobile:'æºå¸¯'};
            Object.entries(labels).forEach(([k,l]) => {
                if (data[k]) msg += `${l}: ${data[k]}\n`;
            });
            alert(msg);
        }

        function resetUserForm() {}

        function getUnitName(unitId) {
            const building = buildings.find(b => b.id === unitId);
            return building ? building.name : (unitId || 'æœªè¨­å®š');
        }

        function getSupportLevelName(level) {
            const levels = { '21':'åŒºåˆ†1','22':'åŒºåˆ†2','23':'åŒºåˆ†3','24':'åŒºåˆ†4','25':'åŒºåˆ†5','26':'åŒºåˆ†6' };
            return levels[level] || 'ãªã—';
        }

        function updateUserSelector() {
            const select = document.getElementById('recordUser');
            select.innerHTML = '<option value="">åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</option>' +
                users.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
        }

        // ========== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»å®Ÿç¸¾è¨˜éŒ² ==========

        function updateCalendar() {
            const calendar = document.getElementById('calendar');
            const monthLabel = document.getElementById('currentMonth');
            
            const date = new Date(currentYear, currentMonth, 1);
            monthLabel.textContent = `${currentYear}å¹´ ${currentMonth + 1}æœˆ`;

            const firstDay = date.getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            let html = '<div class="calendar-grid">';
            
            ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'].forEach(day => {
                html += `<div class="calendar-day header">${day}</div>`;
            });

            for (let i = 0; i < firstDay; i++) {
                html += '<div class="calendar-day disabled"></div>';
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const record = getRecord(selectedUserId, dateStr);
                
                const statusClass = record ? getStatusClass(record.status) : '';
                const statusText = record ? (record.status || '') : '';
                // å¤œé–“æ”¯æ´åŠ ç®—ã®ç•¥ç§°è¡¨ç¤º
                let nightText = '';
                if (record && record.nightSupport) {
                    const m = record.nightSupport.match(/å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆ(.+?)ï¼‰(.+)?/);
                    nightText = m ? `å¤œ(${m[1]})` : '';
                }

                html += '<div class="calendar-day" onclick="openDateModal(\'' + dateStr + '\')">' +
                    '<div class="day-number">' + day + '</div>' +
                    (statusText ? '<div class="day-status ' + statusClass + '">' + statusText + '</div>' : '') +
                    (nightText ? '<div style="font-size:0.65em; color:#667eea; margin-top:2px;">' + nightText + '</div>' : '') +
                    '</div>';
            }

            html += '</div>';
            calendar.innerHTML = html;
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            updateCalendar();
        }

        function loadRecords() {
            selectedUserId = document.getElementById('recordUser').value;
            updateCalendar();
        }

        function fillMonth(status) {
            if (!selectedUserId) {
                alert('åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (!confirm(`${currentYear}å¹´${currentMonth + 1}æœˆã®å…¨ã¦ã®æ—¥ã‚’ã€Œ${status}ã€ã§åŸ‹ã‚ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }

            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            if (!records[selectedUserId]) {
                records[selectedUserId] = {};
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                records[selectedUserId][dateStr] = { status, date: dateStr };
            }

            localStorage.setItem('gh_records', JSON.stringify(records));
            updateCalendar();
            alert(`âœ… ${currentYear}å¹´${currentMonth + 1}æœˆã‚’ã€Œ${status}ã€ã§åŸ‹ã‚ã¾ã—ãŸ`);
        }

        function clearMonth() {
            if (!selectedUserId) {
                alert('åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (!confirm(`${currentYear}å¹´${currentMonth + 1}æœˆã®è¨˜éŒ²ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }

            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            if (records[selectedUserId]) {
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    delete records[selectedUserId][dateStr];
                }
            }

            localStorage.setItem('gh_records', JSON.stringify(records));
            updateCalendar();
            alert(`âœ… ${currentYear}å¹´${currentMonth + 1}æœˆã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
        }

        function getStatusClass(status) {
            if (status === 'â—‹' || status === 'â—‹ï¼ˆæœ¬å…¥å±…ï¼‰') return 'status-ok';
            if (status.includes('å¤–æ³Š')) return 'status-away';
            if (status.includes('å…¥é™¢')) return 'status-hospital';
            return '';
        }

        function getRecord(userId, date) {
            if (!userId || !records[userId]) return null;
            return records[userId][date];
        }

        function openDateModal(dateStr) {
            if (!selectedUserId) {
                alert('åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            selectedDate = dateStr;

            // ç™»éŒ²æ—¥ã‚’é¸æŠã—ãŸæ—¥ä»˜ã«åˆæœŸè¨­å®š
            document.getElementById('modalDateFrom').value = dateStr;
            document.getElementById('modalDateTo').value = dateStr;

            // æ›œæ—¥ãƒã‚§ãƒƒã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.modalDow').forEach(cb => cb.checked = false);

            // ä¸Šæ›¸ããƒã‚§ãƒƒã‚¯
            document.getElementById('modalOverwrite').checked = true;

            // å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼šå»ºç‰©è¨­å®šã‹ã‚‰é¸æŠè‚¢ã‚’ç”Ÿæˆ
            const user = users.find(u => u.id === selectedUserId);
            const building = user ? buildings.find(b => b.id === user.unit) : null;
            const nightSelect = document.getElementById('modalNightSupport');
            const nightHint = document.getElementById('modalNightHint');
            nightSelect.innerHTML = '<option value="">ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>';
            if (building && building.nightSupportType) {
                // å»ºç‰©è¨­å®šå€¤ã‚’å…ˆé ­ã«è¡¨ç¤º
                const opt = document.createElement('option');
                opt.value = building.nightSupportType;
                opt.textContent = building.nightSupportType;
                nightSelect.appendChild(opt);
                nightHint.textContent = 'å»ºç‰©è¨­å®šï¼š' + building.nightSupportType;
            } else {
                nightHint.textContent = 'å»ºç‰©è¨­å®šãªã—';
            }
            // äº‹æ¥­æ‰€ã®å¤œé–“æ”¯æ´è¨­å®šã‚‚è¿½åŠ 
            if (facility.nightSupportType1) {
                const opt = document.createElement('option');
                opt.value = facility.nightSupportType1;
                opt.textContent = facility.nightSupportType1;
                nightSelect.appendChild(opt);
            }
            if (facility.nightSupportType3) {
                const opt = document.createElement('option');
                opt.value = facility.nightSupportType3;
                opt.textContent = facility.nightSupportType3;
                nightSelect.appendChild(opt);
            }

            // æ—¥ä¸­æ”¯æ´åŠ ç®—ãƒ’ãƒ³ãƒˆ
            const daytimeHint = document.getElementById('modalDaytimeHint');
            if (facility.daySupport) {
                daytimeHint.textContent = 'äº‹æ¥­æ‰€è¨­å®šï¼š' + facility.daySupport;
            } else {
                daytimeHint.textContent = '';
            }

            // æ—¢å­˜è¨˜éŒ²ãŒã‚ã‚Œã°èª­ã¿è¾¼ã‚€
            const record = getRecord(selectedUserId, dateStr);
            if (record) {
                document.getElementById('modalStatus').value = record.status || '';
                document.getElementById('modalNightSupport').value = record.nightSupport || '';
                document.getElementById('modalDaytimeSupport').value = record.daytimeSupport || '';
                document.getElementById('modalMedicalCoop').value = record.medicalCoop || '';
                document.getElementById('modalSelfSupport').value = record.selfSupport || '';
                document.getElementById('modalNote').value = record.note || '';
                document.getElementById('modalInpatientSupport').checked = !!record.inpatientSupport;
                document.getElementById('modalReturnSupport').checked = !!record.returnSupport;
                document.getElementById('modalLongInpatient').checked = !!record.longInpatient;
                document.getElementById('modalLongReturn').checked = !!record.longReturn;
                document.getElementById('modalHomeCare').checked = !!record.homeCare;
                document.getElementById('modalIntensive').value = record.intensive || '';
                document.getElementById('modalAfterLeave').checked = !!record.afterLeave;
                document.getElementById('modalPeerSupport').checked = !!record.peerSupport;
                document.getElementById('modalAfterPeer').checked = !!record.afterPeer;
                document.getElementById('modalInfection').checked = !!record.infection;
                document.getElementById('modalStaffArrangement').checked = !!record.staffArrangement;
            } else {
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚¯ãƒªã‚¢
                ['modalStatus','modalNightSupport','modalDaytimeSupport','modalMedicalCoop','modalSelfSupport','modalNote','modalIntensive'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });
                ['modalInpatientSupport','modalReturnSupport','modalLongInpatient','modalLongReturn','modalHomeCare','modalAfterLeave','modalPeerSupport','modalAfterPeer','modalInfection','modalStaffArrangement'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.checked = false;
                });
            }

            // ãã®ä»–é …ç›®ã¯éš ã™
            document.getElementById('modalExtraItems').style.display = 'none';
            const collapseBtn = document.querySelector('.modal-collapse-btn');
            if (collapseBtn) collapseBtn.textContent = 'ãã®ä»–ã®é …ç›®ã‚’è¡¨ç¤º';

            document.getElementById('dateModal').classList.add('active');
        }

        function toggleModalExtra() {
            const el = document.getElementById('modalExtraItems');
            const btn = document.querySelector('.modal-collapse-btn');
            if (el.style.display === 'none' || el.style.display === '') {
                el.style.display = 'block';
                if (btn) btn.textContent = 'ãã®ä»–ã®é …ç›®ã‚’éš ã™';
            } else {
                el.style.display = 'none';
                if (btn) btn.textContent = 'ãã®ä»–ã®é …ç›®ã‚’è¡¨ç¤º';
            }
        }

        function closeModal() {
            document.getElementById('dateModal').classList.remove('active');
        }

        function saveRecord() {
            if (!selectedUserId) return;

            const dateFrom = document.getElementById('modalDateFrom').value;
            const dateTo = document.getElementById('modalDateTo').value;
            const overwrite = document.getElementById('modalOverwrite').checked;

            if (!dateFrom || !dateTo) {
                alert('ç™»éŒ²æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // â˜… ç¢ºå®šãƒ­ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯ï¼šå¯¾è±¡æœŸé–“ã«ç¢ºå®šæ¸ˆã¿æœˆãŒå«ã¾ã‚Œã‚‹å ´åˆã¯ãƒ–ãƒ­ãƒƒã‚¯
            const lockedMonths = [];
            let d0 = new Date(dateFrom);
            const end0 = new Date(dateTo);
            while (d0 <= end0) {
                const ym = d0.getFullYear() + '-' + String(d0.getMonth()+1).padStart(2,'0');
                if (exportConfirmations[ym] && !lockedMonths.includes(ym)) {
                    lockedMonths.push(ym);
                }
                d0.setDate(d0.getDate() + 1);
            }
            if (lockedMonths.length > 0) {
                const labels = lockedMonths.map(ym => {
                    const [y,m] = ym.split('-');
                    return y + 'å¹´' + parseInt(m) + 'æœˆ';
                }).join('ã€');
                alert('âš ï¸ ' + labels + ' ã¯è«‹æ±‚ãƒ‡ãƒ¼ã‚¿ãŒç¢ºå®šæ¸ˆã¿ã§ã™ã€‚\n\nå®Ÿç¸¾è¨˜éŒ²ã‚’å¤‰æ›´ã™ã‚‹ã«ã¯ã€è«‹æ±‚ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›ã‚¿ãƒ–ã§ã€Œç¢ºå®šè§£é™¤ã€ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚');
                return;
            }

            // ç™»éŒ²æ›œæ—¥ã®å–å¾—ï¼ˆãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„å ´åˆã¯å…¨æ›œæ—¥ï¼‰
            const checkedDows = [...document.querySelectorAll('.modalDow:checked')].map(cb => parseInt(cb.value));

            const recordData = {
                status: document.getElementById('modalEnableStatus').checked ? document.getElementById('modalStatus').value : '',
                nightSupport: document.getElementById('modalEnableNight').checked ? document.getElementById('modalNightSupport').value : '',
                daytimeSupport: document.getElementById('modalEnableDaytime').checked ? document.getElementById('modalDaytimeSupport').value : '',
                medicalCoop: document.getElementById('modalEnableMedical').checked ? document.getElementById('modalMedicalCoop').value : '',
                selfSupport: document.getElementById('modalEnableSelfSupport').checked ? document.getElementById('modalSelfSupport').value : '',
                note: document.getElementById('modalEnableNote').checked ? document.getElementById('modalNote').value : '',
                inpatientSupport: document.getElementById('modalInpatientSupport').checked,
                returnSupport: document.getElementById('modalReturnSupport').checked,
                longInpatient: document.getElementById('modalLongInpatient').checked,
                longReturn: document.getElementById('modalLongReturn').checked,
                homeCare: document.getElementById('modalHomeCare').checked,
                intensive: document.getElementById('modalEnableIntensive').checked ? document.getElementById('modalIntensive').value : '',
                afterLeave: document.getElementById('modalAfterLeave').checked,
                peerSupport: document.getElementById('modalPeerSupport').checked,
                afterPeer: document.getElementById('modalAfterPeer').checked,
                infection: document.getElementById('modalInfection').checked,
                staffArrangement: document.getElementById('modalStaffArrangement').checked
            };

            if (!records[selectedUserId]) records[selectedUserId] = {};

            // ç™»éŒ²æœŸé–“ã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦ä¿å­˜
            let d = new Date(dateFrom);
            const end = new Date(dateTo);
            let count = 0;
            while (d <= end) {
                const dow = d.getDay();
                const skip = checkedDows.length > 0 && !checkedDows.includes(dow);
                if (!skip) {
                    const dateStr = d.toISOString().slice(0, 10);
                    if (overwrite || !records[selectedUserId][dateStr]) {
                        records[selectedUserId][dateStr] = { ...recordData, date: dateStr };
                        count++;
                    }
                }
                d.setDate(d.getDate() + 1);
            }

            localStorage.setItem('gh_records', JSON.stringify(records));
            updateCalendar();
            closeModal();
            alert(`âœ… ${count}ä»¶ã®è¨˜éŒ²ã‚’ç™»éŒ²ã—ã¾ã—ãŸ`);
        }

        // ========== CSVå‡ºåŠ› ==========

        // ===== å®Ÿç¸¾è¨˜éŒ²ã®ä¿å­˜ç¢ºèª =====
        function confirmSaveAllRecords() {
            if (!selectedUserId) {
                alert('åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            const user = users.find(u => u.id === selectedUserId);
            const userName = user ? user.name : '';
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const prefix = currentYear + '-' + String(currentMonth + 1).padStart(2, '0');
            const count = records[selectedUserId]
                ? Object.keys(records[selectedUserId]).filter(d => d.startsWith(prefix)).length
                : 0;
            if (confirm(userName + ' ã® ' + currentYear + 'å¹´' + (currentMonth+1) + 'æœˆ ã®å®Ÿç¸¾ï¼ˆ' + count + 'ä»¶ï¼‰ã‚’ä¿å­˜æ¸ˆã¿ã§ã™ã€‚\n\nè¨˜éŒ²ã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚')) {
                alert('âœ… ' + userName + ' ã® ' + currentYear + 'å¹´' + (currentMonth+1) + 'æœˆã®å®Ÿç¸¾è¨˜éŒ²ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚');
            }
        }

        // ===== è«‹æ±‚ãƒ‡ãƒ¼ã‚¿å‡ºåŠ› =====
        // ===== è«‹æ±‚ç¢ºå®šç®¡ç† =====
        let exportConfirmations = JSON.parse(localStorage.getItem('gh_confirmations') || '{}');

        function initExportTab() {
            // äº‹æ¥­æ‰€åè¡¨ç¤º
            const facEl = document.getElementById('exportFacilityName');
            if (facEl) facEl.textContent = facility.facilityName || 'Tokyo. settle';

            // ã‚µãƒ¼ãƒ“ã‚¹æä¾›å¹´æœˆã®ã‚»ãƒ¬ã‚¯ãƒˆï¼ˆéå»24ãƒ¶æœˆï¼‹ä»Šå¾Œ3ãƒ¶æœˆï¼‰
            const sel = document.getElementById('exportMonthSelect');
            if (sel) {
                sel.innerHTML = '';
                const today = new Date();
                for (let i = -3; i <= 24; i++) {
                    const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                    const val = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
                    const label = d.getFullYear() + 'å¹´' + (d.getMonth()+1) + 'æœˆ';
                    const opt = document.createElement('option');
                    opt.value = val;
                    opt.textContent = label;
                    if (i === 0) opt.selected = true;
                    sel.appendChild(opt);
                }
            }
            onExportMonthChange();

            // å°åˆ·æ—¥åˆæœŸå€¤
            const todayStr = new Date().toISOString().slice(0,10);
            ['exportPrintDate','exportPrintDate2','exportPrintDate3','exportPrintDate4'].forEach(id => {
                const el = document.getElementById(id);
                if (el && !el.value) el.value = todayStr;
            });

            renderExportUserList();
        }

        function onExportMonthChange() {
            const sel = document.getElementById('exportMonthSelect');
            const val = sel ? sel.value : '';
            // æ—§äº’æ›ç”¨ã® hidden input ã«ã‚‚åŒæœŸ
            const hidden = document.getElementById('exportMonth');
            if (hidden) hidden.value = val;
            updateConfirmStatus(val);
        }

        function updateConfirmStatus(monthVal) {
            const btn = document.getElementById('btnConfirm');
            const label = document.getElementById('confirmStatusLabel');
            if (!btn || !label) return;
            if (exportConfirmations[monthVal]) {
                btn.textContent = 'ç¢ºå®šè§£é™¤';
                btn.style.background = '#e91e8c';
                const c = exportConfirmations[monthVal];
                label.textContent = 'ç¢ºå®šæ¸ˆã¿ï¼š' + new Date(c.confirmedAt).toLocaleString('ja-JP') + 'ã€€' + (c.confirmedBy || '');
            } else {
                btn.textContent = 'ç¢ºå®š';
                btn.style.background = '#667eea';
                label.textContent = '';
            }
        }

        function toggleConfirm() {
            const sel = document.getElementById('exportMonthSelect');
            const monthVal = sel ? sel.value : document.getElementById('exportMonth').value;
            if (!monthVal) { alert('å¯¾è±¡å¹´æœˆã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
            const [y, m] = monthVal.split('-');
            const label = y + 'å¹´' + parseInt(m) + 'æœˆ';

            if (exportConfirmations[monthVal]) {
                if (!confirm(label + ' ã®ç¢ºå®šã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
                delete exportConfirmations[monthVal];
                alert('âœ… ' + label + ' ã®ç¢ºå®šã‚’è§£é™¤ã—ã¾ã—ãŸ');
            } else {
                if (!confirm(label + ' ã®è«‹æ±‚ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ\n\nç¢ºå®šå¾Œã‚‚ãƒ‡ãƒ¼ã‚¿ã®ä¿®æ­£ã¯å¯èƒ½ã§ã™ãŒã€å†åº¦ç¢ºå®šãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚')) return;
                exportConfirmations[monthVal] = {
                    confirmedAt: new Date().toISOString(),
                    confirmedBy: facility.facilityName || ''
                };
                alert('âœ… ' + label + ' ã‚’ç¢ºå®šã—ã¾ã—ãŸ');
            }
            localStorage.setItem('gh_confirmations', JSON.stringify(exportConfirmations));
            updateConfirmStatus(monthVal);
        }

        function showConfirmHistory() {
            const panel = document.getElementById('confirmHistoryPanel');
            const list = document.getElementById('confirmHistoryList');
            if (!panel || !list) return;
            panel.style.display = panel.style.display === 'none' ? '' : 'none';
            const keys = Object.keys(exportConfirmations).sort().reverse();
            if (keys.length === 0) {
                list.innerHTML = '<p style="color:#aaa;">ç¢ºå®šå±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            list.innerHTML = '<table style="width:100%; border-collapse:collapse;">' +
                '<tr style="border-bottom:1px solid #ddd;"><th style="text-align:left; padding:6px;">å¹´æœˆ</th><th style="text-align:left; padding:6px;">ç¢ºå®šæ—¥æ™‚</th></tr>' +
                keys.map(k => {
                    const [y, m] = k.split('-');
                    const c = exportConfirmations[k];
                    return '<tr style="border-bottom:1px solid #eee;">' +
                        '<td style="padding:6px;">' + y + 'å¹´' + parseInt(m) + 'æœˆ</td>' +
                        '<td style="padding:6px;">' + new Date(c.confirmedAt).toLocaleString('ja-JP') + '</td>' +
                        '</tr>';
                }).join('') +
                '</table>';
        }

        function showTab2(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const tabBtn = document.querySelector('.tab[onclick*="' + name + '"]');
            if (tabBtn) tabBtn.classList.add('active');
            const tabContent = document.getElementById(name);
            if (tabContent) tabContent.classList.add('active');
        }

        function renderExportUserList() {
            const div = document.getElementById('exportUserList');
            if (!div) return;
            if (users.length === 0) {
                div.innerHTML = '<p style="color:#aaa; font-size:0.85em;">åˆ©ç”¨è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
                return;
            }
            div.innerHTML = users.map(u =>
                '<label style="display:flex; align-items:center; gap:6px; padding:5px 10px; background:white; border:1px solid #ddd; border-radius:20px; cursor:pointer; font-size:0.85em; white-space:nowrap;">' +
                '<input type="checkbox" class="exportUserCheck" value="' + u.id + '" checked>' +
                u.name +
                '</label>'
            ).join('');
        }

        function selectAllExportUsers(val) {
            document.querySelectorAll('.exportUserCheck').forEach(cb => cb.checked = val);
        }

        function getSelectedExportUsers() {
            const checked = [...document.querySelectorAll('.exportUserCheck:checked')].map(cb => cb.value);
            return users.filter(u => checked.includes(u.id));
        }

        function exportCSV(type) {
            const month = document.getElementById('exportMonth').value;
            if (!month) { alert('å¯¾è±¡å¹´æœˆã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
            const [year, mon] = month.split('-');
            const targetUsers = getSelectedExportUsers();
            if (targetUsers.length === 0) { alert('å‡ºåŠ›å¯¾è±¡ã®åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
            if (type === 'SE') generateSE(year, mon, targetUsers);
            else if (type === 'SV') generateSV(year, mon, targetUsers);
            else if (type === 'RK') {
                alert('RKï¼ˆåˆ©ç”¨è€…è² æ‹…ä¸Šé™é¡ç®¡ç†çµæœç¥¨ï¼‰ã¯ä¸Šé™é¡ç®¡ç†å¯¾è±¡è€…ãŒã„ã‚‹å ´åˆã«ä½¿ç”¨ã—ã¾ã™ã€‚\nç¾åœ¨ã“ã®CSVã®è‡ªå‹•ç”Ÿæˆã¯æº–å‚™ä¸­ã§ã™ã€‚');
            }
        }

        function exportPDF(type) {
            const month = document.getElementById('exportMonth').value;
            if (!month) { alert('å¯¾è±¡å¹´æœˆã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
            const [year, mon] = month.split('-');
            const targetUsers = getSelectedExportUsers();
            if (targetUsers.length === 0) { alert('å‡ºåŠ›å¯¾è±¡ã®åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }

            if (type === 'SE') {
                generateSEPDF(year, mon, targetUsers);
            } else if (type === 'SV') {
                generateSVPDF(year, mon, targetUsers);
            } else {
                document.getElementById('exportStatus').innerHTML =
                    '<div class="alert alert-info">â„¹ï¸ ' + type + ' ã®PDFå‡ºåŠ›æ©Ÿèƒ½ã¯ç¾åœ¨æº–å‚™ä¸­ã§ã™ã€‚</div>';
            }
        }

        // =========================================================
        // å°åˆ·ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã„ã¦è‡ªå‹•çš„ã«PDFä¿å­˜ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’èµ·å‹•ã™ã‚‹
        // ãƒ–ãƒ©ã‚¦ã‚¶ã®ã€Œå°åˆ·â†’PDFã«ä¿å­˜ã€æ©Ÿèƒ½ã‚’åˆ©ç”¨
        // =========================================================
        function openPrintWindow(bodyHtml, css, pageSize, orientation) {
            const win = window.open('', '_blank', 'width=900,height=700');
            const pageRule = orientation === 'landscape'
                ? '@page { size: A4 landscape; margin: 0; }'
                : '@page { size: A4 portrait; margin: 0; }';
            win.document.write(`<!DOCTYPE html><html lang="ja"><head>
<meta charset="UTF-8">
<style>
${pageRule}
${css}
</style>
</head><body>
${bodyHtml}
<script>
window.onload = function() {
    setTimeout(function() { window.print(); }, 300);
};
<\/script>
</body></html>`);
            win.document.close();
        }

        // =========================================================
        // SEå¸³ç¥¨PDFç”Ÿæˆï¼ˆä»‹è­·çµ¦ä»˜è²»ç­‰è«‹æ±‚æ›¸ãƒ»æ˜ç´°æ›¸ï¼‰
        // æ§˜å¼ç¬¬ä¸‰ï¼ˆè¨“ç·´ç­‰çµ¦ä»˜è²»ç­‰æ˜ç´°æ›¸ï¼‰ï¼‹æ§˜å¼ç¬¬ä¸€ï¼ˆè«‹æ±‚æ›¸ï¼‰
        // =========================================================

        // â”€â”€ å‡¦é‡æ”¹å–„åŠ ç®—ç‡ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆä»¤å’Œ6å¹´4æœˆï¼‰
        const TREATMENT_RATE = {
            'ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆâ… ï¼‰': 0.127,
            'ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆâ…¡ï¼‰': 0.115,
            'ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆâ…¢ï¼‰': 0.087,
            'ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆâ…£ï¼‰': 0.058,
            'ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(1)': 0.036,
            'ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(2)': 0.029,
            'ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(3)': 0.029,
            'ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(4)': 0.021,
            'ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(5)': 0.021,
            'ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(6)': 0.014,
            'ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(7)': 0.013,
            'ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(8)': 0.013,
            'ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(9)': 0.007,
            'ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(10)': 0.007,
            'ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(11)': 0.007,
            'ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(12)': 0.000,
            'ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(13)': 0.000,
            'ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆVï¼‰(14)': 0.000,
        };
        // å‡¦é‡æ”¹å–„åŠ ç®—ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ¼ãƒ‰
        const TREATMENT_CODE = {
            'ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆâ… ï¼‰': '335121',
            'ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆâ…¡ï¼‰': '335122',
            'ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆâ…¢ï¼‰': '335123',
            'ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆâ…£ï¼‰': '335124',
        };
        // äººå“¡é…ç½®ä½“åˆ¶åŠ ç®—å˜ä½æ•°ï¼ˆ1æ—¥ã‚ãŸã‚Šï¼‰
        const JINZAI_UNITS = { '4:1':83, '5:1':66, '6:1':0 };
        const JINZAI_CODE  = { '4:1':'337010', '5:1':'337011' };

        // â”€â”€ äººå“¡é…ç½®ä½“åˆ¶åŠ ç®—ã®ã‚³ãƒ¼ãƒ‰/å˜ä½å–å¾—
        function getJinzaiInfo(staffRatio) {
            if (!staffRatio) return null;
            const r = staffRatio.replace('ï¼š',':').replace(/\s/g,'');
            const units = JINZAI_UNITS[r];
            const code  = JINZAI_CODE[r];
            if (!units || !code) return null;
            return { units, code };
        }

        // â”€â”€ åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—ã®1æ—¥å˜ä½æ•°
        function getMedicalCoopUnits(medType) {
            if (!medType) return { units:0, code:null };
            if (medType.includes('â…¦')) return { units:39, code:'336069' };
            if (medType.includes('â…¥')) return { units:500, code:'336068' }; // â…¥ã¯æœˆé¡
            return { units:0, code:null };
        }

        // â”€â”€ å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—â…¢ã®1æ—¥å˜ä½æ•°ï¼ˆ10å˜ä½å›ºå®šï¼‰
        const NIGHT3_UNITS_PER_DAY = 10;

        // â”€â”€ æ˜ç´°æ›¸1æšã®HTMLç”Ÿæˆ
        function buildMeisaiHTML(user, cert, uc, am, building, serviceYm, details, totalUnits) {
            const f  = facility;
            const ym = serviceYm.substring(0,4) + '-' + serviceYm.substring(4,6);
            const reiwa = parseInt(serviceYm.substring(0,4)) - 2018;
            const ymDisp = `ä»¤å’Œ${String(reiwa).padStart(2,'0')}å¹´${serviceYm.substring(4,6)}æœˆ`;
            const startW = cert.certValidFrom ? (() => {
                const y2 = parseInt(cert.certValidFrom.substring(0,4)) - 2018;
                const m2 = cert.certValidFrom.substring(4,6);
                const d2 = cert.certValidFrom.substring(6,8);
                return `ä»¤å’Œ ${String(y2).padStart(2,'0')} å¹´ ${m2} æœˆ ${d2} æ—¥`;
            })() : '';
            const cityCode = cert.certCityCode || '';
            const certNo   = cert.certNo || '';
            const areaName = {'01':'ä¸€ç´šåœ°','02':'äºŒç´šåœ°','03':'ä¸‰ç´šåœ°','04':'å››ç´šåœ°','05':'äº”ç´šåœ°','06':'å…­ç´šåœ°','07':'ä¸ƒç´šåœ°','20':'ãã®ä»–'}[f.areaCode||'01']||'ãã®ä»–';
            const supportDisp = cert.certSupportLevel || '';
            const burdenLimit = parseInt(cert.certBurdenLimit)||0;
            const unitPriceDisp = ((GH_TANKA[f.areaCode||'01']||10.00)).toFixed(2);
            const hosdays = uc.hospitalDays || 0;
            const exdays  = uc.externalStayDays || 0;
            const nc = (s,n) => s.padStart(n,' ').split('').map(c=>`<td class="gh-c">${c===' '?'&nbsp;':c}</td>`).join('');
            const cityNoStr = cityCode.padStart(6,'0');
            const facNoStr  = (f.facilityNumber||'').padStart(10,'0');
            const certNoStr = certNo.padStart(10,'0');

            let detailRows = '';
            details.forEach(d => {
                const codeStr = String(d.code).padStart(6,'0');
                const uStr    = String(d.unitsPer).padStart(5,' ');
                const cStr    = String(d.count).padStart(3,' ');
                const tStr    = String(d.total).padStart(7,' ');
                detailRows += `<tr>
                    <td style="width:42mm;font-size:7pt;">${d.name}</td>
                    ${codeStr.split('').map(c=>`<td class="gh-c">${c}</td>`).join('')}
                    ${uStr.split('').map(c=>`<td class="gh-c">${c===' '?'&nbsp;':c}</td>`).join('')}
                    ${cStr.split('').map(c=>`<td class="gh-c">${c===' '?'&nbsp;':c}</td>`).join('')}
                    ${tStr.split('').map(c=>`<td class="gh-c">${c===' '?'&nbsp;':c}</td>`).join('')}
                    <td></td>
                </tr>`;
            });
            // ç©ºè¡Œï¼ˆæœ€ä½3è¡Œï¼‰
            const emptyNeeded = Math.max(3, 8 - details.length);
            for(let i=0;i<emptyNeeded;i++) detailRows += `<tr><td colspan="22" style="height:6.5mm;"></td></tr>`;

            const n = (v) => Number(v||0).toLocaleString('ja-JP');
            const tuStr  = String(totalUnits);
            const tcStr  = String(am.totalCost);
            const t10Str = String(Math.floor(am.totalCost * 0.1));
            const ubStr  = String(am.userBurden);
            const raStr  = String(am.grantFee);

            return `<div class="gh-page">
  <div class="gh-title">è¨“ç·´ç­‰çµ¦ä»˜è²»ç­‰æ˜ç´°æ›¸</div>
  <div class="gh-subtitle">ï¼ˆå…±åŒç”Ÿæ´»æ´åŠ©ï¼‰</div>
  <div class="gh-nengetsu">${ymDisp}åˆ†</div>
  <table class="gh-tbl" style="margin-bottom:1.5mm;">
    <tr>
      <td class="gh-lbl" style="width:22mm;">å¸‚ç”ºæ‘ç•ªå·</td>
      ${cityNoStr.split('').map(c=>`<td class="gh-c">${c}</td>`).join('')}
      <td style="border:none;width:4mm;"></td>
      <td class="gh-lbl center" rowspan="2" style="width:18mm;">æŒ‡å®šäº‹æ¥­æ‰€ç•ªå·</td>
      ${facNoStr.split('').map(c=>`<td class="gh-c" style="width:5.2mm;">${c}</td>`).join('')}
    </tr>
    <tr>
      <td class="gh-lbl">åŠ©æˆè‡ªæ²»ä½“ç•ªå·</td>
      ${Array(6).fill('<td class="gh-c">&nbsp;</td>').join('')}
      <td style="border:none;"></td>
      <td colspan="10" style="padding:1px 3px;font-size:7.5pt;">
        <span style="font-size:6.5pt;color:#555;">äº‹æ¥­è€…åŠã³ãã®äº‹æ¥­æ‰€ã®åç§°</span><br>
        ${f.facilityName||''}
      </td>
    </tr>
    <tr>
      <td class="gh-lbl">å—çµ¦è€…è¨¼ç•ªå·</td>
      ${certNoStr.split('').map(c=>`<td class="gh-c">${c}</td>`).join('')}
      <td style="border:none;"></td>
      <td class="gh-lbl" colspan="2">åœ°åŸŸåŒºåˆ†</td>
      <td colspan="9">${areaName}</td>
    </tr>
    <tr>
      <td class="gh-lbl">æ”¯çµ¦æ±ºå®šéšœå®³è€…ç­‰æ°å</td>
      <td colspan="6" style="padding:1px 4px;">${user.name||''}</td>
      <td style="border:none;"></td>
      <td colspan="11"></td>
    </tr>
    <tr>
      <td class="gh-lbl">æ”¯çµ¦æ±ºå®šã«ä¿‚ã‚‹éšœå®³å…æ°å</td>
      <td colspan="6"></td>
      <td style="border:none;"></td>
      <td colspan="11"></td>
    </tr>
  </table>
  <table class="gh-tbl" style="margin-bottom:1.5mm;">
    <tr>
      <td class="gh-lbl" style="width:38mm;">åˆ©ç”¨è€…è² æ‹…ä¸Šé™æœˆé¡ã€€â‘ </td>
      <td colspan="5" class="center">${n(burdenLimit)}</td>
      <td style="width:8mm;border:none;"></td>
      <td class="gh-lbl" style="width:22mm;">éšœå®³æ”¯æ´åŒºåˆ†</td>
      <td colspan="3">${supportDisp}</td>
    </tr>
  </table>
  <table class="gh-tbl" style="margin-bottom:1.5mm;">
    <tr>
      <td class="gh-lbl" rowspan="2" style="width:26mm;">åˆ©ç”¨è€…è² æ‹…ä¸Šé™é¡<br>ç®¡ç†äº‹æ¥­æ‰€</td>
      <td class="gh-lbl" style="width:22mm;">æŒ‡å®šäº‹æ¥­æ‰€ç•ªå·</td>
      <td colspan="10"></td>
      <td class="gh-lbl" style="width:12mm;">ç®¡ç†çµæœ</td>
      <td colspan="3"></td>
      <td class="gh-lbl" style="width:14mm;">ç®¡ç†çµæœé¡</td>
      <td colspan="3"></td>
    </tr>
    <tr><td class="gh-lbl">äº‹æ¥­æ‰€åç§°</td><td colspan="17"></td></tr>
  </table>
  <table class="gh-tbl" style="margin-bottom:1.5mm;">
    <tr>
      <td class="gh-lbl center" rowspan="2" style="width:13mm;">ã‚µãƒ¼ãƒ“ã‚¹<br>ç¨®åˆ¥</td>
      <td class="gh-c">3</td><td class="gh-c">3</td>
      <td class="gh-lbl" style="width:16mm;">é–‹å§‹å¹´æœˆæ—¥</td>
      <td colspan="11" style="padding:1px 4px;font-size:8pt;">${startW}</td>
      <td class="gh-lbl" style="width:13mm;">çµ‚äº†å¹´æœˆæ—¥</td>
      <td colspan="6"></td>
      <td class="gh-lbl" style="width:11mm;">å…¥é™¢æ—¥æ•°</td>
      <td colspan="2" class="center">${hosdays||''}</td>
      <td class="gh-lbl" style="width:11mm;">å¤–æ³Šæ—¥æ•°</td>
      <td colspan="2"></td>
    </tr>
    <tr>
      <td class="gh-lbl">é–‹å§‹å¹´æœˆæ—¥</td>
      <td colspan="11"></td>
      <td class="gh-lbl">çµ‚äº†å¹´æœˆæ—¥</td>
      <td colspan="6"></td>
      <td class="gh-lbl">å…¥é™¢æ—¥æ•°</td>
      <td colspan="2"></td>
      <td class="gh-lbl">å¤–æ³Šæ—¥æ•°</td>
      <td colspan="2"></td>
    </tr>
  </table>
  <table class="gh-tbl" style="margin-bottom:1.5mm;">
    <thead>
      <tr>
        <td class="gh-lbl center" rowspan="${details.length+emptyNeeded+1}" style="width:7mm;writing-mode:vertical-rl;font-size:7pt;">çµ¦<br>ä»˜<br>è²»<br>æ˜<br>ç´°<br>æ¬„</td>
        <td class="gh-lbl center" style="width:42mm;">ã‚µãƒ¼ãƒ“ã‚¹å†…å®¹</td>
        <td class="gh-lbl center" colspan="6">ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ¼ãƒ‰</td>
        <td class="gh-lbl center" colspan="5">å˜ä½æ•°</td>
        <td class="gh-lbl center" colspan="3">å›æ•°</td>
        <td class="gh-lbl center" colspan="7">ã‚µãƒ¼ãƒ“ã‚¹å˜ä½</td>
        <td class="gh-lbl center">æ‘˜è¦</td>
      </tr>
    </thead>
    <tbody>${detailRows}</tbody>
  </table>
  <table class="gh-tbl" style="margin-bottom:1.5mm;">
    <tr>
      <td class="gh-lbl" rowspan="2" style="width:16mm;font-size:6pt;">æ—¥ä¸­ä»‹è­·ç­‰<br>æ”¯æ´åŠ ç®—æ¬„</td>
      <td class="gh-lbl" rowspan="2" style="width:18mm;font-size:6pt;">æ—¥ä¸­æ´»å‹•å…ˆäº‹æ¥­æ‰€</td>
      <td class="gh-lbl" style="width:22mm;">æŒ‡å®šäº‹æ¥­æ‰€ç•ªå·</td>
      <td colspan="9"></td>
      <td class="gh-lbl" colspan="3" style="font-size:6.5pt;">å½“è©²äº‹æ¥­æ‰€ã¸ã®é€šæ‰€æ—¥æ•°</td>
      <td colspan="2"></td>
    </tr>
    <tr>
      <td class="gh-lbl">äº‹æ¥­æ‰€åç§°</td>
      <td colspan="14"></td>
    </tr>
  </table>
  <table class="gh-tbl">
    <tr>
      <td class="gh-lbl center" rowspan="13" style="width:7mm;writing-mode:vertical-rl;font-size:7pt;">è«‹<br>æ±‚<br>é¡<br>é›†<br>è¨ˆ<br>æ¬„</td>
      <td class="gh-lbl" style="width:42mm;">ã‚µãƒ¼ãƒ“ã‚¹ç¨®é¡ã‚³ãƒ¼ãƒ‰</td>
      <td class="gh-c">3</td><td class="gh-c">3</td><td colspan="10"></td>
      <td class="gh-lbl" style="width:10mm;">åˆè¨ˆ</td>
      <td colspan="8"></td>
    </tr>
    <tr>
      <td class="gh-lbl">ã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨æ—¥æ•°</td>
      ${String(uc.serviceDays).split('').map(c=>`<td class="gh-c">${c}</td>`).join('')}
      <td class="gh-lbl" colspan="2">æ—¥</td>
      <td colspan="8"></td>
      <td class="gh-lbl" colspan="2">æ—¥</td>
      <td colspan="5"></td>
    </tr>
    <tr><td class="gh-lbl">çµ¦ä»˜å˜ä½æ•°</td><td colspan="5" class="right" style="padding-right:3px;">${n(totalUnits)}</td><td colspan="7"></td><td colspan="9" class="right" style="padding-right:3px;">${n(totalUnits)}</td></tr>
    <tr><td class="gh-lbl">å˜ä½æ•°å˜ä¾¡</td><td colspan="5" class="right" style="padding-right:3px;">${unitPriceDisp}</td><td class="left" style="font-size:6.5pt;" colspan="2">å††/å˜ä½</td><td colspan="6"></td><td style="font-size:6.5pt;" colspan="2">å††/å˜ä½</td><td colspan="6"></td></tr>
    <tr><td class="gh-lbl">ç·è²»ç”¨é¡</td><td colspan="5" class="right" style="padding-right:3px;">${n(am.totalCost)}</td><td colspan="7"></td><td colspan="9" class="right" style="padding-right:3px;">${n(am.totalCost)}</td></tr>
    <tr><td class="gh-lbl">ï¼‘å‰²ç›¸å½“é¡</td><td colspan="5" class="right" style="padding-right:3px;">${n(Math.floor(am.totalCost*0.1))}</td><td colspan="16"></td></tr>
    <tr><td class="gh-lbl">åˆ©ç”¨è€…è² æ‹…é¡â‘¡</td><td colspan="5" class="right" style="padding-right:3px;">${n(am.userBurden)}</td><td colspan="16"></td></tr>
    <tr><td class="gh-lbl" style="font-size:6.5pt;">ä¸Šé™æœˆé¡èª¿æ•´(â‘ â‘¡ã®å†…å°‘ãªã„æ•°)</td><td colspan="5" class="right" style="padding-right:3px;">0</td><td colspan="7"></td><td colspan="9" class="right" style="padding-right:3px;">0</td></tr>
    <tr><td class="gh-lbl">èª¿æ•´å¾Œåˆ©ç”¨è€…è² æ‹…é¡</td><td colspan="21"></td></tr>
    <tr><td class="gh-lbl">ä¸Šé™é¡ç®¡ç†å¾Œåˆ©ç”¨è€…è² æ‹…é¡</td><td colspan="21"></td></tr>
    <tr><td class="gh-lbl">æ±ºå®šåˆ©ç”¨è€…è² æ‹…é¡</td><td colspan="5" class="right" style="padding-right:3px;">0</td><td colspan="7"></td><td colspan="9" class="right" style="padding-right:3px;">0</td></tr>
    <tr>
      <td class="gh-lbl">è«‹æ±‚é¡</td>
      <td class="gh-lbl" style="width:18mm;">çµ¦ä»˜è²»</td>
      <td colspan="4" class="right" style="padding-right:3px;">${n(am.grantFee)}</td>
      <td colspan="7"></td>
      <td colspan="9" class="right" style="padding-right:3px;">${n(am.grantFee)}</td>
    </tr>
    <tr><td class="gh-lbl" colspan="2">è‡ªæ²»ä½“åŠ©æˆåˆ†è«‹æ±‚é¡</td><td colspan="20"></td></tr>
  </table>
  <table class="gh-tbl" style="margin-top:1.5mm;">
    <tr>
      <td class="gh-lbl" colspan="2" style="width:55mm;">ç‰¹å®šéšœå®³è€…ç‰¹åˆ¥çµ¦ä»˜è²»</td>
      <td colspan="8"></td>
    </tr>
    <tr>
      <td class="gh-lbl" style="width:28mm;">çµ¦ä»˜è²»è«‹æ±‚é¡</td>
      <td class="gh-lbl" style="width:27mm;">å®Ÿè²»ç®—å®šé¡</td>
      <td colspan="8"></td>
    </tr>
    <tr>
      <td class="right" style="padding-right:4px;">10,000</td>
      <td class="right" style="padding-right:4px;">10,000</td>
      <td colspan="8"></td>
    </tr>
  </table>
</div>`;
        }

        // â”€â”€ è«‹æ±‚æ›¸1æšï¼ˆæ§˜å¼ç¬¬ä¸€ï¼‰ã®HTMLç”Ÿæˆ
        function buildSeikyuHTML(cityCode, cityUsers, serviceYm) {
            const f = facility;
            const reiwa = parseInt(serviceYm.substring(0,4)) - 2018;
            const m = parseInt(serviceYm.substring(4,6));
            const processY = (m===12) ? parseInt(serviceYm.substring(0,4))+1 : parseInt(serviceYm.substring(0,4));
            const processM = (m===12) ? 1 : m+1;
            const processReiwa = processY - 2018;
            const requestDate = `ä»¤å’Œ ${processReiwa}å¹´ ${processM}æœˆ 20æ—¥`;
            const ymDisp = `ä»¤å’Œ${String(reiwa).padStart(2,'0')}å¹´${String(m).padStart(2,'0')}æœˆ`;
            const cityNameMap = {
                "131024":"ä¸­å¤®åŒºé•·","131032":"æ¸¯åŒºé•·","131041":"æ–°å®¿åŒºé•·","131059":"æ–‡äº¬åŒºé•·",
                "131067":"å°æ±åŒºé•·","131075":"å¢¨ç”°åŒºé•·","131083":"æ±Ÿæ±åŒºé•·","131091":"å“å·åŒºé•·",
                "131105":"ç›®é»’åŒºé•·","131113":"å¤§ç”°åŒºé•·","131121":"ä¸–ç”°è°·åŒºé•·","131130":"æ¸‹è°·åŒºé•·",
                "131148":"ä¸­é‡åŒºé•·","131156":"æ‰ä¸¦åŒºé•·","131164":"è±Šå³¶åŒºé•·","131172":"åŒ—åŒºé•·",
                "131181":"è’å·åŒºé•·","131199":"æ¿æ©‹åŒºé•·","131202":"ç·´é¦¬åŒºé•·","131211":"è¶³ç«‹åŒºé•·",
                "131229":"è‘›é£¾åŒºé•·","131237":"æ±Ÿæˆ¸å·åŒºé•·",
                "132012":"å…«ç‹å­å¸‚é•·","132021":"ç«‹å·å¸‚é•·","132039":"æ­¦è”µé‡å¸‚é•·","132047":"ä¸‰é·¹å¸‚é•·",
                "132055":"é’æ¢…å¸‚é•·","132063":"åºœä¸­å¸‚é•·","132071":"æ˜­å³¶å¸‚é•·","132080":"èª¿å¸ƒå¸‚é•·",
                "132098":"ç”ºç”°å¸‚é•·","132101":"å°é‡‘äº•å¸‚é•·","132110":"å°å¹³å¸‚é•·","132128":"æ—¥é‡å¸‚é•·",
                "132136":"æ±æ‘å±±å¸‚é•·","132144":"å›½åˆ†å¯ºå¸‚é•·","132152":"å›½ç«‹å¸‚é•·","132187":"ç¦ç”Ÿå¸‚é•·",
                "132195":"ç‹›æ±Ÿå¸‚é•·","132209":"æ±å¤§å’Œå¸‚é•·","132217":"æ¸…ç€¬å¸‚é•·","132225":"æ±ä¹…ç•™ç±³å¸‚é•·",
                "132233":"æ­¦è”µæ‘å±±å¸‚é•·","132241":"å¤šæ‘©å¸‚é•·","132250":"ç¨²åŸå¸‚é•·","132276":"ç¾½æ‘å¸‚é•·",
                "132284":"ã‚ãã‚‹é‡å¸‚é•·","132292":"è¥¿æ±äº¬å¸‚é•·",
            };
            const cityName = cityNameMap[cityCode] || cityCode+'é•·';
            const facNoStr = (f.facilityNumber||'').padStart(10,'0');

            // é›†è¨ˆ
            let totalUnits = 0, totalCost = 0, totalGrant = 0;
            cityUsers.forEach(u => { totalUnits += u._totalUnits||0; totalCost += u._totalCost||0; totalGrant += u._grantFee||0; });
            const totalTokutei = cityUsers.length * 10000;
            const grandTotal = totalCost + totalTokutei;
            const amtStr = String(grandTotal).padStart(7,' ');

            return `<div class="gh-page">
  <div class="gh-title">ä»‹è­·çµ¦ä»˜è²»ãƒ»è¨“ç·´ç­‰çµ¦ä»˜è²»ç­‰è«‹æ±‚æ›¸</div>
  <div class="right" style="font-size:8.5pt;margin-bottom:3mm;">${requestDate}</div>
  <div style="margin-bottom:3mm;font-size:8.5pt;">ï¼ˆ è«‹ æ±‚ å…ˆ ï¼‰</div>
  <table style="border-collapse:collapse;width:100%;margin-bottom:4mm;">
    <tr>
      <td style="border:none;width:58mm;vertical-align:bottom;text-align:center;font-size:10pt;padding-bottom:2mm;">
        <br><br><br>${cityName}ã€€æ®¿
      </td>
      <td style="border:none;width:4mm;"></td>
      <td style="border:none;vertical-align:top;">
        <table class="gh-tbl">
          <tr>
            <td class="gh-lbl" rowspan="5" style="width:6mm;writing-mode:vertical-rl;font-size:7pt;">è«‹<br>æ±‚<br>äº‹<br>æ¥­<br>è€…</td>
            <td class="gh-lbl" style="width:20mm;">æŒ‡å®šäº‹æ¥­æ‰€ç•ªå·</td>
            ${facNoStr.split('').map(c=>`<td class="gh-c" style="width:5mm;">${c}</td>`).join('')}
          </tr>
          <tr>
            <td class="gh-lbl">ä½ã€€æ‰€<br>ï¼ˆæ‰€åœ¨åœ°ï¼‰</td>
            <td colspan="10" style="padding:1px 4px;font-size:7.5pt;">ã€’${f.facilityZip||''}<br>${f.facilityAddress||''}</td>
          </tr>
          <tr><td class="gh-lbl">é›»è©±ç•ªå·</td><td colspan="10" style="padding:1px 4px;">${f.tel||f.facilityTel||''}</td></tr>
          <tr><td class="gh-lbl">åã€€ç§°</td><td colspan="10" style="padding:1px 4px;">${f.corporationName||''} ${f.facilityName||''}</td></tr>
          <tr><td class="gh-lbl">è·ãƒ»æ°å</td><td colspan="10" style="padding:1px 4px;">${f.directorTitle||''} ${f.directorName||''}</td></tr>
        </table>
      </td>
    </tr>
  </table>
  <div style="font-size:8.5pt;margin-bottom:2mm;">ä¸‹è¨˜ã®ã¨ãŠã‚Šè«‹æ±‚ã—ã¾ã™ã€‚</div>
  <table class="gh-tbl" style="width:auto;margin-bottom:3mm;">
    <tr>
      ${(ymDisp+'åˆ†').split('').map(c=>`<td class="gh-c" style="width:7mm;">${c}</td>`).join('')}
    </tr>
  </table>
  <table class="gh-tbl" style="width:auto;margin-bottom:5mm;">
    <tr>
      <td class="gh-lbl" style="width:18mm;">è«‹æ±‚é‡‘é¡</td>
      <td class="gh-lbl center" style="width:8mm;font-size:6.5pt;">ç™¾ä¸‡</td>
      <td class="gh-c" style="width:7mm;">ï¿¥</td>
      ${amtStr.split('').map(c=>`<td class="gh-c right" style="width:7mm;font-size:11pt;font-weight:bold;">${c===' '?'&nbsp;':c}</td>`).join('')}
      <td class="gh-c" style="width:5mm;">å††</td>
    </tr>
  </table>
  <table class="gh-tbl">
    <thead>
      <tr>
        <td class="gh-lbl center" colspan="3">åŒºã€€ã€€ã€€ã€€åˆ†</td>
        <td class="gh-lbl center">ä»¶æ•°</td>
        <td class="gh-lbl center">å˜ä½æ•°</td>
        <td class="gh-lbl center">è²»ç”¨åˆè¨ˆ</td>
        <td class="gh-lbl center">çµ¦ä»˜è²»<br>è«‹æ±‚é¡</td>
        <td class="gh-lbl center">åˆ©ç”¨è€…<br>è² æ‹…é¡</td>
        <td class="gh-lbl center">è‡ªæ²»ä½“<br>åŠ©æˆé¡</td>
      </tr>
    </thead>
    <tbody>
      ${[0,1,2,3,4,5,6].map(()=>`<tr><td class="gh-lbl center" style="width:7mm;writing-mode:vertical-rl;font-size:6pt;" rowspan="7">ä»‹è­·çµ¦ä»˜è²»</td><td colspan="2" style="height:7mm;"></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>`).slice(0,1).join('')}
      <tr><td class="gh-lbl center" style="width:7mm;writing-mode:vertical-rl;font-size:6pt;" rowspan="7">ä»‹<br>è­·<br>çµ¦<br>ä»˜<br>è²»</td><td colspan="2" style="height:7mm;"></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
      <tr><td colspan="2" style="height:7mm;"></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
      <tr><td colspan="2" style="height:7mm;"></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
      <tr><td colspan="2" style="height:7mm;"></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
      <tr><td colspan="2" style="height:7mm;"></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
      <tr><td colspan="2" style="height:7mm;"></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
      <tr>
        <td class="gh-lbl center" style="width:7mm;writing-mode:vertical-rl;font-size:6pt;" rowspan="4">è¨“<br>ç·´<br>ç­‰<br>çµ¦<br>ä»˜<br>è²»</td>
        <td colspan="2" style="padding:1px 4px;">å…±åŒç”Ÿæ´»æ´åŠ©</td>
        <td class="right" style="padding-right:4px;">${cityUsers.length}</td>
        <td class="right" style="padding-right:4px;">${Number(totalUnits).toLocaleString()}</td>
        <td class="right" style="padding-right:4px;">${Number(totalCost).toLocaleString()}</td>
        <td class="right" style="padding-right:4px;">${Number(totalCost).toLocaleString()}</td>
        <td class="right" style="padding-right:4px;">0</td>
        <td class="right" style="padding-right:4px;">0</td>
      </tr>
      <tr><td colspan="2" style="height:7mm;"></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
      <tr><td colspan="2" style="height:7mm;"></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
      <tr><td colspan="2" style="height:7mm;"></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
      <tr>
        <td class="gh-lbl center" style="width:7mm;writing-mode:vertical-rl;font-size:5.5pt;" rowspan="2">åœ°æ”¯<br>åŸŸæ´<br>ç›¸çµ¦<br>è«‡ä»˜<br>è²»</td>
        <td colspan="2" style="height:7mm;"></td><td></td><td></td><td></td><td></td><td></td><td></td>
      </tr>
      <tr><td colspan="2" style="height:7mm;"></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
      <tr>
        <td colspan="3" class="center gh-lbl">å°ã€€ã€€ã€€è¨ˆ</td>
        <td class="right" style="padding-right:4px;">${cityUsers.length}</td>
        <td class="right" style="padding-right:4px;">${Number(totalUnits).toLocaleString()}</td>
        <td class="right" style="padding-right:4px;">${Number(totalCost).toLocaleString()}</td>
        <td class="right" style="padding-right:4px;">${Number(totalCost).toLocaleString()}</td>
        <td class="right" style="padding-right:4px;">0</td>
        <td class="right" style="padding-right:4px;">0</td>
      </tr>
      <tr>
        <td colspan="3" class="center gh-lbl">ç‰¹å®šéšœå®³è€…ç‰¹åˆ¥çµ¦ä»˜è²»</td>
        <td class="right" style="padding-right:4px;">${cityUsers.length}</td>
        <td></td>
        <td class="right" style="padding-right:4px;">${Number(totalTokutei).toLocaleString()}</td>
        <td class="right" style="padding-right:4px;">${Number(totalTokutei).toLocaleString()}</td>
        <td style="border-right:none;border-bottom:none;"></td>
        <td style="border-left:none;border-bottom:none;"></td>
      </tr>
      <tr>
        <td colspan="3" class="center gh-lbl" style="font-weight:bold;">åˆã€€ã€€ã€€è¨ˆ</td>
        <td class="right" style="padding-right:4px;">${cityUsers.length * 2}</td>
        <td class="right" style="padding-right:4px;">${Number(totalUnits).toLocaleString()}</td>
        <td class="right" style="padding-right:4px;">${Number(grandTotal).toLocaleString()}</td>
        <td class="right" style="padding-right:4px;">${Number(grandTotal).toLocaleString()}</td>
        <td class="right" style="padding-right:4px;">0</td>
        <td class="right" style="padding-right:4px;">0</td>
      </tr>
    </tbody>
  </table>
</div>`;
        }

        // â”€â”€ PDFç”Ÿæˆãƒ¡ã‚¤ãƒ³
        function generateSEPDF(year, mon, targetUsers) {
            const serviceYm = year + mon.padStart(2,'0');
            let allPages = [];
            const cityGroups = {};

            targetUsers.forEach(user => {
                const monthRecords = getMonthRecords(user.id, year, mon);
                if (Object.keys(monthRecords).length === 0) return;

                const ym = year + '-' + mon.padStart(2,'0');
                const cert = ((user.certificates||[])
                    .filter(c => {
                        const from = (c.certValidFrom||'0000-00-00').replace(/-/g,'').substring(0,6);
                        const to   = (c.certValidTo  ||'9999-12-31').replace(/-/g,'').substring(0,6);
                        const cur  = serviceYm;
                        return from <= cur && cur <= to;
                    })
                    .sort((a,b)=>(b.certValidFrom||'').localeCompare(a.certValidFrom||'')))[0]
                    || (user.certificates||[])[0] || {};

                const cityCode = cert.certCityCode || '';
                const building = (facility.buildings||[]).find(b=>(b.users||[]).includes(user.id))||null;
                const uc = calcUnits(user, building, cert, monthRecords);
                const incomeCode = getIncomeClassCode(cert.certBurdenLimit);

                // å‡¦é‡æ”¹å–„åŠ ç®—è¨ˆç®—
                const treatType = facility.treatmentImprovement || '';
                const treatRate = TREATMENT_RATE[treatType] || 0;
                const treatUnits = treatRate > 0 ? Math.floor(uc.baseTotal * treatRate) : 0;
                const treatCode  = TREATMENT_CODE[treatType] || '335123';

                // äººå“¡é…ç½®ä½“åˆ¶åŠ ç®—è¨ˆç®—
                const jinzaiInfo = getJinzaiInfo(facility.staffRatio);
                const jinzaiUnits = jinzaiInfo ? jinzaiInfo.units * uc.serviceDays : 0;

                // åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—
                const medInfo = getMedicalCoopUnits(facility.medicalCooperation);
                const medUnits = medInfo.units > 0 ? medInfo.units * uc.serviceDays : 0;

                // å¤œé–“æ”¯æ´â…¡/â…¢
                const ns2 = facility.nightSupportType2 || '';
                const ns3 = facility.nightSupportType3 || '';
                let night2Units = 0, night3Units = 0;
                if (ns2) night2Units = 35 * uc.serviceDays; // â…¡ã¯äººæ•°åˆ¥ã ãŒç°¡æ˜“çš„ã«
                if (ns3) night3Units = NIGHT3_UNITS_PER_DAY * uc.serviceDays;

                // åˆè¨ˆå˜ä½æ•°ï¼ˆå‡¦é‡æ”¹å–„ãƒ»äººå“¡é…ç½®ãƒ»åŒ»ç™‚é€£æºã‚’å«ã‚€ï¼‰
                const totalUnits = uc.totalUnits + treatUnits + jinzaiUnits + medUnits + night2Units + night3Units;
                const am = calcAmount(totalUnits, facility.areaCode||'01', incomeCode, cert.certBurdenLimit||'0');

                // æ˜ç´°è¡Œãƒªã‚¹ãƒˆ
                const baseName = buildBaseName(cert.certSupportLevel||'', building);
                const baseCode = buildBaseCode(cert.certSupportLevel||'', building);
                const details = [];
                details.push({ name:baseName, code:baseCode, unitsPer:uc.baseUnitPerDay, count:uc.serviceDays, total:uc.baseTotal });

                if (treatUnits > 0) details.push({ name:'ç”Ÿæ´'+treatType.replace('ç¦ç¥‰ãƒ»ä»‹è­·è·å“¡ç­‰',''), code:treatCode, unitsPer:treatUnits, count:1, total:treatUnits });
                if (ns3) details.push({ name:'ç”Ÿæ´å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—â…¢', code:'335640', unitsPer:NIGHT3_UNITS_PER_DAY, count:uc.serviceDays, total:night3Units });
                if (medUnits > 0) details.push({ name:'ç”Ÿæ´'+facility.medicalCooperation, code:medInfo.code, unitsPer:medInfo.units, count:uc.serviceDays, total:medUnits });
                if (uc.nightAddition > 0) {
                    const nightUnitPerDay = Math.floor(uc.nightAddition / Math.max(uc.serviceDays,1));
                    details.push({ name:'ç”Ÿæ´å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—â…  '+facility.nightSupportType1, code:uc.nightCode||'125001', unitsPer:nightUnitPerDay, count:uc.serviceDays, total:uc.nightAddition });
                }
                if (jinzaiUnits > 0) details.push({ name:'ç”Ÿæ´äººå“¡é…ç½®ä½“åˆ¶åŠ ç®—'+buildJinzaiName(facility.staffRatio), code:jinzaiInfo.code, unitsPer:jinzaiInfo.units, count:uc.serviceDays, total:jinzaiUnits });

                // é›†è¨ˆç”¨ã«ä¿å­˜
                user._totalUnits = totalUnits;
                user._totalCost  = am.totalCost;
                user._grantFee   = am.grantFee;

                allPages.push(buildMeisaiHTML(user, cert, uc, am, building, serviceYm, details, totalUnits));

                if (!cityGroups[cityCode]) cityGroups[cityCode] = [];
                cityGroups[cityCode].push(user);
            });

            if (allPages.length === 0) { alert('å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹åˆ©ç”¨è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }

            // è«‹æ±‚æ›¸ã‚’è‡ªæ²»ä½“åˆ¥ã«è¿½åŠ 
            Object.entries(cityGroups).forEach(([cityCode, cityUsers]) => {
                allPages.push(buildSeikyuHTML(cityCode, cityUsers, serviceYm));
            });

            const seStyle = `
                body { font-family: "MS Gothic","Meiryo",monospace; margin:0; font-size:8pt; }
                .gh-page { width:210mm; min-height:297mm; background:white; box-sizing:border-box; padding:8mm 10mm; page-break-after:always; }
                .gh-title { text-align:center; font-size:11pt; font-weight:bold; margin-bottom:2mm; }
                .gh-subtitle { text-align:center; font-size:9pt; margin-bottom:1.5mm; }
                .gh-nengetsu { text-align:right; font-size:8.5pt; margin-bottom:1.5mm; }
                .gh-tbl { border-collapse:collapse; width:100%; }
                .gh-tbl td { border:1px solid #000; padding:1px 2px; vertical-align:middle; line-height:1.3; }
                .gh-lbl { background:#f5f5f5; font-size:6.5pt; white-space:nowrap; }
                .gh-c { text-align:center; width:5.5mm; min-width:4.5mm; font-size:8pt; }
                .center { text-align:center; } .right { text-align:right; } .left { text-align:left; }
            `;
            openPrintWindow(allPages.join('\n'), seStyle, 'A4', 'portrait');
            document.getElementById('exportStatus').innerHTML =
                '<div class="alert alert-success">âœ… å°åˆ·ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒé–‹ãã¾ã™ã€‚é€ä¿¡å…ˆã§ <strong>ã€ŒPDFã«ä¿å­˜ã€</strong> ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚<br><span style="font-size:0.85em;color:#555;">ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ <code>SE' + year + mon.padStart(2,'0') + '_å¸³ç¥¨.pdf</code> ã«ã™ã‚‹ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚</span></div>';
        }

        // â”€â”€ åŸºæœ¬ã‚µãƒ¼ãƒ“ã‚¹åã®çµ„ã¿ç«‹ã¦
        function buildBaseName(supportLevel, building) {
            const code = getSupportLevelCode(supportLevel);
            const numMap = {'21':'ï¼‘','22':'ï¼’','23':'ï¼“','24':'ï¼”','25':'ï¼•','26':'ï¼–'};
            const n = numMap[code]||'';
            const large = building ? getLargeScaleRate(building.largeScaleReduction) : 1.0;
            const largeSuffix = large < 0.90 ? 'ãƒ»å¤§ï¼’' : (large < 1.0 ? 'ãƒ»å¤§ï¼‘' : '');
            return 'ç”Ÿæ´»æ´åŠ©â… ' + n + largeSuffix;
        }

        // â”€â”€ åŸºæœ¬ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ¼ãƒ‰ã®çµ„ã¿ç«‹ã¦ï¼ˆå¤§è¦æ¨¡æ¸›ç®—ã‚’åæ˜ ï¼‰
        function buildBaseCode(supportLevel, building) {
            const code = getSupportLevelCode(supportLevel);
            // ä»‹è­·åŒ…æ‹¬å‹â… åŸºæœ¬ã‚³ãƒ¼ãƒ‰ã¯æ”¯æ´åŒºåˆ†ãƒ»å¤§è¦æ¨¡æ¸›ç®—ã§å¤‰ã‚ã‚‹
            // å¼•ç¶™ããƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚ˆã‚Š: 135001ç³» + å¤§è¦æ¨¡æ¸›ç®—ã‚ã‚Š â†’ åˆ¥ã‚³ãƒ¼ãƒ‰
            // ã‚µãƒ³ãƒ—ãƒ«PDFã‚’å‚ç…§: ç”Ÿæ´»æ´åŠ©â… ï¼”ãƒ»å¤§ï¼‘ = 331443
            const baseMap = {
                '26':'331401','25':'331421','24':'331441','23':'331451','22':'331461','21':'331471','99':'331471'
            };
            let base = baseMap[code]||'331461';
            if (building) {
                const lr = getLargeScaleRate(building.largeScaleReduction);
                if (lr < 0.90) base = base.replace(/1$/, '3').replace(/41$/, '43').replace(/51$/, '53').replace(/61$/, '63');
                else if (lr < 1.0) base = base.replace(/1$/, '3').replace(/41$/, '43').replace(/51$/, '53').replace(/61$/, '63').replace(/43$/,'43').replace(/63$/,'63');
            }
            return base;
        }

        // â”€â”€ äººå“¡é…ç½®ä½“åˆ¶åŠ ç®—è¡¨ç¤ºå
        function buildJinzaiName(staffRatio) {
            if (!staffRatio) return '';
            const r = staffRatio.replace('ï¼š',':').trim();
            if (r.startsWith('4')) return 'â… ï¼”';
            if (r.startsWith('5')) return 'â… ï¼“'; // 5:1ã¯â… ï¼“
            return '';
        }

        function exportExcel(type) {
            const month = document.getElementById('exportMonth').value;
            if (!month) { alert('å¯¾è±¡å¹´æœˆã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
            document.getElementById('exportStatus').innerHTML =
                '<div class="alert alert-info">â„¹ï¸ ' + type + ' ã®Excelå‡ºåŠ›æ©Ÿèƒ½ã¯ç¾åœ¨æº–å‚™ä¸­ã§ã™ã€‚</div>';
        }

        // =========================================================
        // SEãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆï¼ˆä»‹è­·çµ¦ä»˜è²»ç­‰è«‹æ±‚æ›¸ãƒ»æ˜ç´°æ›¸ï¼‰
        // ä»¤å’Œ6å¹´4æœˆæ–½è¡Œ å…±åŒç”Ÿæ´»æ´åŠ©ï¼ˆä»‹è­·ã‚µãƒ¼ãƒ“ã‚¹åŒ…æ‹¬å‹ï¼‰
        // ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ä»•æ§˜æ›¸ J111 æº–æ‹ 
        // =========================================================

        // â”€â”€ åœ°åŸŸå˜ä¾¡ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆä»¤å’Œ7å¹´åº¦ä»¥é™ã€å…±åŒç”Ÿæ´»æ´åŠ©ï¼‰
        // å‡ºå…¸ï¼šæ±äº¬éƒ½å›½ä¿é€£ åœ°åŸŸåŒºåˆ†ã¨1å˜ä½å˜ä¾¡PDF
        const GH_TANKA = {
            '01': 10.18, // ä¸€ç´šåœ° 23åŒºãƒ»ç”ºç”°ãƒ»ç‹›æ±Ÿãƒ»å¤šæ‘©ãƒ»èª¿å¸ƒãªã©
            '02': 10.14, // äºŒç´šåœ° ç«‹å·ãƒ»æ˜­å³¶ãƒ»å…«ç‹å­ãƒ»æ­¦è”µé‡ãƒ»ä¸‰é·¹ç­‰
            '03': 10.14,
            '04': 10.00,
            '05': 10.00,
            '06': 10.00,
            '07': 10.00,
            '20': 10.00,
        };

        // â”€â”€ åŸºæœ¬å˜ä½æ•°ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆä»¤å’Œ6å¹´4æœˆ ä»‹è­·ã‚µãƒ¼ãƒ“ã‚¹åŒ…æ‹¬å‹â…  ä¸–è©±äºº6:1ï¼‰
        const BASE_UNITS = {
            '26': 600, // åŒºåˆ†6
            '25': 456, // åŒºåˆ†5
            '24': 372, // åŒºåˆ†4
            '23': 297, // åŒºåˆ†3
            '22': 188, // åŒºåˆ†2
            '21': 171, // åŒºåˆ†1
            '99': 171, // ãªã—
        };

        // â”€â”€ å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ï¼ˆâ… ï¼‰å˜ä½æ•°ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ1ä½å±…ã‚ãŸã‚Šãƒ»åˆ©ç”¨è€…äººæ•°åˆ¥ï¼‰
        const NIGHT1_UNITS = {
            '2äººä»¥ä¸‹':111,'3äºº':81,'4äºº':64,'5äºº':53,'6äºº':46,
            '7äºº':40,'8äºº':36,'9äºº':32,'10äºº':29,
            '11äºº':26,'12äºº':26,'13äºº':23,'14äºº':23,'15äºº':23,
            '16äºº':18,'17äºº':18,'18äºº':18,'19äºº':18,'20äºº':18,
        };

        // â”€â”€ å¤§è¦æ¨¡ä½å±…ç­‰æ¸›ç®—ç‡
        function getLargeScaleRate(largeScaleReduction) {
            if (!largeScaleReduction) return 1.0;
            if (largeScaleReduction.includes('21äººä»¥ä¸Š') || largeScaleReduction.includes('å¤§ï¼’')) return 0.85;
            if (largeScaleReduction.includes('8äººä»¥ä¸Š') || largeScaleReduction.includes('å¤§ï¼‘')) return 0.90;
            return 1.0;
        }

        // â”€â”€ éšœå®³ç¨‹åº¦åŒºåˆ†ã‚³ãƒ¼ãƒ‰å¤‰æ›
        function getSupportLevelCode(level) {
            const map = {
                'åŒºåˆ†1':'21','åŒºåˆ†2':'22','åŒºåˆ†3':'23','åŒºåˆ†4':'24','åŒºåˆ†5':'25','åŒºåˆ†6':'26',
                'åŒºåˆ†ï¼‘':'21','åŒºåˆ†ï¼’':'22','åŒºåˆ†ï¼“':'23','åŒºåˆ†ï¼”':'24','åŒºåˆ†ï¼•':'25','åŒºåˆ†ï¼–':'26',
                'ãªã—':'99',''  :'99'
            };
            return map[level] || '99';
        }

        // â”€â”€ æ‰€å¾—åŒºåˆ†ã‚³ãƒ¼ãƒ‰å¤‰æ›ï¼ˆcertBurdenLimit ã‹ã‚‰ï¼‰
        function getIncomeClassCode(burdenLimit) {
            const v = parseInt(burdenLimit) || 0;
            if (v === 0) return '01';      // ç”Ÿæ´»ä¿è­·ï¼ˆ0å††ï¼‰
            if (v <= 9300) return '02';    // ä½æ‰€å¾—1
            if (v <= 18600) return '03';   // ä½æ‰€å¾—2
            if (v <= 37200) return '04';   // ä¸€èˆ¬1
            return '05';                    // ä¸€èˆ¬2
        }

        // â”€â”€ çµ¦ä»˜ç‡ï¼ˆæ‰€å¾—åŒºåˆ†ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ï¼‰
        function getGrantRate(incomeCode) {
            return (incomeCode === '01' || incomeCode === '02' || incomeCode === '03') ? 100 : 90;
        }

        // â”€â”€ å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ¼ãƒ‰
        function getNightSupportServiceCode(type) {
            if (!type) return null;
            if (type === 'â…¡' || type.includes('â…¡')) return '125002';
            if (type === 'â…¢' || type.includes('â…¢')) return '125003';
            return '125001';
        }

        // â”€â”€ å®Ÿåˆ©ç”¨æ—¥æ•°ï¼ˆæœ¬å…¥å±…ã®æ—¥æ•°ï¼‰
        function countServiceDays(monthRecords) {
            return Object.values(monthRecords).filter(r =>
                r.status === 'â—‹ï¼ˆæœ¬å…¥å±…ï¼‰' || r.status === 'â—‹'
            ).length;
        }

        // â”€â”€ å˜ä½æ•°è¨ˆç®—
        function calcUnits(user, building, cert, monthRecords) {
            const supportCode = getSupportLevelCode(cert.certSupportLevel || '');
            const baseUnitPerDay = BASE_UNITS[supportCode] || 171;
            const serviceDays = countServiceDays(monthRecords);
            const largeScaleRate = getLargeScaleRate(building ? building.largeScaleReduction : '');
            const baseTotal = Math.floor(baseUnitPerDay * serviceDays * largeScaleRate);

            // å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—â… 
            let nightAddition = 0;
            const ns1 = facility.nightSupportType1 || (building && building.nightSupportType) || '';
            if (ns1 && NIGHT1_UNITS[ns1] !== undefined) {
                nightAddition = NIGHT1_UNITS[ns1] * serviceDays;
            }

            // é‡åº¦éšœå®³è€…æ”¯æ´åŠ ç®—
            let severeAddition = 0;
            if (user.calcSevereDisability) {
                const sevMap = { 'â…¡(åŠ é…å‰)':180, 'â…¡(åŠ é…å¾Œ)':360, 'â…¡(åˆè¨ˆ)':540 };
                severeAddition = (sevMap[user.calcSevereDisability] || 0) * serviceDays;
            }

            // åŒ»ç™‚çš„ã‚±ã‚¢å¯¾å¿œæ”¯æ´åŠ ç®—
            const medicalAddition = user.calcMedicalCare ? (39 * serviceDays) : 0;

            return {
                baseUnitPerDay, serviceDays, baseTotal,
                nightAddition, severeAddition, medicalAddition,
                totalUnits: baseTotal + nightAddition + severeAddition + medicalAddition,
                nightCode: ns1 ? getNightSupportServiceCode(ns1) : null,
                largeScaleRate
            };
        }

        // â”€â”€ é‡‘é¡è¨ˆç®—
        function calcAmount(totalUnits, areaCode, incomeCode, burdenLimit) {
            const tanka = GH_TANKA[areaCode] || 10.00;
            const totalCost = Math.floor(totalUnits * tanka);
            const grantRate = getGrantRate(incomeCode);
            const grantFee = Math.floor(totalCost * grantRate / 100);
            const burdenLimitVal = parseInt(burdenLimit) || 0;
            const rawBurden = totalCost - grantFee;
            const userBurden = burdenLimitVal > 0 ? Math.min(rawBurden, burdenLimitVal) : rawBurden;
            const actualGrant = totalCost - userBurden;
            return { totalCost, grantFee: actualGrant, userBurden, tanka, grantRate };
        }

        function generateSE(year, month, targetUsers) {
            const serviceYM = year + month.padStart(2,'0');
            const nextDate = new Date(parseInt(year), parseInt(month), 1);
            const processYM = nextDate.getFullYear() + String(nextDate.getMonth()+1).padStart(2,'0');

            let dataLines = [];
            let totalLines = 0;

            targetUsers.forEach(user => {
                const monthRecords = getMonthRecords(user.id, year, month);
                if (Object.keys(monthRecords).length === 0) return;

                const ym = year + '-' + month.padStart(2,'0');
                const cert = (user.certificates || [])
                    .filter(c => {
                        const from = (c.certValidFrom || '0000-00').substring(0,7);
                        const to   = (c.certValidTo   || '9999-12').substring(0,7);
                        return from <= ym && ym <= to;
                    })
                    .sort((a,b) => (b.certValidFrom||'').localeCompare(a.certValidFrom||''))[0]
                    || (user.certificates||[])[0] || {};

                const cityCode   = cert.certCityCode || '';
                const certNo     = cert.certNo || '';
                const incomeCode = getIncomeClassCode(cert.certBurdenLimit);
                const burdenLimit = cert.certBurdenLimit || '0';
                const building   = (facility.buildings||[]).find(b => (b.users||[]).includes(user.id)) || null;

                const uc = calcUnits(user, building, cert, monthRecords);
                const am = calcAmount(uc.totalUnits, facility.areaCode||'01', incomeCode, burdenLimit);

                const hasUpperMgmt    = cert.certUpperMgmtOrgNo ? '1' : '0';
                const upperMgmtResult = hasUpperMgmt === '1' ? '3' : '0';
                const upperMgmtAmount = hasUpperMgmt === '1' ? String(am.userBurden) : '0';

                // J111 01 åŸºæœ¬æƒ…å ±ãƒ¬ã‚³ãƒ¼ãƒ‰
                dataLines.push([
                    'J111','01', serviceYM,
                    cityCode, facility.facilityNumber||'',
                    '13',                               // ã‚µãƒ¼ãƒ“ã‚¹ç¨®é¡ã‚³ãƒ¼ãƒ‰
                    getSupportLevelCode(cert.certSupportLevel||''), // éšœå®³ç¨‹åº¦åŒºåˆ†
                    incomeCode,                         // æ‰€å¾—åŒºåˆ†ã‚³ãƒ¼ãƒ‰
                    String(am.grantRate),               // çµ¦ä»˜ç‡
                    String(parseInt(burdenLimit)||0),   // æ±ºå®šåˆ©ç”¨è€…è² æ‹…æœˆé¡
                    cert.certUpperMgmtOrgNo||'0',       // ä¸Šé™é¡ç®¡ç†äº‹æ¥­æ‰€ç•ªå·
                    upperMgmtResult,                    // ç®¡ç†çµæœ
                    upperMgmtAmount,                    // ç®¡ç†çµæœé¡
                    String(uc.totalUnits),              // çµ¦ä»˜å˜ä½æ•°ï¼ˆåˆè¨ˆï¼‰
                    String(am.totalCost),               // ç·è²»ç”¨é¡
                    String(am.grantFee),                // çµ¦ä»˜è²»è«‹æ±‚é¡
                    String(am.userBurden),              // æ±ºå®šåˆ©ç”¨è€…è² æ‹…é¡
                    '0','0','0','0',                    // ç‰¹ä¾‹ãƒ»é«˜é¡ãƒ»è‡ªæ²»ä½“åŠ©æˆ
                ]);
                totalLines++;

                // J111 02 æ˜ç´°æƒ…å ±ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆåŸºæœ¬ã‚µãƒ¼ãƒ“ã‚¹ï¼‰
                dataLines.push([
                    'J111','02', serviceYM,
                    cityCode, facility.facilityNumber||'', certNo,
                    '135001',                           // ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ¼ãƒ‰ï¼ˆä»‹è­·åŒ…æ‹¬å‹â… åŸºæœ¬ï¼‰
                    String(uc.baseUnitPerDay),
                    String(uc.serviceDays),
                    String(uc.baseTotal),
                    uc.largeScaleRate < 1.0 ? String(Math.floor((1.0 - uc.largeScaleRate)*100)) : '0',
                ]);
                totalLines++;

                // å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®— æ˜ç´°
                if (uc.nightCode && uc.nightAddition > 0) {
                    const unitPerDay = Math.floor(uc.nightAddition / Math.max(uc.serviceDays,1));
                    dataLines.push([
                        'J111','02', serviceYM,
                        cityCode, facility.facilityNumber||'', certNo,
                        uc.nightCode, String(unitPerDay), String(uc.serviceDays), String(uc.nightAddition), '0',
                    ]);
                    totalLines++;
                }

                // é‡åº¦éšœå®³è€…æ”¯æ´åŠ ç®— æ˜ç´°
                if (uc.severeAddition > 0) {
                    const sevCode = (user.calcSevereDisability||'').includes('â…¡') ? '125301' : '125201';
                    dataLines.push([
                        'J111','02', serviceYM,
                        cityCode, facility.facilityNumber||'', certNo,
                        sevCode, String(Math.floor(uc.severeAddition/Math.max(uc.serviceDays,1))),
                        String(uc.serviceDays), String(uc.severeAddition), '0',
                    ]);
                    totalLines++;
                }

                // åŒ»ç™‚çš„ã‚±ã‚¢å¯¾å¿œæ”¯æ´åŠ ç®— æ˜ç´°
                if (uc.medicalAddition > 0) {
                    dataLines.push([
                        'J111','02', serviceYM,
                        cityCode, facility.facilityNumber||'', certNo,
                        '125401', '39', String(uc.serviceDays), String(uc.medicalAddition), '0',
                    ]);
                    totalLines++;
                }
            });

            if (dataLines.length === 0) {
                alert('å‡ºåŠ›å¯¾è±¡ã¨ãªã‚‹å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            const ctrl = ['1','1','0', String(totalLines), 'J11','0',
                facility.facilityNumber||'','0','1', processYM,'0'];
            let csv = ctrl.map(v => '"' + v + '"').join(',') + '\n';
            let lineNum = 2;
            dataLines.forEach(fields => {
                csv += '"2","' + lineNum + '",' + fields.map(v => '"' + String(v||'') + '"').join(',') + '\n';
                lineNum++;
            });
            csv += '"3","' + lineNum + '"\n';

            const filename = 'SE' + year + month.padStart(2,'0') + '.csv';

            // ã‚·ãƒ•ãƒˆJISã§å‡ºåŠ›ï¼ˆå›½ä¿é€£ä»•æ§˜ï¼‰
            try {
                // UTF-8 BOMã§å‡ºåŠ›ï¼ˆç°¡æ˜“ç‰ˆï¼‰
                downloadCSV(csv, filename);
            } catch(e) {
                downloadCSV(csv, filename);
            }

            // è¨ˆç®—ã‚µãƒãƒªãƒ¼è¡¨ç¤º
            let summary = '<div class="alert alert-success">âœ… ' + filename + ' ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ</div>';
            summary += '<table style="width:100%;margin-top:8px;font-size:0.82em;border-collapse:collapse;">';
            summary += '<tr style="background:#f0f0f0;"><th style="padding:4px 6px;text-align:left;border:1px solid #ddd;">åˆ©ç”¨è€…</th><th style="border:1px solid #ddd;padding:4px;">åˆ©ç”¨æ—¥æ•°</th><th style="border:1px solid #ddd;padding:4px;">åˆè¨ˆå˜ä½</th><th style="border:1px solid #ddd;padding:4px;">å˜ä¾¡</th><th style="border:1px solid #ddd;padding:4px;">ç·è²»ç”¨</th><th style="border:1px solid #ddd;padding:4px;">çµ¦ä»˜è²»</th><th style="border:1px solid #ddd;padding:4px;">åˆ©ç”¨è€…è² æ‹…</th></tr>';
            targetUsers.forEach(user => {
                const monthRecords = getMonthRecords(user.id, year, month);
                if (Object.keys(monthRecords).length === 0) return;
                const ym = year + '-' + month.padStart(2,'0');
                const cert = (user.certificates||[])
                    .filter(c => { const f=(c.certValidFrom||'0000-00').substring(0,7); const t=(c.certValidTo||'9999-12').substring(0,7); return f<=ym && ym<=t; })
                    .sort((a,b)=>(b.certValidFrom||'').localeCompare(a.certValidFrom||''))[0]
                    || (user.certificates||[])[0] || {};
                const building = (facility.buildings||[]).find(b=>(b.users||[]).includes(user.id))||null;
                const uc = calcUnits(user, building, cert, monthRecords);
                const am = calcAmount(uc.totalUnits, facility.areaCode||'01', getIncomeClassCode(cert.certBurdenLimit), cert.certBurdenLimit);
                summary += '<tr><td style="border:1px solid #ddd;padding:4px 6px;">' + user.name + '</td>' +
                    '<td style="border:1px solid #ddd;padding:4px;text-align:right;">' + uc.serviceDays + 'æ—¥</td>' +
                    '<td style="border:1px solid #ddd;padding:4px;text-align:right;">' + uc.totalUnits + '</td>' +
                    '<td style="border:1px solid #ddd;padding:4px;text-align:right;">' + am.tanka + 'å††</td>' +
                    '<td style="border:1px solid #ddd;padding:4px;text-align:right;">' + am.totalCost.toLocaleString() + 'å††</td>' +
                    '<td style="border:1px solid #ddd;padding:4px;text-align:right;">' + am.grantFee.toLocaleString() + 'å††</td>' +
                    '<td style="border:1px solid #ddd;padding:4px;text-align:right;">' + am.userBurden.toLocaleString() + 'å††</td></tr>';
            });
            summary += '</table>';
            document.getElementById('exportStatus').innerHTML = summary;
        }

        // â”€â”€ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰å¤‰æ›ï¼ˆJ611 02ãƒ¬ã‚³ãƒ¼ãƒ‰ç”¨ï¼‰
        // [38]ï¼šã‚µãƒ¼ãƒ“ã‚¹æä¾›ã®çŠ¶æ³ï¼ˆ1=æœ¬å…¥å±…ã€3=æœ¬å…¥å±…+å¤œé–“æ”¯æ´â…¢ç­‰ï¼‰
        // [37]ï¼šä½å±…å¤–åˆ©ç”¨æ™‚åŠ ç®—ï¼ˆå¤–æ³Šç¿Œæ—¥ã®å¤œé–“=3ã€å…¥é™¢=2ç­‰ï¼‰
        function getSvStatusCodes(record, hasNight1, hasNight3) {
            if (!record) return { f37: '', f38: '' };
            const s = record.status || '';
            if (s === 'å…¥é™¢') return { f37: '2', f38: '' };
            if (s === 'å¤–æ³Š') return { f37: hasNight3 ? '3' : '', f38: '' };
            // æœ¬å…¥å±… or â—‹
            const isPresent = s === 'â—‹ï¼ˆæœ¬å…¥å±…ï¼‰' || s === 'â—‹' || s === 'æœ¬å…¥å±…';
            if (!isPresent) return { f37: '', f38: '' };
            // å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—â… ï¼ˆns1ï¼‰ãŒã‚ã‚Œã°1ã€â…¢ãŒã‚ã‚Œã°3
            // ã‚µãƒ³ãƒ—ãƒ«CSVã§ã¯é€šå¸¸æ—¥ã«[38]=3ï¼ˆå¤œé–“â…¢ï¼‰ã¾ãŸã¯1ï¼ˆå¤œé–“â… ï¼‰
            let f38 = '1';
            if (hasNight3) f38 = '3';
            return { f37: '', f38: f38 };
        }

        function generateSV(year, month, targetUsers) {
            const serviceYm = year + month.padStart(2,'0');
            const nextDate = new Date(parseInt(year), parseInt(month), 1);
            const processYM = nextDate.getFullYear() + String(nextDate.getMonth()+1).padStart(2,'0');
            let dataLines = [];
            let totalCount = 0;
            const hasNight1 = !!(facility.nightSupportType1);
            const hasNight3 = !!(facility.nightSupportType3);

            targetUsers.forEach(user => {
                const monthRecords = getMonthRecords(user.id, year, month);
                if (Object.keys(monthRecords).length === 0) return;
                const ym = year + '-' + month.padStart(2,'0');
                const cert = ((user.certificates||[])
                    .filter(c => {
                        const from = (c.certValidFrom||'0000-00-00').replace(/-/g,'').substring(0,6);
                        const to   = (c.certValidTo  ||'9999-12-31').replace(/-/g,'').substring(0,6);
                        return from <= serviceYm && serviceYm <= to;
                    })
                    .sort((a,b)=>(b.certValidFrom||'').localeCompare(a.certValidFrom||'')))[0]
                    || (user.certificates||[])[0] || {};
                const certNo   = cert.certNo || '';
                const cityCode = cert.certCityCode || '';
                const daysInMonth = new Date(parseInt(year), parseInt(month), 0).getDate();
                // åˆ©ç”¨æ—¥æ•°é›†è¨ˆ
                const serviceDays = Object.values(monthRecords).filter(r => r.status === 'â—‹ï¼ˆæœ¬å…¥å±…ï¼‰' || r.status === 'â—‹').length;
                const hospitalDays = Object.values(monthRecords).filter(r => r.status === 'å…¥é™¢').length;
                const externalDays = Object.values(monthRecords).filter(r => r.status === 'å¤–æ³Š').length;

                // J611 01ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆãƒ˜ãƒƒãƒ€ï¼‰- 174ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
                const r01 = ['J611','01',serviceYm,cityCode,facility.facilityNumber||'',certNo,'1801'];
                // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰[9]ã€œ[38]ã¯ç©º, [39]=åˆè¨ˆ, [40]=å…¥é™¢, [41]=å¤–æ³Š
                const pad01 = Array(30).fill('');
                const tail01 = Array(174 - 9 - 30 - 3).fill('');
                dataLines.push(['J611','01',serviceYm,cityCode,facility.facilityNumber||'',certNo,'1801',
                    ...Array(30).fill(''),
                    String(serviceDays), String(hospitalDays), String(externalDays),
                    ...Array(131).fill('')
                ]);
                totalCount++;

                // J611 02ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆæ—¥åˆ¥ï¼‰- 115ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = year + '-' + month.padStart(2,'0') + '-' + String(day).padStart(2,'0');
                    const record = monthRecords[dateStr];
                    const { f37, f38 } = getSvStatusCodes(record, hasNight1, hasNight3);
                    const r02base = ['J611','02',serviceYm,cityCode,facility.facilityNumber||'',certNo,'1801','',String(day)];
                    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰[11]ã€œ[36]=ç©º, [37]=ä½å±…å¤–, [38]=é€šå¸¸å¤œé–“, [39]ã€œ=ç©º
                    const row02 = ['J611','02',serviceYm,cityCode,facility.facilityNumber||'',certNo,'1801','',String(day),
                        ...Array(27).fill(''),
                        f37, f38,
                        ...Array(115 - 9 - 27 - 2).fill('')
                    ];
                    dataLines.push(row02);
                    totalCount++;
                }
            });

            if (dataLines.length === 0) { alert('å‡ºåŠ›å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }

            // åˆ¶å¾¡ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆtotalCountã‚’æ­£ç¢ºã«è¨­å®šï¼‰
            const ctrl = ['1','0', String(totalCount), 'J61','0', facility.facilityNumber||'','0','1', processYM,'0'];
            let csv = '"1","1",' + ctrl.map(v=>'"'+v+'"').join(',') + '\n';
            let lineNum = 2;
            dataLines.forEach(fields => {
                csv += '"2","' + lineNum + '",' + fields.map(v=>'"'+(v||'')+'"').join(',') + '\n';
                lineNum++;
            });
            csv += '"3","' + lineNum + '"\n';

            const filename = 'SV' + year + month.padStart(2,'0') + '.csv';
            downloadCSV(csv, filename);

            // è¨ˆç®—ã‚µãƒãƒªãƒ¼è¡¨ç¤º
            let summary = '<div class="alert alert-success">âœ… ' + filename + ' ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ</div>';
            document.getElementById('exportStatus').innerHTML = summary;
        }

        // =========================================================
        // SVå¸³ç¥¨PDFç”Ÿæˆï¼ˆå…±åŒç”Ÿæ´»æ´åŠ©ã‚µãƒ¼ãƒ“ã‚¹æä¾›å®Ÿç¸¾è¨˜éŒ²ç¥¨ æ§˜å¼18-1ï¼‰
        // =========================================================
        function generateSVPDF(year, mon, targetUsers) {
            const serviceYm = year + mon.padStart(2,'0');
            const reiwa = parseInt(year) - 2018;
            const m = parseInt(mon);
            const ymDisp = `ä»¤å’Œ${String(reiwa).padStart(2,'0')}å¹´${String(m).padStart(2,'0')}æœˆ`;
            const facNo = (facility.facilityNumber||'').padStart(10,'0');
            const daysInMonth = new Date(parseInt(year), parseInt(mon), 0).getDate();
            const weekDayJp = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];

            const hasNight3 = !!(facility.nightSupportType3);

            let allPages = [];
            targetUsers.forEach(user => {
                const monthRecords = getMonthRecords(user.id, year, mon);
                if (Object.keys(monthRecords).length === 0) return;

                const cert = ((user.certificates||[])
                    .filter(c => {
                        const from = (c.certValidFrom||'0000-00-00').replace(/-/g,'').substring(0,6);
                        const to   = (c.certValidTo  ||'9999-12-31').replace(/-/g,'').substring(0,6);
                        return from <= serviceYm && serviceYm <= to;
                    })
                    .sort((a,b)=>(b.certValidFrom||'').localeCompare(a.certValidFrom||'')))[0]
                    || (user.certificates||[])[0] || {};
                const certNo = cert.certNo || '';
                const certNoDisp = certNo.padStart(10,'0');

                const serviceDays = Object.values(monthRecords).filter(r => r.status === 'â—‹ï¼ˆæœ¬å…¥å±…ï¼‰' || r.status === 'â—‹').length;
                const hospitalDays = Object.values(monthRecords).filter(r => r.status === 'å…¥é™¢').length;
                const externalDays = Object.values(monthRecords).filter(r => r.status === 'å¤–æ³Š').length;

                // æ—¥åˆ¥è¡Œã®ç”Ÿæˆ
                let dayRows = '';
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = year + '-' + mon.padStart(2,'0') + '-' + String(day).padStart(2,'0');
                    const record = monthRecords[dateStr];
                    const dow = new Date(parseInt(year), parseInt(mon)-1, day).getDay();
                    const dowStr = weekDayJp[dow];
                    const isSun = dow === 0;
                    const isSat = dow === 6;
                    const dayStyle = isSun ? 'color:red;' : (isSat ? 'color:blue;' : '');

                    const status = record ? record.status : '';
                    let serviceDisp = '';
                    let nightDisp = '';
                    if (status === 'å…¥é™¢') { serviceDisp = '<span style="font-size:7pt;">å…¥é™¢</span>'; }
                    else if (status === 'å¤–æ³Š') { serviceDisp = '<span style="font-size:7pt;">å¤–æ³Š</span>'; }
                    else if (status === 'â—‹ï¼ˆæœ¬å…¥å±…ï¼‰' || status === 'â—‹') {
                        // å¤œé–“æ”¯æ´ç­‰ä½“åˆ¶åŠ ç®—ã®è¡¨ç¤º
                        const { f37, f38 } = getSvStatusCodes(record, !!(facility.nightSupportType1), hasNight3);
                        nightDisp = f38 || f37 || '';
                    }

                    dayRows += `<tr style="height:5.8mm;">
                        <td class="sv-day" style="${dayStyle}">${day}</td>
                        <td class="sv-dow" style="${dayStyle}">${dowStr}</td>
                        <td class="sv-cell">${serviceDisp}</td>
                        <td class="sv-cell"></td>
                        <td class="sv-cell"></td>
                        <td class="sv-night">${nightDisp}</td>
                        <td class="sv-cell"></td>
                        <td class="sv-cell"></td>
                        <td class="sv-cell"></td>
                        <td class="sv-cell"></td>
                        <td class="sv-cell"></td>
                        <td class="sv-cell"></td>
                        <td class="sv-cell"></td>
                        <td class="sv-cell"></td>
                        <td class="sv-sign"></td>
                        <td class="sv-biko"></td>
                    </tr>`;
                }

                // é›†è¨ˆè¡Œ
                const totalRow = `<tr style="background:#f8f8f8;font-size:7pt;">
                    <td colspan="3" class="center" style="font-size:6.5pt;">åˆã€€è¨ˆ</td>
                    <td class="center">${serviceDays}æ—¥</td>
                    <td></td>
                    <td class="center">${Object.values(monthRecords).filter(r=>r.status==='â—‹ï¼ˆæœ¬å…¥å±…ï¼‰'||r.status==='â—‹').length}å›</td>
                    <td class="center">0å›</td>
                    <td class="center">0å›</td>
                    <td class="center">0å›</td>
                    <td class="center">0å›</td>
                    <td class="center">0å›</td>
                    <td class="center">0å›</td>
                    <td class="center">0å›</td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>`;

                const page = `<div class="sv-page">
  <div style="position:absolute;top:3mm;right:4mm;font-size:7pt;">ï¼ˆæ§˜å¼18-1ï¼‰</div>
  <div style="margin-bottom:2mm;">
    <span style="font-size:10pt;font-weight:bold;">${ymDisp}åˆ†ã€€ã€€å…±åŒç”Ÿæ´»æ´åŠ©ã‚µãƒ¼ãƒ“ã‚¹æä¾›å®Ÿç¸¾è¨˜éŒ²ç¥¨</span>
  </div>
  <table class="sv-tbl" style="margin-bottom:2mm;">
    <tr>
      <td class="sv-lbl" style="width:14mm;font-size:6pt;" rowspan="2">å—çµ¦è€…è¨¼<br>ç•ªã€€ã€€å·</td>
      ${certNoDisp.split('').map(c=>`<td class="sv-nc">${c}</td>`).join('')}
      <td class="sv-lbl" style="width:16mm;">æ”¯çµ¦æ±ºå®šéšœå®³è€…æ°å</td>
      <td colspan="6" style="padding:1px 4px;font-size:9pt;font-weight:bold;">${user.name||''}</td>
      <td class="sv-lbl" style="width:14mm;">äº‹æ¥­æ‰€ç•ªå·</td>
      ${facNo.split('').map(c=>`<td class="sv-nc">${c}</td>`).join('')}
    </tr>
    <tr>
      <td colspan="10"></td>
      <td class="sv-lbl" style="font-size:6pt;">äº‹æ¥­è€…åŠã³<br>ãã®äº‹æ¥­æ‰€</td>
      <td colspan="10" style="padding:1px 4px;">${facility.facilityName||''}</td>
    </tr>
  </table>
  <table class="sv-tbl" style="width:100%;table-layout:fixed;">
    <colgroup>
      <col style="width:7mm;"><col style="width:6mm;">
      <col style="width:14mm;"><col style="width:9mm;"><col style="width:9mm;">
      <col style="width:9mm;">
      <col style="width:11mm;"><col style="width:11mm;"><col style="width:11mm;"><col style="width:11mm;">
      <col style="width:11mm;"><col style="width:11mm;"><col style="width:11mm;">
      <col style="width:11mm;">
      <col style="width:12mm;"><col style="width:auto;">
    </colgroup>
    <thead>
      <tr style="font-size:5.5pt;background:#f0f0f0;">
        <td rowspan="2" class="center sv-lbl">æ—¥ä»˜</td>
        <td rowspan="2" class="center sv-lbl">æ›œæ—¥</td>
        <td colspan="12" class="center sv-lbl" style="border-bottom:1px solid #000;">æ”¯æ´å®Ÿç¸¾</td>
        <td rowspan="2" class="center sv-lbl">åˆ©ç”¨è€…<br>ç¢ºèªæ¬„</td>
        <td rowspan="2" class="center sv-lbl">å‚™è€ƒ</td>
      </tr>
      <tr style="font-size:5pt;background:#f0f0f0;">
        <td class="center sv-lbl">ã‚µãƒ¼ãƒ“ã‚¹<br>æä¾›<br>ã®çŠ¶æ³</td>
        <td class="center sv-lbl">ä½å±…å¤–<br>åˆ©ç”¨</td>
        <td class="center sv-lbl">é€€å±…å¾Œ<br>æ”¯æ´</td>
        <td class="center sv-lbl">å¤œé–“æ”¯<br>æ´ç­‰<br>ä½“åˆ¶åŠ ç®—</td>
        <td class="center sv-lbl">å…¥é™¢æ™‚<br>æ”¯æ´<br>ç‰¹åˆ¥åŠ ç®—</td>
        <td class="center sv-lbl">å¸°å®…æ™‚<br>æ”¯æ´<br>åŠ ç®—</td>
        <td class="center sv-lbl">æ—¥ä¸­<br>æ”¯æ´<br>åŠ ç®—</td>
        <td class="center sv-lbl">åŒ»ç™‚<br>é€£æº<br>ä½“åˆ¶åŠ ç®—</td>
        <td class="center sv-lbl">è‡ªç«‹ç”Ÿæ´»<br>æ”¯æ´åŠ ç®—<br>ï¼ˆIï¼‰</td>
        <td class="center sv-lbl">è‡ªç«‹ç”Ÿæ´»<br>æ”¯æ´åŠ ç®—<br>ï¼ˆIIï¼‰</td>
        <td class="center sv-lbl">é›†ä¸­çš„<br>æ”¯æ´<br>åŠ ç®—</td>
      </tr>
    </thead>
    <tbody>
      ${dayRows}
      ${totalRow}
    </tbody>
  </table>
  <table class="sv-tbl" style="margin-top:1mm;font-size:6pt;">
    <tr>
      <td class="sv-lbl" style="width:12mm;">é€€å±…æ—¥</td>
      <td style="width:22mm;"></td>
      <td class="sv-lbl" style="width:28mm;">è‡ªç«‹ç”Ÿæ´»æ”¯æ´åŠ ç®—(II)</td>
      <td style="width:20mm;"></td>
      <td class="sv-lbl" style="width:18mm;">é€€å±…å¾Œç®—å®šæ—¥</td>
      <td style="width:20mm;"></td>
    </tr>
    <tr>
      <td class="sv-lbl">ç§»è¡Œæ”¯æ´ä½å±…</td>
      <td></td>
      <td class="sv-lbl">å…¥å±…æ—¥</td>
      <td></td>
      <td class="sv-lbl">æ”¯æ´é–‹å§‹æ—¥</td>
      <td></td>
    </tr>
    <tr>
      <td class="sv-lbl">é›†ä¸­çš„æ”¯æ´åŠ ç®—</td>
      <td></td>
      <td colspan="4"></td>
    </tr>
  </table>
</div>`;
                allPages.push(page);
            });

            if (allPages.length === 0) { alert('å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹åˆ©ç”¨è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }

            const docHtml = `<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8">
<title>SVå¸³ç¥¨ ${year}å¹´${mon}æœˆåˆ†</title>
<style>
body { font-family: "MS Gothic","Meiryo",monospace; margin:0; background:white; font-size:8pt; }
.sv-page { width:297mm; min-height:210mm; background:white; box-sizing:border-box; padding:5mm 8mm; page-break-after:always; position:relative; }
.sv-tbl { border-collapse:collapse; width:100%; }
.sv-tbl td { border:1px solid #000; padding:1px 2px; vertical-align:middle; line-height:1.2; font-size:7pt; }
.sv-lbl { background:#f5f5f5; font-size:5.5pt; }
.sv-nc { text-align:center; width:4.5mm; font-size:7.5pt; }
.sv-day { text-align:center; font-size:8pt; font-weight:bold; width:7mm; }
.sv-dow { text-align:center; font-size:8pt; }
.sv-cell { text-align:center; font-size:7pt; }
.sv-night { text-align:center; font-size:8pt; font-weight:bold; }
.sv-sign { }
.sv-biko { }
.center { text-align:center; }
@page { size:A4 landscape; margin:0; }
</style></head><body>
${allPages.join('\n')}
</body></html>`;

            const svStyle = `
                body { font-family: "MS Gothic","Meiryo",monospace; margin:0; font-size:8pt; }
                .sv-page { width:297mm; min-height:210mm; background:white; box-sizing:border-box; padding:5mm 8mm; page-break-after:always; position:relative; }
                .sv-tbl { border-collapse:collapse; width:100%; }
                .sv-tbl td { border:1px solid #000; padding:1px 2px; vertical-align:middle; line-height:1.2; font-size:7pt; }
                .sv-lbl { background:#f5f5f5; font-size:5.5pt; }
                .sv-nc { text-align:center; width:4.5mm; font-size:7.5pt; }
                .sv-day { text-align:center; font-size:8pt; font-weight:bold; width:7mm; }
                .sv-dow { text-align:center; font-size:8pt; }
                .sv-cell { text-align:center; font-size:7pt; }
                .sv-night { text-align:center; font-size:8pt; font-weight:bold; }
                .sv-sign { } .sv-biko { } .center { text-align:center; }
            `;
            openPrintWindow(allPages.join('\n'), svStyle, 'A4', 'landscape');
            document.getElementById('exportStatus').innerHTML =
                '<div class="alert alert-success">âœ… å°åˆ·ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒé–‹ãã¾ã™ã€‚é€ä¿¡å…ˆã§ <strong>ã€ŒPDFã«ä¿å­˜ã€</strong> ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚<br><span style="font-size:0.85em;color:#555;">ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ <code>SV' + year + mon.padStart(2,'0') + '_å¸³ç¥¨.pdf</code> ã«ã™ã‚‹ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚</span></div>';
        }

        function countRecordsForMonth(userId, year, month) {
            if (!records[userId]) return 0;
            const prefix = year + '-' + month.padStart(2, '0');
            return Object.keys(records[userId]).filter(date => date.startsWith(prefix)).length;
        }

        function getMonthRecords(userId, year, month) {
            if (!records[userId]) return {};
            const prefix = year + '-' + month.padStart(2, '0');
            const monthRecords = {};
            Object.entries(records[userId]).forEach(([date, record]) => {
                if (date.startsWith(prefix)) monthRecords[date] = record;
            });
            return monthRecords;
        }

        function downloadCSV(content, filename) {
            const bom = '\uFEFF';
            const blob = new Blob([bom + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            document.getElementById('exportStatus').innerHTML =
                '<div class="alert alert-success">âœ… ' + filename + ' ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ</div>';
        }
    </script>
</body>
</html>
