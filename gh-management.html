<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ è«‹æ±‚ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v2</title>
    <!-- Tesseract.js: Coreãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆWorkerãªã—ï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 150px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            border: none;
            background: transparent;
            font-size: 16px;
        }

        .tab:hover {
            background: #e0e0e0;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f9f9f9;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #e6e6ff;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .user-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .user-card {
            border: 2px solid #ddd;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .user-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .user-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .user-card p {
            margin: 5px 0;
            color: #666;
        }

        .calendar {
            margin-top: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: #ddd;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-day {
            background: white;
            padding: 15px;
            min-height: 100px;
            position: relative;
        }

        .calendar-day.header {
            background: #667eea;
            color: white;
            font-weight: 600;
            text-align: center;
            padding: 10px;
            min-height: auto;
        }

        .calendar-day.disabled {
            background: #f5f5f5;
            color: #ccc;
        }

        .day-number {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .day-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 5px;
        }

        .status-ok {
            background: #d4edda;
            color: #155724;
        }

        .status-away {
            background: #fff3cd;
            color: #856404;
        }

        .status-hospital {
            background: #f8d7da;
            color: #721c24;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #667eea;
        }

        .status-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .status-option {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .status-option:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }

        .status-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .progress {
            margin: 20px 0;
            text-align: center;
            color: #667eea;
            font-weight: 600;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }

            .calendar-day {
                min-height: 80px;
                padding: 10px;
            }

            .status-options {
                grid-template-columns: 1fr;
            }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .section-header {
            font-size: 1.5em;
            font-weight: 600;
            color: #667eea;
            margin: 30px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .info-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .info-card h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .info-card p {
            margin: 8px 0;
            color: #495057;
        }

        .quick-action-btns {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ  ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ è«‹æ±‚ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v2</h1>
            <p>éšœå®³è€…å…±åŒç”Ÿæ´»æ´åŠ©ã‚µãƒ¼ãƒ“ã‚¹</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('facility')">ğŸ¢ äº‹æ¥­æ‰€æƒ…å ±</button>
            <button class="tab" onclick="showTab('users')">ğŸ‘¤ åˆ©ç”¨è€…ç®¡ç†</button>
            <button class="tab" onclick="showTab('records')">ğŸ“… å®Ÿç¸¾è¨˜éŒ²</button>
            <button class="tab" onclick="showTab('export')">ğŸ“¤ è«‹æ±‚ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›</button>
        </div>

        <div class="content">
            <!-- äº‹æ¥­æ‰€æƒ…å ±ã‚¿ãƒ– -->
            <div id="facility" class="tab-content active">
                <h2 class="section-header">äº‹æ¥­æ‰€ãƒ»å»ºç‰©åŸºæœ¬æƒ…å ±</h2>

                <form id="facilityForm">
                    <h3 style="color: #667eea; margin: 20px 0;">äº‹æ¥­æ‰€æƒ…å ±</h3>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label>äº‹æ¥­æ‰€ç•ªå· *</label>
                            <input type="text" id="facilityNumber" value="1321402032" required>
                        </div>
                        <div class="form-group">
                            <label>äº‹æ¥­æ‰€å *</label>
                            <input type="text" id="facilityName" value="Tokyo. settle" required>
                        </div>
                    </div>

                    <div class="grid-2">
                        <div class="form-group">
                            <label>æ³•äººå</label>
                            <input type="text" id="corporationName" value="åˆåŒä¼šç¤¾ã‚¨ãƒ´ã‚§ãƒ¬ã‚«ãƒ³ãƒ‘ãƒ‹ãƒ¼">
                        </div>
                        <div class="form-group">
                            <label>åœ°åŸŸåŒºåˆ†</label>
                            <select id="areaCode">
                                <option value="01">ä¸€ç´šåœ°</option>
                                <option value="02">äºŒç´šåœ°</option>
                                <option value="03">ä¸‰ç´šåœ°</option>
                                <option value="04">å››ç´šåœ°</option>
                                <option value="05">äº”ç´šåœ°</option>
                                <option value="06">å…­ç´šåœ°</option>
                                <option value="07">ä¸ƒç´šåœ°</option>
                                <option value="20">ãã®ä»–</option>
                            </select>
                        </div>
                    </div>

                    <h3 style="color: #667eea; margin: 30px 0 20px 0;">å»ºç‰©ï¼ˆãƒ¦ãƒ‹ãƒƒãƒˆï¼‰æƒ…å ±</h3>
                    
                    <div id="buildingList"></div>
                    
                    <button type="button" class="btn btn-info" onclick="addBuilding()">+ å»ºç‰©ã‚’è¿½åŠ </button>

                    <div style="margin-top: 30px;">
                        <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜</button>
                    </div>
                </form>

                <div id="facilityInfo" style="margin-top: 40px;"></div>
            </div>

            <!-- åˆ©ç”¨è€…ç®¡ç†ã‚¿ãƒ– -->
            <div id="users" class="tab-content">
                <h2 class="section-header">åˆ©ç”¨è€…ç™»éŒ²</h2>
                
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="certificateFile" accept="image/*,application/pdf" style="display: none;" onchange="handleFileUpload(event)">
                    <p style="font-size: 1.2em; margin-bottom: 10px;">ğŸ“· å—çµ¦è€…è¨¼ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p>
                    <p style="color: #666;">ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§PDFã¾ãŸã¯ç”»åƒã‚’é¸æŠ</p>
                    <p style="color: #999; font-size: 0.9em; margin-top: 10px;">ğŸ“„ PDFãƒ»PNGãƒ»JPEGã«å¯¾å¿œ</p>
                </div>

                <div id="ocrProgress" class="progress" style="display: none;"></div>

                <form id="userForm" style="margin-top: 30px;">
                    <div class="grid-2">
                        <div class="form-group">
                            <label>å—çµ¦è€…è¨¼ç•ªå· *</label>
                            <input type="text" id="certificateNumber" required>
                        </div>
                        <div class="form-group">
                            <label>æ°å *</label>
                            <input type="text" id="userName" required>
                        </div>
                    </div>

                    <div class="grid-2">
                        <div class="form-group">
                            <label>æ”¯çµ¦å¸‚ç”ºæ‘ç•ªå·</label>
                            <input type="text" id="cityCode" placeholder="131148">
                        </div>
                        <div class="form-group">
                            <label>éšœå®³æ”¯æ´åŒºåˆ†</label>
                            <select id="supportLevel">
                                <option value="">ãªã—</option>
                                <option value="21">åŒºåˆ†1</option>
                                <option value="22">åŒºåˆ†2</option>
                                <option value="23">åŒºåˆ†3</option>
                                <option value="24">åŒºåˆ†4</option>
                                <option value="25">åŒºåˆ†5</option>
                                <option value="26">åŒºåˆ†6</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid-2">
                        <div class="form-group">
                            <label>èªå®šæœ‰åŠ¹æœŸé–“ é–‹å§‹æ—¥</label>
                            <input type="date" id="validFrom">
                        </div>
                        <div class="form-group">
                            <label>èªå®šæœ‰åŠ¹æœŸé–“ çµ‚äº†æ—¥</label>
                            <input type="date" id="validTo">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>æ‰€å±ãƒ¦ãƒ‹ãƒƒãƒˆ *</label>
                        <select id="userUnit" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        </select>
                    </div>

                    <div class="grid-2">
                        <div class="form-group">
                            <label>äº¤ä»˜å¹´æœˆæ—¥</label>
                            <input type="date" id="issueDate">
                        </div>
                        <div class="form-group">
                            <label>åˆ©ç”¨è€…è² æ‹…ä¸Šé™æœˆé¡</label>
                            <input type="number" id="userBurdenLimit" value="0">
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">ğŸ’¾ ç™»éŒ²</button>
                    <button type="button" class="btn btn-secondary" onclick="resetUserForm()">ğŸ”„ ã‚¯ãƒªã‚¢</button>
                </form>

                <h2 class="section-header">ç™»éŒ²æ¸ˆã¿åˆ©ç”¨è€…</h2>
                <div id="userList" class="user-list"></div>
            </div>

            <!-- å®Ÿç¸¾è¨˜éŒ²ã‚¿ãƒ– -->
            <div id="records" class="tab-content">
                <div class="form-group">
                    <label style="font-weight: 600; margin-bottom: 10px; display: block;">åˆ©ç”¨è€…ã‚’é¸æŠ</label>
                    <select id="recordUser" onchange="loadRecords()" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                        <option value="">åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                </div>

                <div class="calendar-header">
                    <button class="btn btn-secondary" onclick="changeMonth(-1)">â† å‰æœˆ</button>
                    <h2 id="currentMonth"></h2>
                    <button class="btn btn-secondary" onclick="changeMonth(1)">æ¬¡æœˆ â†’</button>
                </div>

                <div class="calendar-actions">
                    <button class="btn btn-success" onclick="fillMonth('â—‹')">âœ… å…¨ã¦æœ¬å…¥å±…ï¼ˆâ—‹ï¼‰ã§åŸ‹ã‚ã‚‹</button>
                    <button class="btn btn-warning" onclick="fillMonth('å¤–æ³Š')">ğŸ–ï¸ å…¨ã¦å¤–æ³Šã§åŸ‹ã‚ã‚‹</button>
                    <button class="btn btn-info" onclick="fillMonth('å…¥é™¢')">ğŸ¥ å…¨ã¦å…¥é™¢ã§åŸ‹ã‚ã‚‹</button>
                    <button class="btn btn-secondary" onclick="clearMonth()">ğŸ—‘ï¸ ä»Šæœˆã‚’ã‚¯ãƒªã‚¢</button>
                </div>

                <div id="calendar" class="calendar"></div>
            </div>

            <!-- è«‹æ±‚ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›ã‚¿ãƒ– -->
            <div id="export" class="tab-content">
                <h2 class="section-header">è«‹æ±‚ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›</h2>
                
                <div class="alert alert-info">
                    <strong>ğŸ“‹ å‡ºåŠ›å†…å®¹</strong><br>
                    ãƒ»SE: è¨“ç·´ç­‰çµ¦ä»˜è²»ç­‰æ˜ç´°æ›¸ï¼ˆæ§˜å¼ç¬¬ä¸‰ï¼‰<br>
                    ãƒ»SV: å…±åŒç”Ÿæ´»æ´åŠ©ã‚µãƒ¼ãƒ“ã‚¹æä¾›å®Ÿç¸¾è¨˜éŒ²ç¥¨
                </div>

                <div class="form-group">
                    <label>å¯¾è±¡å¹´æœˆ</label>
                    <input type="month" id="exportMonth">
                </div>

                <button class="btn btn-success" onclick="exportCSV('SE')">ğŸ“„ SEï¼ˆæ˜ç´°æ›¸ï¼‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                <button class="btn btn-success" onclick="exportCSV('SV')">ğŸ“„ SVï¼ˆå®Ÿç¸¾è¨˜éŒ²ç¥¨ï¼‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>

                <div id="exportStatus" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šæ—¥ä»˜é¸æŠ -->
    <div id="dateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="modalDate"></span>ã®è¨˜éŒ²
            </div>

            <div class="form-group">
                <label>ã‚µãƒ¼ãƒ“ã‚¹æä¾›ã®çŠ¶æ³</label>
                <div class="status-options">
                    <div class="status-option" data-status="â—‹">â—‹ï¼ˆæœ¬å…¥å±…ï¼‰</div>
                    <div class="status-option" data-status="å…¥é™¢">å…¥é™¢</div>
                    <div class="status-option" data-status="å¤–æ³Š">å¤–æ³Š</div>
                    <div class="status-option" data-status="å¤–æ³Šå§‹">å¤–æ³Šå§‹</div>
                    <div class="status-option" data-status="å¤–æ³Šçµ‚">å¤–æ³Šçµ‚</div>
                    <div class="status-option" data-status="å…¥é™¢çµ‚">å…¥é™¢çµ‚</div>
                    <div class="status-option" data-status="å…¥é™¢â†’å¤–æ³Š">å…¥é™¢â†’å¤–æ³Š</div>
                    <div class="status-option" data-status="å¤–æ³Šâ†’å…¥é™¢">å¤–æ³Šâ†’å…¥é™¢</div>
                    <div class="status-option" data-status="ä½“é¨“">ä½“é¨“</div>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveRecord()">ä¿å­˜</button>
                <button class="btn btn-secondary" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <script>
        // ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
        let users = JSON.parse(localStorage.getItem('gh_users') || '[]');
        let records = JSON.parse(localStorage.getItem('gh_records') || '{}');
        let facility = JSON.parse(localStorage.getItem('gh_facility') || '{}');
        let buildings = JSON.parse(localStorage.getItem('gh_buildings') || '[]');
        
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        let selectedUserId = null;
        let selectedDate = null;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadFacilityInfo();
            renderBuildingList();
            renderUserList();
            updateUserSelector();
            updateCalendar();
            updateUnitOptions();
            displayFacilityInfo();
            
            const today = new Date();
            document.getElementById('exportMonth').value = 
                `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
        });

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // ========== äº‹æ¥­æ‰€æƒ…å ±ç®¡ç† ==========
        
        function loadFacilityInfo() {
            if (facility.facilityNumber) {
                document.getElementById('facilityNumber').value = facility.facilityNumber || '';
                document.getElementById('facilityName').value = facility.facilityName || '';
                document.getElementById('corporationName').value = facility.corporationName || '';
                document.getElementById('areaCode').value = facility.areaCode || '01';
            }
        }

        function addBuilding() {
            const building = {
                id: Date.now().toString(),
                name: '',
                capacity: 0,
                nightSupport: false,
                medicalCooperation: false,
                largeScale: false
            };
            buildings.push(building);
            renderBuildingList();
        }

        function removeBuilding(id) {
            if (confirm('ã“ã®å»ºç‰©ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                buildings = buildings.filter(b => b.id !== id);
                localStorage.setItem('gh_buildings', JSON.stringify(buildings));
                renderBuildingList();
                updateUnitOptions();
            }
        }

        function renderBuildingList() {
            const container = document.getElementById('buildingList');
            if (buildings.length === 0) {
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å»ºç‰©ã‚’è¿½åŠ 
                buildings = [
                    { id: 'nakano', name: 'Nakano. settle', capacity: 7, nightSupport: true, medicalCooperation: true, largeScale: false },
                    { id: 'nerima', name: 'Nerima. settle', capacity: 5, nightSupport: true, medicalCooperation: false, largeScale: false },
                    { id: 'nerima-west', name: 'Nerima. settle west', capacity: 8, nightSupport: false, medicalCooperation: false, largeScale: true }
                ];
                localStorage.setItem('gh_buildings', JSON.stringify(buildings));
            }

            container.innerHTML = buildings.map(building => `
                <div class="info-card">
                    <div class="grid-2">
                        <div class="form-group">
                            <label>å»ºç‰©å</label>
                            <input type="text" value="${building.name}" onchange="updateBuilding('${building.id}', 'name', this.value)">
                        </div>
                        <div class="form-group">
                            <label>å®šå“¡</label>
                            <input type="number" value="${building.capacity}" onchange="updateBuilding('${building.id}', 'capacity', this.value)">
                        </div>
                    </div>
                    <div class="grid-3">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" ${building.nightSupport ? 'checked' : ''} onchange="updateBuilding('${building.id}', 'nightSupport', this.checked)">
                                å¤œé–“æ”¯æ´ã‚ã‚Š
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" ${building.medicalCooperation ? 'checked' : ''} onchange="updateBuilding('${building.id}', 'medicalCooperation', this.checked)">
                                åŒ»ç™‚é€£æºã‚ã‚Š
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" ${building.largeScale ? 'checked' : ''} onchange="updateBuilding('${building.id}', 'largeScale', this.checked)">
                                å¤§è¦æ¨¡æ¸›ç®—
                            </label>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="removeBuilding('${building.id}')">ğŸ—‘ï¸ å‰Šé™¤</button>
                </div>
            `).join('');

            updateUnitOptions();
        }

        function updateBuilding(id, field, value) {
            const building = buildings.find(b => b.id === id);
            if (building) {
                building[field] = field === 'capacity' ? parseInt(value) : value;
                localStorage.setItem('gh_buildings', JSON.stringify(buildings));
                updateUnitOptions();
            }
        }

        function updateUnitOptions() {
            const select = document.getElementById('userUnit');
            select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
                buildings.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
        }

        document.getElementById('facilityForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            facility = {
                facilityNumber: document.getElementById('facilityNumber').value,
                facilityName: document.getElementById('facilityName').value,
                corporationName: document.getElementById('corporationName').value,
                areaCode: document.getElementById('areaCode').value
            };

            localStorage.setItem('gh_facility', JSON.stringify(facility));
            localStorage.setItem('gh_buildings', JSON.stringify(buildings));
            
            displayFacilityInfo();
            alert('âœ… äº‹æ¥­æ‰€æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
        });

        function displayFacilityInfo() {
            const container = document.getElementById('facilityInfo');
            if (!facility.facilityNumber) return;

            container.innerHTML = `
                <h2 class="section-header">ç™»éŒ²æƒ…å ±</h2>
                <div class="info-card">
                    <h3>äº‹æ¥­æ‰€æƒ…å ±</h3>
                    <p><strong>äº‹æ¥­æ‰€ç•ªå·:</strong> ${facility.facilityNumber}</p>
                    <p><strong>äº‹æ¥­æ‰€å:</strong> ${facility.facilityName}</p>
                    <p><strong>æ³•äººå:</strong> ${facility.corporationName}</p>
                    <p><strong>åœ°åŸŸåŒºåˆ†:</strong> ${getAreaName(facility.areaCode)}</p>
                </div>
                <div class="info-card">
                    <h3>å»ºç‰©æƒ…å ±</h3>
                    ${buildings.map(b => `
                        <p><strong>${b.name}</strong> - å®šå“¡${b.capacity}äºº
                        ${b.nightSupport ? 'ğŸŒ™å¤œé–“æ”¯æ´' : ''}
                        ${b.medicalCooperation ? 'ğŸ¥åŒ»ç™‚é€£æº' : ''}
                        ${b.largeScale ? 'âš ï¸å¤§è¦æ¨¡æ¸›ç®—' : ''}
                        </p>
                    `).join('')}
                </div>
            `;
        }

        function getAreaName(code) {
            const areas = {
                '01': 'ä¸€ç´šåœ°', '02': 'äºŒç´šåœ°', '03': 'ä¸‰ç´šåœ°',
                '04': 'å››ç´šåœ°', '05': 'äº”ç´šåœ°', '06': 'å…­ç´šåœ°',
                '07': 'ä¸ƒç´šåœ°', '20': 'ãã®ä»–'
            };
            return areas[code] || code;
        }

        // ========== OCRæ©Ÿèƒ½ ==========

        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('click', () => {
            document.getElementById('certificateFile').click();
        });

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const file = e.dataTransfer.files[0];
            if (file && (file.type.startsWith('image/') || file.type === 'application/pdf')) {
                processFile(file);
            } else {
                alert('âŒ PDFã¾ãŸã¯ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
            }
        });

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        async function processFile(file) {
            const progress = document.getElementById('ocrProgress');
            progress.style.display = 'block';
            progress.textContent = 'ğŸ” ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...';

            try {
                if (file.type === 'application/pdf') {
                    await processPDFSimple(file);
                } else {
                    await processImage(file);
                }
            } catch (err) {
                console.error('ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã‚¨ãƒ©ãƒ¼:', err);
                progress.textContent = 'âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
                setTimeout(() => {
                    progress.style.display = 'none';
                }, 3000);
            }
        }

        async function processPDFSimple(file) {
            const progress = document.getElementById('ocrProgress');
            progress.textContent = 'ğŸ“„ PDFã‚’ç”»åƒã«å¤‰æ›ä¸­...';
            
            // PDFã‚’ç”»åƒã¨ã—ã¦èª­ã¿è¾¼ã‚€ç°¡æ˜“ç‰ˆ
            alert('ğŸ“ PDFã®OCRã¯ç¾åœ¨é–‹ç™ºä¸­ã§ã™ã€‚ç”»åƒå½¢å¼ï¼ˆPNG/JPEGï¼‰ã§ã®èª­ã¿è¾¼ã¿ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚\n\nã¾ãŸã¯ã€PDFã‚’é–‹ã„ã¦ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®ã‚Šã€ãã®ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
            progress.style.display = 'none';
        }

        async function processImage(file) {
            const progress = document.getElementById('ocrProgress');
            progress.textContent = 'ğŸ” ç”»åƒã‚’è§£æä¸­...';

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    progress.textContent = 'ğŸ” OCRå‡¦ç†ä¸­... 0%';
                    
                    // Tesseract.jsã§OCRå®Ÿè¡Œ
                    const result = await Tesseract.recognize(
                        e.target.result,
                        'jpn',
                        {
                            logger: m => {
                                if (m.status === 'recognizing text') {
                                    const percent = Math.round(m.progress * 100);
                                    progress.textContent = `ğŸ” OCRå‡¦ç†ä¸­... ${percent}%`;
                                }
                            }
                        }
                    );

                    progress.textContent = 'âœ… èª­ã¿å–ã‚Šå®Œäº†ï¼';
                    console.log('OCRçµæœ:', result.data.text);
                    extractCertificateData(result.data.text);
                    
                    setTimeout(() => {
                        progress.style.display = 'none';
                    }, 3000);

                } catch (err) {
                    console.error('OCRã‚¨ãƒ©ãƒ¼:', err);
                    progress.textContent = 'âŒ OCRã«å¤±æ•—ã—ã¾ã—ãŸ';
                    alert('OCRã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\n\nã‚¨ãƒ©ãƒ¼: ' + err.message);
                    setTimeout(() => {
                        progress.style.display = 'none';
                    }, 3000);
                }
            };

            reader.readAsDataURL(file);
        }

        function extractCertificateData(text) {
            console.log('æŠ½å‡ºå…ƒãƒ†ã‚­ã‚¹ãƒˆ:', text);
            
            // å—çµ¦è€…è¨¼ç•ªå·ï¼ˆ10æ¡ï¼‰
            const certMatch = text.match(/\d{10}/);
            if (certMatch) {
                document.getElementById('certificateNumber').value = certMatch[0];
            }

            // æ°å
            const namePatterns = [
                /æ°[\sã€€]*å[ï¼š:\sã€€]*([^\n\rã€€]{2,10})/,
                /å—çµ¦è€…æ°å[ï¼š:\sã€€]*([^\n\rã€€]{2,10})/,
            ];
            
            for (const pattern of namePatterns) {
                const match = text.match(pattern);
                if (match) {
                    const name = match[1].trim().replace(/[0-9]/g, '');
                    if (name.length >= 2) {
                        document.getElementById('userName').value = name;
                        break;
                    }
                }
            }

            // å¸‚ç”ºæ‘ç•ªå·ï¼ˆ6æ¡ï¼‰
            const cityMatch = text.match(/\d{6}/);
            if (cityMatch && cityMatch[0] !== certMatch?.[0]) {
                document.getElementById('cityCode').value = cityMatch[0];
            }

            // éšœå®³æ”¯æ´åŒºåˆ†
            const supportMatch = text.match(/åŒºåˆ†[ã€€\s]*([ï¼‘-ï¼–1-6])/);
            if (supportMatch) {
                const num = supportMatch[1].replace(/[ï¼‘-ï¼–]/g, (s) => 
                    String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
                document.getElementById('supportLevel').value = (20 + parseInt(num)).toString();
            }

            alert('ğŸ“ èª­ã¿å–ã‚Šçµæœã‚’åæ˜ ã—ã¾ã—ãŸã€‚å†…å®¹ã‚’ç¢ºèªã—ã¦å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚');
        }

        // ========== åˆ©ç”¨è€…ç®¡ç† ==========

        document.getElementById('userForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const user = {
                id: Date.now().toString(),
                certificateNumber: document.getElementById('certificateNumber').value,
                name: document.getElementById('userName').value,
                cityCode: document.getElementById('cityCode').value || '131148',
                supportLevel: document.getElementById('supportLevel').value || '22',
                validFrom: document.getElementById('validFrom').value,
                validTo: document.getElementById('validTo').value,
                unit: document.getElementById('userUnit').value,
                issueDate: document.getElementById('issueDate').value,
                userBurdenLimit: document.getElementById('userBurdenLimit').value || '0'
            };

            users.push(user);
            localStorage.setItem('gh_users', JSON.stringify(users));
            
            renderUserList();
            updateUserSelector();
            resetUserForm();
            
            alert('âœ… åˆ©ç”¨è€…ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼');
        });

        function resetUserForm() {
            document.getElementById('userForm').reset();
        }

        function renderUserList() {
            const list = document.getElementById('userList');
            if (users.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ç™»éŒ²ã•ã‚ŒãŸåˆ©ç”¨è€…ã¯ã„ã¾ã›ã‚“</p>';
                return;
            }

            list.innerHTML = users.map(user => `
                <div class="user-card">
                    <h3>${user.name}</h3>
                    <p>ğŸ“‹ å—çµ¦è€…è¨¼ç•ªå·: ${user.certificateNumber}</p>
                    <p>ğŸ  ãƒ¦ãƒ‹ãƒƒãƒˆ: ${getUnitName(user.unit)}</p>
                    <p>ğŸ“Š åŒºåˆ†: ${getSupportLevelName(user.supportLevel)}</p>
                    <p>ğŸ“… æœ‰åŠ¹æœŸé–“: ${user.validFrom || 'æœªè¨­å®š'} ï½ ${user.validTo || 'æœªè¨­å®š'}</p>
                </div>
            `).join('');
        }

        function getUnitName(unitId) {
            const building = buildings.find(b => b.id === unitId);
            return building ? building.name : unitId;
        }

        function getSupportLevelName(level) {
            const levels = {
                '21': 'åŒºåˆ†1', '22': 'åŒºåˆ†2', '23': 'åŒºåˆ†3',
                '24': 'åŒºåˆ†4', '25': 'åŒºåˆ†5', '26': 'åŒºåˆ†6'
            };
            return levels[level] || 'ãªã—';
        }

        function updateUserSelector() {
            const select = document.getElementById('recordUser');
            select.innerHTML = '<option value="">åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</option>' +
                users.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
        }

        // ========== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»å®Ÿç¸¾è¨˜éŒ² ==========

        function updateCalendar() {
            const calendar = document.getElementById('calendar');
            const monthLabel = document.getElementById('currentMonth');
            
            const date = new Date(currentYear, currentMonth, 1);
            monthLabel.textContent = `${currentYear}å¹´ ${currentMonth + 1}æœˆ`;

            const firstDay = date.getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            let html = '<div class="calendar-grid">';
            
            ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'].forEach(day => {
                html += `<div class="calendar-day header">${day}</div>`;
            });

            for (let i = 0; i < firstDay; i++) {
                html += '<div class="calendar-day disabled"></div>';
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const record = getRecord(selectedUserId, dateStr);
                
                const statusClass = record ? getStatusClass(record.status) : '';
                const statusText = record ? record.status : '';

                html += `
                    <div class="calendar-day" onclick="openDateModal('${dateStr}')">
                        <div class="day-number">${day}</div>
                        ${statusText ? `<div class="day-status ${statusClass}">${statusText}</div>` : ''}
                    </div>
                `;
            }

            html += '</div>';
            calendar.innerHTML = html;
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            updateCalendar();
        }

        function loadRecords() {
            selectedUserId = document.getElementById('recordUser').value;
            updateCalendar();
        }

        function fillMonth(status) {
            if (!selectedUserId) {
                alert('åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (!confirm(`${currentYear}å¹´${currentMonth + 1}æœˆã®å…¨ã¦ã®æ—¥ã‚’ã€Œ${status}ã€ã§åŸ‹ã‚ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }

            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            if (!records[selectedUserId]) {
                records[selectedUserId] = {};
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                records[selectedUserId][dateStr] = { status, date: dateStr };
            }

            localStorage.setItem('gh_records', JSON.stringify(records));
            updateCalendar();
            alert(`âœ… ${currentYear}å¹´${currentMonth + 1}æœˆã‚’ã€Œ${status}ã€ã§åŸ‹ã‚ã¾ã—ãŸ`);
        }

        function clearMonth() {
            if (!selectedUserId) {
                alert('åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (!confirm(`${currentYear}å¹´${currentMonth + 1}æœˆã®è¨˜éŒ²ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }

            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            if (records[selectedUserId]) {
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    delete records[selectedUserId][dateStr];
                }
            }

            localStorage.setItem('gh_records', JSON.stringify(records));
            updateCalendar();
            alert(`âœ… ${currentYear}å¹´${currentMonth + 1}æœˆã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
        }

        function getStatusClass(status) {
            if (status === 'â—‹' || status === 'â—‹ï¼ˆæœ¬å…¥å±…ï¼‰') return 'status-ok';
            if (status.includes('å¤–æ³Š')) return 'status-away';
            if (status.includes('å…¥é™¢')) return 'status-hospital';
            return '';
        }

        function getRecord(userId, date) {
            if (!userId || !records[userId]) return null;
            return records[userId][date];
        }

        function openDateModal(dateStr) {
            if (!selectedUserId) {
                alert('åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            selectedDate = dateStr;
            document.getElementById('modalDate').textContent = dateStr;
            
            const record = getRecord(selectedUserId, dateStr);
            document.querySelectorAll('.status-option').forEach(opt => {
                opt.classList.remove('selected');
                if (record && opt.dataset.status === record.status) {
                    opt.classList.add('selected');
                }
            });

            document.getElementById('dateModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('dateModal').classList.remove('active');
        }

        document.querySelectorAll('.status-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.status-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                this.classList.add('selected');
            });
        });

        function saveRecord() {
            const selected = document.querySelector('.status-option.selected');
            if (!selected) {
                alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (!records[selectedUserId]) {
                records[selectedUserId] = {};
            }

            records[selectedUserId][selectedDate] = {
                status: selected.dataset.status,
                date: selectedDate
            };

            localStorage.setItem('gh_records', JSON.stringify(records));
            updateCalendar();
            closeModal();
        }

        // ========== CSVå‡ºåŠ› ==========

        function exportCSV(type) {
            const month = document.getElementById('exportMonth').value;
            if (!month) {
                alert('å¯¾è±¡å¹´æœˆã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const [year, mon] = month.split('-');
            
            if (type === 'SE') {
                generateSE(year, mon);
            } else if (type === 'SV') {
                generateSV(year, mon);
            }
        }

        function generateSE(year, month) {
            let csv = '"1","1","0","11","J11","0","' + facility.facilityNumber + '","0","1","' + year + month + '","0"\n';
            
            let lineNum = 2;
            users.forEach(user => {
                const recordCount = countRecordsForMonth(user.id, year, month);
                if (recordCount > 0) {
                    csv += `"2","${lineNum}","J111","01","${year}${month}","${user.cityCode}","${facility.facilityNumber}","135001","1","10776","125001","125001","0","0","0","1","10000","10000","2","10776","135001","135001","0","0","0"\n`;
                    lineNum++;
                }
            });

            csv += `"3","${lineNum}"\n`;
            downloadCSV(csv, `SE${year}${month}.csv`);
        }

        function generateSV(year, month) {
            let csv = '"1","1","0","32","J61","0","' + facility.facilityNumber + '","0","1","' + year + month + '","0"\n';
            
            let lineNum = 2;
            users.forEach(user => {
                const monthRecords = getMonthRecords(user.id, year, month);
                if (Object.keys(monthRecords).length > 0) {
                    csv += `"2","${lineNum}","J611","01","${year}${month}","${user.cityCode}","${facility.facilityNumber}","${user.certificateNumber}","1801"\n`;
                    lineNum++;

                    const daysInMonth = new Date(year, month, 0).getDate();
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateStr = `${year}-${month.padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const record = monthRecords[dateStr];
                        const status = record ? (record.status === 'â—‹' ? '3' : '') : '';
                        
                        csv += `"2","${lineNum}","J611","02","${year}${month}","${user.cityCode}","${facility.facilityNumber}","${user.certificateNumber}","1801","","${day}","","","","","","","","","","","","","","","","","","","","","","","","","","","${status}"\n`;
                        lineNum++;
                    }
                }
            });

            csv += `"3","${lineNum}"\n`;
            downloadCSV(csv, `SV${year}${month}.csv`);
        }

        function countRecordsForMonth(userId, year, month) {
            if (!records[userId]) return 0;
            
            const prefix = `${year}-${month.padStart(2, '0')}`;
            return Object.keys(records[userId]).filter(date => date.startsWith(prefix)).length;
        }

        function getMonthRecords(userId, year, month) {
            if (!records[userId]) return {};
            
            const prefix = `${year}-${month.padStart(2, '0')}`;
            const monthRecords = {};
            
            Object.entries(records[userId]).forEach(([date, record]) => {
                if (date.startsWith(prefix)) {
                    monthRecords[date] = record;
                }
            });
            
            return monthRecords;
        }

        function downloadCSV(content, filename) {
            const bom = '\uFEFF';
            const blob = new Blob([bom + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            
            document.getElementById('exportStatus').innerHTML = 
                `<div class="alert alert-success">âœ… ${filename} ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ</div>`;
        }
    </script>
</body>
</html>
