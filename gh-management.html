<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ è«‹æ±‚ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // PDF.jsã®è¨­å®š
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            border: none;
            background: transparent;
            font-size: 16px;
        }

        .tab:hover {
            background: #e0e0e0;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* åˆ©ç”¨è€…ç™»éŒ² */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f9f9f9;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #e6e6ff;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        /* åˆ©ç”¨è€…ä¸€è¦§ */
        .user-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .user-card {
            border: 2px solid #ddd;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .user-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .user-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .user-card p {
            margin: 5px 0;
            color: #666;
        }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
        .calendar {
            margin-top: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: #ddd;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-day {
            background: white;
            padding: 15px;
            min-height: 100px;
            position: relative;
        }

        .calendar-day.header {
            background: #667eea;
            color: white;
            font-weight: 600;
            text-align: center;
            padding: 10px;
            min-height: auto;
        }

        .calendar-day.disabled {
            background: #f5f5f5;
            color: #ccc;
        }

        .day-number {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .day-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 5px;
        }

        .status-ok {
            background: #d4edda;
            color: #155724;
        }

        .status-away {
            background: #fff3cd;
            color: #856404;
        }

        .status-hospital {
            background: #f8d7da;
            color: #721c24;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #667eea;
        }

        .status-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .status-option {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .status-option:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }

        .status-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .progress {
            margin: 20px 0;
            text-align: center;
            color: #667eea;
            font-weight: 600;
        }

        .user-selector {
            margin-bottom: 20px;
        }

        .unit-selector {
            margin-bottom: 20px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }

            .calendar-day {
                min-height: 80px;
                padding: 10px;
            }

            .status-options {
                grid-template-columns: 1fr;
            }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ  ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ è«‹æ±‚ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>Tokyo. settle - éšœå®³è€…å…±åŒç”Ÿæ´»æ´åŠ©ã‚µãƒ¼ãƒ“ã‚¹</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('users')">ğŸ‘¤ åˆ©ç”¨è€…ç®¡ç†</button>
            <button class="tab" onclick="showTab('records')">ğŸ“… å®Ÿç¸¾è¨˜éŒ²</button>
            <button class="tab" onclick="showTab('export')">ğŸ“¤ è«‹æ±‚ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›</button>
        </div>

        <div class="content">
            <!-- åˆ©ç”¨è€…ç®¡ç†ã‚¿ãƒ– -->
            <div id="users" class="tab-content active">
                <h2>åˆ©ç”¨è€…ç™»éŒ²</h2>
                
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="certificateImage" accept="image/*,application/pdf" style="display: none;" onchange="handleFileUpload(event)">
                    <p style="font-size: 1.2em; margin-bottom: 10px;">ğŸ“· å—çµ¦è€…è¨¼ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p>
                    <p style="color: #666;">ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§PDFã¾ãŸã¯ç”»åƒã‚’é¸æŠ</p>
                    <p style="color: #999; font-size: 0.9em; margin-top: 10px;">ğŸ“„ PDFãƒ»PNGãƒ»JPEGã«å¯¾å¿œ / OCRã§è‡ªå‹•èª­ã¿å–ã‚Šã—ã¾ã™</p>
                </div>

                <div id="ocrProgress" class="progress" style="display: none;"></div>

                <form id="userForm" style="margin-top: 30px;">
                    <div class="grid-2">
                        <div class="form-group">
                            <label>å—çµ¦è€…è¨¼ç•ªå· *</label>
                            <input type="text" id="certificateNumber" required>
                        </div>
                        <div class="form-group">
                            <label>æ°å *</label>
                            <input type="text" id="userName" required>
                        </div>
                    </div>

                    <div class="grid-2">
                        <div class="form-group">
                            <label>æ”¯çµ¦å¸‚ç”ºæ‘ç•ªå·</label>
                            <input type="text" id="cityCode" placeholder="131148">
                        </div>
                        <div class="form-group">
                            <label>éšœå®³æ”¯æ´åŒºåˆ†</label>
                            <select id="supportLevel">
                                <option value="">ãªã—</option>
                                <option value="21">åŒºåˆ†1</option>
                                <option value="22">åŒºåˆ†2</option>
                                <option value="23">åŒºåˆ†3</option>
                                <option value="24">åŒºåˆ†4</option>
                                <option value="25">åŒºåˆ†5</option>
                                <option value="26">åŒºåˆ†6</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid-2">
                        <div class="form-group">
                            <label>èªå®šæœ‰åŠ¹æœŸé–“ é–‹å§‹æ—¥</label>
                            <input type="date" id="validFrom">
                        </div>
                        <div class="form-group">
                            <label>èªå®šæœ‰åŠ¹æœŸé–“ çµ‚äº†æ—¥</label>
                            <input type="date" id="validTo">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>æ‰€å±ãƒ¦ãƒ‹ãƒƒãƒˆ *</label>
                        <select id="userUnit" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="nakano">Nakano. settle</option>
                            <option value="nerima">Nerima. settle</option>
                            <option value="nerima-west">Nerima. settle west</option>
                        </select>
                    </div>

                    <div class="grid-2">
                        <div class="form-group">
                            <label>äº¤ä»˜å¹´æœˆæ—¥</label>
                            <input type="date" id="issueDate">
                        </div>
                        <div class="form-group">
                            <label>åˆ©ç”¨è€…è² æ‹…ä¸Šé™æœˆé¡</label>
                            <input type="number" id="userBurdenLimit" value="0">
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">ğŸ’¾ ç™»éŒ²</button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">ğŸ”„ ã‚¯ãƒªã‚¢</button>
                </form>

                <h2 style="margin-top: 40px;">ç™»éŒ²æ¸ˆã¿åˆ©ç”¨è€…</h2>
                <div id="userList" class="user-list"></div>
            </div>

            <!-- å®Ÿç¸¾è¨˜éŒ²ã‚¿ãƒ– -->
            <div id="records" class="tab-content">
                <div class="user-selector">
                    <label style="font-weight: 600; margin-bottom: 10px; display: block;">åˆ©ç”¨è€…ã‚’é¸æŠ</label>
                    <select id="recordUser" onchange="loadRecords()" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                        <option value="">åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                </div>

                <div class="calendar-header">
                    <button class="btn btn-secondary" onclick="changeMonth(-1)">â† å‰æœˆ</button>
                    <h2 id="currentMonth"></h2>
                    <button class="btn btn-secondary" onclick="changeMonth(1)">æ¬¡æœˆ â†’</button>
                </div>

                <div id="calendar" class="calendar"></div>
            </div>

            <!-- è«‹æ±‚ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›ã‚¿ãƒ– -->
            <div id="export" class="tab-content">
                <h2>è«‹æ±‚ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›</h2>
                
                <div class="alert alert-info">
                    <strong>ğŸ“‹ å‡ºåŠ›å†…å®¹</strong><br>
                    ãƒ»SE: è¨“ç·´ç­‰çµ¦ä»˜è²»ç­‰æ˜ç´°æ›¸ï¼ˆæ§˜å¼ç¬¬ä¸‰ï¼‰<br>
                    ãƒ»SV: å…±åŒç”Ÿæ´»æ´åŠ©ã‚µãƒ¼ãƒ“ã‚¹æä¾›å®Ÿç¸¾è¨˜éŒ²ç¥¨
                </div>

                <div class="form-group">
                    <label>å¯¾è±¡å¹´æœˆ</label>
                    <input type="month" id="exportMonth">
                </div>

                <button class="btn btn-success" onclick="exportCSV('SE')">ğŸ“„ SEï¼ˆæ˜ç´°æ›¸ï¼‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                <button class="btn btn-success" onclick="exportCSV('SV')">ğŸ“„ SVï¼ˆå®Ÿç¸¾è¨˜éŒ²ç¥¨ï¼‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>

                <div id="exportStatus" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šæ—¥ä»˜é¸æŠ -->
    <div id="dateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="modalDate"></span>ã®è¨˜éŒ²
            </div>

            <div class="form-group">
                <label>ã‚µãƒ¼ãƒ“ã‚¹æä¾›ã®çŠ¶æ³</label>
                <div class="status-options">
                    <div class="status-option" data-status="â—‹">â—‹ï¼ˆæœ¬å…¥å±…ï¼‰</div>
                    <div class="status-option" data-status="å…¥é™¢">å…¥é™¢</div>
                    <div class="status-option" data-status="å¤–æ³Š">å¤–æ³Š</div>
                    <div class="status-option" data-status="å¤–æ³Šå§‹">å¤–æ³Šå§‹</div>
                    <div class="status-option" data-status="å¤–æ³Šçµ‚">å¤–æ³Šçµ‚</div>
                    <div class="status-option" data-status="å…¥é™¢çµ‚">å…¥é™¢çµ‚</div>
                    <div class="status-option" data-status="å…¥é™¢â†’å¤–æ³Š">å…¥é™¢â†’å¤–æ³Š</div>
                    <div class="status-option" data-status="å¤–æ³Šâ†’å…¥é™¢">å¤–æ³Šâ†’å…¥é™¢</div>
                    <div class="status-option" data-status="ä½“é¨“">ä½“é¨“</div>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveRecord()">ä¿å­˜</button>
                <button class="btn btn-secondary" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <script>
        // ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
        let users = JSON.parse(localStorage.getItem('gh_users') || '[]');
        let records = JSON.parse(localStorage.getItem('gh_records') || '{}');
        
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        let selectedUserId = null;
        let selectedDate = null;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            renderUserList();
            updateUserSelector();
            updateCalendar();
            
            const today = new Date();
            document.getElementById('exportMonth').value = 
                `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
        });

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
        document.getElementById('uploadArea').addEventListener('click', () => {
            document.getElementById('certificateImage').click();
        });

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const file = e.dataTransfer.files[0];
            if (file && (file.type.startsWith('image/') || file.type === 'application/pdf')) {
                processFile(file);
            } else {
                alert('âŒ PDFã¾ãŸã¯ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
            }
        });

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        async function processFile(file) {
            if (file.type === 'application/pdf') {
                await processPDF(file);
            } else if (file.type.startsWith('image/')) {
                processImage(file);
            }
        }

        async function processPDF(file) {
            const progress = document.getElementById('ocrProgress');
            progress.style.display = 'block';
            progress.textContent = 'ğŸ“„ PDFã‚’èª­ã¿è¾¼ã¿ä¸­...';

            try {
                // PDF.jsãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
                if (typeof pdfjsLib === 'undefined') {
                    throw new Error('PDF.jsãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                }

                const arrayBuffer = await file.arrayBuffer();
                const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
                const pdf = await loadingTask.promise;
                
                progress.textContent = `ğŸ“„ PDFãƒšãƒ¼ã‚¸æ•°: ${pdf.numPages} - å‡¦ç†é–‹å§‹`;

                // æœ€åˆã®2ãƒšãƒ¼ã‚¸ã‚’å‡¦ç†ï¼ˆå—çµ¦è€…è¨¼ã¯é€šå¸¸1-2ãƒšãƒ¼ã‚¸ï¼‰
                const pagesToProcess = Math.min(2, pdf.numPages);
                let allText = '';

                for (let pageNum = 1; pageNum <= pagesToProcess; pageNum++) {
                    progress.textContent = `ğŸ“„ ${pageNum}/${pagesToProcess}ãƒšãƒ¼ã‚¸ç›®ã‚’èª­ã¿è¾¼ã¿ä¸­...`;
                    
                    const page = await pdf.getPage(pageNum);
                    const viewport = page.getViewport({ scale: 2.5 });
                    
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport
                    };

                    await page.render(renderContext).promise;

                    progress.textContent = `ğŸ” ${pageNum}/${pagesToProcess}ãƒšãƒ¼ã‚¸ç›®ã‚’OCRå‡¦ç†ä¸­...`;

                    // Canvasã‚’BlobçµŒç”±ã§å‡¦ç†ï¼ˆã‚ˆã‚Šå®‰å®šï¼‰
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                    
                    const result = await Tesseract.recognize(
                        blob,
                        'jpn',
                        {
                            logger: m => {
                                if (m.status === 'recognizing text') {
                                    const percent = Math.round(m.progress * 100);
                                    progress.textContent = `ğŸ” ${pageNum}/${pagesToProcess}ãƒšãƒ¼ã‚¸ç›® OCRå‡¦ç†ä¸­... ${percent}%`;
                                }
                            }
                        }
                    );

                    allText += result.data.text + '\n\n';
                    console.log(`ãƒšãƒ¼ã‚¸${pageNum} OCRçµæœ:`, result.data.text);
                }

                progress.textContent = 'âœ… PDFèª­ã¿å–ã‚Šå®Œäº†ï¼';
                console.log('å…¨ä½“ã®OCRçµæœ:', allText);
                extractCertificateData(allText);
                
                setTimeout(() => {
                    progress.style.display = 'none';
                }, 3000);

            } catch (err) {
                console.error('PDFã‚¨ãƒ©ãƒ¼è©³ç´°:', err);
                progress.textContent = 'âŒ PDFèª­ã¿å–ã‚Šã«å¤±æ•—ã—ã¾ã—ãŸ';
                progress.style.display = 'block';
                
                // ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’è¡¨ç¤º
                const errorDetail = document.createElement('div');
                errorDetail.style.cssText = 'color: red; margin-top: 10px; font-size: 0.9em;';
                errorDetail.textContent = `ã‚¨ãƒ©ãƒ¼: ${err.message}`;
                
                const progressDiv = document.getElementById('ocrProgress');
                if (!progressDiv.querySelector('.error-detail')) {
                    errorDetail.className = 'error-detail';
                    progressDiv.appendChild(errorDetail);
                }
                
                // ç”»åƒã¨ã—ã¦èª­ã¿è¾¼ã¿ã‚’è©¦ã¿ã‚‹
                setTimeout(() => {
                    if (confirm('PDFã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç”»åƒã¨ã—ã¦èª­ã¿è¾¼ã¿ã‚’è©¦ã—ã¾ã™ã‹ï¼Ÿ')) {
                        processImage(file);
                    }
                }, 1000);
            }
        }

        function processImage(file) {
            const progress = document.getElementById('ocrProgress');
            progress.style.display = 'block';
            progress.textContent = 'ğŸ” ç”»åƒã‚’è§£æä¸­...';

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    // Tesseract.jsãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
                    if (typeof Tesseract === 'undefined') {
                        throw new Error('Tesseract.jsãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                    }

                    const result = await Tesseract.recognize(
                        e.target.result,
                        'jpn',
                        {
                            logger: m => {
                                if (m.status === 'recognizing text') {
                                    progress.textContent = `ğŸ” ãƒ†ã‚­ã‚¹ãƒˆèªè­˜ä¸­... ${Math.round(m.progress * 100)}%`;
                                }
                            }
                        }
                    );

                    progress.textContent = 'âœ… èª­ã¿å–ã‚Šå®Œäº†ï¼';
                    console.log('OCRçµæœ:', result.data.text);
                    extractCertificateData(result.data.text);
                    
                    setTimeout(() => {
                        progress.style.display = 'none';
                    }, 3000);

                } catch (err) {
                    console.error('ç”»åƒOCRã‚¨ãƒ©ãƒ¼:', err);
                    progress.textContent = 'âŒ èª­ã¿å–ã‚Šã«å¤±æ•—ã—ã¾ã—ãŸ';
                    
                    const errorDetail = document.createElement('div');
                    errorDetail.style.cssText = 'color: red; margin-top: 10px; font-size: 0.9em;';
                    errorDetail.textContent = `ã‚¨ãƒ©ãƒ¼: ${err.message}`;
                    
                    const progressDiv = document.getElementById('ocrProgress');
                    const existingError = progressDiv.querySelector('.error-detail');
                    if (existingError) {
                        existingError.remove();
                    }
                    errorDetail.className = 'error-detail';
                    progressDiv.appendChild(errorDetail);
                }
            };

            reader.onerror = (err) => {
                console.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
                progress.textContent = 'âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
            };

            reader.readAsDataURL(file);
        }

        function extractCertificateData(text) {
            console.log('OCRçµæœ:', text);
            
            // å—çµ¦è€…è¨¼ç•ªå·ï¼ˆ10æ¡ã®æ•°å­—ï¼‰
            const certMatch = text.match(/\d{10}/);
            if (certMatch) {
                document.getElementById('certificateNumber').value = certMatch[0];
            }

            // æ°åã®æŠ½å‡º
            const namePatterns = [
                /æ°[\sã€€]*å[ï¼š:\sã€€]*([^\n\rã€€]{2,10})/,
                /å—çµ¦è€…æ°å[ï¼š:\sã€€]*([^\n\rã€€]{2,10})/,
                /ãƒ•ãƒªã‚¬ãƒŠ[\s\S]{0,20}[\r\n]+([^\n\rã€€]{2,10})/
            ];
            
            for (const pattern of namePatterns) {
                const match = text.match(pattern);
                if (match) {
                    const name = match[1].trim().replace(/[0-9]/g, '');
                    if (name.length >= 2) {
                        document.getElementById('userName').value = name;
                        break;
                    }
                }
            }

            // å¸‚ç”ºæ‘ç•ªå·ï¼ˆ6æ¡ï¼‰
            const cityPatterns = [
                /å¸‚ç”ºæ‘ç•ªå·[ï¼š:\sã€€]*(\d{6})/,
                /æ”¯çµ¦å¸‚ç”ºæ‘ç•ªå·[ï¼š:\sã€€]*(\d{6})/,
                /(\d{6})/  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            ];
            
            for (const pattern of cityPatterns) {
                const match = text.match(pattern);
                if (match && match[1] !== certMatch?.[0]) {  // å—çµ¦è€…è¨¼ç•ªå·ã¨é‡è¤‡ã—ãªã„ã‚ˆã†ã«
                    document.getElementById('cityCode').value = match[1];
                    break;
                }
            }

            // éšœå®³æ”¯æ´åŒºåˆ†
            const supportLevelMatch = text.match(/åŒºåˆ†[ã€€\s]*([ï¼‘-ï¼–1-6])/);
            if (supportLevelMatch) {
                const levelNum = supportLevelMatch[1].replace(/[ï¼‘-ï¼–]/g, (s) => 
                    String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
                const levelCode = (20 + parseInt(levelNum)).toString();
                document.getElementById('supportLevel').value = levelCode;
            }

            // äº¤ä»˜å¹´æœˆæ—¥
            const issueDatePatterns = [
                /äº¤ä»˜å¹´æœˆæ—¥[ï¼š:\sã€€]*[ä»¤å’Œå¹³æˆ]*(\d{1,2})[å¹´\sã€€]*(\d{1,2})[æœˆ\sã€€]*(\d{1,2})/,
                /(\d{4})[å¹´\/\-](\d{1,2})[æœˆ\/\-](\d{1,2})/
            ];
            
            for (const pattern of issueDatePatterns) {
                const match = text.match(pattern);
                if (match) {
                    let year = match[1];
                    const month = match[2].padStart(2, '0');
                    const day = match[3].padStart(2, '0');
                    
                    // å’Œæš¦ã‚’è¥¿æš¦ã«å¤‰æ›ï¼ˆä»¤å’Œï¼‰
                    if (year.length <= 2) {
                        year = (2018 + parseInt(year)).toString();
                    }
                    
                    document.getElementById('issueDate').value = `${year}-${month}-${day}`;
                    break;
                }
            }

            // èªå®šæœ‰åŠ¹æœŸé–“
            const validPeriodPattern = /(\d{4})[å¹´\/\-](\d{1,2})[æœˆ\/\-](\d{1,2})[^\d]+(\d{4})[å¹´\/\-](\d{1,2})[æœˆ\/\-](\d{1,2})/;
            const validMatch = text.match(validPeriodPattern);
            if (validMatch) {
                const fromDate = `${validMatch[1]}-${validMatch[2].padStart(2, '0')}-${validMatch[3].padStart(2, '0')}`;
                const toDate = `${validMatch[4]}-${validMatch[5].padStart(2, '0')}-${validMatch[6].padStart(2, '0')}`;
                document.getElementById('validFrom').value = fromDate;
                document.getElementById('validTo').value = toDate;
            }

            // åˆ©ç”¨è€…è² æ‹…ä¸Šé™é¡
            const burdenMatch = text.match(/åˆ©ç”¨è€…è² æ‹…[\s\S]{0,20}?(\d+)[å††]/);
            if (burdenMatch) {
                document.getElementById('userBurdenLimit').value = burdenMatch[1];
            }

            alert('ğŸ“ èª­ã¿å–ã‚Šçµæœã‚’åæ˜ ã—ã¾ã—ãŸã€‚å†…å®¹ã‚’ç¢ºèªã—ã¦å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚');
        }

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
        document.getElementById('userForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const user = {
                id: Date.now().toString(),
                certificateNumber: document.getElementById('certificateNumber').value,
                name: document.getElementById('userName').value,
                cityCode: document.getElementById('cityCode').value || '131148',
                supportLevel: document.getElementById('supportLevel').value || '22',
                validFrom: document.getElementById('validFrom').value,
                validTo: document.getElementById('validTo').value,
                unit: document.getElementById('userUnit').value,
                issueDate: document.getElementById('issueDate').value,
                userBurdenLimit: document.getElementById('userBurdenLimit').value || '0'
            };

            users.push(user);
            localStorage.setItem('gh_users', JSON.stringify(users));
            
            renderUserList();
            updateUserSelector();
            resetForm();
            
            alert('âœ… åˆ©ç”¨è€…ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼');
        });

        function resetForm() {
            document.getElementById('userForm').reset();
        }

        function renderUserList() {
            const list = document.getElementById('userList');
            if (users.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ç™»éŒ²ã•ã‚ŒãŸåˆ©ç”¨è€…ã¯ã„ã¾ã›ã‚“</p>';
                return;
            }

            list.innerHTML = users.map(user => `
                <div class="user-card" onclick="editUser('${user.id}')">
                    <h3>${user.name}</h3>
                    <p>ğŸ“‹ å—çµ¦è€…è¨¼ç•ªå·: ${user.certificateNumber}</p>
                    <p>ğŸ  ãƒ¦ãƒ‹ãƒƒãƒˆ: ${getUnitName(user.unit)}</p>
                    <p>ğŸ“Š åŒºåˆ†: ${getSupportLevelName(user.supportLevel)}</p>
                    <p>ğŸ“… æœ‰åŠ¹æœŸé–“: ${user.validFrom || 'æœªè¨­å®š'} ï½ ${user.validTo || 'æœªè¨­å®š'}</p>
                </div>
            `).join('');
        }

        function getUnitName(unit) {
            const units = {
                'nakano': 'Nakano. settle',
                'nerima': 'Nerima. settle',
                'nerima-west': 'Nerima. settle west'
            };
            return units[unit] || unit;
        }

        function getSupportLevelName(level) {
            const levels = {
                '21': 'åŒºåˆ†1', '22': 'åŒºåˆ†2', '23': 'åŒºåˆ†3',
                '24': 'åŒºåˆ†4', '25': 'åŒºåˆ†5', '26': 'åŒºåˆ†6'
            };
            return levels[level] || 'ãªã—';
        }

        function editUser(userId) {
            // ç·¨é›†æ©Ÿèƒ½ã¯å¾Œã§å®Ÿè£…
            alert('ç·¨é›†æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™');
        }

        function updateUserSelector() {
            const select = document.getElementById('recordUser');
            select.innerHTML = '<option value="">åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</option>' +
                users.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é–¢é€£
        function updateCalendar() {
            const calendar = document.getElementById('calendar');
            const monthLabel = document.getElementById('currentMonth');
            
            const date = new Date(currentYear, currentMonth, 1);
            monthLabel.textContent = `${currentYear}å¹´ ${currentMonth + 1}æœˆ`;

            const firstDay = date.getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            let html = '<div class="calendar-grid">';
            
            // æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼
            ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'].forEach(day => {
                html += `<div class="calendar-day header">${day}</div>`;
            });

            // ç©ºç™½ã‚»ãƒ«
            for (let i = 0; i < firstDay; i++) {
                html += '<div class="calendar-day disabled"></div>';
            }

            // æ—¥ä»˜ã‚»ãƒ«
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const record = getRecord(selectedUserId, dateStr);
                
                const statusClass = record ? getStatusClass(record.status) : '';
                const statusText = record ? record.status : '';

                html += `
                    <div class="calendar-day" onclick="openDateModal('${dateStr}')">
                        <div class="day-number">${day}</div>
                        ${statusText ? `<div class="day-status ${statusClass}">${statusText}</div>` : ''}
                    </div>
                `;
            }

            html += '</div>';
            calendar.innerHTML = html;
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            updateCalendar();
        }

        function loadRecords() {
            selectedUserId = document.getElementById('recordUser').value;
            updateCalendar();
        }

        function getStatusClass(status) {
            if (status === 'â—‹' || status === 'â—‹ï¼ˆæœ¬å…¥å±…ï¼‰') return 'status-ok';
            if (status.includes('å¤–æ³Š')) return 'status-away';
            if (status.includes('å…¥é™¢')) return 'status-hospital';
            return '';
        }

        function getRecord(userId, date) {
            if (!userId || !records[userId]) return null;
            return records[userId][date];
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«
        function openDateModal(dateStr) {
            if (!selectedUserId) {
                alert('åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            selectedDate = dateStr;
            document.getElementById('modalDate').textContent = dateStr;
            
            // æ—¢å­˜ã®è¨˜éŒ²ãŒã‚ã‚Œã°é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
            const record = getRecord(selectedUserId, dateStr);
            document.querySelectorAll('.status-option').forEach(opt => {
                opt.classList.remove('selected');
                if (record && opt.dataset.status === record.status) {
                    opt.classList.add('selected');
                }
            });

            document.getElementById('dateModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('dateModal').classList.remove('active');
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠ
        document.querySelectorAll('.status-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.status-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                this.classList.add('selected');
            });
        });

        function saveRecord() {
            const selected = document.querySelector('.status-option.selected');
            if (!selected) {
                alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (!records[selectedUserId]) {
                records[selectedUserId] = {};
            }

            records[selectedUserId][selectedDate] = {
                status: selected.dataset.status,
                date: selectedDate
            };

            localStorage.setItem('gh_records', JSON.stringify(records));
            updateCalendar();
            closeModal();
        }

        // CSVå‡ºåŠ›
        function exportCSV(type) {
            const month = document.getElementById('exportMonth').value;
            if (!month) {
                alert('å¯¾è±¡å¹´æœˆã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const [year, mon] = month.split('-');
            
            if (type === 'SE') {
                generateSE(year, mon);
            } else if (type === 'SV') {
                generateSV(year, mon);
            }
        }

        function generateSE(year, month) {
            // ç°¡æ˜“ç‰ˆã®SEç”Ÿæˆï¼ˆå®Ÿéš›ã«ã¯ã‚‚ã£ã¨è¤‡é›‘ï¼‰
            let csv = '"1","1","0","11","J11","0","1321402032","0","1","' + year + month + '","0"\n';
            
            users.forEach((user, index) => {
                const recordCount = countRecordsForMonth(user.id, year, month);
                if (recordCount > 0) {
                    // åŸºæœ¬æƒ…å ±ãƒ¬ã‚³ãƒ¼ãƒ‰
                    csv += `"2","${index + 2}","J111","01","${year}${month}","${user.cityCode}","1321402032","135001","1","10776","125001","125001","0","0","0","1","10000","10000","2","10776","135001","135001","0","0","0"\n`;
                }
            });

            csv += '"3","' + (users.length + 2) + '"\n';

            downloadCSV(csv, `SE${year}${month}.csv`);
        }

        function generateSV(year, month) {
            // ç°¡æ˜“ç‰ˆã®SVç”Ÿæˆ
            let csv = '"1","1","0","32","J61","0","1321402032","0","1","' + year + month + '","0"\n';
            
            let lineNum = 2;
            users.forEach(user => {
                const monthRecords = getMonthRecords(user.id, year, month);
                if (Object.keys(monthRecords).length > 0) {
                    // åŸºæœ¬æƒ…å ±
                    csv += `"2","${lineNum}","J611","01","${year}${month}","${user.cityCode}","1321402032","${user.certificateNumber}","1801","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","30","0","0"\n`;
                    lineNum++;

                    // æ—¥åˆ¥è¨˜éŒ²
                    const daysInMonth = new Date(year, month, 0).getDate();
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateStr = `${year}-${month.padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const record = monthRecords[dateStr];
                        const status = record ? (record.status === 'â—‹' || record.status === 'â—‹ï¼ˆæœ¬å…¥å±…ï¼‰' ? '3' : '') : '';
                        
                        csv += `"2","${lineNum}","J611","02","${year}${month}","${user.cityCode}","1321402032","${user.certificateNumber}","1801","","${day}","","","","","","","","","","","","","","","","","","","","","","","","","","","${status}"\n`;
                        lineNum++;
                    }
                }
            });

            csv += `"3","${lineNum}"\n`;

            downloadCSV(csv, `SV${year}${month}.csv`);
        }

        function countRecordsForMonth(userId, year, month) {
            if (!records[userId]) return 0;
            
            const prefix = `${year}-${month.padStart(2, '0')}`;
            return Object.keys(records[userId]).filter(date => date.startsWith(prefix)).length;
        }

        function getMonthRecords(userId, year, month) {
            if (!records[userId]) return {};
            
            const prefix = `${year}-${month.padStart(2, '0')}`;
            const monthRecords = {};
            
            Object.entries(records[userId]).forEach(([date, record]) => {
                if (date.startsWith(prefix)) {
                    monthRecords[date] = record;
                }
            });
            
            return monthRecords;
        }

        function downloadCSV(content, filename) {
            const bom = '\uFEFF';
            const blob = new Blob([bom + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            
            document.getElementById('exportStatus').innerHTML = 
                `<div class="alert alert-success">âœ… ${filename} ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ</div>`;
        }
    </script>
</body>
</html>
